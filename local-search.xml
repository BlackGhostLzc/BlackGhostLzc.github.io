<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>åŒæ­¥ï¼šä¿¡å·é‡</title>
    <link href="/2023/11/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%90%8C%E6%AD%A5%EF%BC%9A%E4%BF%A1%E5%8F%B7%E9%87%8F/"/>
    <url>/2023/11/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%90%8C%E6%AD%A5%EF%BC%9A%E4%BF%A1%E5%8F%B7%E9%87%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ¬è®²å†…å®¹ï¼šå¦ä¸€ç§å…±äº«å†…å­˜ç³»ç»Ÿä¸­å¸¸ç”¨çš„åŒæ­¥æ–¹æ³•ï¼šä¿¡å·é‡"><a href="#æœ¬è®²å†…å®¹ï¼šå¦ä¸€ç§å…±äº«å†…å­˜ç³»ç»Ÿä¸­å¸¸ç”¨çš„åŒæ­¥æ–¹æ³•ï¼šä¿¡å·é‡" class="headerlink" title="æœ¬è®²å†…å®¹ï¼šå¦ä¸€ç§å…±äº«å†…å­˜ç³»ç»Ÿä¸­å¸¸ç”¨çš„åŒæ­¥æ–¹æ³•ï¼šä¿¡å·é‡"></a>æœ¬è®²å†…å®¹ï¼šå¦ä¸€ç§å…±äº«å†…å­˜ç³»ç»Ÿä¸­å¸¸ç”¨çš„åŒæ­¥æ–¹æ³•ï¼šä¿¡å·é‡</h2><ul><li>ä»€ä¹ˆæ˜¯ä¿¡å·é‡</li><li>ä¿¡å·é‡é€‚åˆè§£å†³ä»€ä¹ˆé—®é¢˜</li><li>å“² â™‚ å­¦å®¶åƒé¥­é—®é¢˜</li></ul><h2 id="ä»€ä¹ˆæ˜¯ä¿¡å·é‡"><a href="#ä»€ä¹ˆæ˜¯ä¿¡å·é‡" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¿¡å·é‡"></a>ä»€ä¹ˆæ˜¯ä¿¡å·é‡</h2><p>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œä¿¡å·é‡å°±æ˜¯ä¸€ä¸ªå˜é‡ï¼ˆå¯ä»¥æ˜¯æ•´æ•°æˆ–å¤æ‚çš„è®°å½•å‹å˜é‡ï¼‰ï¼Œç”¨æ¥è¡¨ç¤ºç³»ç»Ÿä¸­æŸç§èµ„æºçš„æ•°é‡ã€‚</p><h3 id="Linuxä¸­çš„ä¿¡å·é‡"><a href="#Linuxä¸­çš„ä¿¡å·é‡" class="headerlink" title="Linuxä¸­çš„ä¿¡å·é‡"></a>Linuxä¸­çš„ä¿¡å·é‡</h3><ul><li>Pæ“ä½œï¼šå°è¯•åœ¨ç›’å­ä¸­æ‹¿ä¸€ä¸ªçƒï¼Œè‹¥ç›’å­ä¸­æ²¡æœ‰çƒï¼Œåˆ™ç¡çœ ï¼›å¦åˆ™å°±å¯ä»¥è¿›å…¥ä¸´ç•ŒåŒºã€‚</li><li>Væ“ä½œï¼šå°è¯•åœ¨ç›’å­ä¸­æ”¾å…¥ä¸€ä¸ªçƒï¼Œè‹¥ç›’å­å·²æ»¡ï¼Œåˆ™ç¡çœ ï¼›æ”¾å…¥æˆåŠŸåï¼Œå¯å”¤é†’åœ¨è¿™ä¸ªä¿¡å·é‡ä¸Šé˜»å¡çš„çº¿ç¨‹ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> P sem_wait</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> V sem_post</span><br></code></pre></td></tr></table></figure><h3 id="è®¡ç®—å›¾"><a href="#è®¡ç®—å›¾" class="headerlink" title="è®¡ç®—å›¾"></a>è®¡ç®—å›¾</h3><p>å¯¹äºä»»ä½•è®¡ç®—å›¾</p><ol><li>ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªçº¿ç¨‹</li><li>å¯¹æ¯æ¡å…¥è¾¹æ‰§è¡Œ P (wait) æ“ä½œ</li><li>å®Œæˆè®¡ç®—ä»»åŠ¡</li><li>å¯¹æ¯æ¡å‡ºè¾¹æ‰§è¡Œ V (post&#x2F;signal) æ“ä½œ<br>æ¯æ¡è¾¹æ°å¥½ P ä¸€æ¬¡ã€V ä¸€æ¬¡</li></ol><h3 id="ä¼˜é›…å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"><a href="#ä¼˜é›…å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜" class="headerlink" title="ä¼˜é›…å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"></a>ä¼˜é›…å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</h3><p>å›åˆ°ä¸Šæ¬¡è¯¾çš„æ‰“å°åˆæ³•æ‹¬å·é—®é¢˜ï¼ˆæ‹¬å·åºåˆ—è¦åˆæ³•ï¼Œä¸”åµŒå¥—æ·±åº¦ä¸è¦è¶…è¿‡nï¼‰<br>å¦‚ä½•ç”¨ä¿¡å·é‡æ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ<br>æˆ‘ä»¬æƒ³è±¡æœ‰ä¸¤ä¸ªç›’å­ï¼Œ<strong>â‘ å·ç›’å­è¡¨ç¤ºå½“å‰å·¦æ‹¬å·å¯ä»¥æ‰“å°çš„ä¸ªæ•°</strong>ï¼Œ<strong>â‘¡å·ç›’å­è¡¨ç¤ºå½“å‰å³æ‹¬å·å¯ä»¥æ‰“å°çš„ä¸ªæ•°</strong>ã€‚ã€</p><ul><li>åˆå§‹çš„æ—¶å€™ï¼Œâ‘ å·ç›’å­ä¸­æ”¾æœ‰nä¸ªçƒï¼Œâ‘¡å·ç›’å­0ä¸ªçƒ</li><li>æ‰“å° ( çš„æ—¶å€™ï¼Œè¦å…ˆä»â‘ å·ç›’å­ä¸­æ‹¿å‡ºä¸€ä¸ªçƒï¼ˆæ²¡æœ‰çƒå°±é˜»å¡ï¼‰ï¼Œå†å¾€â‘¡å·ç›’å­ä¸­æ”¾å…¥ä¸€ä¸ªçƒï¼ˆæ»¡äº†ä¹Ÿé˜»å¡ï¼‰ã€‚<br>è½¬åŒ–æˆä»£ç ï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹æ“ä½œï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">P(â‘ å·ç›’å­)    <span class="hljs-comment">// å·¦æ‹¬å·ç›’å­ä¸­å–å‡ºä¸€ä¸ªçƒ</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>)  <span class="hljs-comment">// æ‰“å°</span><br>v(â‘¡å·ç›’å­)    <span class="hljs-comment">// å³æ‹¬å·ç›’å­ä¸­æ”¾å…¥ä¸€ä¸ªçƒ</span><br></code></pre></td></tr></table></figure></li><li>æ‰“å° ) çš„æ—¶å€™ï¼ŒåŒç†ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">P(â‘¡å·ç›’å­)    <span class="hljs-comment">// å³æ‹¬å·ç›’å­ä¸­å–å‡ºä¸€ä¸ªçƒ</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>)  <span class="hljs-comment">// æ‰“å°</span><br>v(â‘ å·ç›’å­)    <span class="hljs-comment">// å·¦æ‹¬å·ç›’å­ä¸­æ”¾å…¥ä¸€ä¸ªçƒ</span><br></code></pre></td></tr></table></figure></li></ul><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread-sync.h&quot;</span></span><br><br><span class="hljs-type">sem_t</span> fill, empty;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tproduce</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    P(&amp;empty);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>);<br>    V(&amp;fill);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tconsume</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    P(&amp;fill);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>);<br>    V(&amp;empty);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  assert(argc == <span class="hljs-number">2</span>);<br>  SEM_INIT(&amp;fill, <span class="hljs-number">0</span>);<br>  SEM_INIT(&amp;empty, atoi(argv[<span class="hljs-number">1</span>]));<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>    create(Tproduce);<br>    create(Tconsume);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å“²å­¦å®¶å°±é¤é—®é¢˜"><a href="#å“²å­¦å®¶å°±é¤é—®é¢˜" class="headerlink" title="å“²å­¦å®¶å°±é¤é—®é¢˜"></a>å“²å­¦å®¶å°±é¤é—®é¢˜</h2><p>æ­»é”ä¼šåœ¨ 5 ä¸ªå“²å­¦å®¶ â€œåŒæ—¶åƒé¥­â€ æ—¶å‘ç”Ÿï¼Œå¦‚äº”ä¸ªå“²å­¦å®¶éƒ½æ‹¿äº†ä¸€åªç­·å­ã€‚</p><blockquote><p>ç ´åè¿™ä¸ªæ¡ä»¶å³å¯,çº¦å®š<strong>ä»»ä½•æ—¶å€™è‡³å¤šåªæœ‰ 4 ä¸ªäººå¯ä»¥åƒé¥­</strong><br>å››ä¸ªäººåƒé¥­çš„æ—¶å€™è‡³å°‘ä¸€äººå°±å¯ä»¥æ‹¿åˆ°ä¸¤åªç­·å­ï¼</p></blockquote><p>ä¹Ÿå°±æ˜¯äº”ä¸ªå“²å­¦å®¶å…ˆä»æ¡Œå­ä¸Šé€€å‡º,æœ‰å››å¼ å¡,å‡­å¡å…¥åº§ã€‚<br><strong>è¿™é‡Œçš„å¡å°±æ˜¯ä¿¡å·é‡</strong>,åˆå§‹åŒ–ä¸º 4ã€‚<br>äº”æ”¯ç­·å­ä¹Ÿéœ€è¦äº”ä¸ªä¿¡å·é‡ï¼Œåˆå§‹åŒ–ä¸º 1.</p><blockquote><p>åˆå§‹åŒ–ä¸º 1 çš„ä¿¡å·é‡ä¸ç¡çœ é”çš„ä½œç”¨æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¡çœ é”å¯ä»¥çœ‹æˆæ˜¯ç‰¹æ®Šçš„ä¿¡å·é‡ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread-sync.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N 5</span><br><br><span class="hljs-type">sem_t</span> table, avail[N];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tphilosopher</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>  <span class="hljs-type">int</span> lhs = (id + N - <span class="hljs-number">1</span>) % N;<br>  <span class="hljs-type">int</span> rhs = id % N;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-comment">// Come to table</span><br>    P(&amp;table);<br><br>    P(&amp;avail[lhs]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;+ %d by T%d\n&quot;</span>, lhs, id);<br>    P(&amp;avail[rhs]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;+ %d by T%d\n&quot;</span>, rhs, id);<br><br>    <span class="hljs-comment">// Eat</span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- %d by T%d\n&quot;</span>, lhs, id);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- %d by T%d\n&quot;</span>, rhs, id);<br>    V(&amp;avail[lhs]);<br>    V(&amp;avail[rhs]);<br><br>    <span class="hljs-comment">// Leave table</span><br>    V(&amp;table);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  SEM_INIT(&amp;table, N - <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>    SEM_INIT(&amp;avail[i], <span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>    create(Tphilosopher);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŒæ­¥ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…ä¸æ¡ä»¶å˜é‡</title>
    <link href="/2023/11/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%90%8C%E6%AD%A5%EF%BC%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E4%B8%8E%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/"/>
    <url>/2023/11/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%90%8C%E6%AD%A5%EF%BC%9A%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E4%B8%8E%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="åŒæ­¥"><a href="#åŒæ­¥" class="headerlink" title="åŒæ­¥"></a>åŒæ­¥</h2><p>ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»ã€‚</p><p>å†æ¬¡æŠŠçº¿ç¨‹æƒ³è±¡æˆè‡ªå·±</p><ul><li>NPYï¼šç­‰æˆ‘æ´—ä¸ªå¤´å°±å‡ºé—¨&#x2F;ç­‰æˆ‘æ‰“å®Œè¿™å±€æ¸¸æˆå°±æ¥</li><li>èˆå‹ï¼šç­‰æˆ‘ä¿®å¥½è¿™ä¸ª bug å°±åƒé¥­</li><li>å¯¼å¸ˆï¼šç­‰æˆ‘å‡ºå·®å›æ¥å°±è®¨è®ºè¿™ä¸ªè¯¾é¢˜<br>â€œå…ˆåˆ°å…ˆç­‰â€ï¼Œ<strong>åœ¨æ¡ä»¶è¾¾æˆçš„ç¬é—´å†æ¬¡æ¢å¤å¹¶è¡Œ</strong><br>åŒæ—¶å¼€å§‹å‡ºå»ç©&#x2F;åƒé¥­&#x2F;è®¨è®º</li></ul><h2 id="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"><a href="#ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜" class="headerlink" title="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜"></a>ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</h2><p>99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">Tproduce</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>); &#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">Tconsume</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>); &#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>printf</code> å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³</p><ul><li>ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€</li><li>æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡ n<ul><li>n&#x3D;3, <code>((())())(((</code> åˆæ³•</li><li>n&#x3D;3, <code>(((())))</code>, <code>(()))</code> ä¸åˆæ³•</li></ul></li><li>ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸­çš„åŒæ­¥<ul><li><code>Tproduce</code>: ç­‰åˆ°æœ‰ç©ºä½æ—¶æ‰èƒ½æ‰“å°å·¦æ‹¬å·</li><li><code>Tconsume</code>: ç­‰åˆ°æœ‰å¤šä½™çš„å·¦æ‹¬å·æ—¶æ‰èƒ½æ‰“å°å³æ‹¬å·</li></ul></li></ul><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š<br>ä»£ç ä¸­çš„<code>mutex_lock</code>å…¶å®å°±æ˜¯è°ƒç”¨äº†<code>pthread_mutex_lock</code>,è€Œ<code>mutex_unlock</code>æ˜¯è°ƒç”¨äº†<code>pthread_mutex_unlock</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread-sync.h&quot;</span></span><br><br><span class="hljs-type">int</span> n, count = <span class="hljs-number">0</span>;<br><span class="hljs-type">mutex_t</span> lk = MUTEX_INIT();<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_PRODUCE (count &lt; n)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_CONSUME (count &gt; 0)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tproduce</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>retry:<br>    mutex_lock(&amp;lk);<br>    <span class="hljs-keyword">if</span> (!CAN_PRODUCE) &#123;<br>      mutex_unlock(&amp;lk);<br>      <span class="hljs-keyword">goto</span> retry;<br>    &#125;<br>    count++;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>);  <span class="hljs-comment">// Push an element into buffer</span><br>    mutex_unlock(&amp;lk);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tconsume</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>retry:<br>    mutex_lock(&amp;lk);<br>    <span class="hljs-keyword">if</span> (!CAN_CONSUME) &#123;<br>      mutex_unlock(&amp;lk);<br>      <span class="hljs-keyword">goto</span> retry;<br>    &#125;<br>    count--;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>);  <span class="hljs-comment">// Pop an element from buffer</span><br>    mutex_unlock(&amp;lk);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  assert(argc == <span class="hljs-number">2</span>);<br>  n = atoi(argv[<span class="hljs-number">1</span>]);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>    create(Tproduce);<br>    create(Tconsume);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h2><h3 id="ä»€ä¹ˆæ˜¯æ¡ä»¶å˜é‡"><a href="#ä»€ä¹ˆæ˜¯æ¡ä»¶å˜é‡" class="headerlink" title="ä»€ä¹ˆæ˜¯æ¡ä»¶å˜é‡"></a>ä»€ä¹ˆæ˜¯æ¡ä»¶å˜é‡</h3><p>æ¡ä»¶å˜é‡æ˜¯å¤šçº¿ç¨‹ç¨‹åºä¸­ç”¨æ¥å®ç°ç­‰å¾…å’Œå”¤é†’é€»è¾‘å¸¸ç”¨çš„æ–¹æ³•ã€‚é€šå¸¸æœ‰<code>wait</code>å’Œ<code>notify</code>ä¸¤ä¸ªåŠ¨ä½œï¼Œ<code>wait</code>ç”¨äºé˜»å¡æŒ‚èµ·çº¿ç¨‹Aï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹Bé€šè¿‡é€šè¿‡<code>notify</code>å”¤é†’çº¿ç¨‹Aï¼Œå”¤é†’åçº¿ç¨‹Aä¼šç»§ç»­è¿è¡Œã€‚</p><p>çº¿ç¨‹åŒæ­¥ç”±<strong>æ¡ä»¶ä¸æˆç«‹ç­‰å¾…</strong>å’Œ<strong>åŒæ­¥æ¡ä»¶è¾¾æˆç»§ç»­</strong>æ„æˆã€‚<br>é‚£ä¹ˆåœ¨æˆ‘ä»¬çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­å¦‚ä½•å»ä½¿ç”¨æ¡ä»¶å˜é‡å‘¢ã€‚<br>ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…é—®é¢˜</p><ul><li>Tproduce åŒæ­¥æ¡ä»¶ï¼šCAN_PRODUCE (count &lt; n)</li><li>Tproduce è¾¾æˆåŒæ­¥ï¼šTconsume countâ€“</li><li>Tconsume åŒæ­¥æ¡ä»¶ï¼šCAN_CONSUME (count &gt; 0)</li><li>Tconsume è¾¾æˆåŒæ­¥ï¼šTproduce count++</li></ul><h3 id="æ¡ä»¶å˜é‡é”™è¯¯çš„ä½¿ç”¨æ–¹å¼"><a href="#æ¡ä»¶å˜é‡é”™è¯¯çš„ä½¿ç”¨æ–¹å¼" class="headerlink" title="æ¡ä»¶å˜é‡é”™è¯¯çš„ä½¿ç”¨æ–¹å¼"></a>æ¡ä»¶å˜é‡é”™è¯¯çš„ä½¿ç”¨æ–¹å¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread-sync.h&quot;</span></span><br><br><span class="hljs-type">int</span> n, count = <span class="hljs-number">0</span>;<br><span class="hljs-type">mutex_t</span> lk = MUTEX_INIT();<br><span class="hljs-type">cond_t</span> cv = COND_INIT();<br> <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_PRODUCE (count &lt; n)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_CONSUME (count &gt; 0)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tproduce</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    mutex_lock(&amp;lk);<br>    <span class="hljs-keyword">if</span> (!CAN_PRODUCE) &#123;<br>      cond_wait(&amp;cv, &amp;lk);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>); count++;<br>    cond_signal(&amp;cv);<br>    mutex_unlock(&amp;lk);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tconsume</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    mutex_lock(&amp;lk);<br>    <span class="hljs-keyword">if</span> (!CAN_CONSUME) &#123;<br>      cond_wait(&amp;cv, &amp;lk);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>); count--;<br>    cond_signal(&amp;cv);<br>    mutex_unlock(&amp;lk);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  assert(argc == <span class="hljs-number">3</span>);<br>  n = atoi(argv[<span class="hljs-number">1</span>]);<br>  <span class="hljs-type">int</span> T = atoi(argv[<span class="hljs-number">2</span>]);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; T; i++) &#123;<br>    create(Tproduce);<br>    create(Tconsume);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœè¿™é‡Œçš„ T å¤§äº 1ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šä¸ªconsumerå’Œå¤šä¸ªproducerï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ<br><code>signal</code>ä¼šéšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨è¿™æ ·ä¸€ç§å¯èƒ½ä¸€ä¸ªconsumerçº¿ç¨‹å”¤é†’å¦ä¸€ä¸ªconsumerçº¿ç¨‹,è€Œå› ä¸ºæ˜¯<code>if</code>ï¼Œæ‰€ä»¥è¿™ä¸ªconsumerçº¿ç¨‹ç›´æ¥è·³è¿‡äº†<code>!CAN_CONSUME</code>çš„åˆ¤æ–­ï¼Œè¿™æ ·å°±å¯¼è‡´äº†é”™è¯¯ã€‚</p><h3 id="æ¡ä»¶å˜é‡æ­£ç¡®çš„æ‰“å¼€æ–¹å¼"><a href="#æ¡ä»¶å˜é‡æ­£ç¡®çš„æ‰“å¼€æ–¹å¼" class="headerlink" title="æ¡ä»¶å˜é‡æ­£ç¡®çš„æ‰“å¼€æ–¹å¼"></a>æ¡ä»¶å˜é‡æ­£ç¡®çš„æ‰“å¼€æ–¹å¼</h3><p>çœ‹çœ‹ä¸Šé¢çš„é”™è¯¯å®ç°</p><ol><li><p>é¦–å…ˆéœ€è¦æ›´æ”¹çš„å°±æ˜¯<code>if</code>è¯­å¥ï¼Œè¿™é‡Œåº”è¯¥æ”¹ä¸ºä¸€ä¸ªåˆ¤æ–­çš„<code>while</code>å¾ªç¯(è¢«å”¤é†’æ—¶åº”è¯¥å†æ¬¡æ£€æŸ¥)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> (!CAN_CONSUME) &#123;<br>  cond_wait(&amp;cv, &amp;lk);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ç”±äº<code>signal</code>åªæ˜¯éšæœºå”¤é†’ä¸€ä¸ªé˜»å¡åœ¨è¿™ä¸ªæ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹ï¼Œå†åŠ ä¸Šæœ‰äº†è¿™ä¸ª<code>while</code>å¾ªç¯ï¼Œæˆ‘ä»¬åº”è¯¥ç”¨<code>broadcast</code>å”¤é†’æ‰€æœ‰é˜»å¡åœ¨è¿™ä¸ªæ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹ã€‚ï¼ˆåªèƒ½ç”¨<code>broadcast</code>)</p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread-sync.h&quot;</span></span><br><br><span class="hljs-type">int</span> n, count = <span class="hljs-number">0</span>;<br><span class="hljs-type">mutex_t</span> lk = MUTEX_INIT();<br><span class="hljs-type">cond_t</span> cv = COND_INIT();<br> <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_PRODUCE (count &lt; n)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_CONSUME (count &gt; 0)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tproduce</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    mutex_lock(&amp;lk);<br>    <span class="hljs-keyword">while</span> (!CAN_PRODUCE) &#123;<br>      cond_wait(&amp;cv, &amp;lk);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>); count++;<br>    cond_broadcast(&amp;cv);<br>    mutex_unlock(&amp;lk);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tconsume</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    mutex_lock(&amp;lk);<br>    <span class="hljs-keyword">while</span> (!CAN_CONSUME) &#123;<br>      cond_wait(&amp;cv, &amp;lk);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>); count--;<br>    cond_broadcast(&amp;cv);<br>    mutex_unlock(&amp;lk);<br>  &#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  assert(argc == <span class="hljs-number">3</span>);<br>  n = atoi(argv[<span class="hljs-number">1</span>]);<br>  <span class="hljs-type">int</span> T = atoi(argv[<span class="hljs-number">2</span>]);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; T; i++) &#123;<br>    create(Tproduce);<br>    create(Tconsume);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¤æ€ªçš„ä¹ é¢˜ï¼šæ‰“å°å°é±¼"><a href="#å¤æ€ªçš„ä¹ é¢˜ï¼šæ‰“å°å°é±¼" class="headerlink" title="å¤æ€ªçš„ä¹ é¢˜ï¼šæ‰“å°å°é±¼"></a>å¤æ€ªçš„ä¹ é¢˜ï¼šæ‰“å°å°é±¼</h2><h2 id="æœ‰ä¸‰ç§çº¿ç¨‹-Ta-è‹¥å¹²-æ­»å¾ªç¯æ‰“å°-Tc-è‹¥å¹²-æ­»å¾ªç¯æ‰“å°"><a href="#æœ‰ä¸‰ç§çº¿ç¨‹-Ta-è‹¥å¹²-æ­»å¾ªç¯æ‰“å°-Tc-è‹¥å¹²-æ­»å¾ªç¯æ‰“å°" class="headerlink" title="æœ‰ä¸‰ç§çº¿ç¨‹- Ta è‹¥å¹²: æ­»å¾ªç¯æ‰“å° &lt;- Tb è‹¥å¹²: æ­»å¾ªç¯æ‰“å° &gt;- Tc è‹¥å¹²: æ­»å¾ªç¯æ‰“å° _"></a>æœ‰ä¸‰ç§çº¿ç¨‹<br>- Ta è‹¥å¹²: æ­»å¾ªç¯æ‰“å° &lt;<br>- Tb è‹¥å¹²: æ­»å¾ªç¯æ‰“å° &gt;<br>- Tc è‹¥å¹²: æ­»å¾ªç¯æ‰“å° _</h2><p>ä»»åŠ¡ï¼š</p><ul><li>å¯¹è¿™äº›çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—å±å¹•æ‰“å°å‡º &lt;&gt;&lt;_ å’Œ &gt;&lt;&gt;_ çš„ç»„åˆï¼Œ_è¡¨ç¤ºåˆ†éš”ç¬¦</li></ul><ul><li>çŠ¶æ€æœºçš„è§†è§’ï¼š<br>åˆå§‹çŠ¶æ€ä¸ºAï¼Œæ‰“å°ä¸€ä¸ª&lt;åˆ°çŠ¶æ€Bï¼Œæˆ–è€…æ‰“å°ä¸€ä¸ª&gt;åˆ°çŠ¶æ€Eã€‚<blockquote><p>æ¯ä¸ªçŠ¶æ€éƒ½æœ‰å¯ä»¥æ‰“å°çš„å­—ç¬¦ï¼Œç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡è¡¨ç¤ºå½“å‰çŠ¶æ€ã€‚<br>æ­¤å¤–ï¼Œç”±äºä¸å¯ä»¥ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰“å°ï¼Œæ‰€ä»¥è¿˜éœ€ä¸€ä¸ªquotaå˜é‡ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›å…¥ä¸´ç•ŒåŒºã€‚</p></blockquote></li></ul><p>æˆ‘ä»¬æŠŠçŠ¶æ€è½¬æ¢å›¾ä»¥ä»£ç å½¢å¼è¡¨ç¤ºå‡ºæ¥ã€‚</p><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread-sync.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LENGTH(arr) (sizeof(arr) / sizeof(arr[0]))</span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span> A = <span class="hljs-number">1</span>, B, C, D, E, F, &#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rule</span> &#123;</span><br>  <span class="hljs-type">int</span> from, ch, to;<br>&#125; rules[] = &#123;<br>  &#123; A, <span class="hljs-string">&#x27;&lt;&#x27;</span>, B &#125;,<br>  &#123; B, <span class="hljs-string">&#x27;&gt;&#x27;</span>, C &#125;,<br>  &#123; C, <span class="hljs-string">&#x27;&lt;&#x27;</span>, D &#125;,<br>  &#123; A, <span class="hljs-string">&#x27;&gt;&#x27;</span>, E &#125;,<br>  &#123; E, <span class="hljs-string">&#x27;&lt;&#x27;</span>, F &#125;,<br>  &#123; F, <span class="hljs-string">&#x27;&gt;&#x27;</span>, D &#125;,<br>  &#123; D, <span class="hljs-string">&#x27;_&#x27;</span>, A &#125;,<br>&#125;;<br><span class="hljs-type">int</span> current = A, quota = <span class="hljs-number">1</span>;<br><br><span class="hljs-type">mutex_t</span> lk = MUTEX_INIT();<br><span class="hljs-type">cond_t</span> cv = COND_INIT();<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">next</span><span class="hljs-params">(<span class="hljs-type">char</span> ch)</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; LENGTH(rules); i++) &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rule</span> *<span class="hljs-title">rule</span> =</span> &amp;rules[i];<br>    <span class="hljs-keyword">if</span> (rule-&gt;from == current &amp;&amp; rule-&gt;ch == ch) &#123;<br>      <span class="hljs-keyword">return</span> rule-&gt;to;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">can_print</span><span class="hljs-params">(<span class="hljs-type">char</span> ch)</span> &#123;<br>    <span class="hljs-keyword">return</span> next(ch) != <span class="hljs-number">0</span> &amp;&amp; quota &gt; <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">fish_before</span><span class="hljs-params">(<span class="hljs-type">char</span> ch)</span> &#123;<br>  mutex_lock(&amp;lk);<br>  <span class="hljs-keyword">while</span> (!can_print(ch)) &#123;<br>    <span class="hljs-comment">// can proceed only if (next(ch) &amp;&amp; quota)</span><br>    cond_wait(&amp;cv, &amp;lk);<br>  &#125;<br>  quota--;<br>  mutex_unlock(&amp;lk);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">fish_after</span><span class="hljs-params">(<span class="hljs-type">char</span> ch)</span> &#123;<br>  mutex_lock(&amp;lk);<br>  quota++;<br>  current = next(ch);<br>  assert(current);<br>  cond_broadcast(&amp;cv);<br>  mutex_unlock(&amp;lk);<br>&#125;<br><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> roles[] = <span class="hljs-string">&quot;.&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;___&quot;</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">fish_thread</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>  <span class="hljs-type">char</span> role = roles[id];<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    fish_before(role);<br>    <span class="hljs-built_in">putchar</span>(role);  <span class="hljs-comment">// Not lock-protected</span><br>    fish_after(role);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">strlen</span>(roles); i++)<br>    create(fish_thread);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¹¶å‘æ§åˆ¶åŸºç¡€</title>
    <link href="/2023/11/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%9F%BA%E7%A1%80/"/>
    <url>/2023/11/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h2 id="Petersonç®—æ³•"><a href="#Petersonç®—æ³•" class="headerlink" title="Petersonç®—æ³•"></a>Petersonç®—æ³•</h2><p>åœ¨ä»‹ç»Petersonç®—æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹æˆ‘ä»¬ä½œå‡ºä»¥ä¸‹åŸºæœ¬å‡è®¾ï¼šå†…å­˜çš„è¯»&#x2F;å†™å¯ä»¥ä¿è¯é¡ºåºã€åŸå­åœ°å®Œæˆã€‚</p><h3 id="Petersonç®—æ³•ï¼š"><a href="#Petersonç®—æ³•ï¼š" class="headerlink" title="Petersonç®—æ³•ï¼š"></a>Petersonç®—æ³•ï¼š</h3><p>A å’Œ B äº‰ç”¨å•æ‰€çš„åŒ…å¢</p><ul><li>æƒ³è¿›å…¥åŒ…å¢ä¹‹å‰ï¼ŒA&#x2F;B éƒ½é¦–å…ˆä¸¾èµ·è‡ªå·±çš„æ——å­<ul><li>A å¾€å•æ‰€é—¨ä¸Šè´´ä¸Š â€œB æ­£åœ¨ä½¿ç”¨â€ çš„æ ‡ç­¾</li><li>B å¾€å•æ‰€é—¨ä¸Šè´´ä¸Š â€œA æ­£åœ¨ä½¿ç”¨â€ çš„æ ‡ç­¾</li></ul></li><li>ç„¶åï¼Œ<strong>å¦‚æœå¯¹æ–¹ä¸¾ç€æ——ï¼Œä¸”é—¨ä¸Šçš„åå­—æ˜¯å¯¹æ–¹</strong>ï¼Œç­‰å¾…<ul><li>å¦åˆ™å¯ä»¥è¿›å…¥åŒ…å¢</li></ul></li><li>å‡ºåŒ…å¢åï¼Œæ”¾ä¸‹è‡ªå·±çš„æ——å­ (å®Œå…¨ä¸ç®¡é—¨ä¸Šçš„æ ‡ç­¾)</li></ul><h3 id="å¦‚ä½•éªŒè¯è¯¥ç®—æ³•çš„æ­£ç¡®æ€§ï¼Ÿ"><a href="#å¦‚ä½•éªŒè¯è¯¥ç®—æ³•çš„æ­£ç¡®æ€§ï¼Ÿ" class="headerlink" title="å¦‚ä½•éªŒè¯è¯¥ç®—æ³•çš„æ­£ç¡®æ€§ï¼Ÿ"></a>å¦‚ä½•éªŒè¯è¯¥ç®—æ³•çš„æ­£ç¡®æ€§ï¼Ÿ</h3><p>jyyè€å¸ˆç»™å‡ºäº†ä¸€ä¸ªç”¨Pythonå®ç°çš„model checkerã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">T1</span>():<br>  <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    heap.x = <span class="hljs-string">&#x27;ğŸ´&#x27;</span><br>    sys_sched()<br>    heap.turn = <span class="hljs-string">&#x27;â·&#x27;</span><br>    sys_sched()<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>      t = heap.turn<br>      sys_sched()<br>      y = heap.y != <span class="hljs-string">&#x27;&#x27;</span><br>      sys_sched()<br>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> y <span class="hljs-keyword">or</span> t == <span class="hljs-string">&#x27;â¶&#x27;</span>:<br>        <span class="hljs-keyword">break</span><br>    sys_sched()<br>    heap.cs += <span class="hljs-string">&#x27;â¶&#x27;</span><br>    sys_sched()<br>    heap.cs = heap.cs.replace(<span class="hljs-string">&#x27;â¶&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    sys_sched()<br>    heap.x = <span class="hljs-string">&#x27;&#x27;</span><br>    sys_sched()<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">T2</span>():<br>  <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    heap.y = <span class="hljs-string">&#x27;ğŸ&#x27;</span><br>    sys_sched()<br>    heap.turn = <span class="hljs-string">&#x27;â¶&#x27;</span><br>    sys_sched()<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>      t = heap.turn<br>      sys_sched()<br>      x = heap.x<br>      sys_sched()<br>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> x <span class="hljs-keyword">or</span> t == <span class="hljs-string">&#x27;â·&#x27;</span>:<br>        <span class="hljs-keyword">break</span><br>      sys_sched()<br>    sys_sched()<br>    heap.cs += <span class="hljs-string">&#x27;â·&#x27;</span><br>    sys_sched()<br>    heap.cs = heap.cs.replace(<span class="hljs-string">&#x27;â·&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    sys_sched()<br>    heap.y = <span class="hljs-string">&#x27;&#x27;</span><br>    sys_sched()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>  heap.x = <span class="hljs-string">&#x27;&#x27;</span><br>  heap.y = <span class="hljs-string">&#x27;&#x27;</span><br>  heap.turn = <span class="hljs-string">&#x27;&#x27;</span><br>  heap.cs = <span class="hljs-string">&#x27;&#x27;</span><br>  sys_spawn(T1)<br>  sys_spawn(T2)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>sys_spawn</code>å’Œ<code>sys_sched</code>å‡½æ•°çš„å®ç°åœ¨å‰é¢çš„è¯¾ä¸­æåˆ°è¿‡ï¼Œæˆ‘æ²¡çœ‹åˆ°ï¼Œåœ¨model checkerä¸­ï¼Œä¸ºäº†ä¿è¯æˆ‘ä»¬çš„åŸºæœ¬å‡è®¾ï¼Œæˆ‘ä»¬çœ‹åˆ°åœ¨æ¯ä¸€æ¬¡è¯»å†™å˜é‡çš„æ—¶å€™éƒ½è°ƒç”¨äº†<code>sys_sched</code>å‡½æ•°ã€‚</p><h2 id="Compiler-barrier-volatile"><a href="#Compiler-barrier-volatile" class="headerlink" title="Compiler barrier&#x2F;volatile"></a>Compiler barrier&#x2F;volatile</h2><p>ä»æ¨¡å‹å›åˆ°ç°å®ï¼Œæˆ‘ä»¬å¸Œæœ›å¤„ç†å™¨å’Œç¼–è¯‘å™¨èƒ½å¤Ÿé…åˆï¼Œå®ç°åŸå­æŒ‡ä»¤ã€‚å®é™…ä¸ŠæŒ‰ç…§ä¸Šé¢æ¨¡å‹ç›´æ¥å†™çš„Petersonç®—æ³•å…¶å®æ˜¯é”™çš„ã€‚</p><p>Compiler barrierï¼ˆç¼–è¯‘å™¨å±éšœï¼‰æ˜¯ä¸€ç§ç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨åœ¨æ­¤å¤„ä¸è¦å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–é‡æ’ã€‚</p><blockquote><p>ç¼–è¯‘å™¨æä¾› __sync_synchronize() å‡½æ•°,å®ƒçš„ä½œç”¨æ˜¯ç¡®ä¿åœ¨æ‰§è¡Œè¯¥å‡½æ•°ä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œéƒ½å®Œæˆï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œè¯¥å‡½æ•°ä¹‹åçš„æ‰€æœ‰è¯»æ“ä½œéƒ½å¼€å§‹ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BARRIER __sync_synchronize()</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">TA</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    x = <span class="hljs-number">1</span>;                   BARRIER;<br>    turn = B;                BARRIER; <span class="hljs-comment">// &lt;- this is critcal for x86</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!y) <span class="hljs-keyword">break</span>;         BARRIER;<br>      <span class="hljs-keyword">if</span> (turn != B) <span class="hljs-keyword">break</span>;  BARRIER;<br>    &#125;<br>    critical_section();<br>    x = <span class="hljs-number">0</span>;                   BARRIER;<br>  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">TB</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    y = <span class="hljs-number">1</span>;                   BARRIER;<br>    turn = A;                BARRIER;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!x) <span class="hljs-keyword">break</span>;         BARRIER;<br>      <span class="hljs-keyword">if</span> (turn != A) <span class="hljs-keyword">break</span>;  BARRIER;<br>    &#125;<br>    critical_section();<br>    y = <span class="hljs-number">0</span>;                   BARRIER;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±æ­£ç¡®å®ç°äº†Petersonç®—æ³•ã€‚<br>é€šè¿‡ä½¿ç”¨å†…å­˜å±éšœï¼Œå¯ä»¥å¼ºåˆ¶ç¼–è¯‘å™¨åœ¨ç‰¹å®šä½ç½®æ’å…¥åŒæ­¥æŒ‡ä»¤ï¼Œä»¥ç¡®ä¿å¯¹å…±äº«å˜é‡çš„è¯»å†™æ“ä½œæŒ‰ç…§é¢„æœŸé¡ºåºè¿›è¡Œï¼Œå¹¶ä¸”å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚è¿™æ ·ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨ <code>_sync_synchronize()</code>ä¹‹å‰çš„å†™æ“ä½œå®Œæˆåï¼Œå…¶ä»–çº¿ç¨‹åœ¨è°ƒç”¨ <code>_sync_synchronize()</code>ä¹‹åçš„è¯»æ“ä½œæ‰èƒ½çœ‹åˆ°è¿™äº›å†™æ“ä½œçš„ç»“æœï¼Œä»è€Œä¿è¯äº†çº¿ç¨‹é—´çš„æ­£ç¡®åŒæ­¥å’Œåä½œã€‚</p><h2 id="åŸå­æŒ‡ä»¤"><a href="#åŸå­æŒ‡ä»¤" class="headerlink" title="åŸå­æŒ‡ä»¤"></a>åŸå­æŒ‡ä»¤</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">atomic_inc</span><span class="hljs-params">(<span class="hljs-type">long</span> *ptr)</span> &#123;<br>  <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-string">&quot;lock incq %0&quot;</span>  <span class="hljs-comment">// Atomic + memory fence</span></span><br><span class="hljs-params">    : <span class="hljs-string">&quot;+m&quot;</span>(*ptr)</span><br><span class="hljs-params">    :</span><br><span class="hljs-params">    : <span class="hljs-string">&quot;memory&quot;</span></span><br><span class="hljs-params">  )</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„è¿™ä¸ª<code>lock</code>å°±æ˜¯æ€»çº¿<code>lock</code>,ä¿è¯äº†å¤šå¤„ç†å™¨ä¸­ï¼Œåªæœ‰ä¸€ä¸ªå¤„ç†å™¨èƒ½å¤Ÿè¯»å†™å†…å­˜</p>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¹¶å‘Bugçš„åº”å¯¹</title>
    <link href="/2023/11/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%B9%B6%E5%8F%91Bug%E7%9A%84%E5%BA%94%E5%AF%B9/"/>
    <url>/2023/11/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%B9%B6%E5%8F%91Bug%E7%9A%84%E5%BA%94%E5%AF%B9/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ¬è®²å†…å®¹ï¼šä¸€èŠ‚çœŸæ­£çš„-â€œç¼–ç¨‹-â€è¯¾ï¼šå¦‚ä½•æ­£ç¡®åœ°-å¹¶å‘-ç¼–ç¨‹ï¼š"><a href="#æœ¬è®²å†…å®¹ï¼šä¸€èŠ‚çœŸæ­£çš„-â€œç¼–ç¨‹-â€è¯¾ï¼šå¦‚ä½•æ­£ç¡®åœ°-å¹¶å‘-ç¼–ç¨‹ï¼š" class="headerlink" title="æœ¬è®²å†…å®¹ï¼šä¸€èŠ‚çœŸæ­£çš„ â€œç¼–ç¨‹ â€è¯¾ï¼šå¦‚ä½•æ­£ç¡®åœ° (å¹¶å‘) ç¼–ç¨‹ï¼š"></a>æœ¬è®²å†…å®¹ï¼šä¸€èŠ‚çœŸæ­£çš„ â€œç¼–ç¨‹ â€è¯¾ï¼šå¦‚ä½•æ­£ç¡®åœ° (å¹¶å‘) ç¼–ç¨‹ï¼š</h2><ul><li>Lock ordering</li><li>é˜²å¾¡æ€§ç¼–ç¨‹</li><li>è¿è¡Œæ—¶æ£€æŸ¥</li></ul><h2 id="Lock-ordering"><a href="#Lock-ordering" class="headerlink" title="Lock ordering"></a>Lock ordering</h2><ul><li>ä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„</li><li>ä¸¥æ ¼æŒ‰ç…§å›ºå®šçš„é¡ºåºè·å¾—æ‰€æœ‰é” (Lock Ordering)ï¼Œå°±å¯ä»¥æ¶ˆç­å¾ªç¯ç­‰å¾…</li><li>â€œåœ¨ä»»æ„æ—¶åˆ»è·å¾— â€œæœ€é åâ€ é”çš„çº¿ç¨‹æ€»æ˜¯å¯ä»¥ç»§ç»­æ‰§è¡Œâ€<br>ä¹Ÿå°±æ˜¯ä¸ºæ‰€æœ‰çš„é”å›ºå®šä¸€ä¸ªé¡ºåºï¼ŒæŸä¸ªçº¿ç¨‹æƒ³è¦è·å–æŸç§èµ„æºå°±è¦æŒ‰é¡ºåºå»è·å¾—è¿™äº›é”ï¼Œè¿™æ ·å°±æ¶ˆé™¤äº†<strong>å¾ªç¯ç­‰å¾…</strong>ã€‚</li></ul><ul><li>å“²å­¦å®¶å°±é¤é—®é¢˜çš„è§£å†³<blockquote><p>å…ˆè·å–åºå·å°çš„é‚£æŠŠé”ï¼Œå†è·å–åºå·å¤§çš„é‚£æŠŠé”ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">sem_t</span> avail[N];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tphilosopher</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>  <span class="hljs-type">int</span> lhs = (id + N - <span class="hljs-number">1</span>) % N;<br>  <span class="hljs-type">int</span> rhs = id % N;<br><br>  <span class="hljs-comment">// Enforce lock ordering</span><br>  <span class="hljs-keyword">if</span> (lhs &gt; rhs) &#123;<br>    <span class="hljs-type">int</span> tmp = lhs;<br>    lhs = rhs;<br>    rhs = tmp;<br>  &#125;<br><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    P(&amp;avail[lhs]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;+ %d by T%d\n&quot;</span>, lhs, id);<br>    P(&amp;avail[rhs]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;+ %d by T%d\n&quot;</span>, rhs, id);<br><br>    <span class="hljs-comment">// Eat</span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- %d by T%d\n&quot;</span>, lhs, id);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- %d by T%d\n&quot;</span>, rhs, id);<br>    V(&amp;avail[lhs]);<br>    V(&amp;avail[rhs]);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>    SEM_INIT(&amp;avail[i], <span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>    create(Tphilosopher);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="Bug-çš„æœ¬è´¨å’Œé˜²å¾¡æ€§ç¼–ç¨‹"><a href="#Bug-çš„æœ¬è´¨å’Œé˜²å¾¡æ€§ç¼–ç¨‹" class="headerlink" title="Bug çš„æœ¬è´¨å’Œé˜²å¾¡æ€§ç¼–ç¨‹"></a>Bug çš„æœ¬è´¨å’Œé˜²å¾¡æ€§ç¼–ç¨‹</h2><p>å§‹ç»ˆå‡è®¾è‡ªå·±çš„ä»£ç æ˜¯é”™çš„ã€‚<br>åŠæ—©æ£€æŸ¥ã€åŠæ—©æŠ¥å‘Šã€åŠæ—©ä¿®å¤ã€‚<br>ä¾‹å¦‚ï¼Œå¤šç”¨æ–­è¨€<code>assert</code>å‡½æ•°<br>åœ¨xv6ä»£ç ä¸­ä¹Ÿæœ‰é˜²å¾¡æ€§ç¼–ç¨‹çš„æ™ºæ…§ã€‚</p><ol><li>é¿å…è¿ç»­ä¸¤æ¬¡<code>acquire</code>åŒä¸€æŠŠé”çš„æ£€æŸ¥ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// acquireå‡½æ•°</span><br><span class="hljs-keyword">if</span>(holding(lk))<br>   panic(<span class="hljs-string">&quot;acquire&quot;</span>);<br></code></pre></td></tr></table></figure></li><li>é¿å…è¿ç»­ä¸¤æ¬¡<code>release</code>åŒä¸€æŠŠé”çš„æ£€æŸ¥ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//releaseå‡½æ•°</span><br><span class="hljs-keyword">if</span>(!holding(lk))<br>   panic(<span class="hljs-string">&quot;release&quot;</span>);<br></code></pre></td></tr></table></figure></li></ol><h2 id="è‡ªåŠ¨è¿è¡Œæ—¶æ£€æŸ¥"><a href="#è‡ªåŠ¨è¿è¡Œæ—¶æ£€æŸ¥" class="headerlink" title="è‡ªåŠ¨è¿è¡Œæ—¶æ£€æŸ¥"></a>è‡ªåŠ¨è¿è¡Œæ—¶æ£€æŸ¥</h2>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CS144-lab1</title>
    <link href="/2023/09/13/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/CS144/lab1/"/>
    <url>/2023/09/13/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/CS144/lab1/</url>
    
    <content type="html"><![CDATA[<h2 id="å®éªŒç›®çš„"><a href="#å®éªŒç›®çš„" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h2><ul><li>èƒŒæ™¯ä»‹ç»<br>åœ¨è¿™ä¸ªå®éªŒä¸­å’Œä¸‹ä¸€ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°TCP receiverã€‚å®ƒæ¥æ”¶æ•°æ®æŠ¥ï¼ŒæŠŠå®ƒä»¬è½¬æˆå¯é çš„å­—èŠ‚æµï¼Œä»¥ä¾›socketè¯»å–ã€‚<br>TCP senderæŠŠå­—èŠ‚æµåˆ†æˆä¸åŒçš„segmentsï¼Œæ¯ä¸ªsegmentéƒ½å°è£…æˆæ•°æ®æŠ¥ã€‚ä½†æ˜¯ç½‘ç»œä¼ é€å¯èƒ½ä¼šä¸¢å¤±ï¼Œé‡å¤æˆ–å¤±åºï¼Œè¿™å°±éœ€è¦TCP receiveré‡æ–°ç»„åˆï¼Œè¿˜åŸæœ€åˆçš„å­—èŠ‚æµã€‚</li><li>å®éªŒç›®çš„<br>å®Œæˆä¸€ä¸ªæ•°æ®ç»“æ„<code>StreamReassembler</code>ã€‚å®ƒæ¥æ”¶ä¸€äº›å­ä¸²ï¼ˆå­—èŠ‚æµï¼‰ï¼Œä»¥åŠæ¯ä¸ªå­ä¸²ç¬¬ä¸€ä¸ªå­—èŠ‚æ‰€åœ¨å­—èŠ‚æµçš„ç´¢å¼•ã€‚<br><code>StreamReassembler</code>æœ‰ä¸€ä¸ªæˆå‘˜<code>ByteStream</code>ï¼Œåªè¦<code>StreamReassembler</code>çŸ¥é“äº†å­—èŠ‚æµçš„ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œå°±ä¼šæŠŠæ•°æ®å†™å…¥<code>ByteStream</code>ä¸­ã€‚</li></ul><h2 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h2><img src="https://s1.ax1x.com/2022/10/19/xsG8nP.png" alt="capacity.png" style="zoom:67%;" />å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ`capacity`æ˜¯æ•´ä¸ªç¼“å­˜çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯`ByteStream`çš„å¤§å°ï¼Œè“è‰²éƒ¨åˆ†è¡¨ç¤ºå·²ç»å†™å…¥å¹¶è¢«`ByteStream`è¯»å‡ºæ¥çš„éƒ¨åˆ†ï¼›ç»¿è‰²éƒ¨åˆ†è¡¨ç¤ºå·²ç»å†™å…¥`ByteStream`è¿˜æ²¡æœ‰è¢«è¯»çš„éƒ¨åˆ†ï¼›çº¢è‰²éƒ¨åˆ†æ˜¯éœ€è¦æˆ‘ä»¬åœ¨ä¸€ä¸ªbufferä¸­ç¼“å­˜èµ·æ¥çš„éƒ¨åˆ†ï¼Œå°±æ˜¯æ¥æ”¶åˆ°çš„å­—èŠ‚æµï¼Œä½†è¿™ä¸€éƒ¨åˆ†å­—èŠ‚æµåªæ˜¯å·²ç»è¢«ç¼“å­˜ï¼Œä½†è¿˜æ²¡æœ‰é‡ç»„ï¼Œç­‰åˆ°è¿ç»­æ—¶ä¸€å¹¶å†™å…¥`ByteSream`ä¸­ã€‚æˆ‘ä»¬è¿˜è®°å¾—ï¼Œä¹Ÿå°±æ˜¯`ByteStream`ä¸­æœ‰ä¸‹é¢å‡ ä¸ªæˆå‘˜ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> capacity_;<br><span class="hljs-type">size_t</span> read_size_;     <span class="hljs-comment">//æ€»å…±è¯»å–çš„å­—èŠ‚æ•°</span><br><span class="hljs-type">size_t</span> write_size_;    <span class="hljs-comment">//æ€»å…±å†™å…¥çš„å­—èŠ‚æ•°</span><br><span class="hljs-type">bool</span> end_input_;       <span class="hljs-comment">//èƒ½å¦å†å†™</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å°±æ˜¯è¯´ï¼š</p><ul><li>ä¸Šå›¾ä¸­çš„first unreadæ˜¯<code>read_size_</code></li><li>ä¸Šå›¾çš„first unassembledæ˜¯<code>write_size_</code>ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ªå¯ä»¥å†™åˆ°<code>ByteStream</code>ä¸­çš„å­—èŠ‚</li><li>ä¸Šå›¾çš„first unacceptableæ˜¯<code>read_size_ + capacity_</code></li></ul><p>æ‰€ä»¥æœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½æ€§ï¼š</p><ol><li>å¦‚æœå­å­—èŠ‚æµçš„<code>index</code>è½åœ¨first unacceptableä¹‹åï¼Œé‚£ä¹ˆè¿™ä¸ªsubstringåº”è¯¥è¢«ä¸¢å¼ƒã€‚</li><li>å¦‚æœå­å­—èŠ‚æµå…¨éƒ¨è½åœ¨[0, first unassembled - 1]ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªsubstringå·²ç»å†™å…¥äº†<code>ByteStream</code>ä¸­ï¼Œä¹Ÿåº”è¯¥ä¸¢å¼ƒ</li><li>é™¤æ­¤ä¹‹å¤–ï¼Œåº”è¯¥æˆªæ–­å­å­—èŠ‚æµï¼Œä½¿ä¹‹å®Œå…¨è½åœ¨[first unassembled - 1, first unacceptable - 1]ä¸­</li></ol><p>å®Œæˆäº†ä¸Šè¿°æ“ä½œåï¼Œåº”è¯¥å¤„ç†å­—èŠ‚æµåŒºé—´é‡å¤çš„é—®é¢˜ï¼Œå¿…é¡»è¦ä¿è¯<code>set&lt;Segment&gt; _buffer</code>ä¸­æ¯ä¸ª<code>Segment</code>éƒ½å¿…é¡»å½¼æ­¤ä¸é‡å¤ï¼Œå…·ä½“æ€è·¯è§ä»£ç ã€‚</p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>é¦–å…ˆå®šä¹‰<code>Segment</code>ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// stream_reassembler.hh</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Segment</span>&#123;</span><br>  public:<br>    <span class="hljs-type">size_t</span> idx_;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> data_;<br>  <br>    Segment():idx_(<span class="hljs-number">0</span>),data_(<span class="hljs-string">&quot;&quot;</span>)&#123;&#125;<br>    Segment(<span class="hljs-type">size_t</span> idx, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> data):idx_(idx), data_(data)&#123;&#125;<br><br>    <span class="hljs-type">bool</span> operator&lt;(<span class="hljs-type">const</span> Segment&amp; seg) <span class="hljs-type">const</span> &#123;<br>      <span class="hljs-keyword">return</span> this-&gt;idx_ &lt; seg.idx_;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸º<code>StreamReassembler</code>æ·»åŠ æˆå‘˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;Segment&gt; _buffer;<br><span class="hljs-type">bool</span> _eof;<br><span class="hljs-type">size_t</span> _eof_idx;<br><span class="hljs-type">size_t</span> _unassembled_bytes; <br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">handle_substring</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> &amp;data, <span class="hljs-type">const</span> <span class="hljs-type">uint64_t</span> index)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">handle_overlap</span><span class="hljs-params">(Segment&amp; seg)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">adjustment</span><span class="hljs-params">(Segment&amp; seg, <span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;Segment&gt;::iterator &amp;it)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">buffer_erase</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;Segment&gt;::iterator &amp;it)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">buffer_insert</span><span class="hljs-params">(Segment&amp; seg)</span>;<br></code></pre></td></tr></table></figure><blockquote><p> ä¸Šé¢çš„ <code>_buffer</code> åªå­˜å‚¨ä½äºä¸Šå›¾ä¸­çº¢è‰²çš„åŒºé—´<code>Segment</code>ï¼Œçº¢è‰²åŒºé—´çš„å¤§å°å°±ä¸º<code>_unassembled_bytes</code>ã€‚</p><p> <code>_eof_idx</code>å°±æ˜¯å½“æœ€åä¸€ä¸ªç»“æŸç¬¦å·çš„ç´¢å¼•ï¼Œå½“ <code>_output</code>å†™çš„å­—èŠ‚æ•°(<code>bytes_written()</code>)ç­‰äº <code>_eof_idx</code> æ—¶ï¼Œåº”è¯¥ç»“æŸè¾“å…¥ï¼Œè°ƒç”¨ <code>_output.end_input()</code>å‡½æ•°ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stream_reassembler.hh&quot;</span></span><br><br><span class="hljs-comment">// Dummy implementation of a stream reassembler.</span><br><br><span class="hljs-comment">// For Lab 1, please replace with a real implementation that passes the</span><br><span class="hljs-comment">// automated checks run by `make check_lab1`.</span><br><br><span class="hljs-comment">// You will need to add private members to the class declaration in `stream_reassembler.hh`</span><br><br>template &lt;typename... Targs&gt;<br><span class="hljs-type">void</span> <span class="hljs-title function_">DUMMY_CODE</span><span class="hljs-params">(Targs &amp;&amp;... <span class="hljs-comment">/* unused */</span>)</span> &#123;&#125;<br>using namespace <span class="hljs-built_in">std</span>;<br><br>StreamReassembler::StreamReassembler(<span class="hljs-type">const</span> <span class="hljs-type">size_t</span> capacity) : <br>    _output(capacity), <br>    _capacity(capacity), <br>    _buffer(),<br>    _eof(<span class="hljs-literal">false</span>),<br>    _eof_idx(<span class="hljs-number">0</span>),<br>    _unassembled_bytes(<span class="hljs-number">0</span>)<br>&#123;<br><br>&#125;<br><br><span class="hljs-comment">//! \details This function accepts a substring (aka a segment) of bytes,</span><br><span class="hljs-comment">//! possibly out-of-order, from the logical stream, and assembles any newly</span><br><span class="hljs-comment">//! contiguous substrings and writes them into the output stream in order.</span><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">StreamReassembler::handle_substring</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;data, <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> index)</span>&#123;<br>    <br>    <span class="hljs-keyword">auto</span> seg = Segment&#123;index, data&#125;;<br><br>    <span class="hljs-comment">// èŒƒå›´æ˜¯[read_size_ , read_size_ + _capacity - 1],ç¬¬ä¸€ä¸ªä¸å¯ä»¥è¢«å†™å…¥çš„ç´¢å¼•æ˜¯ read_size_ + _capacity</span><br>    <span class="hljs-comment">//      [index, index + data.length() - 1]</span><br><br>    <span class="hljs-comment">// segè½åœ¨å¯å†™åŒºåŸŸçš„å¤–é¢ ok</span><br>    <span class="hljs-keyword">if</span>(seg.idx_ &gt;= _output.bytes_read() + _capacity)&#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// seg.data_å³ç«¯å¦‚æœè¶…å‡ºäº†å³è¾¹ç•Œ</span><br>    <span class="hljs-keyword">if</span>(seg.idx_ &lt; _output.bytes_read() + _capacity &amp;&amp;<br>       seg.idx_ + seg.data_.length() - <span class="hljs-number">1</span> &gt;= _output.bytes_read() + _capacity)&#123;<br>        <span class="hljs-comment">// [seg.idx_, read_size_ + _capacity - 1]</span><br>        seg.data_ = seg.data_.substr(<span class="hljs-number">0</span>, _output.bytes_read() + _capacity - seg.idx_);<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœseg.data_éƒ½å·²ç»å†™å…¥äº†ByteSreamä¸­ ok</span><br>    <span class="hljs-keyword">if</span>(seg.idx_ + seg.data_.length() - <span class="hljs-number">1</span> &lt; _output.bytes_written())&#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœseg.data_æœ‰ä¸€éƒ¨åˆ†å·²è¢«å†™å…¥ï¼Œå¦ä¸€éƒ¨åˆ†æ²¡æœ‰è¢«å†™å…¥</span><br>    <span class="hljs-keyword">if</span>(seg.idx_ &lt; _output.bytes_written() &amp;&amp; <br>       seg.idx_ + seg.data_.length() - <span class="hljs-number">1</span> &gt;= _output.bytes_written())&#123;<br>        seg.data_ = seg.data_.substr(_output.bytes_written() - seg.idx_);<br>        seg.idx_ = _output.bytes_written();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(_buffer.empty())&#123;<br>        buffer_insert(seg);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    handle_overlap(seg);<br>&#125;<br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">StreamReassembler::adjustment</span><span class="hljs-params">(Segment&amp; seg, <span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;Segment&gt;::iterator&amp; it)</span>&#123;<br>    <span class="hljs-comment">// [it_l , it_r]</span><br>    <span class="hljs-type">size_t</span> it_l = it-&gt;idx_;<br>    <span class="hljs-type">size_t</span> it_r = it-&gt;idx_ + it-&gt;data_.length() - <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">// [seg_l, seg_r]</span><br>    <span class="hljs-type">size_t</span> seg_l = seg.idx_;<br>    <span class="hljs-type">size_t</span> seg_r = seg.idx_ + seg.data_.length() - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// 1. å¦‚æœ seg å…¨åŒ…å« it çš„èŒƒå›´     </span><br>    <span class="hljs-comment">// _bufferå»é™¤ it</span><br>    <span class="hljs-keyword">if</span>(seg_l &lt;= it_l &amp;&amp; seg_r &gt;= it_r)&#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 2. å¦‚æœitå…¨åŒ…å« seg çš„èŒƒå›´</span><br>    <span class="hljs-comment">// seg å˜ä¸º it, _bufferåˆ é™¤ it </span><br>    <span class="hljs-keyword">if</span>(it_l &lt;= seg_l &amp;&amp; it_r &gt;= seg_r)&#123;<br>        seg.idx_ = it_l;<br>        seg.data_ = it-&gt;data_;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 3. å¦‚å›¾ä¸‹ï¼š</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        seg:           _________</span><br><span class="hljs-comment">        it:        _______</span><br><span class="hljs-comment">    */</span><br>   <br>    <span class="hljs-keyword">if</span>(seg_l &gt;= it_l &amp;&amp; seg_r &gt; it_r)&#123;<br>        seg.data_ = it-&gt;data_ + seg.data_.substr(it-&gt;idx_ + it-&gt;data_.length() - seg.idx_);<br>        seg.idx_ = it-&gt;idx_;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br><br><br>    <span class="hljs-comment">// 4. å¦‚ä¸‹å›¾ï¼š</span><br>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">        seg:      _________</span><br><span class="hljs-comment">        it:            ________</span><br><span class="hljs-comment">    */</span><br>    <br>    <span class="hljs-keyword">if</span>(it_l &gt; seg_l &amp;&amp; it_r &gt;= seg_r)&#123;<br>        seg.data_ = seg.data_.substr(<span class="hljs-number">0</span>, it-&gt;idx_ - seg.idx_) + it-&gt;data_;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">StreamReassembler::handle_overlap</span><span class="hljs-params">(Segment&amp; seg)</span>&#123;<br>    <span class="hljs-comment">// ä¿è¯æ’å…¥çš„å’ŒåŸæœ¬å­˜åœ¨çš„æ²¡æœ‰é‡å éƒ¨åˆ†</span><br>    <span class="hljs-keyword">auto</span> it = _buffer.begin();<br>    <span class="hljs-keyword">for</span>(; it != _buffer.end();)&#123;<br>        <span class="hljs-type">size_t</span> it_l = it-&gt;idx_;<br>        <span class="hljs-type">size_t</span> it_r = it-&gt;idx_ + it-&gt;data_.length() - <span class="hljs-number">1</span>;<br><br>        <span class="hljs-type">size_t</span> seg_l = seg.idx_;<br>        <span class="hljs-type">size_t</span> seg_r = seg.idx_ + seg.data_.length() - <span class="hljs-number">1</span>;<br><br>        <span class="hljs-comment">// ä¸¤æ¡çº¿æ®µæœ‰é‡å </span><br>        <span class="hljs-keyword">if</span>((it_l &gt;= seg_l &amp;&amp; it_l &lt;= seg_r) || (seg_l &gt;= it_l &amp;&amp; seg_l &lt;= it_r))&#123;<br>            adjustment(seg, it);<br>            buffer_erase(it++);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            it++;<br>        &#125;<br>    &#125;<br><br>    buffer_insert(seg);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">StreamReassembler::buffer_erase</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;Segment&gt;::iterator&amp; it)</span>&#123;<br>    <span class="hljs-comment">// å¦‚æœåˆ é™¤äº†ï¼Œé‚£ä¹ˆ _unassembled_bytes å°±è¦å‡</span><br>    _unassembled_bytes -= it-&gt;data_.length();<br>    _buffer.erase(it);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">StreamReassembler::buffer_insert</span><span class="hljs-params">(Segment&amp; seg)</span>&#123;<br>    _unassembled_bytes += seg.data_.length();<br>    _buffer.insert(seg);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">StreamReassembler::push_substring</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;data, <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> index, <span class="hljs-type">const</span> <span class="hljs-type">bool</span> eof)</span> &#123;<br><br>    <span class="hljs-keyword">if</span>(!data.empty())&#123;<br>        handle_substring(data, index);<br>    &#125;<br><br>    <span class="hljs-comment">// æ£€æŸ¥ _buffer ä¸­æ˜¯å¦æœ‰è¿ç»­çš„å¯å†™å…¥ ByteStream çš„éƒ¨åˆ†</span><br>    <span class="hljs-comment">// ç¬¬ä¸€ä¸ªå¯ä»¥å†™å…¥çš„å­—èŠ‚æ˜¯ written_size_</span><br>    <span class="hljs-keyword">while</span>(!_buffer.empty() &amp;&amp; _buffer.begin()-&gt;idx_ == _output.bytes_written())&#123;<br>        <span class="hljs-keyword">auto</span> it = _buffer.begin();<br>        _output.write(it-&gt;data_);<br>        buffer_erase(it);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(eof)&#123;<br>        _eof = <span class="hljs-literal">true</span>;<br>        _eof_idx = index + data.length();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(_eof &amp;&amp; _output.bytes_written() == _eof_idx)&#123;<br>        _output.end_input();<br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">StreamReassembler::unassembled_bytes</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> &#123; <br>    <span class="hljs-keyword">return</span> _unassembled_bytes;<br>&#125;<br><br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">StreamReassembler::empty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> &#123; <br>    <span class="hljs-keyword">return</span> _buffer.empty();<br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºç½‘ç»œ</category>
      
      <category>CS144</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
      <tag>CS144</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CS144-lab0</title>
    <link href="/2023/09/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/CS144/lab0/"/>
    <url>/2023/09/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/CS144/lab0/</url>
    
    <content type="html"><![CDATA[<h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1.ç®€ä»‹"></a>1.ç®€ä»‹</h2><p>è·å–å®éªŒæŒ‡å¯¼ä¹¦ï¼š<a href="https://vixbob.github.io/cs144-web-page/assignments/lab0.pdf">Lab Checkpoint 0: networking warmup</a><br>ä¸ªäººCS144å®éªŒåœ°å€ï¼š<a href="https://github.com/BlackGhostLzc/CS144.git">github</a></p><h2 id="2-telnetæ‰‹åŠ¨è®¿é—®ç½‘é¡µ"><a href="#2-telnetæ‰‹åŠ¨è®¿é—®ç½‘é¡µ" class="headerlink" title="2.telnetæ‰‹åŠ¨è®¿é—®ç½‘é¡µ"></a>2.telnetæ‰‹åŠ¨è®¿é—®ç½‘é¡µ</h2><p>Telnetåè®®æ˜¯TCP&#x2F;IPåè®®æ—ä¸­çš„ä¸€å‘˜ï¼Œæ˜¯Internetè¿œç¨‹ç™»é™†æœåŠ¡çš„æ ‡å‡†åè®®å’Œä¸»è¦æ–¹å¼ã€‚å®ƒä¸ºç”¨æˆ·æä¾›äº†åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šå®Œæˆè¿œç¨‹ä¸»æœºå·¥ä½œçš„ èƒ½åŠ›ã€‚åœ¨ç»ˆç«¯ä½¿ç”¨è€…çš„ç”µè„‘ä¸Šä½¿ç”¨<code>telnet</code>ç¨‹åºï¼Œç”¨å®ƒè¿æ¥åˆ°æœåŠ¡å™¨ã€‚ç»ˆç«¯ä½¿ç”¨è€…å¯ä»¥åœ¨<code>telnet</code>ç¨‹åºä¸­è¾“å…¥å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤ä¼šåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œå°±åƒç›´æ¥åœ¨æœåŠ¡å™¨çš„æ§åˆ¶å°ä¸Šè¾“å…¥ä¸€æ ·ã€‚</p><p>ä½¿ç”¨ <code>telnet cs144.keithw.org http</code>å‘½ä»¤ä»¥è¿æ¥è¿œç¨‹ç½‘é¡µæœåŠ¡å™¨ï¼Œä¹‹ååœ¨ç»ˆç«¯é”®å…¥ä»¥ä¸‹å†…å®¹:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/hello</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>cs144.keithw.org<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br></code></pre></td></tr></table></figure><p>ä¹‹åçœ‹åˆ°è¿œç¨‹æœåŠ¡å™¨ä¼šè¿”å›ç½‘é¡µçš„å†…å®¹å¹¶å±•ç¤ºå†ç»ˆç«¯ä¸Šã€‚</p><h2 id="3-å®ç°webget-cc"><a href="#3-å®ç°webget-cc" class="headerlink" title="3. å®ç°webget.cc"></a>3. å®ç°webget.cc</h2><p>å®éªŒæŒ‡å¯¼ä¹¦ä¸Šä¹Ÿæœ‰æç¤ºï¼Œéœ€è¦å€ŸåŠ©<code>libsponge</code>åº“ä¸­çš„<code>TCPSocket</code>å’Œ<code>Address</code>ä¸¤ä¸ªç±»æ¥å®ç°ã€‚</p><p>æ³¨æ„ï¼š</p><ol><li>HTTPå¤´éƒ¨æ¯ä¸€è¡Œéƒ½ä»¥<code>\r\n</code>ç»“å°¾ï¼Œè€Œä¸æ˜¯<code>\n</code></li><li>éœ€è¦åŒ…å«<code>Connection: close</code></li><li>å€ŸåŠ©<code>eof</code>å‡½æ•°æ¥æ”¶æœåŠ¡å™¨çš„å‘é€æ•°æ®</li></ol><p>å…¶ä½™éƒ¨åˆ†æŒ‰ç…§ä¸Šé¢çš„<code>telnet</code>å‘½ä»¤ä»¿å†™å³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">get_URL</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;host, <span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;path)</span> &#123;<br>    <span class="hljs-comment">// Your code here.</span><br>    <br>    Address <span class="hljs-title function_">addr</span><span class="hljs-params">(host, <span class="hljs-string">&quot;http&quot;</span>)</span>;<br>    TCPSocket http_socket;<br>    <br>    http_socket.connect(addr);<br>    http_socket.write(<span class="hljs-string">&quot;GET &quot;</span> + path + <span class="hljs-string">&quot; HTTP/1.1\r\n&quot;</span>);<br>    http_socket.write(<span class="hljs-string">&quot;Host: &quot;</span> + host + <span class="hljs-string">&quot;\r\n&quot;</span>);<br>    http_socket.write(<span class="hljs-string">&quot;Connection: close\r\n&quot;</span>);<br>    http_socket.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br><br>    <span class="hljs-keyword">while</span>(!http_socket.eof())&#123;<br>        <span class="hljs-built_in">cout</span>&lt;&lt;http_socket.read();<br>    &#125;<br><br>    http_socket.close();<br>    <span class="hljs-comment">// You will need to connect to the &quot;http&quot; service on</span><br>    <span class="hljs-comment">// the computer whose name is in the &quot;host&quot; string,</span><br>    <span class="hljs-comment">// then request the URL path given in the &quot;path&quot; string.</span><br><br>    <span class="hljs-comment">// Then you&#x27;ll need to print out everything the server sends back,</span><br>    <span class="hljs-comment">// (not just one call to read() -- everything) until you reach</span><br>    <span class="hljs-comment">// the &quot;eof&quot; (end of file).</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å®ç°ByteStream"><a href="#å®ç°ByteStream" class="headerlink" title="å®ç°ByteStream"></a>å®ç°ByteStream</h2><p>è¦æ±‚å®ç°ä¸€ä¸ªåœ¨å†…å­˜ä¸­çš„æœ‰åºå¯é å­—èŠ‚æµã€‚</p><p>æ³¨æ„ï¼š</p><ul><li>å­—èŠ‚æµå¯ä»¥ä»å†™å…¥ç«¯å†™å…¥ï¼Œå¹¶ä»¥ç›¸åŒçš„é¡ºåºï¼Œä»è¯»å–ç«¯è¯»å–</li><li>å­—èŠ‚æµæ˜¯æœ‰é™çš„ï¼Œå†™å…¥è€…å¯ä»¥ç»ˆæ­¢å†™å…¥</li><li>ç¼“å†²åŒºæ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œç¼“å†²åŒºæ»¡çš„æ—¶å€™ï¼Œå†™å…¥è€…ä¸å…è®¸å†å†™å…¥</li><li>ByteStreamæµçš„å­—èŠ‚å¯èƒ½æ¯”ç¼“å†²åŒºè¦å¤§çš„å¤š</li><li>å•çº¿ç¨‹ç¯å¢ƒï¼Œä¸è€ƒè™‘ç«æ€æ¡ä»¶</li></ul><p>æˆ‘ä»¬è€ƒè™‘ç”¨<code>deque</code>æ•°æ®ç»“æ„æ¥å®ç°è¿™ä¸ªå­—èŠ‚æµã€‚<br>éœ€è¦ä¸ºByteStreamæ·»åŠ æ•°æ®æˆå‘˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// byte_stream.hhæ–‡ä»¶</span><br><span class="hljs-built_in">std</span>::<span class="hljs-built_in">deque</span>&lt;<span class="hljs-type">char</span>&gt; dq_;<br><span class="hljs-type">size_t</span> capacity_;<br><span class="hljs-type">size_t</span> read_size_;     <span class="hljs-comment">//æ€»å…±è¯»å–çš„å­—èŠ‚æ•°</span><br><span class="hljs-type">size_t</span> write_size_;    <span class="hljs-comment">//æ€»å…±å†™å…¥çš„å­—èŠ‚æ•°</span><br><span class="hljs-type">bool</span> end_input_;       <span class="hljs-comment">//èƒ½å¦å†å†™</span><br></code></pre></td></tr></table></figure><p>å…·ä½“å‡½æ•°ä¹Ÿä¸éš¾å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// byte_stream.ccæ–‡ä»¶</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;byte_stream.hh&quot;</span></span><br><br><span class="hljs-comment">// Dummy implementation of a flow-controlled in-memory byte stream.</span><br><br><span class="hljs-comment">// For Lab 0, please replace with a real implementation that passes the</span><br><span class="hljs-comment">// automated checks run by `make check_lab0`.</span><br><br><span class="hljs-comment">// You will need to add private members to the class declaration in `byte_stream.hh`</span><br><br>template &lt;typename... Targs&gt;<br><span class="hljs-type">void</span> <span class="hljs-title function_">DUMMY_CODE</span><span class="hljs-params">(Targs &amp;&amp;... <span class="hljs-comment">/* unused */</span>)</span> &#123;&#125;<br><br>using namespace <span class="hljs-built_in">std</span>;<br><br>ByteStream::ByteStream(<span class="hljs-type">const</span> <span class="hljs-type">size_t</span> capacity):dq_(), capacity_(capacity), read_size_(<span class="hljs-number">0</span>), write_size_(<span class="hljs-number">0</span>),end_input_(<span class="hljs-number">0</span>) &#123; <br>    <br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">ByteStream::write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;data)</span> &#123;<br>    <span class="hljs-keyword">if</span>(end_input_)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// æŠŠ data å†™è¿› dq_ä¸­</span><br>    <span class="hljs-type">size_t</span> write_sz = <span class="hljs-built_in">std</span>::min(data.size(), capacity_ - dq_.size());<br>    write_size_ += write_sz;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; write_sz; i++)&#123;<br>        dq_.push_back(data[i]);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> write_sz;<br>&#125;<br><br><span class="hljs-comment">//! \param[in] len bytes will be copied from the output side of the buffer</span><br><span class="hljs-built_in">string</span> <span class="hljs-title function_">ByteStream::peek_output</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">size_t</span> len)</span> <span class="hljs-type">const</span> &#123;<br>    <span class="hljs-comment">// dq_ä¸­çš„å†…å®¹ä¸ä¼šè¢«æ¸…é™¤</span><br>    <span class="hljs-type">size_t</span> pop_size = min(len, dq_.size());<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">string</span>(dq_.begin(), dq_.begin() + pop_size);<br>&#125;<br><br><span class="hljs-comment">//! \param[in] len bytes will be removed from the output side of the buffer</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">ByteStream::pop_output</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">size_t</span> len)</span> &#123; <br>    <span class="hljs-comment">//dq_ä¸­çš„å†…å®¹ä¼šè¢«æ¸…é™¤</span><br>    <span class="hljs-type">size_t</span> pop_size = min(len, dq_.size());<br>    read_size_ += pop_size;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; pop_size; i++)&#123;<br>        dq_.pop_front();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//! Read (i.e., copy and then pop) the next &quot;len&quot; bytes of the stream</span><br><span class="hljs-comment">//! \param[in] len bytes will be popped and returned</span><br><span class="hljs-comment">//! \returns a string</span><br><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title function_">ByteStream::read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">size_t</span> len)</span> &#123;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> ret = peek_output(len);<br>    pop_output(len);<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">ByteStream::end_input</span><span class="hljs-params">()</span> &#123;<br>    end_input_ = <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">ByteStream::input_ended</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> &#123; <br>    <span class="hljs-keyword">return</span> end_input_;    <br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">ByteStream::buffer_size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> &#123; <br>    <span class="hljs-keyword">return</span> dq_.size();<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">ByteStream::buffer_empty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> &#123; <br>    <span class="hljs-keyword">return</span> dq_.size() == <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">ByteStream::eof</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> &#123; <br>    <span class="hljs-keyword">return</span> dq_.size() == <span class="hljs-number">0</span> &amp;&amp; input_ended();    <br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">ByteStream::bytes_written</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> &#123; <br>    <span class="hljs-keyword">return</span> write_size_;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">ByteStream::bytes_read</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> &#123; <br>    <span class="hljs-keyword">return</span> read_size_;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">ByteStream::remaining_capacity</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> &#123; <br>    <span class="hljs-keyword">return</span> capacity_ - dq_.size();    <br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºç½‘ç»œ</category>
      
      <category>CS144</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
      <tag>CS144</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Tinyhttpd</title>
    <link href="/2023/09/08/%E9%A1%B9%E7%9B%AE/Tinyhttpd/Tinyhttpd/"/>
    <url>/2023/09/08/%E9%A1%B9%E7%9B%AE/Tinyhttpd/Tinyhttpd/</url>
    
    <content type="html"><![CDATA[<h2 id="é¡¹ç›®ä»‹ç»"><a href="#é¡¹ç›®ä»‹ç»" class="headerlink" title="é¡¹ç›®ä»‹ç»"></a>é¡¹ç›®ä»‹ç»</h2><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è½»é‡HTTPæœåŠ¡å™¨ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬ç†è§£æœåŠ¡å™¨å·¥ä½œçš„æµç¨‹ä¸æœ¬è´¨ã€‚<br><a href="https://github.com/BlackGhostLzc/Tinyhttpd.git">æˆ‘çš„GitHubåœ°å€</a>ã€‚<br>å¯¹ä»£ç æˆ‘åšäº†ä¸€ç‚¹æ›´æ”¹ï¼Œä¾‹å¦‚å†æœåŠ¡å™¨è¿›ç¨‹ä¸­æ‰“å°ä¸€äº›æŠ¥æ–‡çš„å†…å®¹ä»¥åŠåšäº†æ¯”è¾ƒè¯¦ç»†çš„æ³¨é‡Šï¼Œè¿˜æœ‰æ›´æ”¹äº†<code>simpleclient.c</code>æ–‡ä»¶ä½¿å¾—è¿™ä¸ªç¨‹åºä¹Ÿå¯ä»¥ä¸<code>http</code>è¿›è¡Œé<code>GET</code>é<code>POST</code>çš„é€šä¿¡ã€‚</p><h2 id="ç¨‹åºè¿è¡Œ"><a href="#ç¨‹åºè¿è¡Œ" class="headerlink" title="ç¨‹åºè¿è¡Œ"></a>ç¨‹åºè¿è¡Œ</h2><p>ç¼–è¯‘å¥½é¡¹ç›®åï¼Œé¦–å…ˆè¿è¡Œ<code>http</code>ç¨‹åºï¼Œ<code>http.c</code>æ–‡ä»¶ä¸­ä½æœåŠ¡å™¨æŒ‡å®šäº†ä¸€ä¸ªç«¯å£ï¼Œç„¶åå¯ä»¥æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥<code>localhost:ç«¯å£å·</code>æˆ–è€…<code>127.0.0.1:ç«¯å£å·</code>å°±å¯ä»¥è¿æ¥åˆ°æœåŠ¡å™¨ã€‚<br>åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ä¸€ä¸ªé¢œè‰²ï¼Œç‚¹å‡»æäº¤ï¼Œå¾—åˆ°ä¸‹é¢çš„æ•ˆæœå›¾ã€‚<br><img src="https://pic4.zhimg.com/80/v2-c0f3f89359dc034bf5597b83caa42243_1440w.webp" alt="img" style="zoom:50%;" /></p><h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><h3 id="HTTPè¯·æ±‚"><a href="#HTTPè¯·æ±‚" class="headerlink" title="HTTPè¯·æ±‚"></a>HTTPè¯·æ±‚</h3><p>å½“æˆ‘ä»¬åœ¨æµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰è¾“å…¥ä¸€ä¸ªç½‘å€ï¼Œæµè§ˆå™¨å°±ä¼šå‘æœåŠ¡å™¨å‘å‡ºä¸€ä¸ªHTTPæŠ¥æ–‡ã€‚<br>è¿™é‡Œå¹¶ä¸è®²HTTPæŠ¥æ–‡çš„æ ¼å¼ï¼Œåªä»‹ç»<code>Tinyhttpd</code>ç”¨åˆ°çš„çš„è¯·æ±‚æ–¹æ³•ï¼š</p><ol><li><code>GET</code>: è¯·æ±‚æŒ‡å®šçš„é¡µé¢ä¿¡æ¯ï¼Œå¹¶è¿”å›å®ä½“ä¸»ä½“ã€‚</li><li><code>POST</code>:å‘æŒ‡å®šèµ„æºæäº¤æ•°æ®è¿›è¡Œå¤„ç†è¯·æ±‚ï¼ˆä¾‹å¦‚æäº¤è¡¨å•æˆ–è€…ä¸Šä¼ æ–‡ä»¶ï¼‰ã€‚æ•°æ®è¢«åŒ…å«åœ¨è¯·æ±‚ä½“ä¸­ã€‚<code>POST</code> è¯·æ±‚å¯èƒ½ä¼šå¯¼è‡´æ–°çš„èµ„æºçš„å»ºç«‹å’Œ&#x2F;æˆ–å·²æœ‰èµ„æºçš„ä¿®æ”¹ã€‚</li></ol><h3 id="CGIè„šæœ¬"><a href="#CGIè„šæœ¬" class="headerlink" title="CGIè„šæœ¬"></a>CGIè„šæœ¬</h3><p>CGIä¸æ˜¯ä¸€é—¨ç¼–ç¨‹è¯­è¨€ã€‚å®ƒæ˜¯ç½‘é¡µçš„è¡¨å•å’Œä½ å†™çš„ç¨‹åºä¹‹é—´é€šä¿¡çš„ä¸€ç§åè®®ã€‚<br>å…¸å‹çš„CGIè„šæœ¬åšäº†å¦‚ä¸‹çš„äº‹æƒ…ï¼š</p><ol><li>è¯»å–ç”¨æˆ·æäº¤è¡¨å•çš„ä¿¡æ¯ã€‚</li><li>å¤„ç†è¿™äº›ä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯å®ç°ä¸šåŠ¡ï¼‰ã€‚</li><li>è¾“å‡ºï¼Œè¿”å›htmlå“åº”ï¼ˆè¿”å›å¤„ç†å®Œçš„æ•°æ®ï¼‰<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#!/usr/bin/perl -Tw</span><br><br><span class="hljs-keyword">use</span> strict;<br><span class="hljs-keyword">use</span> CGI;<br><br><span class="hljs-keyword">my</span>($cgi) = new CGI;<br><br><span class="hljs-keyword">print</span> $cgi-&gt;header;<br><span class="hljs-keyword">my</span>($color) = <span class="hljs-string">&quot;blue&quot;</span>;<br>$color = $cgi-&gt;param(<span class="hljs-string">&#x27;color&#x27;</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">defined</span> $cgi-&gt;param(<span class="hljs-string">&#x27;color&#x27;</span>);<br><br><span class="hljs-keyword">print</span> $cgi-&gt;start_html(<span class="hljs-string">-title =&gt;</span> <span class="hljs-keyword">uc</span>($color),<br>                       <span class="hljs-string">-BGCOLOR =&gt;</span> $color);<br><span class="hljs-keyword">print</span> $cgi-&gt;h1(<span class="hljs-string">&quot;This is $color&quot;</span>);<br><span class="hljs-keyword">print</span> $cgi-&gt;end_html;<br></code></pre></td></tr></table></figure>ä¸Šé¢è¿™ä¸ªCGIè„šæœ¬å°±ç”Ÿæˆäº†ä¸€ä¸ªhtmlæ ¼å¼çš„æ–‡ä»¶ï¼ŒæœåŠ¡å™¨è¿›ç¨‹åˆ›å»ºçš„å­è¿›ç¨‹ä¼šè¿è¡Œè¿™ä¸ªè„šæœ¬ï¼Œé€šè¿‡ç®¡é“ï¼ŒæœåŠ¡å™¨è¿›ç¨‹å‘å­è¿›ç¨‹ä¼ å…¥æ‰§è¡Œè¿™ä¸ªè„šæœ¬éœ€è¦çš„ä¸€äº›å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æäº¤çš„è¡¨å•ï¼Œè€Œå­è¿›ç¨‹ä¹Ÿé€šè¿‡ç®¡é“æŠŠè„šæœ¬æ‰§è¡Œå†…å®¹ä¼ ç»™æœåŠ¡å™¨è¿›ç¨‹ï¼Œå†ç”±æœåŠ¡å™¨å‘é€ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ ·å®ç°äº†åŠ¨æ€è§£æã€‚</li></ol><h2 id="ä»£ç è®²è§£"><a href="#ä»£ç è®²è§£" class="headerlink" title="ä»£ç è®²è§£"></a>ä»£ç è®²è§£</h2><p><code>Tinyhttpd</code>æœ‰ä¸‹é¢è¿™å‡ ä¸ªå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">accept_request</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<span class="hljs-comment">//å¤„ç†ä»å¥—æ¥å­—ä¸Šç›‘å¬åˆ°çš„ä¸€ä¸ª HTTP è¯·æ±‚</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bad_request</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<span class="hljs-comment">//è¿”å›ç»™å®¢æˆ·ç«¯è¿™æ˜¯ä¸ªé”™è¯¯è¯·æ±‚ï¼Œ400å“åº”ç </span><br><span class="hljs-type">void</span> <span class="hljs-title function_">cat</span><span class="hljs-params">(<span class="hljs-type">int</span>, FILE *)</span>;<span class="hljs-comment">//è¯»å–æœåŠ¡å™¨ä¸ŠæŸä¸ªæ–‡ä»¶å†™åˆ° socket å¥—æ¥å­—</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">cannot_execute</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<span class="hljs-comment">//å¤„ç†å‘ç”Ÿåœ¨æ‰§è¡Œ cgi ç¨‹åºæ—¶å‡ºç°çš„é”™è¯¯</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">error_die</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)</span>;<span class="hljs-comment">//æŠŠé”™è¯¯ä¿¡æ¯å†™åˆ° perror </span><br><span class="hljs-type">void</span> <span class="hljs-title function_">execute_cgi</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *)</span>;<span class="hljs-comment">//è¿è¡Œcgiè„šæœ¬ï¼Œè¿™ä¸ªéå¸¸é‡è¦ï¼Œæ¶‰åŠåŠ¨æ€è§£æ</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_line</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">char</span> *, <span class="hljs-type">int</span>)</span>;<span class="hljs-comment">//è¯»å–ä¸€è¡ŒHTTPæŠ¥æ–‡</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">headers</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *)</span>;<span class="hljs-comment">//è¿”å›HTTPå“åº”å¤´</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">not_found</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<span class="hljs-comment">//è¿”å›æ‰¾ä¸åˆ°è¯·æ±‚æ–‡ä»¶</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">serve_file</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *)</span>;<span class="hljs-comment">//è°ƒç”¨ cat æŠŠæœåŠ¡å™¨æ–‡ä»¶å†…å®¹è¿”å›ç»™æµè§ˆå™¨ã€‚</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">startup</span><span class="hljs-params">(u_short *)</span>;<span class="hljs-comment">//å¼€å¯httpæœåŠ¡ï¼ŒåŒ…æ‹¬ç»‘å®šç«¯å£ï¼Œç›‘å¬ï¼Œå¼€å¯çº¿ç¨‹å¤„ç†é“¾æ¥</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">unimplemented</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<span class="hljs-comment">//è¿”å›ç»™æµè§ˆå™¨è¡¨æ˜æ”¶åˆ°çš„ HTTP è¯·æ±‚æ‰€ç”¨çš„ method ä¸è¢«æ”¯æŒã€‚</span><br></code></pre></td></tr></table></figure><h3 id="accept-requestå‡½æ•°"><a href="#accept-requestå‡½æ•°" class="headerlink" title="accept_requestå‡½æ•°"></a>accept_requestå‡½æ•°</h3><p>ç›¸å…³ä»£ç é€»è¾‘åœ¨æ³¨é‡Šä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">accept_request</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-type">int</span> client = (<span class="hljs-type">intptr_t</span>)arg;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];<br>    <span class="hljs-type">size_t</span> numchars;<br>    <span class="hljs-type">char</span> method[<span class="hljs-number">255</span>];<br>    <span class="hljs-type">char</span> url[<span class="hljs-number">255</span>];<br>    <span class="hljs-type">char</span> path[<span class="hljs-number">512</span>];<br>    <span class="hljs-type">size_t</span> i, j;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br>    <span class="hljs-type">int</span> cgi = <span class="hljs-number">0</span>;      <span class="hljs-comment">/* becomes true if server decides this is a CGI</span><br><span class="hljs-comment">                       * program */</span><br>    <span class="hljs-type">char</span> *query_string = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">// è·å–è¯·æ±‚æŠ¥æ–‡çš„ç¬¬ä¸€è¡Œ</span><br>    numchars = get_line(client, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>    i = <span class="hljs-number">0</span>; j = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;First line: %s&quot;</span>, buf);<br><br>    <span class="hljs-comment">// è·å–è¯·æ±‚æŠ¥æ–‡çš„æ–¹æ³•ï¼Œæ˜¯GETè¿˜æ˜¯POSTæ–¹æ³•</span><br>    <span class="hljs-keyword">while</span> (!ISspace(buf[i]) &amp;&amp; (i &lt; <span class="hljs-keyword">sizeof</span>(method) - <span class="hljs-number">1</span>))<br>    &#123;<br>        method[i] = buf[i];<br>        i++;<br>    &#125;<br>    j=i;<br>    method[i] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>    <span class="hljs-comment">// å¦‚æœä¸æ˜¯è¿™ä¸¤ç§æ–¹æ³•ï¼Œé‚£å°±åªèƒ½æ˜¯simpleclientç¨‹åº</span><br>    <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;GET&quot;</span>) &amp;&amp; strcasecmp(method, <span class="hljs-string">&quot;POST&quot;</span>))<br>    &#123;<br>        buf[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;#&#x27;</span>;<br>        <span class="hljs-comment">// å‘simpleclientå‘é€ä¸€ä¸ªå­—ç¬¦</span><br>        write(client, buf, <span class="hljs-number">1</span>);<br>        unimplemented(client);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœæ˜¯POSTæ–¹æ³•ï¼Œé‚£ä¹ˆéœ€è¦æ‰§è¡Œcgiè„šæœ¬</span><br>    <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;POST&quot;</span>) == <span class="hljs-number">0</span>)<br>        cgi = <span class="hljs-number">1</span>;<br><br><br>    i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (ISspace(buf[j]) &amp;&amp; (j &lt; numchars))<br>        j++;<br>    <br>    <span class="hljs-comment">// è·å–url</span><br>    <span class="hljs-keyword">while</span> (!ISspace(buf[j]) &amp;&amp; (i &lt; <span class="hljs-keyword">sizeof</span>(url) - <span class="hljs-number">1</span>) &amp;&amp; (j &lt; numchars))<br>    &#123;<br>        url[i] = buf[j];<br>        i++; j++;<br>    &#125;<br>    url[i] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>    <span class="hljs-comment">// å¦‚æœæ˜¯GETæ–¹æ³•ï¼Œè¿™é‡Œçš„urlæ˜¯  / </span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;url: %s\n&quot;</span>, url);<br><br><span class="hljs-comment">// urlè¿˜éœ€è¦è¿›è¡Œæ‹¼æ¥æ“ä½œï¼ŒæŠŠhtdocsç›®å½•ä¸‹çš„index.htmlå‘é€ç»™å®¢æˆ·ç«¯</span><br><br>    <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;GET&quot;</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-comment">// å¦‚æœæœ‰æŸ¥è¯¢å‚æ•°</span><br>        query_string = url;<br>        <span class="hljs-keyword">while</span> ((*query_string != <span class="hljs-string">&#x27;?&#x27;</span>) &amp;&amp; (*query_string != <span class="hljs-string">&#x27;\0&#x27;</span>))<br>            query_string++;<br>        <span class="hljs-keyword">if</span> (*query_string == <span class="hljs-string">&#x27;?&#x27;</span>)<br>        &#123;<br>            cgi = <span class="hljs-number">1</span>;<br>            *query_string = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            query_string++;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">sprintf</span>(path, <span class="hljs-string">&quot;htdocs%s&quot;</span>, url);<br>    <span class="hljs-comment">// å¦‚æœæ˜¯GETæ–¹æ³•ï¼š  path:htdocs/</span><br>    <span class="hljs-comment">// å¦‚æœæ˜¯POSTæ–¹æ³•ï¼š path:htdocs/color.cgi</span><br><br><br>    <span class="hljs-keyword">if</span> (path[<span class="hljs-built_in">strlen</span>(path) - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;/&#x27;</span>)<br>        <span class="hljs-built_in">strcat</span>(path, <span class="hljs-string">&quot;index.html&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;path: %s\n&quot;</span>, path);<br>    <span class="hljs-comment">// å¦‚æœæ˜¯GETæ–¹æ³•ï¼š    path: htdocs/index.html</span><br>    <span class="hljs-comment">// å¦‚æœæ˜¯POSTæ–¹æ³•ï¼š   path: htdocs/color.cgi</span><br><br>    <span class="hljs-comment">// æŠŠpathæ–‡ä»¶ä¸stå…³è”èµ·æ¥</span><br>    <span class="hljs-keyword">if</span> (stat(path, &amp;st) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-keyword">while</span> ((numchars &gt; <span class="hljs-number">0</span>) &amp;&amp; <span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;\n&quot;</span>, buf))  <span class="hljs-comment">/* read &amp; discard headers */</span><br>            numchars = get_line(client, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>        not_found(client);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-comment">// å¦‚æœè·¯å¾„æ˜¯ä¸ªç›®å½•ï¼Œé‚£å°±å°†ä¸»é¡µè¿›è¡Œæ˜¾ç¤º</span><br>        <span class="hljs-keyword">if</span> ((st.st_mode &amp; S_IFMT) == S_IFDIR)<br>            <span class="hljs-built_in">strcat</span>(path, <span class="hljs-string">&quot;/index.html&quot;</span>);<br>        <span class="hljs-keyword">if</span> ((st.st_mode &amp; S_IXUSR) ||<br>                (st.st_mode &amp; S_IXGRP) ||<br>                (st.st_mode &amp; S_IXOTH)    )<br>            cgi = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (!cgi)<br>            <span class="hljs-comment">// ä¸ºå®¢æˆ·ç«¯å‘é€é™æ€ç½‘é¡µ</span><br>            serve_file(client, path);<br>        <span class="hljs-keyword">else</span><br>            execute_cgi(client, path, method, query_string);<br>    &#125;<br><br>    close(client);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="execute-cgiå‡½æ•°"><a href="#execute-cgiå‡½æ•°" class="headerlink" title="execute_cgiå‡½æ•°"></a>execute_cgiå‡½æ•°</h3><p>è¿™ä¸ªå‡½æ•°æ˜¯è¿›è¡ŒåŠ¨æ€è§£æçš„æ ¸å¿ƒå‡½æ•°ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">execute_cgi</span><span class="hljs-params">(<span class="hljs-type">int</span> client, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *path,</span><br><span class="hljs-params">        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *method, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *query_string)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Get into execute_cgi\n&quot;</span>);<br><br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];<br>    <span class="hljs-type">int</span> cgi_output[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> cgi_input[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-type">int</span> numchars = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> content_length = <span class="hljs-number">-1</span>;<br><br>    buf[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;A&#x27;</span>; buf[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>    <span class="hljs-comment">// å¦‚æœæ˜¯GETè¯·æ±‚ï¼Œå°±ä¸æ–­çš„è¯»å–å¹¶ä¸¢å¼ƒå¤´ä¿¡æ¯</span><br>    <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;GET&quot;</span>) == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">while</span> ((numchars &gt; <span class="hljs-number">0</span>) &amp;&amp; <span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;\n&quot;</span>, buf))  <span class="hljs-comment">/* read &amp; discard headers */</span><br>            numchars = get_line(client, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;POST&quot;</span>) == <span class="hljs-number">0</span>) <span class="hljs-comment">/*POST*/</span><br>    &#123;<br>        <span class="hljs-comment">// POSTè¯·æ±‚</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is a POST method\n&quot;</span>); <br>        numchars = get_line(client, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>        <br>         <span class="hljs-comment">/*</span><br><span class="hljs-comment">        ....</span><br><span class="hljs-comment">        Content-Length: 9</span><br><span class="hljs-comment">        ....</span><br><span class="hljs-comment">        ç©ºä¸€è¡Œ \n</span><br><span class="hljs-comment">        å†…å®¹(color=red)</span><br><span class="hljs-comment">        */</span><br>        <br>        <span class="hljs-keyword">while</span> ((numchars &gt; <span class="hljs-number">0</span>) &amp;&amp; <span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;\n&quot;</span>, buf))<br>        &#123;<br>            buf[<span class="hljs-number">15</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            <span class="hljs-comment">// å¾—åˆ°æ¶ˆæ¯ä½“çš„é•¿åº¦æ˜¯å¤šå°‘</span><br>            <span class="hljs-keyword">if</span> (strcasecmp(buf, <span class="hljs-string">&quot;Content-Length:&quot;</span>) == <span class="hljs-number">0</span>)<br>                content_length = atoi(&amp;(buf[<span class="hljs-number">16</span>]));<br>            numchars = get_line(client, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, buf);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (content_length == <span class="hljs-number">-1</span>) &#123;<br>            bad_request(client);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><span class="hljs-comment">/*HEAD or other*/</span><br>    &#123;<br>    &#125;<br><br><span class="hljs-comment">// åˆå§‹åŒ–ç®¡é“</span><br>    <span class="hljs-keyword">if</span> (pipe(cgi_output) &lt; <span class="hljs-number">0</span>) &#123;<br>        cannot_execute(client);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (pipe(cgi_input) &lt; <span class="hljs-number">0</span>) &#123;<br>        cannot_execute(client);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ( (pid = fork()) &lt; <span class="hljs-number">0</span> ) &#123;<br>        cannot_execute(client);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>);<br>    send(client, buf, <span class="hljs-built_in">strlen</span>(buf), <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)  <span class="hljs-comment">/* child: CGI script */</span><br>    &#123;<br>        <span class="hljs-comment">// å­è¿›ç¨‹æ¥æ‰§è¡Œ cgi è„šæœ¬</span><br>        <span class="hljs-type">char</span> meth_env[<span class="hljs-number">255</span>];<br>        <span class="hljs-type">char</span> query_env[<span class="hljs-number">255</span>];<br>        <span class="hljs-type">char</span> length_env[<span class="hljs-number">255</span>];<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;å­è¿›ç¨‹æ‰§è¡Œ%sç¨‹åº\n&quot;</span>, path);<br><br><span class="hljs-comment">// æ“ä½œæ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿å¾—æ‰§è¡Œcgiè„šæœ¬çš„æ—¶å€™ï¼Œprintæ‰“å°ç›´æ¥äº¤ç»™ç®¡é“çš„å†™ç«¯</span><br>        dup2(cgi_output[<span class="hljs-number">1</span>], STDOUT);<br>        dup2(cgi_input[<span class="hljs-number">0</span>], STDIN);<br>        close(cgi_output[<span class="hljs-number">0</span>]);<br>        close(cgi_input[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-built_in">sprintf</span>(meth_env, <span class="hljs-string">&quot;REQUEST_METHOD=%s&quot;</span>, method);<br>        putenv(meth_env);<br>        <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;GET&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">sprintf</span>(query_env, <span class="hljs-string">&quot;QUERY_STRING=%s&quot;</span>, query_string);<br>            putenv(query_env);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;   <span class="hljs-comment">/* POST */</span><br>            <span class="hljs-built_in">sprintf</span>(length_env, <span class="hljs-string">&quot;CONTENT_LENGTH=%d&quot;</span>, content_length);<br>            putenv(length_env);<br>        &#125;<br><br>        <span class="hljs-comment">// æ‰§è¡Œ cgi è„šæœ¬ï¼Œcgiè„šæœ¬ä¸­çš„ print éƒ½ä¼šé€šè¿‡ç®¡é“é‡å®šå‘ç»™çˆ¶è¿›ç¨‹</span><br>        execl(path, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;    <span class="hljs-comment">/* parent */</span><br>        close(cgi_output[<span class="hljs-number">1</span>]);<br>        close(cgi_input[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;POST&quot;</span>) == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;çˆ¶è¿›ç¨‹æ¥å—åˆ°çš„æ¶ˆæ¯å†…å®¹æ˜¯:\n&quot;</span>);<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; content_length; i++) &#123;<br>                recv(client, &amp;c, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>                <span class="hljs-comment">// çˆ¶è¿›ç¨‹æŠŠæ”¶åˆ°çš„æ¶ˆæ¯å†…å®¹ä¼ é€’ç»™å­è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯ â€œcolor=redâ€ è¿™æ¡ä¿¡æ¯ï¼Œç”±cgiç”Ÿæˆæ–°çš„htmlæ–‡ä»¶</span><br>                <span class="hljs-comment">// å†ç”±çˆ¶è¿›ç¨‹ï¼ˆæœåŠ¡å™¨ï¼‰è½¬äº¤ç»™å®¢æˆ·ç«¯</span><br>                write(cgi_input[<span class="hljs-number">1</span>], &amp;c, <span class="hljs-number">1</span>);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c&quot;</span>,c);<br>            &#125;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;çˆ¶è¿›ç¨‹é€šè¿‡ç®¡é“æ¥æ”¶åˆ°çš„ï¼š\n&quot;</span>);<br><br>        <span class="hljs-keyword">while</span> (read(cgi_output[<span class="hljs-number">0</span>], &amp;c, <span class="hljs-number">1</span>) &gt; <span class="hljs-number">0</span>)&#123;<br>            send(client, &amp;c, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c&quot;</span>, c);<br>        &#125;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        æˆ‘æŠŠçˆ¶è¿›ç¨‹æ¥æ”¶åˆ°å­è¿›ç¨‹çš„å­—ç¬¦å†™è¿›äº†new.htmlæ–‡ä»¶ä¸­ï¼Œå¯ä»¥å‘ç°è¿™å°±æ˜¯ä¸€ä¸ªç½‘é¡µ</span><br><span class="hljs-comment">        */</span><br>        close(cgi_output[<span class="hljs-number">0</span>]);<br>        close(cgi_input[<span class="hljs-number">1</span>]);<br>        waitpid(pid, &amp;status, <span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åï¼ŒæŠŠæœåŠ¡å™¨è¿›ç¨‹é€šè¿‡ç®¡é“æ”¶åˆ°çš„CGIè„šæœ¬è¾“å‡ºå†…å®¹å†å‘é€ç»™å®¢æˆ·ç«¯ï¼Œhtmlæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™ä¹Ÿæ­£æ˜¯ç‚¹å‡»æäº¤åå†æµè§ˆå™¨ä¸Šå±•ç¤ºçš„ç½‘é¡µã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span></span><br><span class="hljs-meta">    <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span class="hljs-string">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en-US&quot;</span> <span class="hljs-attr">xml:lang</span>=<span class="hljs-string">&quot;en-US&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>RED<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Content-Type&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;text/html; charset=iso-8859-1&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">bgcolor</span>=<span class="hljs-string">&quot;red&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>This is red<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œæ¸…æ¥šäº†HTTPæ˜¯å¦‚ä½•å“åº”å’Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„ï¼Œæ˜ç™½äº†HTTPæœåŠ¡å™¨çš„å·¥ä½œæœºåˆ¶ï¼Œä¹Ÿå¯¹CGIè„šæœ¬æœ‰äº†ä¸€ç‚¹äº†è§£ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>é¡¹ç›®</category>
      
      <category>ç½‘ç»œç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é¡¹ç›®</tag>
      
      <tag>ç½‘ç»œç¼–ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆå§‹socket</title>
    <link href="/2023/08/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/%E5%88%9D%E8%AF%86socket/"/>
    <url>/2023/08/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/%E5%88%9D%E8%AF%86socket/</url>
    
    <content type="html"><![CDATA[<h2 id="1-ä»€ä¹ˆæ˜¯socket"><a href="#1-ä»€ä¹ˆæ˜¯socket" class="headerlink" title="1.ä»€ä¹ˆæ˜¯socket"></a>1.ä»€ä¹ˆæ˜¯socket</h2><p>socket çš„åŸæ„æ˜¯â€œæ’åº§â€ï¼Œæ˜¯ä¸€ç§æ“ä½œç³»ç»Ÿæä¾›çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ã€‚</p><p>åœ¨UNIX&#x2F;Linuxç³»ç»Ÿä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œç½‘ç»œè¿æ¥ä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒä¹Ÿæœ‰æ–‡ä»¶æè¿°ç¬¦ã€‚<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>socket()</code> å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªç½‘ç»œè¿æ¥ï¼Œæˆ–è€…è¯´æ‰“å¼€ä¸€ä¸ªç½‘ç»œæ–‡ä»¶ï¼Œ<code>socket()</code> çš„è¿”å›å€¼å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ã€‚æœ‰äº†æ–‡ä»¶æè¿°ç¬¦ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æ™®é€šçš„æ–‡ä»¶æ“ä½œå‡½æ•°æ¥ä¼ è¾“æ•°æ®äº†ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ç”¨ <code>read()</code> è¯»å–ä»è¿œç¨‹è®¡ç®—æœºä¼ æ¥çš„æ•°æ®ï¼›</li><li>ç”¨ <code>write()</code> å‘è¿œç¨‹è®¡ç®—æœºå†™å…¥æ•°æ®ã€‚</li></ul><p>è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å°±æ˜¯ç½‘ç»œå­—èŠ‚åºã€‚<br>ç½‘ç»œå­—èŠ‚åºä¸€èˆ¬éƒ½æ˜¯å¤§ç«¯è¡¨ç¤ºçš„ï¼Œè€Œä¸»æœºå­—èŠ‚åºä¸€èˆ¬æ˜¯å°ç«¯è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥éœ€è¦åŒ…å«ä¸€æ®µè¿™ä¸¤è€…ä¹‹é—´çš„è½¬æ¢å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// å°†ä¸€ä¸ªçŸ­æ•´å½¢ä»ä¸»æœºå­—èŠ‚åº -&gt; ç½‘ç»œå­—èŠ‚åº</span><br><span class="hljs-type">uint16_t</span> <span class="hljs-title function_">htons</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> hostshort)</span>;<br><span class="hljs-comment">// å°†ä¸€ä¸ªæ•´å½¢ä»ä¸»æœºå­—èŠ‚åº -&gt; ç½‘ç»œå­—èŠ‚åº</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">htonl</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> hostlong)</span>;<br><br><span class="hljs-comment">// å°†ä¸€ä¸ªçŸ­æ•´å½¢ä»ç½‘ç»œå­—èŠ‚åº -&gt; ä¸»æœºå­—èŠ‚åº</span><br><span class="hljs-type">uint16_t</span> <span class="hljs-title function_">ntohs</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> netshort)</span><br><span class="hljs-comment">// å°†ä¸€ä¸ªæ•´å½¢ä»ç½‘ç»œå­—èŠ‚åº -&gt; ä¸»æœºå­—èŠ‚åº</span><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">ntohl</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> netlong)</span>;<br></code></pre></td></tr></table></figure><p>è€Œå¯¹äºIPåœ°å€ï¼Œæˆ‘ä»¬ä¸€èˆ¬è§åˆ°çš„è¡¨ç¤ºå½¢å¼éƒ½æ˜¯ç‚¹åˆ†åè¿›åˆ¶ï¼ŒæŠŠè¿™ç§ç‚¹åˆ†åè¿›åˆ¶è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºéœ€è¦å‡½æ•°<code>inet_pton()</code>,<code>inet_ntop</code>å°†å¤§ç«¯çš„æ•´å½¢æ•°, è½¬æ¢ä¸ºå°ç«¯çš„ç‚¹åˆ†åè¿›åˆ¶çš„IPåœ°å€ã€‚</p><h2 id="2-TCPé€šä¿¡æµç¨‹"><a href="#2-TCPé€šä¿¡æµç¨‹" class="headerlink" title="2.TCPé€šä¿¡æµç¨‹"></a>2.TCPé€šä¿¡æµç¨‹</h2><p>TCPæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„ï¼Œå®‰å…¨çš„ï¼Œæµå¼ä¼ è¾“åè®®ï¼Œè¿™ä¸ªåè®®æ˜¯ä¸€ä¸ªä¼ è¾“å±‚åè®®ã€‚</p><h3 id="2-1æœåŠ¡å™¨ç«¯é€šä¿¡æµç¨‹"><a href="#2-1æœåŠ¡å™¨ç«¯é€šä¿¡æµç¨‹" class="headerlink" title="2.1æœåŠ¡å™¨ç«¯é€šä¿¡æµç¨‹"></a>2.1æœåŠ¡å™¨ç«¯é€šä¿¡æµç¨‹</h3><p>ä¸€èˆ¬è€Œè¨€ï¼ŒæœåŠ¡å™¨éœ€è¦ä¸€ä¸ªç›‘å¬å¥—æ¥å­—å’Œå¤šä¸ªé€šä¿¡å¥—æ¥å­—ï¼Œç›‘å¬å¥—æ¥å­—è´Ÿè´£ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œé€šä¿¡å¥—æ¥å­—åˆ™æ˜¯ä¸å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®ä¼ é€ã€‚</p><ol><li>è°ƒç”¨<code>socket()</code>å‡½æ•°åˆ›å»ºç”¨äºç›‘å¬çš„å¥—æ¥å­—ï¼Œå¾—åˆ°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚</li><li>å°†å¾—åˆ°çš„ç›‘å¬æ–‡ä»¶æè¿°ç¬¦å’Œæœ¬åœ°çš„IPç«¯å£è¿›è¡Œç»‘å®šï¼Œ<code>bind()</code>å‡½æ•°ã€‚</li><li><code>listen()</code>å‡½æ•°è®¾ç½®ç›‘å¬ã€‚</li><li><code>accept()</code>å‡½æ•°ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œä¼šè¿”å›ä¸€ä¸ªç”¨äºä¸å®¢æˆ·ç«¯é€šä¿¡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæ²¡æœ‰è¯·æ±‚å°±ä¼šå µå¡ã€‚</li><li><code>read()</code>æˆ–<code>recv()</code>æ¥å—æ•°æ®ï¼Œ<code>write()</code>æˆ–<code>send()</code>å‘é€æ•°æ®ã€‚</li><li><code>close()</code>æ–­å¼€è¿æ¥ï¼Œå…³é—­å¥—æ¥å­—ã€‚</li></ol><ul><li>æ³¨æ„ï¼šæœåŠ¡ç«¯éœ€è¦ç»‘å®šä¸€ä¸ªç‰¹å®šçš„ç«¯å£ï¼Œä¸èƒ½éšæ„åˆ†é…ã€‚è¿™æ˜¯å› ä¸ºå®¢æˆ·ç«¯åœ¨è¯·æ±‚ä¸æœåŠ¡å™¨ç«¯è¿›è¡Œè¿æ¥çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šIPåœ°å€ä»¥åŠç«¯å£ï¼Œæ‰€ä»¥æœåŠ¡å™¨çš„ç«¯å£å¯¹äºå®¢æˆ·ç«¯æ¥è¯´æ˜¯å·²çŸ¥çš„ã€‚<br>ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬è¾“å…¥ç½‘å€<code>https://www.bilibili.com</code>ï¼Œå…¶å®httpsçš„é»˜è®¤ç«¯å£å°±æ˜¯443ï¼Œæ‰€ä»¥ç›¸å½“äºæˆ‘ä»¬çœç•¥äº†ç«¯å£ï¼Œè¾“å…¥<code>https://www.bilibili.com:443</code>ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚å†è®²ä¸€å¥é¢˜å¤–è¯ï¼Œæˆ‘ä»¬æŒ‰ä¸‹F12ï¼Œç‚¹å‡»ç½‘ç»œï¼Œä¹Ÿä¼šå¾—åˆ°è¿œç¨‹æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£ï¼Œå‘ç°ç«¯å£ä¹Ÿæ˜¯443ï¼Œå‰ææ˜¯ä½ è¦å…³é—­vpnä»£ç†ã€‚</li></ul><h3 id="2-2-å®¢æˆ·ç«¯çš„é€šä¿¡æµç¨‹"><a href="#2-2-å®¢æˆ·ç«¯çš„é€šä¿¡æµç¨‹" class="headerlink" title="2.2 å®¢æˆ·ç«¯çš„é€šä¿¡æµç¨‹"></a>2.2 å®¢æˆ·ç«¯çš„é€šä¿¡æµç¨‹</h3><p>ä¸€èˆ¬æ¥è¯´å®¢æˆ·ç«¯é€šä¿¡çš„æ–‡ä»¶æè¿°ç¬¦åªæœ‰ä¸€ä¸ªï¼Œä¸éœ€è¦åšæŒºçš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><ol><li><code>socket()</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—ï¼Œè¿”å›æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li><code>connect()</code>å‡½æ•°è¿æ¥æœåŠ¡å™¨ï¼Œéœ€è¦çŸ¥é“æœåŠ¡å™¨ç»‘å®šçš„IPå’Œç«¯å£ã€‚</li><li><code>read()</code>æˆ–<code>recv()</code>å‡½æ•°æ¥å—æ•°æ®ï¼Œ<code>write()</code>æˆ–<code>send()</code>å‘é€æ•°æ®ã€‚</li><li><code>close()</code>æ–­å¼€è¿æ¥ã€‚</li></ol><h2 id="3-åŸºæœ¬API"><a href="#3-åŸºæœ¬API" class="headerlink" title="3.åŸºæœ¬API"></a>3.åŸºæœ¬API</h2><ul><li><code>int socket(int domain, int type, int protocol)</code>ï¼š<br>å‚æ•°ï¼š<br><code>domain</code>åœ°å€æ—ï¼Œå¸¸è§çš„æœ‰AF_INETï¼ˆIPv4ï¼‰å’ŒAF_INET6ï¼ˆIPv6ï¼‰ã€‚<br><code>type</code> å¥—æ¥å­—ç±»å‹,å¸¸è§çš„æœ‰SOCK_STREAMï¼ˆç”¨äºTCPåè®®ï¼‰å’ŒSOCK_DGRAMï¼ˆç”¨äºUDPåè®®ï¼‰ã€‚<br><code>protocal</code>åè®®ï¼Œé€šå¸¸ç½®ä¸º0ï¼Œæ ¹æ®å‰ä¸¤ä¸ªå‚æ•°è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„åè®®ã€‚</li></ul><p>è¿”å›å€¼æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚</p><ul><li><code>int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code><br>å‚æ•°ï¼š<br><code>sockfd</code>éœ€è¦ç»‘å®šçš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚<br><code>addr</code>:å­˜æ”¾äº†æœåŠ¡ç«¯ç”¨äºé€šä¿¡çš„åœ°å€å’Œç«¯å£ã€‚<br><code>addrlen</code>:ç»“æ„ä½“addrçš„å¤§å°ã€‚</li></ul><p><code>sockaddr_in</code>ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">sa_family_t</span> sin_family;<span class="hljs-comment">/* åœ°å€æ—åè®®: AF_INET */</span><br>    <span class="hljs-type">in_port_t</span> sin_port;         <span class="hljs-comment">/* ç«¯å£, 2å­—èŠ‚-&gt; å¤§ç«¯  */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in_addr</span> <span class="hljs-title">sin_addr</span>;</span>    <span class="hljs-comment">/* IPåœ°å€, 4å­—èŠ‚ -&gt; å¤§ç«¯  */</span><br>    <span class="hljs-comment">/* å¡«å…… 8å­—èŠ‚ */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> sin_zero[<span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> sockaddr) - <span class="hljs-keyword">sizeof</span>(sin_family) -<br>               <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">in_port_t</span>) - <span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> in_addr)];<br>&#125;;  <br></code></pre></td></tr></table></figure><ul><li><p><code>int listen(int sockfd, int backlog)</code><br>å‚æ•°ï¼š<br><code>sockfd</code>: æ–‡ä»¶æè¿°ç¬¦, å¯ä»¥é€šè¿‡è°ƒç”¨<code>socket()</code>å¾—åˆ°ï¼Œåœ¨ç›‘å¬ä¹‹å‰å¿…é¡»è¦ç»‘å®š <code>bind()</code><br><code>backlog</code>: åŒæ—¶èƒ½å¤„ç†çš„æœ€å¤§è¿æ¥è¦æ±‚ï¼Œæœ€å¤§å€¼ä¸º128</p></li><li><p><code>int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen);</code><br>å‚æ•°ï¼š<br><code>sockfd</code>: ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦<br><code>addr</code>: <strong>ä¼ å‡ºå‚æ•°</strong>, é‡Œè¾¹å­˜å‚¨äº†å»ºç«‹è¿æ¥çš„å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯,å¦‚å®¢æˆ·ç«¯çš„ç«¯å£å’ŒIPã€‚<br><code>addrlen</code>: ä¼ å…¥ä¼ å‡ºå‚æ•°ï¼Œç”¨äºå­˜å‚¨addræŒ‡å‘çš„å†…å­˜å¤§å°</p></li></ul><p>è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªé˜»å¡å‡½æ•°ï¼Œå½“æ²¡æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚çš„æ—¶å€™ï¼Œè¯¥å‡½æ•°é˜»å¡ï¼›å½“æ£€æµ‹åˆ°æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ—¶ï¼Œé˜»å¡è§£é™¤ï¼Œæ–°è¿æ¥å°±å»ºç«‹äº†ï¼Œå¾—åˆ°çš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ŒåŸºäºè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å°±å¯ä»¥å’Œå®¢æˆ·ç«¯é€šä¿¡äº†ã€‚</p><ul><li><code>int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code><br>å‚æ•°ï¼š<br><code>sockfd</code>: é€šä¿¡çš„æ–‡ä»¶æè¿°ç¬¦, é€šè¿‡è°ƒç”¨socket()å‡½æ•°å°±å¾—åˆ°äº†<br><code>addr</code>: å­˜å‚¨äº†è¦è¿æ¥çš„æœåŠ¡å™¨ç«¯çš„åœ°å€ä¿¡æ¯: IP å’Œ ç«¯å£ï¼Œè¿™ä¸ªIPå’Œç«¯å£ä¹Ÿéœ€è¦è½¬æ¢ä¸ºå¤§ç«¯ç„¶åå†èµ‹å€¼<br><code>addrlen</code>: <code>addr</code>æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜çš„å¤§å° <code>sizeof(struct sockaddr)</code></li></ul><p>è‡³äºå‘é€æ¥å—æ•°æ®çš„å‡½æ•°ï¼Œè¿™ä¸ªæ˜¯å†…æ ¸æ¥ç»´æŠ¤çš„ï¼Œå†…æ ¸å†³å®šå¤šä¹…å‘é€å‡ºå»å°±å¤šä¹…å‘é€å‡ºå»ï¼Œå¤šä¹…ä»ç¼“å†²åŒºè·å–æ•°æ®å°±å¤šä¹…è·å–ã€‚åŒæ—¶ï¼Œå¦‚æœç¼“å†²åŒºæ»¡äº†ï¼Œ<code>write</code>æˆ–<code>send</code>å‡½æ•°å°±ä¼šè¢«é˜»å¡ã€‚</p><h2 id="4-ç¤ºä¾‹ä»£ç "><a href="#4-ç¤ºä¾‹ä»£ç " class="headerlink" title="4.ç¤ºä¾‹ä»£ç "></a>4.ç¤ºä¾‹ä»£ç </h2><p>åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä»£ç ä¸­ï¼ŒæœåŠ¡å™¨ç«¯æˆ‘ä»¬è¦ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œæ¯å½“ä¸€ä¸ªå®¢æˆ·ç«¯å‘è¿‡æ¥ä¸€ä¸ªè¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨ç«¯éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;ctype.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">sys_err</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* str)</span>&#123;<br>    perror(str);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SERV_PORT 9527</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFSIZE 256</span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">client_handler</span><span class="hljs-params">(<span class="hljs-type">void</span> *socket_desc)</span> &#123;<br>    <span class="hljs-type">int</span> client_socket = *(<span class="hljs-type">int</span> *)socket_desc;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];<br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>        ret = read(client_socket, buf, <span class="hljs-keyword">sizeof</span>(buf));<br>        write(STDOUT_FILENO, buf, ret);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ret; i++)&#123;<br>            buf[i] = <span class="hljs-built_in">toupper</span>(buf[i]);<br>        &#125;<br><br>        write(client_socket, buf, ret);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span>&#123;<br><br>    <span class="hljs-type">int</span> lfd = <span class="hljs-number">0</span>, cfd = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">char</span> buf[BUFSIZE];<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">serv_addr</span>, <span class="hljs-title">clit_addr</span>;</span><br>    <span class="hljs-type">pthread_t</span> thread_id;<br><br>    serv_addr.sin_family = AF_INET;<br>    serv_addr.sin_port = htons(SERV_PORT);<br>    serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);<br><br><br>    lfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(lfd == <span class="hljs-number">-1</span>)&#123;<br>        sys_err(<span class="hljs-string">&quot;socket error&quot;</span>);<br>    &#125;<br><br>    bind(lfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;serv_addr, <span class="hljs-keyword">sizeof</span>(serv_addr));<br><br>    listen(lfd, <span class="hljs-number">128</span>);<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-type">socklen_t</span> clit_addr_len = <span class="hljs-keyword">sizeof</span>(clit_addr);<br>        cfd = accept(lfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;clit_addr, &amp;clit_addr_len);<br><br>        <span class="hljs-keyword">if</span> (cfd == <span class="hljs-number">-1</span>) &#123;<br>            perror(<span class="hljs-string">&quot;Accept failed&quot;</span>);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Client connected\n&quot;</span>);<br><br>        <span class="hljs-type">int</span> *new_sock = (<span class="hljs-type">int</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);<br>        *new_sock = cfd;<br><br>        <span class="hljs-keyword">if</span> (pthread_create(&amp;thread_id, <span class="hljs-literal">NULL</span>, client_handler, (<span class="hljs-type">void</span> *)new_sock) &lt; <span class="hljs-number">0</span>) &#123;<br>            perror(<span class="hljs-string">&quot;Could not create thread&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>    close(lfd);<br>    close(cfd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</code><br>è¿™è¡Œä»£ç çš„æ„æ€æ˜¯å¯ä»¥ç»‘å®šæœ¬åœ°çš„ä»»ä½•ä¸€ä¸ªIPåœ°å€ï¼ŒæœåŠ¡å™¨ç«¯è‡ªåŠ¨åœ°è¯»ç½‘å¡çš„å®é™…IPï¼Œå¹¶ä¸è¿™ä¸ªå®é™…IPè¿›è¡Œç»‘å®šã€‚<br>ç°åœ¨æˆ‘ä»¬è¿˜æ²¡æœ‰å®¢æˆ·ç«¯çš„ä»£ç ï¼Œä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥å¯¹æœåŠ¡å™¨ä»£ç è¿›è¡Œæµ‹è¯•ã€‚<br>é¦–å…ˆç¼–è¯‘å¹¶è¿è¡ŒæœåŠ¡å™¨ç«¯ä»£ç ï¼Œç„¶åå¦å¤–å¼€å‡ ä¸ªç»ˆç«¯ï¼Œè¾“å…¥<code>nc 127.0.0.1 9527</code>å‘½ä»¤ã€‚</p><blockquote><p>Linuxä¸­çš„ncå‘½ä»¤æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ç½‘ç»œå·¥å…·ï¼Œä¹Ÿè¢«ç§°ä¸ºnetcatï¼Œå¯ä»¥å®ç°TCP&#x2F;UDPç«¯å£çš„ä¾¦å¬ï¼Œ127.0.0.1ä»£è¡¨æœ¬åœ°ä¸»æœºï¼Œ9527ç«¯å£æ˜¯æœåŠ¡å™¨ç›‘å¬å¥—æ¥å­—ç»‘å®šäº†çš„ã€‚</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºç½‘ç»œ</category>
      
      <category>ç½‘ç»œç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
      <tag>ç½‘ç»œç¼–ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CMU_15445ï¼šBuffer Pool Manager</title>
    <link href="/2023/08/16/%E6%95%B0%E6%8D%AE%E5%BA%93/CMU_15445/Project1/"/>
    <url>/2023/08/16/%E6%95%B0%E6%8D%AE%E5%BA%93/CMU_15445/Project1/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>æ•°æ®åº“</category>
      
      <category>CMU_15445</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•°æ®åº“</tag>
      
      <tag>CMU_15445</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸­æ–­å’Œè®¾å¤‡é©±åŠ¨ç¨‹åº</title>
    <link href="/2023/08/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/5.%E4%B8%AD%E6%96%AD%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/"/>
    <url>/2023/08/14/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/5.%E4%B8%AD%E6%96%AD%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯ä¸­æ–­"><a href="#ä»€ä¹ˆæ˜¯ä¸­æ–­" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸­æ–­"></a>ä»€ä¹ˆæ˜¯ä¸­æ–­</h2><p>ä¸­æ–­å¯¹åº”çš„åœºæ™¯å¾ˆç®€å•ï¼Œå°±æ˜¯ç¡¬ä»¶æƒ³è¦å¾—åˆ°æ“ä½œç³»ç»Ÿçš„å…³æ³¨ã€‚<br>æ“ä½œç³»ç»Ÿéœ€è¦åšçš„æ˜¯ï¼Œä¿å­˜å½“å‰çš„å·¥ä½œï¼Œå¤„ç†ä¸­æ–­ï¼Œå¤„ç†å®Œæˆä¹‹åå†æ¢å¤ä¹‹å‰çš„å·¥ä½œã€‚è¿™é‡Œçš„ä¿å­˜å’Œæ¢å¤å·¥ä½œï¼Œä¸æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹éå¸¸ç›¸ä¼¼ã€‚æ‰€ä»¥ç³»ç»Ÿè°ƒç”¨ï¼Œpage faultï¼Œä¸­æ–­ï¼Œéƒ½ä½¿ç”¨ç›¸åŒçš„æœºåˆ¶ã€‚</p><ul><li><strong>ä¸­æ–­ä¸ç³»ç»Ÿè°ƒç”¨çš„åŒºåˆ«</strong></li></ul><ol><li>asynchronousï¼ˆå¼‚æ­¥æ€§ï¼‰ï¼šå½“ç¡¬ä»¶ç”Ÿæˆä¸­æ–­æ—¶ï¼ŒInterrupt handlerä¸å½“å‰è¿è¡Œçš„è¿›ç¨‹åœ¨CPUä¸Šæ²¡æœ‰ä»»ä½•å…³è”ã€‚è€Œç³»ç»Ÿè°ƒç”¨ä¼šå‘ç”Ÿåœ¨è¿è¡Œè¿›ç¨‹çš„contextä¸‹ã€‚</li><li>concurrencyï¼ˆå¹¶å‘ï¼‰ï¼šCPUå’Œè®¾å¤‡ä¹‹é—´æ˜¯çœŸæ­£çš„å¹¶è¡Œçš„ã€‚</li><li>program deviceï¼šè®¾å¤‡éœ€è¦è¢«ç¼–ç¨‹ã€‚</li></ol><ul><li><strong>PLIC</strong></li></ul><p>æ‰€æœ‰çš„è®¾å¤‡éƒ½è¿æ¥åˆ°å¤„ç†å™¨ä¸Šï¼Œå¤„ç†å™¨ä¸Šæ˜¯é€šè¿‡Platform Level Interrupt Controlï¼Œç®€ç§°PLICæ¥å¤„ç†è®¾å¤‡ä¸­æ–­ã€‚PLICä¼šè·¯ç”±è¿™äº›ä¸­æ–­,PLICä¼šå°†ä¸­æ–­è·¯ç”±åˆ°æŸä¸€ä¸ªCPUçš„æ ¸ã€‚å¦‚æœæ‰€æœ‰çš„CPUæ ¸éƒ½æ­£åœ¨å¤„ç†ä¸­æ–­ï¼ŒPLICä¼šä¿ç•™ä¸­æ–­ç›´åˆ°æœ‰ä¸€ä¸ªCPUæ ¸å¯ä»¥ç”¨æ¥å¤„ç†ä¸­æ–­ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯è®¾å¤‡é©±åŠ¨"><a href="#ä»€ä¹ˆæ˜¯è®¾å¤‡é©±åŠ¨" class="headerlink" title="ä»€ä¹ˆæ˜¯è®¾å¤‡é©±åŠ¨"></a>ä»€ä¹ˆæ˜¯è®¾å¤‡é©±åŠ¨</h2><p>é€šå¸¸æ¥è¯´ï¼Œç®¡ç†è®¾å¤‡çš„ä»£ç ç§°ä¸ºé©±åŠ¨ï¼Œæ‰€æœ‰çš„é©±åŠ¨éƒ½åœ¨å†…æ ¸ä¸­ã€‚æˆ‘ä»¬ä»Šå¤©è¦çœ‹çš„æ˜¯UARTè®¾å¤‡çš„é©±åŠ¨ï¼Œä»£ç åœ¨uart.cæ–‡ä»¶ä¸­ã€‚</p><blockquote><p>å¤§éƒ¨åˆ†é©±åŠ¨éƒ½åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œbottom å’Œ topã€‚</p></blockquote><ul><li><p>bottoméƒ¨åˆ†<br>é€šå¸¸æ˜¯Interrupt handlerã€‚ä¸­æ–­å¤„ç†ç¨‹åºå¹¶ä¸è¿è¡Œåœ¨ä»»ä½•ç‰¹å®šè¿›ç¨‹çš„ä¸Šä¸‹æ–‡  ä¸­ï¼Œå®ƒåªæ˜¯å¤„ç†ä¸­æ–­ã€‚</p></li><li><p>topéƒ¨åˆ†<br>æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œæˆ–è€…å†…æ ¸çš„å…¶ä»–éƒ¨åˆ†è°ƒç”¨çš„æ¥å£ã€‚ä¾‹å¦‚ <code>read</code> å’Œ <code>write</code></p></li></ul><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œé©±åŠ¨ä¸­ä¼šæœ‰ä¸€äº›é˜Ÿåˆ—ï¼ˆæˆ–è€…è¯´bufferï¼‰ï¼Œtopéƒ¨åˆ†çš„ä»£ç ä¼šä»é˜Ÿåˆ—ä¸­è¯»å†™æ•°æ®ï¼Œè€ŒInterrupt handlerï¼ˆbottoméƒ¨åˆ†ï¼‰åŒæ—¶ä¹Ÿä¼šå‘é˜Ÿåˆ—ä¸­è¯»å†™æ•°æ®ã€‚è¿™é‡Œçš„é˜Ÿåˆ—å¯ä»¥å°†å¹¶è¡Œè¿è¡Œçš„è®¾å¤‡å’ŒCPUè§£è€¦å¼€æ¥ã€‚</p><ul><li>memory mapped I&#x2F;O<br>I&#x2F;Oè®¾å¤‡çš„å¯„å­˜å™¨è¢«æ˜ å°„åˆ°ç³»ç»Ÿå†…å­˜åœ°å€ç©ºé—´çš„ä¸€æ®µåœ°å€èŒƒå›´å†…ï¼Œç¨‹åºå¯ä»¥é€šè¿‡è¯»å†™å†…å­˜åœ°å€çš„æ–¹å¼æ¥è¿›è¡Œå¯¹I&#x2F;Oè®¾å¤‡çš„æ§åˆ¶å’Œè®¿é—®ã€‚</li></ul><h2 id="åœ¨xv6ä¸­è®¾ç½®ä¸­æ–­"><a href="#åœ¨xv6ä¸­è®¾ç½®ä¸­æ–­" class="headerlink" title="åœ¨xv6ä¸­è®¾ç½®ä¸­æ–­"></a>åœ¨xv6ä¸­è®¾ç½®ä¸­æ–­</h2><h3 id="Console-input"><a href="#Console-input" class="headerlink" title="Console input"></a>Console input</h3><p>å½“ç”¨æˆ·è¾“å…¥ä¸€ä¸ªå­—ç¬¦åï¼ŒUARTç¡¬ä»¶å°†äº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œè¿™ä¸ªä¸­æ–­å°†è§¦å‘xv6è¿›å…¥trapï¼Œéšåè°ƒç”¨<code>devintr</code>æ¥é€šè¿‡<code>scause</code>å¯„å­˜å™¨åˆ¤æ–­æ˜¯å¤–éƒ¨è®¾å¤‡è§¦å‘äº†è¿™ä¸ªä¸­æ–­ï¼Œç„¶åç¡¬ä»¶å°†è°ƒç”¨PLICåˆ¤æ–­æ˜¯å“ªä¸ªå¤–éƒ¨è®¾å¤‡è§¦å‘äº†è¿™ä¸ªå¤–éƒ¨ä¸­æ–­ï¼Œå¦‚æœæ˜¯UARTè§¦å‘çš„,<code>devintr</code>å°†è°ƒç”¨<code>uartintr</code>ã€‚<code>uartintr</code>å°†è¯»å–ä»UARTç¡¬ä»¶ä¸­å†™å…¥çš„å­—ç¬¦ç„¶åå°†å…¶ä¼ é€ç»™<code>consoleintr</code>ï¼Œ<code>consoleintr</code>å°†ç§¯ç´¯è¿™äº›å­—ç¬¦ç›´åˆ°æ•´è¡Œéƒ½å·²ç»è¢«è¯»å–ï¼Œç„¶åå°†å”¤é†’ä»åœ¨sleepçš„<code>consoleread</code>ã€‚å½“<code>consoleread</code>è¢«å”¤é†’åï¼Œå°†è¿™ä¸€è¡Œå‘½ä»¤å¤åˆ¶ç»™user spaceç„¶åè¿”å›ã€‚</p><h3 id="Console-output"><a href="#Console-output" class="headerlink" title="Console output"></a>Console output</h3><p>å¯¹consoleä¸Šçš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œ<code>write</code> system callï¼Œæœ€ç»ˆåˆ°è¾¾kernel&#x2F;uart.cçš„<code>uartputc</code>å‡½æ•°ã€‚è¾“å‡ºçš„å­—èŠ‚å°†ç¼“å­˜åœ¨<code>uart_tx_buf</code>ä¸­ï¼Œè¿™æ ·å†™å…¥è¿›ç¨‹å°±ä¸éœ€è¦ç­‰å¾…UARTç¡¬ä»¶å®Œæˆå­—èŠ‚çš„å‘é€ï¼Œåªè¦å½“è¿™ä¸ªç¼“å­˜åŒºæ»¡äº†çš„æƒ…å†µä¸‹<code>uartputc</code>æ‰ä¼šç­‰å¾…ã€‚å½“UARTå®Œæˆäº†ä¸€ä¸ªå­—ç¬¦çš„å‘é€ä¹‹åï¼Œå°†äº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œ<code>uartintr</code>å°†è°ƒç”¨<code>uartstart</code>æ¥åˆ¤æ–­è®¾å¤‡æ˜¯å¦ç¡®å®å·²ç»å®Œæˆå‘é€ï¼Œç„¶åå°†ä¸‹ä¸€ä¸ªéœ€è¦å‘é€çš„å­—ç¬¦å‘é€ç»™UARTã€‚å› æ­¤è®©UARTä¼ é€å¤šä¸ªå­—ç¬¦æ—¶ï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦ç”±<code>uartputc</code>å¯¹<code>uartstart</code>çš„è°ƒç”¨ä¼ é€ï¼Œåé¢çš„å­—ç¬¦ç”±<code>uartintr</code>å¯¹<code>uartstart</code>çš„è°ƒç”¨è¿›è¡Œä¼ é€ã€‚</p><h3 id="UARTé©±åŠ¨çš„topéƒ¨åˆ†"><a href="#UARTé©±åŠ¨çš„topéƒ¨åˆ†" class="headerlink" title="UARTé©±åŠ¨çš„topéƒ¨åˆ†"></a>UARTé©±åŠ¨çš„topéƒ¨åˆ†</h3><p>å½“XV6å¯åŠ¨æ—¶ï¼ŒShellä¼šè¾“å‡ºæç¤ºç¬¦â€œ$ â€ï¼Œå¦‚æœæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šè¾“å…¥lsï¼Œæœ€ç»ˆå¯ä»¥çœ‹åˆ°â€œ$ lsâ€ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥é€šè¿‡ç ”ç©¶Consoleæ˜¯å¦‚ä½•æ˜¾ç¤ºå‡ºâ€œ$ lsâ€ï¼Œæ¥çœ‹ä¸€ä¸‹è®¾å¤‡ä¸­æ–­æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><p>é¦–å…ˆï¼Œç³»ç»Ÿå¯åŠ¨åè¿è¡Œç¬¬ä¸€ä¸ªè¿›ç¨‹init,è¿™ä¸ªè¿›ç¨‹ä¼šåˆ›å»ºä¸€ä¸ªConsoleè®¾å¤‡ã€‚ç„¶åå†è¿›è¡Œä¸¤æ¬¡dupåï¼Œæ–‡ä»¶æè¿°ç¬¦0,1,2éƒ½æŒ‡å‘äº†è¿™ä¸ªConsoleè®¾å¤‡ã€‚éšåè¿™ä¸ªè¿›ç¨‹ä¼šforkï¼Œç„¶åå­è¿›ç¨‹è¿›å…¥shellã€‚</p><p>åœ¨shellçš„<code>getcmd</code>å‡½æ•°ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;$ &quot;</span>);<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œwriteç³»ç»Ÿè°ƒç”¨ï¼Œ<code>sys_write</code>å‡½æ•°åˆä¼šè°ƒç”¨file.cä¸­çš„<code>filewrite</code>å‡½æ•°ã€‚<br>è¿™ä¸ª<code>filewrite</code>å‡½æ•°åˆ¤æ–­æ–‡ä»¶çš„ç±»å‹ï¼Œ(è¿™é‡Œè¿˜ä¼šç”¨åˆ°<code>argfd</code>å‡½æ•°ï¼Œç”¨ä¸€ä¸ª<code>struct file*</code>çš„ç±»å‹è·å–fdçš„æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘çš„æ–‡ä»¶)ã€‚<br><code>filewrite</code>å‡½æ•°å‘ç°è¿™ä¸ªæ–‡ä»¶ç±»å‹æ˜¯å±äºä¸€ä¸ªè®¾å¤‡åï¼Œå°±ä¼šä¸ºè¿™ä¸ªç‰¹å®šçš„è®¾å¤‡æ‰§è¡Œç›¸åº”çš„<code>write</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">ret = devsw[f-&gt;major].write(<span class="hljs-number">1</span>,addr,n);<br></code></pre></td></tr></table></figure><p>å› ä¸ºè®¾å¤‡æ˜¯Consoleï¼Œæ‰€ä»¥ä¼šè°ƒç”¨console.cä¸­çš„<code>consolewrite</code>å‡½æ•°ã€‚</p><blockquote><p>consolewriteæ˜¯UARTé©±åŠ¨çš„topéƒ¨åˆ†</p></blockquote><p><code>consolewrite</code>ä¼šè°ƒç”¨<code>uartputc</code>å‡½æ•°ï¼Œé¦–å…ˆæŠŠæ•°æ®å­˜åœ¨ä¸€ä¸ªç¼“å†²åŒºé‡Œ<code>uart_tx_buf</code>ä¸­ã€‚</p><p>å†ç„¶åä¼šè°ƒç”¨<code>uartstart</code>å‡½æ•°ï¼Œé€šçŸ¥UARTè®¾å¤‡æ‰§è¡Œæ“ä½œã€‚å–å‡ºæ•°æ®æ”¾å…¥THRå‘é€å¯„å­˜å™¨ã€‚<br>ä¸€æ—¦æ•°æ®é€åˆ°äº†è®¾å¤‡ï¼Œç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›ï¼Œç”¨æˆ·åº”ç”¨ç¨‹åºShellå°±å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚ä¸æ­¤åŒæ—¶ï¼ŒUARTè®¾å¤‡ä¼šå°†æ•°æ®é€å‡ºã€‚</p><blockquote><p>UARTè¿æ¥äº†ä¸¤ä¸ªè®¾å¤‡ï¼Œä¸€ä¸ªæ˜¯é”®ç›˜ï¼Œå¦ä¸€ä¸ªæ˜¯æ˜¾ç¤ºè®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯Consoleã€‚</p></blockquote><p>ç„¶åå‘¢ã€‚ã€‚ã€‚ä¼šå‘ç”Ÿä¸­æ–­ã€‚</p><h3 id="UARTé©±åŠ¨çš„bottoméƒ¨åˆ†"><a href="#UARTé©±åŠ¨çš„bottoméƒ¨åˆ†" class="headerlink" title="UARTé©±åŠ¨çš„bottoméƒ¨åˆ†"></a>UARTé©±åŠ¨çš„bottoméƒ¨åˆ†</h3><p>trap.cçš„<code>devintr</code>å‡½æ•°ä¸­ï¼Œé¦–å…ˆä¼šé€šè¿‡<code>SCAUSE</code>å¯„å­˜å™¨åˆ¤æ–­å½“å‰ä¸­æ–­æ˜¯å¦æ˜¯æ¥è‡ªäºå¤–è®¾çš„ä¸­æ–­ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œå†è°ƒç”¨plic_claimå‡½æ•°æ¥è·å–ä¸­æ–­ã€‚å¦‚æœæ˜¯UARTä¸­æ–­ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨<code>uartintr</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">uartintr(<span class="hljs-type">void</span>)&#123;<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br><span class="hljs-type">int</span> c = uartgetc();<br><span class="hljs-keyword">if</span>(c == <span class="hljs-number">-1</span>) <span class="hljs-keyword">break</span>;<br>consoleintr();<br>&#125;<br>acquire(&amp;uart_tx_lock);<br>uartstart();<br>release(&amp;uart_tx_lock);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬æ²¡æœ‰åœ¨é”®ç›˜ä¸Šæ•²ä¸‹ä»»ä½•ä¸€ä¸ªé”®(è¿™é‡Œçº¯ç²¹è¯´ä¸€ä¸‹â€$â€æ˜¯å¦‚ä½•è¢«å¤„ç†çš„)ï¼Œæ‰€ä»¥ä¼šç›´æ¥æ‰§è¡Œuartsatrtå‡½æ•°ã€‚</p><ul><li>å°ç–‘é—®ï¼šä¸ºä»€ä¹ˆinterruptå’Œwriteéƒ½ä¼šè°ƒç”¨äº†uartstartå‡½æ•°ï¼Ÿ<blockquote><p>é¦–å…ˆï¼Œå¦‚æœæ˜¯writeå¤šä¸ªå­—èŠ‚çš„è¯ï¼Œç¬¬ä¸€æ¬¡é€šè¿‡uartputcè°ƒç”¨uartstartï¼ŒæŠŠç¬¬ä¸€ä¸ªå­—èŠ‚å‘é€å‡ºå»ã€‚ç¬¬ä¸€ä¸ªå­—èŠ‚å‘é€å®Œæˆåï¼Œä¼šäº§ç”Ÿä¸­æ–­ï¼Œç´§æ¥ç€æŠŠä½™ä¸‹çš„å­—èŠ‚éƒ½å‘é€å‡ºå»ã€‚<br>A general pattern to note is the decoupling of device activity from process activity via buffering and interrupts.</p></blockquote></li></ul><blockquote><p>Interrupt handlerï¼Œä¹Ÿå°±æ˜¯uartintrå‡½æ•°ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸‹æ˜¯consumerï¼Œæ¯å½“æœ‰ä¸€ä¸ªä¸­æ–­ï¼Œå¹¶ä¸”è¯»æŒ‡é’ˆè½åäºå†™æŒ‡é’ˆï¼Œuartintrå‡½æ•°å°±ä¼šä»è¯»æŒ‡é’ˆä¸­è¯»å–ä¸€ä¸ªå­—ç¬¦å†é€šè¿‡UARTè®¾å¤‡å‘é€ï¼Œå¹¶ä¸”å°†è¯»æŒ‡é’ˆåŠ 1ã€‚å½“è¯»æŒ‡é’ˆè¿½ä¸Šå†™æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªæŒ‡é’ˆç›¸ç­‰çš„æ—¶å€™ï¼Œbufferä¸ºç©ºï¼Œè¿™æ—¶å°±ä¸ç”¨åšä»»ä½•æ“ä½œã€‚</p></blockquote><h3 id="UARTè¯»å–é”®ç›˜è¾“å…¥"><a href="#UARTè¯»å–é”®ç›˜è¾“å…¥" class="headerlink" title="UARTè¯»å–é”®ç›˜è¾“å…¥"></a>UARTè¯»å–é”®ç›˜è¾“å…¥</h3><p>ç±»ä¼¼çš„ï¼Œshellä¼šè°ƒç”¨<code>read</code>ä»é”®ç›˜è¯»å–å­—ç¬¦ã€‚å†ä¼šè°ƒç”¨<code>fileread</code>å‡½æ•°ï¼Œå¦‚æœæ–‡ä»¶ç±»å‹æ˜¯è®¾å¤‡ï¼Œåœ¨è¿™é‡Œæ˜¯<code>console</code>è®¾å¤‡ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨<code>consoleread</code>å‡½æ•°ã€‚è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªBufferã€‚<br>å¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š<br>å‡è®¾ç”¨æˆ·é€šè¿‡é”®ç›˜è¾“å…¥äº†â€œlâ€ï¼Œè¿™ä¼šå¯¼è‡´â€œlâ€è¢«å‘é€åˆ°ä¸»æ¿ä¸Šçš„UARTèŠ¯ç‰‡ï¼Œäº§ç”Ÿä¸­æ–­ä¹‹åå†è¢«PLICè·¯ç”±åˆ°æŸä¸ªCPUæ ¸ï¼Œä¹‹åä¼šè§¦å‘<code>devintr</code>å‡½æ•°ï¼Œ<code>devintr</code>å¯ä»¥å‘ç°è¿™æ˜¯ä¸€ä¸ªUARTä¸­æ–­ï¼Œç„¶åé€šè¿‡<code>uartgetc</code>å‡½æ•°è·å–åˆ°ç›¸åº”çš„å­—ç¬¦ï¼Œä¹‹åå†å°†å­—ç¬¦ä¼ é€’ç»™<code>consoleintr</code>å‡½æ•°ã€‚<br>é»˜è®¤æƒ…å†µä¸‹ï¼Œå­—ç¬¦ä¼šé€šè¿‡<code>consputc</code>ï¼Œè¾“å‡ºåˆ°consoleä¸Šç»™ç”¨æˆ·æŸ¥çœ‹ã€‚ä¹‹åï¼Œå­—ç¬¦è¢«å­˜æ”¾åœ¨bufferä¸­ã€‚åœ¨é‡åˆ°æ¢è¡Œç¬¦çš„æ—¶å€™ï¼Œå”¤é†’ä¹‹å‰sleepçš„è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯Shellï¼Œå†ä»bufferä¸­å°†æ•°æ®è¯»å‡ºã€‚<br>æ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯é€šè¿‡bufferå°†consumerå’Œproducerä¹‹é—´è§£è€¦ï¼Œè¿™æ ·å®ƒä»¬æ‰èƒ½æŒ‰ç…§è‡ªå·±çš„é€Ÿåº¦ï¼Œç‹¬ç«‹çš„å¹¶è¡Œè¿è¡Œã€‚å¦‚æœæŸä¸€ä¸ªè¿è¡Œçš„è¿‡å¿«äº†ï¼Œé‚£ä¹ˆbufferè¦ä¹ˆæ˜¯æ»¡çš„è¦ä¹ˆæ˜¯ç©ºçš„ï¼Œconsumerå’Œproducerå…¶ä¸­ä¸€ä¸ªä¼šsleepå¹¶ç­‰å¾…å¦ä¸€ä¸ªè¿½ä¸Šæ¥ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>MIT6.S081</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
      <tag>MIT6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é”çš„å®ç°</title>
    <link href="/2023/08/13/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/6.%E9%94%81/"/>
    <url>/2023/08/13/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/6.%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h2 id="è‡ªæ—‹é”ï¼ˆSpin-lockï¼‰çš„å®ç°"><a href="#è‡ªæ—‹é”ï¼ˆSpin-lockï¼‰çš„å®ç°" class="headerlink" title="è‡ªæ—‹é”ï¼ˆSpin lockï¼‰çš„å®ç°"></a>è‡ªæ—‹é”ï¼ˆSpin lockï¼‰çš„å®ç°</h2><ul><li>ä»€ä¹ˆæ˜¯è‡ªæ—‹é”<br>è‡ªæ—‹é”æ˜¯ä¸€ç§å¿™ç­‰å¾…çš„é”æœºåˆ¶ã€‚é”çš„ç‰¹æ€§å°±æ˜¯åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥è·å–é”ï¼Œåœ¨ä»»ä½•æ—¶é—´ç‚¹éƒ½ä¸èƒ½æœ‰è¶…è¿‡ä¸€ä¸ªé”çš„æŒæœ‰è€…ã€‚<br>åœ¨<code>acquire</code>é‡Œé¢æœ‰ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå¾ªç¯ä¸­åˆ¤æ–­é”å¯¹è±¡çš„lockedå­—æ®µæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0é‚£è¡¨æ˜å½“å‰é”æ²¡æœ‰æŒæœ‰è€…ï¼Œå½“å‰å¯¹äº<code>acquire</code>çš„è°ƒç”¨å¯ä»¥è·å–é”ã€‚ä¹‹åæˆ‘ä»¬é€šè¿‡è®¾ç½®é”å¯¹è±¡çš„<code>locked</code>å­—æ®µä¸º1æ¥è·å–é”ã€‚æœ€åè¿”å›ã€‚</li></ul><blockquote><p>ä½†ä¸¤ä¸ªè¿›ç¨‹å¯èƒ½åŒæ—¶è¯»åˆ° locked å­—æ®µä¸º 0.</p></blockquote><p>è¿™å°±éœ€è¦åŸå­æŒ‡ä»¤ <code>test-and-set</code>ï¼Œåœ¨RISC-Vä¸Šï¼Œè¿™ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤å°±æ˜¯<code>amoswap</code>ï¼ˆatomic memory swapï¼‰ã€‚è¿™ä¸ªæŒ‡ä»¤æ¥æ”¶3ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯addressï¼Œå¯„å­˜å™¨r1ï¼Œå¯„å­˜å™¨r2ã€‚è¿™æ¡æŒ‡ä»¤ä¼šå…ˆé”å®šä½addressï¼Œå°†addressä¸­çš„æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ªä¸´æ—¶å˜é‡ä¸­ï¼ˆtmpï¼‰ï¼Œä¹‹åå°†r1ä¸­çš„æ•°æ®å†™å…¥åˆ°åœ°å€ä¸­ï¼Œä¹‹åå†å°†ä¿å­˜åœ¨ä¸´æ—¶å˜é‡ä¸­çš„æ•°æ®å†™å…¥åˆ°r2ä¸­ï¼Œæœ€åå†å¯¹äºåœ°å€è§£é”ã€‚</p><ul><li>ä»£ç å®ç°<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Mutual exclusion lock.</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> &#123;</span><br>  uint locked;       <span class="hljs-comment">// Is the lock held?</span><br><br>  <span class="hljs-comment">// For debugging:</span><br>  <span class="hljs-type">char</span> *name;        <span class="hljs-comment">// Name of lock.</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cpu</span> *<span class="hljs-title">cpu</span>;</span>   <span class="hljs-comment">// The cpu holding the lock.</span><br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spinlock *lk)</span><br>&#123;<br>  push_off(); <span class="hljs-comment">// disable interrupts to avoid deadlock.</span><br>  <span class="hljs-keyword">if</span>(holding(lk))<br>    panic(<span class="hljs-string">&quot;acquire&quot;</span>);<br><br>  <span class="hljs-comment">// On RISC-V, sync_lock_test_and_set turns into an atomic swap:</span><br>  <span class="hljs-comment">//   a5 = 1</span><br>  <span class="hljs-comment">//   s1 = &amp;lk-&gt;locked</span><br>  <span class="hljs-comment">//   amoswap.w.aq a5, a5, (s1)</span><br>  <span class="hljs-keyword">while</span>(__sync_lock_test_and_set(&amp;lk-&gt;locked, <span class="hljs-number">1</span>) != <span class="hljs-number">0</span>)<br>    ;<br><br>  <span class="hljs-comment">// Tell the C compiler and the processor to not move loads or stores</span><br>  <span class="hljs-comment">// past this point, to ensure that the critical section&#x27;s memory</span><br>  <span class="hljs-comment">// references happen strictly after the lock is acquired.</span><br>  <span class="hljs-comment">// On RISC-V, this emits a fence instruction.</span><br>  __sync_synchronize();<br><br>  <span class="hljs-comment">// Record info about lock acquisition for holding() and debugging.</span><br>  lk-&gt;cpu = mycpu();<br>&#125;<br></code></pre></td></tr></table></figure>ç”±äºå…³é—­äº†ä¸­æ–­ï¼Œæ‰€ä»¥è¿™ä¸€ä¸ªè¿›ç¨‹è¿˜æ˜¯åœ¨åŒä¸€ä¸ªCPUæ ¸ä¸Šè¿è¡Œçš„ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">holding</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> spinlock *lk)</span><br>&#123;<br>  <span class="hljs-type">int</span> r;<br>  r = (lk-&gt;locked &amp;&amp; lk-&gt;cpu == mycpu());<br>  <span class="hljs-keyword">return</span> r;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>__sync_synchronize() å‡½æ•°çš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªå†…å­˜å±éšœï¼ˆmemory barrierï¼‰æˆ–è€…ç§°ä¸ºå†…å­˜æ …æ ï¼ˆmemory fenceï¼‰ã€‚å†…å­˜å±éšœæ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºç¡®ä¿åœ¨å±éšœä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®æ“ä½œéƒ½åœ¨å±éšœä¹‹å‰å®Œæˆï¼Œå¹¶ä¸”åœ¨å±éšœä¹‹åçš„æ‰€æœ‰å†…å­˜è®¿é—®æ“ä½œéƒ½åœ¨å±éšœä¹‹åæ‰§è¡Œã€‚<br>å‘Šè¯‰ç¼–è¯‘å™¨å’Œå¤„ç†å™¨åœ¨è¯¥ç‚¹ä¹‹å‰å’Œä¹‹åçš„å†…å­˜æ“ä½œä¸èƒ½è¢«é‡æ’åºæˆ–ä¼˜åŒ–ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨è‡ªæ—‹é”çš„ä¸´ç•ŒåŒºä»£ç æ‰§è¡Œä¹‹å‰ï¼Œæ‰€æœ‰å¯¹ä¸´ç•ŒåŒºç›¸å…³çš„å†…å­˜è®¿é—®éƒ½å·²ç»å®Œæˆï¼Œè€Œåœ¨ä¸´ç•ŒåŒºä»£ç æ‰§è¡Œä¹‹åï¼Œæ‰€æœ‰å¯¹ä¸´ç•ŒåŒºç›¸å…³çš„å†…å­˜è®¿é—®éƒ½å·²ç»ç”Ÿæ•ˆã€‚</p></blockquote></li></ul><h2 id="ç¡çœ é”"><a href="#ç¡çœ é”" class="headerlink" title="ç¡çœ é”"></a>ç¡çœ é”</h2><p>xv6ä¸­è¿˜æœ‰ä¸€ç§é”æ¯”è¾ƒæœ‰è¶£ï¼Œå«åšç¡çœ é”ã€‚<br>é¦–å…ˆæˆ‘ä»¬å¾—çŸ¥é“è‡ªæ—‹é”çš„ç¼ºç‚¹æœ‰ä»€ä¹ˆã€‚</p><blockquote><p>æŒæœ‰é”çš„è¿›ç¨‹ä¸ä¼šä¸»åŠ¨å‡ºè®©CPU,å…¶ä»–è¿›ç¨‹è¦è·å–é”ï¼Œé•¿æ—¶é—´çš„è‡ªæ—‹ä¹Ÿä¼šå¼•èµ·é•¿æ—¶é—´çš„æµªè´¹ã€‚</p></blockquote><p>è¿™é‡Œæœ‰ä¸€ç§çŸ›ç›¾ï¼Œå½“æŒæœ‰é”çš„æ—¶å€™è®©å‡ºCPUç»™å…¶ä»–çº¿ç¨‹(<code>sched</code>)æ˜¯è¿æ³•çš„ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹å¦‚æœä¹Ÿè¦<code>acquire</code>è·å–è¿™æŠŠé”,å°±ä¼šå¯¼è‡´æ­»é”ã€‚åŒæ—¶ï¼Œè¿™ç§åšæ³•åŒæ ·ä¹Ÿè¿åäº†å½“è‡ªæ—‹é”è¢«æŒæœ‰çš„æ—¶å€™ä¸­æ–­å¿…é¡»å…³é—­çš„è¦æ±‚ã€‚<br>æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±è¦è®¾è®¡ä¸€ç§é”ï¼Œå®ƒåœ¨è¢«<code>acquire</code>ç­‰å¾…çš„æ—¶å€™èƒ½å¤Ÿè®©å‡ºCPU,ä»¥åŠå…è®¸æŒæœ‰è¿™ç§é”çš„æ—¶å€™è®©å‡ºå’Œä¸­æ–­çš„é”ã€‚</p><h3 id="é”™è¯¯çš„è®¾è®¡ï¼š"><a href="#é”™è¯¯çš„è®¾è®¡ï¼š" class="headerlink" title="é”™è¯¯çš„è®¾è®¡ï¼š"></a>é”™è¯¯çš„è®¾è®¡ï¼š</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">V</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> semaphore *s)</span><br>&#123;<br>    acquire(&amp;s-&gt;lock);<br>    s-&gt;count += <span class="hljs-number">1</span>;<br>    wakeup(s);             <span class="hljs-comment">// change this</span><br>    release(&amp;s-&gt;lock);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">P</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> semaphore *s)</span><br>&#123;<br>    <span class="hljs-keyword">while</span> (s-&gt;count == <span class="hljs-number">0</span>)<br>        sleep(s);          <span class="hljs-comment">// change this</span><br>    acquire(&amp;s-&gt;lock);<br>    s-&gt;count -= <span class="hljs-number">1</span>;<br>    release(&amp;s-&gt;lock);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå®ç°ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“ä¸€ä¸ªçº¿ç¨‹å‘ç°<code>count</code>ä¸º0æ—¶ï¼Œè¿˜æ²¡æ‰§è¡Œ<code>sleep</code>å‡½æ•°æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œäº†Væ“ä½œï¼Œ<code>count</code>åŠ äº†1ï¼Œ<code>wakeup</code>å†æŠŠæ‰€æœ‰çš„<code>chan</code>ä¸º<code>s</code>çš„çº¿ç¨‹çš„<code>state</code>ä»<code>sleeping</code>æ”¹ä¸º<code>runable</code>ã€‚æ¥ç€Pè¿›ç¨‹æ¥ç€æ‰§è¡Œ<code>sleep</code>å‡½æ•°ï¼ŒæŠŠè‡ªå·±çš„<code>state</code>æ”¹ä¸º<code>sleeping</code>ã€‚<br>æ‰€ä»¥è¿™å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼ŒPè¿›ç¨‹å¯èƒ½æ°¸è¿œä¸ä¼šè¢«å”¤é†’ï¼Œé™¤éVè¿›ç¨‹å†æ¬¡è°ƒç”¨äº†<code>wakeup</code>ã€‚</p><h3 id="æ”¹è¿›"><a href="#æ”¹è¿›" class="headerlink" title="æ”¹è¿›"></a>æ”¹è¿›</h3><p>ä¸Šé¢é—®é¢˜çš„æ ¹æºå°±æ˜¯Påªåœ¨<code>s-&gt;count==0</code>æ—¶ç¡çœ çš„ä¸å˜é‡è¢«æ­£åœ¨è¿è¡Œçš„Vç»™ç ´åäº†ã€‚<br>ä½†æ˜¯åˆä¸èƒ½åœ¨P<code>while</code>å¾ªç¯å‰é¢ç”³è¯·é”ï¼Œè¿™æ ·å¾ˆæ˜æ˜¾ä¼šé€ æˆæ­»é”ã€‚<br>æ­£ç¡®å®ç°ï¼š</p><blockquote><p>ä¿®æ”¹sleepæ¥å£æ¥ä¿®å¤ä¸Šè¿°æ–¹æ¡ˆï¼šè°ƒç”¨è€…å¿…é¡»ä¼ é€’ä¸€ä¸ªæ¡ä»¶é”ç»™sleepï¼Œä½¿å¾—å…¶å¯ä»¥åœ¨ç¡çœ è°ƒç”¨çš„è¿›ç¨‹å¹¶åœ¨ç¡çœ é€šé“ä¸Šç­‰å¾…æ—¶é‡Šæ”¾é”ã€‚é”ä¼šå¼ºåˆ¶å¹¶è¡Œçš„Vç­‰å¾…ç›´åˆ°På°†å®ƒè‡ªå·±ç¡çœ ï¼Œå› æ­¤wakeupä¼šæ‰¾åˆ°ä¸€ä¸ªæ­£åœ¨ç¡çœ çš„æ¶ˆè´¹è€…å¹¶å”¤é†’å®ƒã€‚ä¸€æ—¦æ¶ˆè´¹è€…è¢«å”¤é†’ï¼Œsleepå°±éœ€è¦åœ¨è¿”å›å‰å†æ¬¡è·å–é”ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Long-term locks for processes</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sleeplock</span> &#123;</span><br>  uint locked;      / Is the lock held?<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">lk</span>;</span> <span class="hljs-comment">// spinlock protecting this sleep lock</span><br>  <br>  <span class="hljs-comment">// For debugging:</span><br>  <span class="hljs-type">char</span> *name;        <span class="hljs-comment">// Name of lock.</span><br>  <span class="hljs-type">int</span> pid;           <span class="hljs-comment">// Process holding lock</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>sleeplock</code>æœ‰ä¸¤æŠŠé”ã€‚</p><p>åœ¨è¿™ä¹‹å‰ï¼Œå…ˆç®€å•äº†è§£ä¸€ä¸‹<code>sleep</code>å‡½æ•°å’Œ<code>wakeup</code>å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">sleep</span><span class="hljs-params">(<span class="hljs-type">void</span> *chan, <span class="hljs-keyword">struct</span> spinlock *lk)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  acquire(&amp;p-&gt;lock);  <span class="hljs-comment">//DOC: sleeplock1</span><br>  release(lk);<br><br>  <span class="hljs-comment">// Go to sleep.</span><br>  p-&gt;chan = chan;<br>  p-&gt;state = SLEEPING;<br><br>  sched();<br><br>  <span class="hljs-comment">// Tidy up.</span><br>  p-&gt;chan = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// Reacquire original lock.</span><br>  release(&amp;p-&gt;lock);<br>  acquire(lk);<br>&#125;<br><br><span class="hljs-comment">// Wake up all processes sleeping on chan.</span><br><span class="hljs-comment">// Must be called without any p-&gt;lock.</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">wakeup</span><span class="hljs-params">(<span class="hljs-type">void</span> *chan)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span>;</span><br><br>  <span class="hljs-keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;<br>    <span class="hljs-keyword">if</span>(p != myproc())&#123;<br>      acquire(&amp;p-&gt;lock);<br>      <span class="hljs-keyword">if</span>(p-&gt;state == SLEEPING &amp;&amp; p-&gt;chan == chan) &#123;<br>        p-&gt;state = RUNNABLE;<br>      &#125;<br>      release(&amp;p-&gt;lock);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨xv6çš„<code>proc</code>ç»“æ„ä½“ä¸­ï¼Œæœ‰ä¸€ä¸ª<code>chan</code>å­—æ®µç”¨äºå®ç°è¿›ç¨‹çš„ç­‰å¾…é€šé“çš„ã€‚å½“ä¸€ä¸ªè¿›ç¨‹éœ€è¦ç­‰å¾…æŸä¸€ä¸ªäº‹ä»¶æ—¶ï¼Œéœ€è¦æŠŠ<code>chan</code>å­—æ®µè®¾ç½®ä¸ºç›¸åº”çš„é€šé“æˆ–æ¡ä»¶ã€‚</p><p>ä¸‹é¢çœ‹<code>acquiresleep</code>å’Œ<code>releasesleep</code>å‡½æ•°çš„ä»£ç å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">acquiresleep</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sleeplock *lk)</span><br>&#123;<br>  acquire(&amp;lk-&gt;lk);<br>  <span class="hljs-keyword">while</span> (lk-&gt;locked) &#123;<br>    sleep(lk, &amp;lk-&gt;lk);<br>  &#125;<br>  lk-&gt;locked = <span class="hljs-number">1</span>;<br>  lk-&gt;pid = myproc()-&gt;pid;<br>  release(&amp;lk-&gt;lk);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">releasesleep</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sleeplock *lk)</span><br>&#123;<br>  acquire(&amp;lk-&gt;lk);<br>  lk-&gt;locked = <span class="hljs-number">0</span>;<br>  lk-&gt;pid = <span class="hljs-number">0</span>;<br>  wakeup(lk);<br>  release(&amp;lk-&gt;lk);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>acquiresleep</code>å‡½æ•°é¦–å…ˆä¼šç”³è¯·<code>lk-&gt;lk</code>è¿™æŠŠé”ï¼Œè¿™ä½¿å¾—åœ¨æ‰§è¡Œ<code>while</code>è¯­å¥çš„æ—¶å€™ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹çš„<code>wakeup</code>æ“ä½œã€‚<br><code>sleeplock</code>æœ‰ä¸€ä¸ªå­—æ®µ<code>locked</code>è¡¨ç¤ºè¿™æŠŠé”æ˜¯å¦è¢«è·å–äº†ï¼Œå¦‚æœè¢«è·å–äº†ï¼Œç›´æ¥<code>sleep</code>ç¡çœ ã€‚<code>sleeplock</code>çš„<code>lk</code>å­—æ®µå°±æ˜¯ç”¨æ¥ä¿æŠ¤å…±äº«èµ„æº<code>locked</code>çš„ï¼Œåªæœ‰åœ¨è·å–äº†<code>lk-&gt;lk</code>è¿™æŠŠé”åæ‰èƒ½å¯¹<code>locked</code>å­—æ®µè¿›è¡Œä¿®æ”¹ã€‚<br>åœ¨è¿›å…¥<code>sleep</code>å‡½æ•°çš„æ—¶å€™ï¼Œå°±å¯ä»¥é‡Šæ”¾<code>lk-&gt;lk</code>è¿™æŠŠé”ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šå°è¯•è°ƒç”¨<code>wakeup</code>,ä½†è¿›å…¥<code>sleep</code>çš„çº¿ç¨‹ä¼šäº‹å…ˆ<code>aquire(&amp;myproc-&gt;lock)</code>,<code>wakeup</code>ä¹Ÿä¼šå°è¯•è·å–çº¿ç¨‹çš„é”ï¼Œæ‰€ä»¥è¿™æ ·ä¸ä¼šå¼•èµ·å”¤é†’ä¸¢å¤±ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>MIT6.S081</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
      <tag>MIT6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sleep&amp;wakeup</title>
    <link href="/2023/08/13/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/8.sleep&amp;wakeup/"/>
    <url>/2023/08/13/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/8.sleep&amp;wakeup/</url>
    
    <content type="html"><![CDATA[<h2 id="Sleep-wakeup"><a href="#Sleep-wakeup" class="headerlink" title="Sleep &amp; wakeup"></a>Sleep &amp; wakeup</h2><p><code>sleep</code>æ˜¯å½“ä¸€ä¸ªè¿›ç¨‹åœ¨ç­‰å¾…æŸä¸€ä¸ªäº‹ä»¶æ—¶é™·å…¥ä¼‘çœ çŠ¶æ€ï¼Œå½“è¿™ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶å¦å¤–ä¸€ä¸ªè¿›ç¨‹å”¤é†’å®ƒã€‚é™·å…¥ä¼‘çœ çŠ¶æ€å¯ä»¥è®©è¿™ä¸ªè¿›ç¨‹ä¸åœ¨ç­‰å¾…çš„æ—¶å€™å ç”¨CPUèµ„æº</p><p><code>sleep(chan)</code>è®©è¿™ä¸ªè¿›ç¨‹ç¡çœ åœ¨<code>chan</code>è¿™ä¸ªwait channelä¸Šï¼Œ<code>wakeup(chan)</code>å°†æ‰€æœ‰ç¡çœ åœ¨<code>chan</code>ä¸Šçš„è¿›ç¨‹å…¨éƒ¨å”¤é†’ã€‚</p><p>lost wake-up problemï¼šå½“ä¸€ä¸ªè¿›ç¨‹Aå³å°†ç¡çœ æ—¶ï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹Bå‘ç°å·²ç»æ»¡è¶³äº†å”¤é†’å®ƒçš„æ¡ä»¶è¿›è¡Œäº†å”¤é†’ï¼Œä½†æ˜¯è¿™æ—¶è¿˜æ²¡æœ‰è¿›ç¨‹ç¡çœ åœ¨<code>chan</code>ä¸Šï¼Œå½“è¿›ç¨‹Aå¼€å§‹è¿›å…¥ç¡çœ åï¼Œè¿›ç¨‹Bå¯èƒ½ä¸ä¼šå†å¯¹è¿›ç¨‹Aè¿›è¡Œå”¤é†’ï¼Œè¿›ç¨‹Aæ°¸è¿œè¿›å…¥ç¡çœ çŠ¶æ€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">sleep</span><span class="hljs-params">(<span class="hljs-type">void</span> *chan, <span class="hljs-keyword">struct</span> spinlock *lk)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  acquire(&amp;p-&gt;lock);  <span class="hljs-comment">//DOC: sleeplock1</span><br>  release(lk);<br><br>  <span class="hljs-comment">// Go to sleep.</span><br>  p-&gt;chan = chan;<br>  p-&gt;state = SLEEPING;<br><br>  sched();<br><br>  <span class="hljs-comment">// Tidy up.</span><br>  p-&gt;chan = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// Reacquire original lock.</span><br>  release(&amp;p-&gt;lock);<br>  acquire(lk);<br>&#125;<br><br><span class="hljs-comment">// Wake up all processes sleeping on chan.</span><br><span class="hljs-comment">// Must be called without any p-&gt;lock.</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">wakeup</span><span class="hljs-params">(<span class="hljs-type">void</span> *chan)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span>;</span><br><br>  <span class="hljs-keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;<br>    <span class="hljs-keyword">if</span>(p != myproc())&#123;<br>      acquire(&amp;p-&gt;lock);<br>      <span class="hljs-keyword">if</span>(p-&gt;state == SLEEPING &amp;&amp; p-&gt;chan == chan) &#123;<br>        p-&gt;state = RUNNABLE;<br>       &#125;<br>      release(&amp;p-&gt;lock);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>sleep</code>å‡½æ•°è°ƒç”¨å‰ï¼Œé¦–å…ˆè¦è·å–<code>lk</code>è¿™æŠŠé”ï¼Œè¿™æŠŠé”æ˜¯ç”¨æ¥ä¿æŠ¤è®¿é—®çš„å…±äº«èµ„æºçš„ã€‚<code>sleep</code>æœ€åè°ƒç”¨<code>acquire(lk)</code>ä¹Ÿæ˜¯ä¸ºäº†åœ¨è¿›ç¨‹éœ€è¦è¢«å”¤é†’æ—¶ï¼Œèƒ½å¤Ÿå®‰å…¨åœ°è®¿é—®ä¹‹å‰é‡Šæ”¾çš„å…±äº«èµ„æºã€‚</p><p>ä¸‹é¢ç›´æ¥çœ‹<code>sleep</code>å’Œ<code>wakeup</code>è¿ç”¨çš„åœºæ™¯ã€‚</p><h2 id="Code-Pipes"><a href="#Code-Pipes" class="headerlink" title="Code: Pipes"></a>Code: Pipes</h2><p>æ¯ä¸€ä¸ª<code>pipe</code>éƒ½æœ‰ä¸€ä¸ª<code>struct pipe</code>ï¼ŒåŒ…æ‹¬äº†ä¸€ä¸ª<code>lock</code>å’Œä¸€ä¸ª<code>data</code>ç¼“å†²æ•°ç»„ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªè¯»å’Œä¸€ä¸ªå†™çš„ä¿¡å·é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">lock</span>;</span><br>  <span class="hljs-type">char</span> data[PIPESIZE];<br>  uint nread;     <span class="hljs-comment">// number of bytes read</span><br>  uint nwrite;    <span class="hljs-comment">// number of bytes written</span><br>  <span class="hljs-type">int</span> readopen;   <span class="hljs-comment">// read fd is still open</span><br>  <span class="hljs-type">int</span> writeopen;  <span class="hljs-comment">// write fd is still open</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>pipewrite()</code>å¾€ç®¡é“ä¸­å†™å…¥nä¸ªå­—èŠ‚ã€‚</p><p>é¦–å…ˆéœ€è¦è·å–<code>pipe</code>çš„é”ï¼Œè¿™æ˜¯ä¸ºäº†ä¿æŠ¤<code>pi</code>ç»“æ„ä½“é‡Œé¢çš„å…±äº«èµ„æºã€‚<br>é€šè¿‡<code>pi-&gt;nwrite == pi-&gt;nread+PIPESIZE</code>åˆ¤æ–­ç¼“å†²åŒºæ˜¯å¦å·²ç»æ»¡äº†ï¼Œå¦‚æœå·²ç»æ»¡äº†å°±å”¤é†’ç¡åœ¨<code>&amp;pi-&gt;nread</code>ä¸Šçš„<code>piperead</code>è¿›ç¨‹å¯¹ç¼“å†²åŒºè¿›è¡Œè¯»å–ï¼Œè‡ªå·±ç¡åœ¨<code>&amp;pi-&gt;nwrite</code>ç­‰å¾…å”¤é†’ï¼Œå¦åˆ™å°±ä»user spaceçš„<code>addr</code>ä¸­<code>copyin</code>åˆ°å†…æ ¸æ€ä¸­çš„<code>pi</code>ç¼“å†²åŒºå†…ï¼Œå®Œæˆnå­—èŠ‚çš„è¯»å–ä¹‹åå°†<code>piperead</code>è¿›ç¨‹å”¤é†’ï¼Œé‡Šæ”¾<code>&amp;pi-&gt;lock</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">pipewrite</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe *pi, uint64 addr, <span class="hljs-type">int</span> n)</span><br>&#123;<br>  <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">pr</span> =</span> myproc();<br><br>  acquire(&amp;pi-&gt;lock);<br>  <span class="hljs-keyword">while</span>(i &lt; n)&#123;<br>    <span class="hljs-keyword">if</span>(pi-&gt;readopen == <span class="hljs-number">0</span> || pr-&gt;killed)&#123;<br>      release(&amp;pi-&gt;lock);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(pi-&gt;nwrite == pi-&gt;nread + PIPESIZE)&#123; <span class="hljs-comment">//DOC: pipewrite-full</span><br>      wakeup(&amp;pi-&gt;nread);<br>      sleep(&amp;pi-&gt;nwrite, &amp;pi-&gt;lock);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-type">char</span> ch;<br>      <span class="hljs-keyword">if</span>(copyin(pr-&gt;pagetable, &amp;ch, addr + i, <span class="hljs-number">1</span>) == <span class="hljs-number">-1</span>)<br>        <span class="hljs-keyword">break</span>;<br>      pi-&gt;data[pi-&gt;nwrite++ % PIPESIZE] = ch;<br>      i++;<br>    &#125;<br>  &#125;<br>  wakeup(&amp;pi-&gt;nread);<br>  release(&amp;pi-&gt;lock);<br><br>  <span class="hljs-keyword">return</span> i;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>piperead</code>ä»ç®¡é“ä¸­è¯»å–nä¸ªå­—èŠ‚ã€‚</p><p>ä¹Ÿè¦å…ˆè·å–<code>pi-&gt;lock</code>ï¼Œåˆ¤æ–­å½“å‰ç¼“å†²åŒºå†…æ˜¯ä¸æ˜¯ç©ºçš„ï¼Œå¦‚æœæ˜¯ç©ºçš„å°±è¿›å…¥ç¡çœ ï¼Œç­‰å¾…<code>pipewrite</code>è¿›è¡Œå†™å…¥å¹¶å”¤é†’ï¼Œå¦åˆ™å¾ªç¯è¯»å–nå­—èŠ‚ç¼“å†²åŒºæ•°æ®ï¼Œå°†ç¼“å†²åŒºçš„æ•°æ®<code>copyout</code>åˆ°ç”¨æˆ·ç©ºé—´çš„<code>addr</code>åœ°å€ä¸­ï¼Œå¾…nå­—èŠ‚æ•°æ®å…¨éƒ¨è¯»å–å®Œæˆä¹‹åå°†<code>pipewrite</code>å”¤é†’ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">piperead</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe *pi, uint64 addr, <span class="hljs-type">int</span> n)</span><br>&#123;<br>  <span class="hljs-type">int</span> i;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">pr</span> =</span> myproc();<br>  <span class="hljs-type">char</span> ch;<br><br>  acquire(&amp;pi-&gt;lock);<br>  <span class="hljs-keyword">while</span>(pi-&gt;nread == pi-&gt;nwrite &amp;&amp; pi-&gt;writeopen)&#123;  <span class="hljs-comment">//DOC: pipe-empty</span><br>    <span class="hljs-keyword">if</span>(pr-&gt;killed)&#123;<br>      release(&amp;pi-&gt;lock);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    sleep(&amp;pi-&gt;nread, &amp;pi-&gt;lock); <span class="hljs-comment">//DOC: piperead-sleep</span><br>  &#125;<br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; n; i++)&#123;  <span class="hljs-comment">//DOC: piperead-copy</span><br>    <span class="hljs-keyword">if</span>(pi-&gt;nread == pi-&gt;nwrite)<br>      <span class="hljs-keyword">break</span>;<br>    ch = pi-&gt;data[pi-&gt;nread++ % PIPESIZE];<br>    <span class="hljs-keyword">if</span>(copyout(pr-&gt;pagetable, addr + i, &amp;ch, <span class="hljs-number">1</span>) == <span class="hljs-number">-1</span>)<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  wakeup(&amp;pi-&gt;nwrite);  <span class="hljs-comment">//DOC: piperead-wakeup</span><br>  release(&amp;pi-&gt;lock);<br>  <span class="hljs-keyword">return</span> i;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Code-wait-exit"><a href="#Code-wait-exit" class="headerlink" title="Code: wait &amp; exit"></a>Code: wait &amp; exit</h2><h3 id="waitä»£ç å®ç°"><a href="#waitä»£ç å®ç°" class="headerlink" title="waitä»£ç å®ç°"></a>waitä»£ç å®ç°</h3><p><code>wait</code>ä¸­æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œæ¯ä¸ªå¾ªç¯ä¸­å…ˆå¯¹æ‰€æœ‰çš„è¿›ç¨‹å¾ªç¯æŸ¥æ‰¾è‡ªå·±çš„å­è¿›ç¨‹ï¼Œå½“å‘ç°æœ‰å­è¿›ç¨‹å¹¶ä¸”å­è¿›ç¨‹çš„çŠ¶æ€ä¸º<code>ZOMBIE</code>æ—¶ï¼Œå°†å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€<code>np-&gt;xstate</code> <code>copyout</code>åˆ°<code>wait</code>ä¼ å…¥çš„ç”¨æˆ·ç©ºé—´çš„<code>addr</code>ä¸­ï¼Œç„¶åé‡Šæ”¾æ‰å­è¿›ç¨‹å ç”¨çš„æ‰€æœ‰çš„å†…å­˜ç©ºé—´ï¼Œè¿”å›å­è¿›ç¨‹çš„pidã€‚å¦‚æœæ²¡æœ‰å‘ç°ä»»ä½•<code>ZOMBIE</code>å­è¿›ç¨‹ï¼Œç¡çœ åœ¨<code>p</code>ä¸Šä»¥ç­‰å¾…å­è¿›ç¨‹<code>exit</code>æ—¶å”¤é†’<code>p</code>ã€‚</p><blockquote><p>exitå‡½æ•°ä¼šè°ƒç”¨wakeup(p-&gt;parent)å”¤é†’çˆ¶è¿›ç¨‹ã€‚</p></blockquote><p><strong>æ³¨æ„</strong>ï¼š<br><code>wait()</code>å…ˆè¦è·å–è°ƒç”¨è¿›ç¨‹çš„<code>p-&gt;lock</code>ä½œä¸º<code>sleep</code>çš„condition lockï¼Œç„¶ååœ¨å‘ç°<code>ZOMBIE</code>å­è¿›ç¨‹åè·å–å­è¿›ç¨‹çš„<code>np-&gt;lock</code>ï¼Œå› æ­¤xv6ä¸­å¿…é¡»éµå®ˆå…ˆè·å–çˆ¶è¿›ç¨‹çš„é”æ‰èƒ½è·å–å­è¿›ç¨‹çš„é”è¿™ä¸€ä¸ªè§„åˆ™ã€‚å› æ­¤åœ¨å¾ªç¯æŸ¥æ‰¾<code>np-&gt;parent == p</code>æ—¶ï¼Œä¸èƒ½å…ˆè·å–<code>np-&gt;lock</code>ï¼Œå› ä¸º<code>np</code>å¾ˆæœ‰å¯èƒ½æ˜¯è‡ªå·±çš„çˆ¶è¿›ç¨‹ï¼Œè¿™æ ·å°±è¿èƒŒäº†å…ˆè·å–çˆ¶è¿›ç¨‹é”å†è·å–å­è¿›ç¨‹é”è¿™ä¸ªè§„åˆ™ï¼Œå¯èƒ½é€ æˆæ­»é”ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">wait</span><span class="hljs-params">(uint64 addr)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">np</span>;</span><br>  <span class="hljs-type">int</span> havekids, pid;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br><br>  acquire(&amp;wait_lock);<br><br>  <span class="hljs-keyword">for</span>(;;)&#123;<br>    <span class="hljs-comment">// Scan through table looking for exited children.</span><br>    havekids = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(np = proc; np &lt; &amp;proc[NPROC]; np++)&#123;<br>      <span class="hljs-keyword">if</span>(np-&gt;parent == p)&#123;<br>        <span class="hljs-comment">// make sure the child isn&#x27;t still in exit() or swtch().</span><br>        acquire(&amp;np-&gt;lock);<br><br>        havekids = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span>(np-&gt;state == ZOMBIE)&#123;<br>          <span class="hljs-comment">// Found one.</span><br>          pid = np-&gt;pid;<br>          <span class="hljs-keyword">if</span>(addr != <span class="hljs-number">0</span> &amp;&amp; copyout(p-&gt;pagetable, addr, (<span class="hljs-type">char</span> *)&amp;np-&gt;xstate,<br>                                  <span class="hljs-keyword">sizeof</span>(np-&gt;xstate)) &lt; <span class="hljs-number">0</span>) &#123;<br>            release(&amp;np-&gt;lock);<br>            release(&amp;wait_lock);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>          &#125;<br>          freeproc(np);<br>          release(&amp;np-&gt;lock);<br>          release(&amp;wait_lock);<br>          <span class="hljs-keyword">return</span> pid;<br>        &#125;<br>        release(&amp;np-&gt;lock);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// No point waiting if we don&#x27;t have any children.</span><br>    <span class="hljs-keyword">if</span>(!havekids || p-&gt;killed)&#123;<br>      release(&amp;wait_lock);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// Wait for a child to exit.</span><br>    sleep(p, &amp;wait_lock);  <span class="hljs-comment">//DOC: wait-sleep</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="exitä»£ç å®ç°"><a href="#exitä»£ç å®ç°" class="headerlink" title="exitä»£ç å®ç°"></a>exitä»£ç å®ç°</h3><p><code>exit</code>å…³é—­æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ï¼Œå°†è‡ªå·±çš„å­è¿›ç¨‹reparentç»™<code>init</code>è¿›ç¨‹ï¼Œå› ä¸º<code>init</code>è¿›ç¨‹æ°¸è¿œåœ¨è°ƒç”¨<code>wait</code>ï¼Œè¿™æ ·å°±å¯ä»¥è®©è‡ªå·±çš„å­è¿›ç¨‹åœ¨<code>exit</code>åç”±<code>init</code>è¿›è¡Œ<code>freeproc</code>ç­‰åç»­çš„æ“ä½œã€‚ç„¶åè·å–è¿›ç¨‹é”ï¼Œè®¾ç½®é€€å‡ºçŠ¶æ€å’Œå½“å‰çŠ¶æ€ä¸º<code>ZOMBIE</code>ï¼Œè¿›å…¥<code>scheduler</code>ä¸­å¹¶ä¸”ä¸å†è¿”å›ã€‚</p><p>æ³¨æ„ï¼šåœ¨å°†<code>p-&gt;state</code>è®¾ç½®ä¸º<code>ZOMBIE</code>ä¹‹åæ‰èƒ½é‡Šæ”¾æ‰<code>wait_lock</code>ï¼Œå¦åˆ™<code>wait()</code>çš„è¿›ç¨‹è¢«å”¤é†’ä¹‹åå‘ç°äº†<code>ZOMBIE</code>è¿›ç¨‹ä¹‹åç›´æ¥å°†å…¶é‡Šæ”¾ï¼Œæ­¤æ—¶<code>ZOMBIE</code>è¿›ç¨‹è¿˜æ²¡è¿è¡Œå®Œæ¯•ã€‚</p><p><code>exit</code>æ˜¯è®©è‡ªå·±çš„ç¨‹åºè¿›è¡Œé€€å‡ºï¼Œ<code>kill</code>æ˜¯è®©ä¸€ä¸ªç¨‹åºå¼ºåˆ¶è¦æ±‚å¦ä¸€ä¸ªç¨‹åºé€€å‡ºã€‚<code>kill</code>ä¸èƒ½ç«‹åˆ»ç»ˆç»“å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œå› ä¸ºå¦ä¸€ä¸ªè¿›ç¨‹å¯èƒ½åœ¨æ‰§è¡Œæ•æ„Ÿå‘½ä»¤ï¼Œå› æ­¤killä»…ä»…è®¾ç½®äº†<code>p-&gt;killed</code>ä¸º1ï¼Œä¸”å¦‚æœè¯¥è¿›ç¨‹åœ¨ç¡çœ çŠ¶æ€åˆ™å°†å…¶å”¤é†’ã€‚å½“è¢«<code>kill</code>çš„è¿›ç¨‹è¿›å…¥<code>usertrap</code>ä¹‹åï¼Œå°†ä¼šæŸ¥çœ‹<code>p-&gt;killed</code>æ˜¯å¦ä¸º1ï¼Œå¦‚æœä¸º1åˆ™å°†è°ƒç”¨<code>exit</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">exit</span><span class="hljs-params">(<span class="hljs-type">int</span> status)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br><br>  <span class="hljs-keyword">if</span>(p == initproc)<br>    panic(<span class="hljs-string">&quot;init exiting&quot;</span>);<br><br>  <span class="hljs-comment">// Close all open files.</span><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> fd = <span class="hljs-number">0</span>; fd &lt; NOFILE; fd++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;ofile[fd])&#123;<br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span> =</span> p-&gt;ofile[fd];<br>      fileclose(f);<br>      p-&gt;ofile[fd] = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br><br>  begin_op();<br>  iput(p-&gt;cwd);<br>  end_op();<br>  p-&gt;cwd = <span class="hljs-number">0</span>;<br><br>  acquire(&amp;wait_lock);<br><br>  <span class="hljs-comment">// Give any children to init.</span><br>  reparent(p);<br><br>  <span class="hljs-comment">// Parent might be sleeping in wait().</span><br>  wakeup(p-&gt;parent);<br>  <br>  acquire(&amp;p-&gt;lock);<br><br>  p-&gt;xstate = status;<br>  p-&gt;state = ZOMBIE;<br><br>  release(&amp;wait_lock);<br><br>  <span class="hljs-comment">// Jump into the scheduler, never to return.</span><br>  sched();<br>  panic(<span class="hljs-string">&quot;zombie exit&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>MIT6.S081</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
      <tag>MIT6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç³»ç»Ÿè°ƒç”¨å’Œtrap</title>
    <link href="/2023/08/12/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/4.%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%92%8Ctrap/"/>
    <url>/2023/08/12/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/4.%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%92%8Ctrap/</url>
    
    <content type="html"><![CDATA[<h2 id="ç®€å•ä»‹ç»"><a href="#ç®€å•ä»‹ç»" class="headerlink" title="ç®€å•ä»‹ç»"></a>ç®€å•ä»‹ç»</h2><p>è¿™ç¯‡ç¬”è®°ä¸»è¦å¸®åŠ©å›é¡¾xv6æ˜¯å¦‚ä½•ç»è¿‡trapé™·å…¥åˆ°å†…æ ¸å»çš„ï¼Œä»‹ç»ç›¸å…³çš„ä»£ç çš„é‡è¦çš„ç»†èŠ‚ã€‚</p><ul><li>é‡è¦çš„å¯„å­˜å™¨</li></ul><ol><li><code>SATP</code>ï¼ˆSupervisor Address Translation and Protectionï¼‰ï¼šå®ƒåŒ…å«äº†æŒ‡å‘page tableçš„ç‰©ç†å†…å­˜åœ°å€</li><li><code>STVEC</code>ï¼ˆSupervisor Trap Vector Base Address Registerï¼‰ï¼šå®ƒæŒ‡å‘äº†å†…æ ¸ä¸­å¤„ç†trapçš„æŒ‡ä»¤çš„èµ·å§‹åœ°å€ã€‚</li><li><code>SEPC</code>ï¼ˆSupervisor Exception Program Counterï¼‰ï¼šåœ¨trapçš„è¿‡ç¨‹ä¸­ä¿å­˜ç¨‹åºè®¡æ•°å™¨çš„å€¼ã€‚</li><li><code>SSRATCH</code>ï¼ˆSupervisor Scratch Registerï¼‰å¯„å­˜å™¨ï¼šåœ¨ecallæŒ‡ä»¤å‰æŒ‡å‘çš„æ˜¯è¿›ç¨‹trapframeçš„åœ°å€<blockquote><p>trapframeåœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä½äºtrampolineçš„ä¸Šä¸€é¡µ(åœ°å€ä½äºtrampoline)ã€‚</p></blockquote></li></ol><ul><li>trap è°ƒç”¨çš„å‡½æ•°<blockquote><p>uservec -&gt; usertrap -&gt; usertrapret -&gt; userret.</p></blockquote></li></ul><h2 id="ecallæŒ‡ä»¤åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#ecallæŒ‡ä»¤åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ecallæŒ‡ä»¤åšäº†ä»€ä¹ˆï¼Ÿ"></a>ecallæŒ‡ä»¤åšäº†ä»€ä¹ˆï¼Ÿ</h2><ol><li><code>ecall</code>å°†ä»£ç ä»user modeæ”¹åˆ°supervisor modeã€‚</li><li><code>ecall</code>å°†ç¨‹åºè®¡æ•°å™¨çš„å€¼ä¿å­˜åœ¨äº†SEPCå¯„å­˜å™¨ã€‚</li><li><code>ecall</code>ä¼šè·³è½¬åˆ°STVECå¯„å­˜å™¨æŒ‡å‘çš„æŒ‡ä»¤<blockquote><p>ecallå¹¶æ²¡æœ‰åˆ‡æ¢åˆ°å†…æ ¸çš„é¡µè¡¨ã€‚ä¹Ÿæ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªå†…æ ¸æ ˆ(Cä»£ç çš„æ‰§è¡Œéœ€è¦æ ˆ)</p></blockquote></li></ol><h2 id="uservec"><a href="#uservec" class="headerlink" title="uservec"></a>uservec</h2><p>æ‰§è¡Œå®Œ<code>ecall</code>æŒ‡ä»¤ï¼Œä¼šè·³è½¬åˆ°<code>STVEC</code>æ‰€æŒ‡å‘çš„åœ°å€å¤„ï¼Œè¿™æ˜¯ä½äº<code>trampoline</code>é¡µé¢çš„ç¬¬ä¸€æ¡åœ°å€ã€‚</p><blockquote><p>å†…æ ¸å·²ç»äº‹å…ˆè®¾ç½®å¥½äº†STVECå¯„å­˜å™¨çš„å†…å®¹ä¸º0x3ffffff000ã€‚</p></blockquote><ol><li><p>é¦–å…ˆäº¤æ¢<code>a0</code>å’Œ<code>SSRATCH</code>å¯„å­˜å™¨çš„å€¼</p><blockquote><p>è…¾å‡ºä¸€ä¸ªé€šç”¨å¯„å­˜å™¨, a0æŒ‡å‘trapframe,æ³¨æ„æ­¤æ—¶è¿˜æ²¡æœ‰åˆ‡æ¢é¡µè¡¨ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asm">csrrw a0, sscratch, a0<br></code></pre></td></tr></table></figure></li><li><p>å°†å„ç§å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨trapframeä¸­ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asm">sd ra, 40(a0)<br>sd sp, 48(a0)<br>.....<br></code></pre></td></tr></table></figure></li><li><p>åœ¨trapframeä¸­è·å–ä¸€äº›ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´<code>usertrap</code>çš„åœ°å€ï¼Œ kernel stackï¼Œ current hartid</p></li><li><p>åˆ‡æ¢åˆ°å†…æ ¸çš„é¡µè¡¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asm">ld t1, 0(a0)<br>csrw satp, t1<br></code></pre></td></tr></table></figure></li><li><p>ç„¶åè·³è½¬åˆ°<code>usertrap</code>å‡½æ•°ä¸­ã€‚</p></li></ol><h2 id="usertrap"><a href="#usertrap" class="headerlink" title="usertrap"></a>usertrap</h2><p>è¿™æ—¶å€™å·²ç»åœ¨å†…æ ¸çš„é¡µè¡¨ä¸­äº†ã€‚</p><ol><li><p>æ›´æ”¹<code>stvec</code>å¯„å­˜å™¨çš„å€¼,è·å–å½“å‰è¿›ç¨‹</p><blockquote><p>trapå¦‚æœä»å†…æ ¸ç©ºé—´å‘èµ·ï¼Œå°†ä¼šæ˜¯ä¸€ä¸ªéå¸¸ä¸åŒçš„å¤„ç†æµç¨‹</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">w_stvec((uint64)kernelvec);<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br></code></pre></td></tr></table></figure><blockquote><p>myprocå‡½æ•°å®é™…ä¸Šä¼šæŸ¥æ‰¾ä¸€ä¸ªæ ¹æ®å½“å‰CPUæ ¸çš„ç¼–å·ç´¢å¼•çš„æ•°ç»„ï¼ŒCPUæ ¸çš„ç¼–å·æ˜¯hartidï¼Œå¦‚æœä½ è¿˜è®°å¾—ï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨uservecå‡½æ•°ä¸­å°†å®ƒå­˜åœ¨äº†tpå¯„å­˜å™¨ã€‚è¿™æ˜¯myprocå‡½æ•°æ‰¾å‡ºå½“å‰è¿è¡Œè¿›ç¨‹çš„æ–¹æ³•ã€‚</p></blockquote></li><li><p>ä¿å­˜pc</p><blockquote><p>ä¸­é€”å¯èƒ½åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// save user program counter.</span><br>  p-&gt;trapframe-&gt;epc = r_sepc();<br></code></pre></td></tr></table></figure></li><li><p>æ£€æŸ¥trapçš„åŸå› ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚ä¾‹å¦‚å¦‚æœæ˜¯ç³»ç»Ÿè°ƒç”¨å°±è°ƒç”¨syscallå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(r_scause() == <span class="hljs-number">8</span>)&#123;<br>    <span class="hljs-comment">// system call</span><br><br>    <span class="hljs-keyword">if</span>(p-&gt;killed)<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br><br>    <span class="hljs-comment">// sepc points to the ecall instruction,</span><br>    <span class="hljs-comment">// but we want to return to the next instruction.</span><br>    p-&gt;trapframe-&gt;epc += <span class="hljs-number">4</span>;<br><br>    <span class="hljs-comment">// an interrupt will change sstatus &amp;c registers,</span><br>    <span class="hljs-comment">// so don&#x27;t enable until done with those registers.</span><br>    intr_on();<br><br>    syscall();<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((which_dev = devintr()) != <span class="hljs-number">0</span>)&#123;<br></code></pre></td></tr></table></figure><blockquote><p>epcè¿˜éœ€è¦+4ï¼Œæ˜¯å› ä¸ºåœ¨RISC-Vä¸­ï¼Œå­˜å‚¨åœ¨SEPCå¯„å­˜å™¨ä¸­çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ˜¯ç”¨æˆ·ç¨‹åºä¸­è§¦å‘trapçš„æŒ‡ä»¤çš„åœ°å€ã€‚ä½†æ˜¯å½“æˆ‘ä»¬æ¢å¤ç”¨æˆ·ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ä¸‹ä¸€æ¡æŒ‡ä»¤æ¢å¤ï¼Œä¹Ÿå°±æ˜¯ecallä¹‹åçš„ä¸€æ¡æŒ‡ä»¤ã€‚</p></blockquote></li><li><p>è°ƒç”¨<code>usertrapret</code>å‡½æ•°</p></li></ol><h2 id="usertrapret"><a href="#usertrapret" class="headerlink" title="usertrapret"></a>usertrapret</h2><p>è¿”å›åˆ°ç”¨æˆ·ç©ºé—´ä¹‹å‰å†…æ ¸è¦åšçš„å·¥ä½œ.</p><ol><li>å…³é—­äº†ä¸­æ–­,stvecæŒ‡å‘ç”¨æˆ·ç©ºé—´çš„trapå¤„ç†ä»£ç </li><li>è®¾ç½®trapframeä¸­çš„æ•°æ®ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡ä»ç”¨æˆ·ç©ºé—´è½¬æ¢åˆ°å†…æ ¸ç©ºé—´æ—¶å¯ä»¥ç”¨åˆ°è¿™äº›æ•°æ®ã€‚</li><li>è·³è½¬åˆ°å‡½æ•°userretã€‚<blockquote><p>è¿™ä¸ªè·³è½¬æœ‰ä¸€ç‚¹ç»†èŠ‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">uint64 fn = TRAMPOLINE + (userret - trampoline);<br>((<span class="hljs-type">void</span> (*)(uint64, uint64))fn)(TRAPFRAME, satp);<br></code></pre></td></tr></table></figure><blockquote><p>é¦–å…ˆè®¡ç®—å‡º userret åœ¨trampolineé¡µé¢çš„åœ°å€ï¼Œç„¶åå†è¿›è¡Œä¸€æ¬¡å‡½æ•°è·³è½¬<br>æ­¤æ—¶<strong>a0å¯„å­˜å™¨çš„å€¼ä¸º TRAPFRAME</strong>,<strong>a1å¯„å­˜å™¨çš„å€¼ä¸ºè¿›ç¨‹çš„satp</strong>ã€‚</p></blockquote></li></ol><h2 id="userret"><a href="#userret" class="headerlink" title="userret"></a>userret</h2><blockquote><p>è¿™æ®µä»£ç ä¹Ÿåœ¨trampolineé¡µä¸­,æ‰€ä»¥åˆ‡æ¢é¡µè¡¨åpcå¹¶ä¸ä¼šå‡ºç°é”™è¯¯ã€‚</p></blockquote><ol><li><p>åˆ‡æ¢page tableã€‚</p></li><li><p>æ¢å¤å¯„å­˜å™¨ç°åœº</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asm"># put the saved user a0 in sscratch, so we<br># can swap it with our a0 (TRAPFRAME) in the last step.<br>ld t0, 112(a0)<br>csrw sscratch, t0<br><br># restore all but a0 from TRAPFRAME<br>ld ra, 40(a0)<br>ld sp, 48(a0)<br>ld gp, 56(a0)<br>.....<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶<code>sscratch</code>å¯„å­˜å™¨çš„å€¼æ˜¯ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ã€‚<br>å›é¡¾ä¸€ä¸‹ï¼Œåœ¨<code>syscall</code>å‡½æ•°ä¸­æœ‰ä¸‹é¢ä¸€è¡Œ,ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼è¦†ç›–äº†æˆ‘ä»¬ä¿å­˜åœ¨<code>trapframe</code>ä¸­çš„<code>a0</code>å¯„å­˜å™¨çš„å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/syscall.c</span><br>p-&gt;trapframe-&gt;a0 = syscalls[num]();<br></code></pre></td></tr></table></figure></li><li><p>äº¤æ¢a0å’Œsscratchçš„å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asm"># restore user a0, and save TRAPFRAME in sscratch<br>csrrw a0, sscratch, a0<br></code></pre></td></tr></table></figure><p>è¿™æ ·<code>a0</code>å°±æ˜¯ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼äº†ã€‚<code>sscratch</code>å°±æŒ‡å‘<code>trapframe</code>çš„åœ°å€äº†ã€‚</p></li><li><p>æœ€åè°ƒç”¨<code>sret</code>æŒ‡ä»¤</p></li></ol><ul><li>ç¨‹åºä¼šåˆ‡æ¢å›user mode</li><li>SEPCå¯„å­˜å™¨çš„æ•°å€¼ä¼šè¢«æ‹·è´åˆ°PCå¯„å­˜å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰</li><li>é‡æ–°æ‰“å¼€ä¸­æ–­</li></ul>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>MIT6.S081</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
      <tag>MIT6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çº¿ç¨‹åˆ‡æ¢</title>
    <link href="/2023/08/12/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/7.%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2/"/>
    <url>/2023/08/12/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/7.%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2/</url>
    
    <content type="html"><![CDATA[<h2 id="xv6ä¸­çš„çº¿ç¨‹"><a href="#xv6ä¸­çš„çº¿ç¨‹" class="headerlink" title="xv6ä¸­çš„çº¿ç¨‹"></a>xv6ä¸­çš„çº¿ç¨‹</h2><p>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¤ä¸ºæ˜¯ä¸²è¡Œæ‰§è¡Œä»£ç çš„å•å…ƒã€‚</p><ol><li>å†…æ ¸çº¿ç¨‹çš„æ¦‚å¿µï¼Œå¯¹äºæ¯ä¸ªç”¨æˆ·è¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ¥æ‰§è¡Œæ¥è‡ªç”¨æˆ·è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚æ‰€æœ‰çš„å†…æ ¸çº¿ç¨‹éƒ½å…±äº«äº†å†…æ ¸å†…å­˜ï¼Œæ‰€ä»¥XV6çš„å†…æ ¸çº¿ç¨‹çš„ç¡®ä¼šå…±äº«å†…å­˜ã€‚</li><li>æ¯ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„å†…å­˜åœ°å€ç©ºé—´ï¼Œå¹¶ä¸”åŒ…å«äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹æ§åˆ¶äº†ç”¨æˆ·è¿›ç¨‹ä»£ç æŒ‡ä»¤çš„æ‰§è¡Œã€‚æ‰€ä»¥XV6ä¸­çš„ç”¨æˆ·çº¿ç¨‹ä¹‹é—´æ²¡æœ‰å…±äº«å†…å­˜ï¼Œä½ å¯ä»¥æœ‰å¤šä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œä½†æ˜¯æ¯ä¸ªç”¨æˆ·è¿›ç¨‹éƒ½æ˜¯æ‹¥æœ‰ä¸€ä¸ªçº¿ç¨‹çš„ç‹¬ç«‹åœ°å€ç©ºé—´ã€‚XV6ä¸­çš„è¿›ç¨‹ä¸ä¼šå…±äº«å†…å­˜ã€‚<blockquote><p>åœ¨ä¸€äº›å…¶ä»–æ›´åŠ å¤æ‚çš„ç³»ç»Ÿä¸­ï¼Œä¾‹å¦‚Linuxï¼Œå…è®¸åœ¨ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ä¸­åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„åœ°å€ç©ºé—´</p></blockquote></li></ol><hr><h2 id="xv6çº¿ç¨‹è°ƒåº¦"><a href="#xv6çº¿ç¨‹è°ƒåº¦" class="headerlink" title="xv6çº¿ç¨‹è°ƒåº¦"></a>xv6çº¿ç¨‹è°ƒåº¦</h2><p><strong>æ¯ä¸ªCPUæ ¸éƒ½åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹è°ƒåº¦å™¨</strong>ã€‚<br>å¯¹äºè¿ç®—å¯†é›†å‹çº¿ç¨‹ï¼Œçº¿ç¨‹è°ƒåº¦å¯ä»¥åˆ©ç”¨å®šæ—¶å™¨ä¸­æ–­ã€‚å®šæ—¶å™¨ä¸­æ–­å¤„ç†ç¨‹åºä¼šè‡ªæ„¿çš„å°†CPUè®©å‡º(yield)ç»™çº¿ç¨‹è°ƒåº¦å™¨ï¼Œè®©å…¶ä»–çº¿ç¨‹è¿è¡Œã€‚<br>çº¿ç¨‹çŠ¶æ€ï¼š</p><ol><li>RUNNINGï¼Œçº¿ç¨‹å½“å‰æ­£åœ¨æŸä¸ªCPUä¸Šè¿è¡Œ</li><li>RUNABLEï¼Œçº¿ç¨‹è¿˜æ²¡æœ‰åœ¨æŸä¸ªCPUä¸Šè¿è¡Œï¼Œä½†æ˜¯ä¸€æ—¦æœ‰ç©ºé—²çš„CPUå°±å¯ä»¥è¿è¡Œ</li><li>SLEEPINGï¼Œè¿™ä¸ªçŠ¶æ€æ„å‘³ç€çº¿ç¨‹åœ¨ç­‰å¾…ä¸€äº›I&#x2F;Oäº‹ä»¶ï¼Œå®ƒåªä¼šåœ¨I&#x2F;Oäº‹ä»¶å‘ç”Ÿäº†ä¹‹åè¿è¡Œ</li></ol><hr><h2 id="xv6çº¿ç¨‹åˆ‡æ¢"><a href="#xv6çº¿ç¨‹åˆ‡æ¢" class="headerlink" title="xv6çº¿ç¨‹åˆ‡æ¢"></a>xv6çº¿ç¨‹åˆ‡æ¢</h2><p>ç”¨æˆ·ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œå®é™…ä¸Šæ˜¯ç”¨æˆ·è¿›ç¨‹ä¸­çš„ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹åœ¨è¿è¡Œã€‚å¦‚æœç¨‹åºæ‰§è¡Œäº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æˆ–è€…å› ä¸ºå“åº”ä¸­æ–­èµ°åˆ°äº†å†…æ ¸ä¸­ï¼Œé‚£ä¹ˆç›¸åº”çš„ç”¨æˆ·ç©ºé—´çŠ¶æ€ä¼šè¢«ä¿å­˜åœ¨ç¨‹åºçš„<code>trapframe</code>ä¸­ï¼ŒåŒæ—¶å±äºè¿™ä¸ªç”¨æˆ·ç¨‹åºçš„å†…æ ¸çº¿ç¨‹è¢«æ¿€æ´»ã€‚<br>å¦‚æœXV6å†…æ ¸å†³å®šä»ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œé‚£ä¹ˆé¦–å…ˆåœ¨å†…æ ¸ä¸­ç¬¬ä¸€ä¸ªè¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹ä¼šè¢«åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªè¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹ã€‚ä¹‹åå†åœ¨ç¬¬äºŒä¸ªè¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹ä¸­è¿”å›åˆ°ç”¨æˆ·ç©ºé—´çš„ç¬¬äºŒä¸ªè¿›ç¨‹ï¼Œè¿™é‡Œè¿”å›åˆ°ç”¨æˆ·ç©ºé—´ä¹Ÿæ˜¯é€šè¿‡æ¢å¤<code>trapframe</code>å®Œæˆçš„ã€‚</p><p>å®Œæ•´è¿‡ç¨‹ï¼ˆä»¥æ—¶é’Ÿåˆ‡æ¢ä¸ºä¾‹ï¼‰ï¼š</p><ol><li>å®šæ—¶å™¨ä¸­æ–­å¼ºè¿«CPUä»ç”¨æˆ·ç©ºé—´åˆ‡æ¢åˆ°å†…æ ¸ï¼Œç”¨æˆ·ç©ºé—´çš„ä»£ç ä¿å­˜åœ¨<code>trapframe</code>ä¸­ã€‚</li><li>å†…æ ¸è¿è¡Œ<code>usertrap</code>ï¼Œè¿™æ—¶å€™è¿è¡Œçš„æ˜¯è¿›ç¨‹1çš„å†…æ ¸çº¿ç¨‹ã€‚</li><li>è°ƒç”¨<code>swtch</code>å‡½æ•°ï¼Œä¿å­˜è¿›ç¨‹1çš„å†…æ ¸çº¿ç¨‹å¯„å­˜å™¨åˆ°<code>context</code>å¯¹è±¡ï¼Œåœ¨<code>proc</code>ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ª<code>context</code>ã€‚(ç”¨æˆ·å¯„å­˜å™¨åœ¨<code>trapframe</code>ï¼Œå†…æ ¸çº¿ç¨‹å¯„å­˜å™¨åœ¨<code>context</code>)ã€‚</li><li><code>swtch</code>å‡½æ•°æ¢å¤åŸæ¥åœ¨è¿™ä¸ªCPUä¸Šçš„è°ƒåº¦å™¨çº¿ç¨‹ä¿å­˜çš„å¯„å­˜å™¨å’Œstack pointer,<code>swtch</code>å‡½æ•°è¿”å›åï¼ŒCPUå¯„å­˜å™¨è¢«è®¾ç½®ä¸ºè°ƒåº¦å™¨çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åå°±åœ¨è°ƒåº¦ä¸‹çº¿ç¨‹çš„contextä¸‹æ‰§è¡Œ<code>scheduler</code>å‡½æ•°ã€‚</li><li><code>scheduler</code>å‡½æ•°æŠŠP1è®¾ç½®æˆRUNABLEçŠ¶æ€ï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ªRUNABLEè¿›ç¨‹ï¼Œå†æ¬¡è°ƒç”¨<code>swtch</code>å‡½æ•°, <code>swtch</code>å‡½æ•°å®Œæˆåï¼Œè¿”å›åˆ°äº†æ–°çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ã€‚<blockquote><p>æ•´ä¸ªxv6ä¸­ä¸€ä¸ªCPUæ ¸å¯¹åº”ä¸€ä¸ªå†…æ ¸è°ƒåº¦çº¿ç¨‹ï¼Œå®ƒåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆ›å»ºã€‚è¿™ä¸ªå†…æ ¸è°ƒåº¦çº¿ç¨‹æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå®ƒä¸æ–­åœ°é€‰æ‹©å¯è¿è¡Œçš„è¿›ç¨‹å¹¶è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥å®ç°å¤šè¿›ç¨‹å¹¶å‘ã€‚XV6çš„start.sæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä¸ºæ¯ä¸ªCPUæ ¸è®¾ç½®å¥½è°ƒåº¦å™¨çº¿ç¨‹ã€‚</p></blockquote></li></ol><hr><h2 id="ä»£ç è®²è§£"><a href="#ä»£ç è®²è§£" class="headerlink" title="ä»£ç è®²è§£"></a>ä»£ç è®²è§£</h2><h3 id="yieldå‡½æ•°"><a href="#yieldå‡½æ•°" class="headerlink" title="yieldå‡½æ•°"></a>yieldå‡½æ•°</h3><p><code>yield</code>æ˜¯çº¿ç¨‹åˆ‡æ¢çš„ç¬¬ä¸€æ­¥ã€‚å½“è§¦å‘æ—¶é’Ÿä¸­æ–­æ—¶ï¼Œä¼šè°ƒç”¨<code>yield</code>å‡½æ•°ï¼Œå½“å‰è¿›ç¨‹ä¼šå‡ºè®©CPUå¹¶è®©å¦ä¸€ä¸ªè¿›ç¨‹è¿è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">yield</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  acquire(&amp;p-&gt;lock);<br>  p-&gt;state = RUNNABLE;<br>  sched();<br>  release(&amp;p-&gt;lock);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦å†…å®¹æ˜¯åŠ é”ï¼Œé˜²æ­¢ä¸€ä¸ªçº¿ç¨‹åœ¨å¤šä¸ªCPUæ ¸ä¸Šè¢«è°ƒåº¦ã€‚å°†è¿›ç¨‹çš„çŠ¶æ€æ”¹ä¸ºRUNABLEï¼Œè¡¨ç¤ºè®©å‡ºCPUï¼Œéšåæ‰§è¡Œ<code>sched</code>å‡½æ•°ã€‚</p><h3 id="schedå‡½æ•°"><a href="#schedå‡½æ•°" class="headerlink" title="schedå‡½æ•°"></a>schedå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">sched</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>  <span class="hljs-type">int</span> intena;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br><br>  <span class="hljs-keyword">if</span>(!holding(&amp;p-&gt;lock))<br>    panic(<span class="hljs-string">&quot;sched p-&gt;lock&quot;</span>);<br>  <span class="hljs-keyword">if</span>(mycpu()-&gt;noff != <span class="hljs-number">1</span>)<br>    panic(<span class="hljs-string">&quot;sched locks&quot;</span>);<br>  <span class="hljs-keyword">if</span>(p-&gt;state == RUNNING)<br>    panic(<span class="hljs-string">&quot;sched running&quot;</span>);<br>  <span class="hljs-keyword">if</span>(intr_get())<br>    panic(<span class="hljs-string">&quot;sched interruptible&quot;</span>);<br><br>  intena = mycpu()-&gt;intena;<br>  swtch(&amp;p-&gt;context, &amp;mycpu()-&gt;context);<br>  mycpu()-&gt;intena = intena;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="swtchå‡½æ•°"><a href="#swtchå‡½æ•°" class="headerlink" title="swtchå‡½æ•°"></a>swtchå‡½æ•°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asm">.globl swtch<br>swtch:<br>        sd ra, 0(a0)<br>        ....çœç•¥<br><br>        ld ra, 0(a1)<br>        ....çœç•¥<br>        ret<br></code></pre></td></tr></table></figure><blockquote><p>a0æ˜¯p-&gt;contextçš„åœ°å€ï¼Œa1æ˜¯cpuä¸­çš„contextç»“æ„ä½“åœ°å€</p></blockquote><ol><li>ä¼šå°†å½“å‰çš„å†…æ ¸çº¿ç¨‹çš„å¯„å­˜å™¨(ra,sp,s0ç­‰)ä¿å­˜åˆ°p-&gt;contextä¸­,procç»“æ„ä½“ä¸­çš„contextå­—æ®µå°±æ˜¯ç”¨æ¥ä¿å­˜è¯¥è¿›ç¨‹å†…æ ¸çº¿ç¨‹å¯„å­˜å™¨çš„ã€‚</li><li>ç„¶åä¼šæŠŠcpuä¸­çš„contextèµ‹å€¼ç»™(ra,sp,s0)ç­‰å¯„å­˜å™¨<blockquote><p><strong>CPUç»“æ„ä½“ä¸­çš„contextä¿å­˜äº†å½“å‰CPUæ ¸çš„è°ƒåº¦å™¨çº¿ç¨‹çš„å¯„å­˜å™¨!!!</strong><br>å†…æ ¸è°ƒåº¦çº¿ç¨‹æ²¡æœ‰è¿›ç¨‹ä¸ä¹‹å¯¹åº”ï¼Œå¹¶ä¸”ä¸€ä¸ªCPUæ ¸åªæœ‰ä¸€ä¸ªå†…æ ¸è°ƒåº¦çº¿ç¨‹ï¼Œæ‰€ä»¥æŠŠå®ƒæ‰€éœ€è¦çš„contextç›´æ¥æ”¾åˆ°äº†cpuçš„contextç»“æ„ä½“ä¸­ä¿å­˜ã€‚è€Œcpuä¸­contextç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªè¿”å›åœ°å€ä¸€å®šå°±æ˜¯schedulerå‡½æ•°çš„æŸä¸€æ¡æŒ‡ä»¤ã€‚</p></blockquote></li></ol><ul><li><p>swtchå‡½æ•°ä¸­åªä¿å­˜å¹¶æ¢å¤äº†14ä¸ªå¯„å­˜å™¨</p><blockquote><p><strong>switchæ˜¯æŒ‰ç…§ä¸€ä¸ªæ™®é€šå‡½æ•°æ¥è°ƒç”¨çš„</strong>ï¼Œå¯¹äºæœ‰äº›å¯„å­˜å™¨ï¼Œ<code>swtch</code>å‡½æ•°çš„è°ƒç”¨è€…é»˜è®¤<code>swtch</code>å‡½æ•°ä¼šåšä¿®æ”¹ï¼Œæ‰€ä»¥è°ƒç”¨è€…å·²ç»åœ¨è‡ªå·±çš„æ ˆä¸Šä¿å­˜äº†è¿™äº›å¯„å­˜å™¨ï¼Œå½“å‡½æ•°è¿”å›æ—¶ï¼Œè¿™äº›å¯„å­˜å™¨ä¼šè‡ªåŠ¨æ¢å¤ã€‚æ‰€ä»¥<code>swtch</code> å‡½æ•°é‡Œåªéœ€è¦ä¿å­˜Callee Saved Registerå°±è¡Œã€‚</p></blockquote></li><li><p>è¿”å›åœ°å€çš„å¦™ç”¨</p><blockquote><p>æ­£å› ä¸ºswitchæ˜¯æŒ‰ç…§ä¸€ä¸ªæ™®é€šå‡½æ•°æ¥è°ƒç”¨çš„ï¼Œåœ¨è¿™é‡Œï¼Œæ‰€ä»¥<code>ra</code>å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯å†…æ ¸çº¿ç¨‹1çš„è¿”å›åœ°å€ï¼Œéšå<code>ld ra, 0(a1)</code>æŒ‡ä»¤ï¼Œ<strong>æŠŠè¿”å›åœ°å€ç»™æ¢äº†</strong>ï¼Œæ¢æˆäº†CPUå¤„ç†å™¨è°ƒåº¦å™¨çº¿ç¨‹çš„è¿”å›åœ°å€ï¼Œä»¥åŠåé¢çš„ä¸€äº›ä¸Šä¸‹æ–‡ã€‚éšå<code>swtch</code>å‡½æ•°å®Œæˆåï¼Œè¿”å›åˆ°äº†<code>scheduler</code>å‡½æ•°ã€‚</p></blockquote></li></ul><h3 id="schedulerå‡½æ•°"><a href="#schedulerå‡½æ•°" class="headerlink" title="schedulerå‡½æ•°"></a>schedulerå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">scheduler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cpu</span> *<span class="hljs-title">c</span> =</span> mycpu();<br><br>  c-&gt;proc = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (;;)<br>  &#123;<br>    <span class="hljs-comment">// Avoid deadlock by ensuring that devices can interrupt.</span><br>    intr_on();<br><br>    <span class="hljs-keyword">for</span> (p = proc; p &lt; &amp;proc[NPROC]; p++)<br>    &#123;<br>      acquire(&amp;p-&gt;lock);<br>      <span class="hljs-keyword">if</span> (p-&gt;state == RUNNABLE)<br>      &#123;<br>        <span class="hljs-comment">// Switch to chosen process.  It is the process&#x27;s job</span><br>        <span class="hljs-comment">// to release its lock and then reacquire it</span><br>        <span class="hljs-comment">// before jumping back to us.</span><br>        p-&gt;state = RUNNING;<br>        c-&gt;proc = p;<br>        swtch(&amp;c-&gt;context, &amp;p-&gt;context);<br><br>        <span class="hljs-comment">// Process is done running for now.</span><br>        <span class="hljs-comment">// It should have changed its p-&gt;state before coming back.</span><br>        c-&gt;proc = <span class="hljs-number">0</span>;<br>      &#125;<br>      release(&amp;p-&gt;lock);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒåº¦å™¨çº¿ç¨‹åœ¨<code>scheduler</code>å‡½æ•°ä¸­ä¹Ÿä¼šè°ƒç”¨äº†<code>swtch</code>å‡½æ•°ï¼ŒåŒæ ·çš„ï¼Œå®ƒæŠŠCPUä¸Šå¯„å­˜å™¨æ¢æˆäº†æ–°çº¿ç¨‹çš„ï¼Œå¹¶æŠŠè°ƒåº¦å™¨çº¿ç¨‹çš„å¯„å­˜å™¨ä¿å­˜åˆ°äº†<code>mycpu()-&gt;context</code>ä¸­ã€‚æ‰€ä»¥æˆ‘ä»¬ä»<code>swtch</code>å‡½æ•°è¿”å›æ—¶ï¼Œå¦‚æœä¸è€ƒè™‘è°ƒåº¦å™¨çº¿ç¨‹åœ¨é‡Œé¢çš„ä½œç”¨ï¼Œå®é™…ä¸Šæ˜¯è¿”å›åˆ°äº†å¯¹äº<code>switch</code>çš„å¦ä¸€ä¸ªè°ƒç”¨ï¼Œè€Œä¸æ˜¯è°ƒåº¦å™¨çº¿ç¨‹ä¸­çš„è°ƒç”¨ã€‚<strong>æˆ‘ä»¬è¿”å›åˆ°çš„æ˜¯è°ƒåº¦åˆ°çš„æ–°è¿›ç¨‹åœ¨å¾ˆä¹…ä¹‹å‰å¯¹äºswitchçš„è°ƒç”¨</strong>ã€‚è¿™å°±æ˜¯çº¿ç¨‹åˆ‡æ¢çš„æ ¸å¿ƒã€‚</p><blockquote><p>åœ¨è¯¾ç¨‹çš„ç¤ºä¾‹ä¸­ï¼ŒP1çº¿ç¨‹ç”±äºå®šæ—¶å™¨çš„ä¸­æ–­è€Œè¢«è°ƒåº¦ï¼Œæ‰§è¡Œ<code>yield</code>å‡½æ•°ï¼Œ<code>sched</code>å‡½æ•°ï¼Œ<code>swtch</code>å‡½æ•°åè€Œè¢«é˜»å¡ã€‚å‡è®¾P2çº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼ŒéšåP2çº¿ç¨‹ä¹Ÿç»è¿‡åŒæ ·çš„è¿‡ç¨‹å†æ‰§è¡Œè°ƒåº¦çº¿ç¨‹ï¼Œå†æ‰§è¡ŒP1,P1è¢«å”¤é†’çš„åˆšå¼€å§‹æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€å°±æ˜¯<code>sched</code>å‡½æ•°ä¸­çš„<code>swtch</code>çš„è¿”å›åœ°å€ã€‚<br>å¦‚æœä¸æ˜¯å› ä¸ºå®šæ—¶å™¨ä¸­æ–­å‘ç”Ÿçš„åˆ‡æ¢ï¼Œraå¯„å­˜å™¨å¯èƒ½æŒ‡å‘å…¶ä»–ä½ç½®ã€‚</p></blockquote><p>schedulerå‡½æ•°åˆä¼šè°ƒç”¨swtchå‡½æ•°ï¼Œä½†å‚æ•°ç¨æœ‰ä¸åŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">p-&gt;state = RUNNING;<br>c-&gt;proc = p;<br>swtch(&amp;c-&gt;context, &amp;p-&gt;context);<br></code></pre></td></tr></table></figure><blockquote><p>è¿™æ ·å°±æŠŠå½“å‰è°ƒåº¦å™¨çº¿ç¨‹çš„å¯„å­˜å™¨ä¼ å…¥cpuçš„contextç»“æ„ä½“ä¸­ã€‚å†æŠŠå¯„å­˜å™¨çš„å€¼æ¢æˆè°ƒåº¦çš„æ–°è¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹çš„contextã€‚</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>MIT6.S081</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
      <tag>MIT6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ–‡ä»¶ç³»ç»Ÿå±‚çº§ç»“æ„</title>
    <link href="/2023/08/08/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/9.%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84/"/>
    <url>/2023/08/08/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MIT6.S081/9.%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h2 id="1-æ–‡ä»¶ç³»ç»Ÿç»„ç»‡æ¶æ„"><a href="#1-æ–‡ä»¶ç³»ç»Ÿç»„ç»‡æ¶æ„" class="headerlink" title="1.æ–‡ä»¶ç³»ç»Ÿç»„ç»‡æ¶æ„"></a>1.æ–‡ä»¶ç³»ç»Ÿç»„ç»‡æ¶æ„</h2><p><img src="https://fanxiao.tech/img/posts/MIT_6S081/image-20210207194130429.png" alt="image-20210207194130429"></p><ul><li><p><code>disk</code>å±‚ï¼šå¯¹ç¡¬ç›˜ä¸Šçš„å—è¿›è¡Œè¯»å†™æ“ä½œ</p></li><li><p><code>buffer cache</code>å±‚ï¼šåœ¨å†…å­˜ä¸­å¯¹ç£ç›˜å—è¿›è¡Œç¼“å­˜ï¼Œå¹¶ç¡®ä¿åªæœ‰1ä¸ªå†…æ ¸è¿›ç¨‹èƒ½åœ¨ä¸€æ®µæ—¶é—´å†…ä¿®æ”¹æ–‡ä»¶å—ä¸Šå­˜å‚¨çš„æ•°æ®ã€‚</p></li><li><p><code>logging</code>å±‚ï¼šè®©æ›´é«˜çš„å±‚çº§èƒ½å¤Ÿå°†å¯¹æ–‡ä»¶å—çš„æ‰€æœ‰<code>update</code>æ‰“åŒ…åˆ°ä¸€ä¸ª<code>transaction</code>ä¸­ï¼Œä»è€Œèƒ½ä¿è¯æ‰€æœ‰æ–‡ä»¶å—èƒ½å¤Ÿåœ¨å°†è¦å´©æºƒæ—¶åŸå­åœ°è¿›è¡Œ<code>update</code></p></li><li><p><code>inode</code>å±‚ï¼šä¸ºæ¯ä¸ªæ–‡ä»¶æä¾›ç‹¬ä¸€æ— äºŒçš„inode number</p></li><li><p><code>directory</code>å±‚ï¼šæ¯ä¸ªæ–‡ä»¶å¤¹ä¹Ÿä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„inodeç»“æ„ä½“ï¼Œä¸è¿‡å†…å®¹æ˜¯ä¸€æ¡ä¸€æ¡çš„entry</p></li><li><p><code>pathname</code>å±‚ï¼šå°†æ–‡ä»¶å¤¹ç»„ç»‡ä¸ºå±‚çº§ï¼Œè§£æè·¯å¾„ã€</p></li><li><p><code>file descriptor</code>å±‚ï¼šå°†æ‰€æœ‰çš„èµ„æºéƒ½æŠ½è±¡ä¸º<code>struct file</code>,å¦‚è®¾å¤‡ï¼Œæ–‡æœ¬æ–‡ä»¶ï¼Œç®¡é“ç­‰</p><hr></li></ul><h2 id="2-Disk-å±‚"><a href="#2-Disk-å±‚" class="headerlink" title="2.Disk å±‚"></a>2.Disk å±‚</h2><p>xv6æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜å—å¸ƒå±€å¦‚ä¸‹ï¼š</p><p><img src="https://fanxiao.tech/img/posts/MIT_6S081/image-20210207200046544.png" alt="image-20210207200046544"></p><ul><li><p><code>block 0</code>ï¼šå¯åŠ¨åŒºåŸŸï¼Œæ–‡ä»¶ç³»ç»Ÿä¸ä¼šä½¿ç”¨ï¼ŒåŒ…å«äº†æ“ä½œç³»ç»Ÿå¯åŠ¨æ‰€éœ€è¦çš„ä»£ç </p></li><li><p><code>blcok 1</code>: <code>superblock</code>ï¼Œå­˜å‚¨äº†æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ï¼ˆblockçš„å¤§å°ã€blockçš„æ•°ç›®ã€inodeçš„æ•°ç›®ç­‰ï¼‰ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªmkfsçš„ç¨‹åºï¼Œç”¨æ¥æ„å»ºåˆå§‹çš„æ–‡ä»¶ç³»ç»Ÿ</p></li><li><p><code>block 2-31</code>ï¼š<code>log block</code></p></li><li><p><code>block 32-44</code>: <code>inode</code>ï¼Œä¸€ä¸ª<code>inode</code>çš„å¤§å°ä¸º64å­—èŠ‚ï¼Œä¸€ä¸ª<code>block</code>çš„å¤§å°ä¸º1024å­—èŠ‚ï¼Œå› æ­¤<code>block32</code>ä¸º<code>inode 1-16</code>ï¼Œblock33ä¸º<code>inode 17-32</code></p></li><li><p><code>block 45 bitmap block</code>ï¼Œç”¨æ¥è·Ÿè¸ªå“ªäº›<code>block</code>æ˜¯åœ¨ä½¿ç”¨</p></li><li><p>æœ€åä»<code>block 46</code>å¼€å§‹æ˜¯<code>data block</code>ï¼Œè¦ä¹ˆæ˜¯åœ¨<code>bitmap</code>ä¸­è¢«æ ‡è®°ä¸ºç©ºé—²çŠ¶æ€ï¼Œè¦ä¹ˆå­˜å‚¨äº†æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹çš„å†…å®¹</p><hr></li></ul><h2 id="3-Buffer-cacheå±‚"><a href="#3-Buffer-cacheå±‚" class="headerlink" title="3.Buffer cacheå±‚"></a>3.Buffer cacheå±‚</h2><h3 id="buffer-cacheå±‚çš„ä½œç”¨"><a href="#buffer-cacheå±‚çš„ä½œç”¨" class="headerlink" title="buffer cacheå±‚çš„ä½œç”¨"></a>buffer cacheå±‚çš„ä½œç”¨</h3><ol><li>å°†å¯¹ç£ç›˜å—çš„è®¿é—®æƒé™è¿›è¡ŒåŒæ­¥ï¼Œä¿è¯å†…å­˜ä¸­åªä¿å­˜ä¸€ä¸ªè¯¥ç£ç›˜å—çš„æ‹·è´ï¼Œä¸”ä¸€æ¬¡åªæœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹è®¿é—®è¿™ä¸ªæ‹·è´ï¼Œä½†åŒæ—¶å¯ä»¥æœ‰å¤šä¸ªå¯¹è¿™ä¸ª<code>block</code>çš„å¼•ç”¨</li><li>å°†è¢«é¢‘ç¹è®¿é—®çš„å—ç¼“å­˜åˆ°å†…å­˜ä¸­(å±€éƒ¨æ€§åŸç†)</li></ol><h3 id="ä»£ç è§£æ"><a href="#ä»£ç è§£æ" class="headerlink" title="ä»£ç è§£æ"></a>ä»£ç è§£æ</h3><p><code>bcache</code>å°±æ˜¯å†…å­˜ä¸­å¯¹ç¡¬ç›˜<code>block</code>çš„ç¼“å†²ï¼Œ<code>head</code>çš„ä½œç”¨æ˜¯æŠŠ<code>bcache</code>ç»„ç»‡ä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œç¼“å†²åŒºçš„ä½¿ç”¨æ—©æ™šå°±æ˜¯é€šè¿‡<code>head</code>æ¥åˆ¤æ–­çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">lock</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> <span class="hljs-title">buf</span>[<span class="hljs-title">NBUF</span>];</span><br><br>  <span class="hljs-comment">// Linked list of all buffers, through prev/next.</span><br>  <span class="hljs-comment">// Sorted by how recently the buffer was used.</span><br>  <span class="hljs-comment">// head.next is most recent, head.prev is least.</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> <span class="hljs-title">head</span>;</span><br>&#125; bcache;<br></code></pre></td></tr></table></figure><p>buffer cacheæœ‰ä¸¤ä¸ªæ¥å£ï¼Œåˆ†åˆ«æ˜¯<code>bread()</code>å’Œ<code>bwrite()</code>ã€‚<br><code>bread</code>é€šè¿‡<code>bget</code>è·å–ä¸€ä¸ªæŒ‡å®šäº†è®¾å¤‡<code>dev</code>å’Œ<code>blockno</code>çš„<code>buf *</code>ï¼Œè¿™æ˜¯ä»ç¡¬ç›˜æŒ‡å®šçš„å—ä¸­è·å–çš„ä¸€ä¸ªç¼“å†²æ•°æ®ç»“æ„ä½“ã€‚<code>valid</code>è¡¨ç¤ºçš„æ˜¯å†…å­˜ä¸­çš„æŸä¸ª<code>block</code>æœ‰æ— ç£ç›˜å—çš„ä¸€ä»½æ‹·è´ï¼Œå¦‚æœæ²¡æœ‰å°±è¦è°ƒç”¨<code>virtio_disk_rw</code>å‡½æ•°ä»ç£ç›˜å†™åˆ°å†…å­˜ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> buf*<br><span class="hljs-title function_">bread</span><span class="hljs-params">(uint dev, uint blockno)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">b</span>;</span><br><br>  b = bget(dev, blockno);<br>  <span class="hljs-keyword">if</span>(!b-&gt;valid) &#123;<br>    virtio_disk_rw(b, <span class="hljs-number">0</span>);<br>    b-&gt;valid = <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> b;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯ä»¥å…è®¸å¤šä¸ªæ–‡ä»¶æŒ‡å‘å†…å­˜ä¸­åŒä¸€ä¸ª<code>buffer</code>ï¼Œè¿™é‡Œçš„æ›¿æ¢ç®—æ³•ä¹Ÿæ˜¯ç›¸å½“ç®€å•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> buf*<br><span class="hljs-title function_">bget</span><span class="hljs-params">(uint dev, uint blockno)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">b</span>;</span><br><br>  acquire(&amp;bcache.lock);<br><br>  <span class="hljs-comment">// Is the block already cached?</span><br>  <span class="hljs-keyword">for</span>(b = bcache.head.next; b != &amp;bcache.head; b = b-&gt;next)&#123;<br>    <span class="hljs-keyword">if</span>(b-&gt;dev == dev &amp;&amp; b-&gt;blockno == blockno)&#123;<br>      b-&gt;refcnt++;<br>      release(&amp;bcache.lock);<br>      acquiresleep(&amp;b-&gt;lock);<br>      <span class="hljs-keyword">return</span> b;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Not cached.</span><br>  <span class="hljs-comment">// Recycle the least recently used (LRU) unused buffer.</span><br>  <span class="hljs-keyword">for</span>(b = bcache.head.prev; b != &amp;bcache.head; b = b-&gt;prev)&#123;<br>    <span class="hljs-keyword">if</span>(b-&gt;refcnt == <span class="hljs-number">0</span>) &#123;<br>      b-&gt;dev = dev;<br>      b-&gt;blockno = blockno;<br>      b-&gt;valid = <span class="hljs-number">0</span>;<br>      b-&gt;refcnt = <span class="hljs-number">1</span>;<br>      release(&amp;bcache.lock);<br>      acquiresleep(&amp;b-&gt;lock);<br>      <span class="hljs-keyword">return</span> b;<br>    &#125;<br>  &#125;<br>  panic(<span class="hljs-string">&quot;bget: no buffers&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ä¸ºä»€ä¹ˆè¦<code>acquiresleep</code>?<blockquote><p>è·å–è¿™ä¸ªé”ä¹‹åç«‹å³è®©è¿™ä¸ªè¿›ç¨‹è¿›å…¥ç¡çœ ï¼Œä¸€æ—¦è¿™ä¸ªé”å¯ç”¨ï¼Œè¯¥çº¿ç¨‹å°±ä¼šç«‹åˆ»è¢«å”¤é†’ã€‚</p></blockquote></li></ul><p><code>bwrite</code>æ˜¯å‘ç¡¬ç›˜æŒ‡å®šå—å†™å…¥æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">bwrite</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> buf *b)</span><br>&#123;<br>  <span class="hljs-keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))<br>    panic(<span class="hljs-string">&quot;bwrite&quot;</span>);<br>  virtio_disk_rw(b, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>brelse</code>æ˜¯é‡Šæ”¾æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">brelse</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> buf *b)</span><br>&#123;<br>  <span class="hljs-keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))<br>    panic(<span class="hljs-string">&quot;brelse&quot;</span>);<br><br>  releasesleep(&amp;b-&gt;lock);<br><br>  acquire(&amp;bcache.lock);<br>  b-&gt;refcnt--;<br>  <span class="hljs-keyword">if</span> (b-&gt;refcnt == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// no one is waiting for it.</span><br>    b-&gt;next-&gt;prev = b-&gt;prev;<br>    b-&gt;prev-&gt;next = b-&gt;next;<br>    b-&gt;next = bcache.head.next;<br>    b-&gt;prev = &amp;bcache.head;<br>    bcache.head.next-&gt;prev = b;<br>    bcache.head.next = b;<br>  &#125;<br>  <br>  release(&amp;bcache.lock);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="4-Block-å±‚"><a href="#4-Block-å±‚" class="headerlink" title="4.Block å±‚"></a>4.Block å±‚</h2><p>block allocatorä¸ºç£ç›˜çš„æ˜¯å¦ç©ºé—²çš„çŠ¶æ€å‡†å¤‡äº†ä¸€ä¸ªbitmapï¼Œæ¯ä¸€ä½å¯¹åº”ä¸€ä¸ªç£ç›˜å—ï¼Œ0è¡¨ç¤ºç©ºé—²1è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨ï¼Œ<code>mkfs</code>è´Ÿè´£è®¾ç½®è¿™äº›ä½ã€‚</p><p><code>sb</code>æ˜¯ä¸€ä¸ªsuper block,å®ƒè®°å½•äº†æ–‡ä»¶ç³»ç»Ÿä¸€äº›åŸºæœ¬ä¿¡æ¯ã€‚<br><code>BBLOCK</code>å®æ˜¯åˆ¤æ–­æŸä¸ªé€»è¾‘å—å·çš„ä¿¡æ¯åœ¨å“ªä¸ª<code>bitmap</code>å—ä¸­ã€‚<br>ä¸€ä¸ª<code>bitmap</code>å—ä¸­ï¼Œæ€»å…±ç”¨<code>BSIZE</code>ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯<code>BPB</code>ä¸ªbitã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPB           (BSIZE*8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BBLOCK(b, sb) ((b)/BPB + sb.bmapstart)</span><br></code></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä»£ç ä¸­<code>bp</code>æ˜¯è·å–åˆ°çš„<code>bitmap</code>å—ï¼Œä¸€ä¸ª<code>bitmap</code>çš„æ¯ä¸€ä¸ªbitéƒ½ç”¨æ¥æ ‡è®°è¯¥<code>blockno</code>æ˜¯ä¸æ˜¯ç©ºé—²çš„ã€‚<code>b</code>æ˜¯éå†åˆ°çš„ä½å›¾çš„ç¬¬0ä¸ªbitè¡¨ç¤ºçš„é€»è¾‘å—å·ã€‚<code>bi</code>å°±æ˜¯åç§»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> uint<br><span class="hljs-title function_">balloc</span><span class="hljs-params">(uint dev)</span><br>&#123;<br>  <span class="hljs-type">int</span> b, bi, m;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bp</span>;</span><br><br>  bp = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span>(b = <span class="hljs-number">0</span>; b &lt; sb.size; b += BPB)&#123;<br>    bp = bread(dev, BBLOCK(b, sb));<br>    <span class="hljs-keyword">for</span>(bi = <span class="hljs-number">0</span>; bi &lt; BPB &amp;&amp; b + bi &lt; sb.size; bi++)&#123;<br>      m = <span class="hljs-number">1</span> &lt;&lt; (bi % <span class="hljs-number">8</span>);<br>      <span class="hljs-keyword">if</span>((bp-&gt;data[bi/<span class="hljs-number">8</span>] &amp; m) == <span class="hljs-number">0</span>)&#123;  <span class="hljs-comment">// Is block free?</span><br>        bp-&gt;data[bi/<span class="hljs-number">8</span>] |= m;  <span class="hljs-comment">// Mark block in use.</span><br>        log_write(bp);<br>        brelse(bp);<br>        bzero(dev, b + bi);<br>        <span class="hljs-keyword">return</span> b + bi;<br>      &#125;<br>    &#125;<br>    brelse(bp);<br>  &#125;<br>  panic(<span class="hljs-string">&quot;balloc: out of blocks&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·è¿˜éœ€è¦<code>bfree</code>å‡½æ•°é‡Šæ”¾ç¡¬ç›˜å—ã€‚</p><hr><h2 id="5-Inode-å±‚"><a href="#5-Inode-å±‚" class="headerlink" title="5.Inode å±‚"></a>5.Inode å±‚</h2><p>è¿™é‡Œå°±å¼€å§‹æ¶‰åŠæ–‡ä»¶æ˜¯å¦‚ä½•ç»„ç»‡çš„äº†ã€‚</p><ol><li><code>inode</code>:å†…å­˜ä¸­çš„ç»“æ„ï¼Œç”¨äºæ–‡ä»¶æè¿°ã€‚</li><li><code>dinode</code>:ç¡¬ç›˜ä¸­çš„ç»“æ„ï¼Œ64å­—èŠ‚å¤§å°ï¼Œä¾‹å¦‚<code>inode block</code>ä¸­å°±æ˜¯å­˜æ”¾è¿™äº›ç»“æ„ä½“çš„ã€‚å®ƒä»¬åœ¨ç¡¬ç›˜ä¸­å æ®è¿ç»­çš„ä¸€äº›å—ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> &#123;</span><br>  uint dev;           <span class="hljs-comment">// Device number</span><br>  uint inum;          <span class="hljs-comment">// Inode number</span><br>  <span class="hljs-type">int</span> ref;            <span class="hljs-comment">// Reference count</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sleeplock</span> <span class="hljs-title">lock</span>;</span> <span class="hljs-comment">// protects everything below here</span><br>  <span class="hljs-type">int</span> valid;          <span class="hljs-comment">// inode has been read from disk?</span><br><br>  <span class="hljs-type">short</span> type;         <span class="hljs-comment">// copy of disk inode</span><br>  <span class="hljs-type">short</span> major;<br>  <span class="hljs-type">short</span> minor;<br>  <span class="hljs-type">short</span> nlink;<br>  uint size;<br>  uint addrs[NDIRECT+<span class="hljs-number">1</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dinode</span> &#123;</span><br>  <span class="hljs-type">short</span> type;           <span class="hljs-comment">// File type</span><br>  <span class="hljs-type">short</span> major;          <span class="hljs-comment">// Major device number (T_DEVICE only)</span><br>  <span class="hljs-type">short</span> minor;          <span class="hljs-comment">// Minor device number (T_DEVICE only)</span><br>  <span class="hljs-type">short</span> nlink;          <span class="hljs-comment">// Number of links to inode in file system</span><br>  uint size;            <span class="hljs-comment">// Size of file (bytes)</span><br>  uint addrs[NDIRECT+<span class="hljs-number">1</span>];   <span class="hljs-comment">// Data block addresses</span><br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>ä¹Ÿå°±æ˜¯è¯´å†…å­˜ä¸­çš„inodeæ˜¯active inodesï¼Œå³å†…å­˜ä¸­æœ‰CæŒ‡é’ˆæŒ‡å‘è¿™ä¸ªinode,refæ˜¯æŒ‡å‘è¿™ä¸ªinodeæŒ‡é’ˆçš„æ•°é‡ã€‚refä¸º0æ—¶è¦åˆ é™¤è¿™ä¸ªinode</p></blockquote></li></ol><p><code>NDIRECT</code>ä¸ª<code>addr</code>å«åšdirect blocksï¼Œæœ€åä¸€ä¸ª<code>addr</code>ç»™å‡ºäº†indirect blockçš„åœ°å€ï¼Œå› æ­¤ä¸€ä¸ªæ–‡ä»¶çš„å‰12kBï¼ˆ<code>NDIRECT</code> x <code>BSIZE</code>ï¼‰å¯ä»¥ä»inodeä¸­çš„direct block <code>addr</code>ç›´æ¥è¯»å–ï¼Œå256kBï¼ˆ<code>NINDIRECT</code> x<code>BSIZE</code>ï¼‰å¯ä»¥é€šè¿‡indirect block addrç¿»è¯‘å¾—åˆ°ã€‚å› æ­¤xv6æ”¯æŒçš„æœ€å¤§çš„æ–‡ä»¶å¤§å°ä¸º268kBã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">lock</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> <span class="hljs-title">inode</span>[<span class="hljs-title">NINODE</span>];</span><br>&#125; itable;<br></code></pre></td></tr></table></figure><p>å†…å­˜ä¸­çš„itableä¹Ÿæ˜¯å¯¹<code>dinode block</code>çš„ç¼“å­˜,ä¹Ÿå°±æ˜¯<code>inode cache</code> ,<code>inode</code>ä¸­çš„validå°±æ˜¯å¯¹è¿™ä¸ªç¼“å­˜æ˜¯å¦æœ‰æ•ˆçš„æ ‡è®°ã€‚<br><code>iget</code>å‡½æ•°å’Œ<code>iput</code>å‡½æ•°åœ¨æ­¤ä¹‹ä¸Šå®ç°å¯¹inodeæŒ‡é’ˆçš„è·å–å’Œé‡Šæ”¾ã€‚<br>å…¸å‹ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">ip = iget(dev, inum);<br>ilock(ip);<br>...examine and modify ip-&gt;xxx<br><span class="hljs-title function_">iunlock</span><span class="hljs-params">(ip)</span>;<br>iput(ip);<br></code></pre></td></tr></table></figure><p><code>iget</code>è¿”å›äº†ä¸€ä¸ªç›´åˆ°è°ƒç”¨<code>iput</code>éƒ½æœ‰æ•ˆçš„<code>inode</code>ï¼Œä»»ä½•ä»£ç å‡å¯åŒæ—¶è®¿é—®ï¼Œå› æ­¤å¯ä»¥æœ‰å¾ˆå¤šæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ª<code>inode</code>ã€‚</p><p><code>ialloc</code>è´Ÿè´£ä»ç¡¬ç›˜ä¸Šçš„inode blocksä¸­å¯»æ‰¾ç©ºé—²çš„inodeï¼Œå½“æ‰¾åˆ°ä¹‹åå°†æ–°çš„typeå†™å…¥åˆ°diskä¸­ç„¶åé€šè¿‡è°ƒç”¨<code>iget</code>è¿”å›ä¸€ä¸ªå†…å­˜ä¸­çš„inodeï¼ˆå°†è¿™ä¸ªinodeå†™å…¥åˆ°inode cacheï¼‰ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> inode*<br><span class="hljs-title function_">ialloc</span><span class="hljs-params">(uint dev, <span class="hljs-type">short</span> type)</span><br>&#123;<br>  <span class="hljs-type">int</span> inum;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bp</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dinode</span> *<span class="hljs-title">dip</span>;</span><br><br>  <span class="hljs-keyword">for</span>(inum = <span class="hljs-number">1</span>; inum &lt; sb.ninodes; inum++)&#123;<br>    bp = bread(dev, IBLOCK(inum, sb));<br>    dip = (<span class="hljs-keyword">struct</span> dinode*)bp-&gt;data + inum%IPB;<br>    <span class="hljs-keyword">if</span>(dip-&gt;type == <span class="hljs-number">0</span>)&#123;  <span class="hljs-comment">// a free inode</span><br>      <span class="hljs-built_in">memset</span>(dip, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*dip));<br>      dip-&gt;type = type;<br>      log_write(bp);   <span class="hljs-comment">// mark it allocated on the disk</span><br>      brelse(bp);<br>      <span class="hljs-keyword">return</span> iget(dev, inum);<br>    &#125;<br>    brelse(bp);<br>  &#125;<br>  panic(<span class="hljs-string">&quot;ialloc: no inodes&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>iget</code>åœ¨inode cacheä¸­æŸ¥æ‰¾å’Œä¼ å…¥çš„deviceã€inode noç›¸åŒçš„active entryï¼Œå¦‚æœæ‰¾åˆ°äº†è¿™ä¸ªentryå°±è¿”å›å¯¹è¿™ä¸ªinodeçš„ä¸€ä¸ªæ–°çš„æŒ‡é’ˆï¼Œå¦åˆ™æ‰¾åˆ°ä¸€ä¸ªç©ºçš„entryå°†å…¶devã€inumç­‰è®¾ç½®ä¸ºå¯¹åº”çš„æ•°å€¼ï¼Œå¹¶è®¾ç½®validä¸º0å¾…åç»­ä»blockä¸­è¯»å–æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> inode*<br><span class="hljs-title function_">iget</span><span class="hljs-params">(uint dev, uint inum)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">ip</span>, *<span class="hljs-title">empty</span>;</span><br><br>  acquire(&amp;icache.lock);<br><br>  <span class="hljs-comment">// Is the inode already cached?</span><br>  empty = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span>(ip = &amp;icache.inode[<span class="hljs-number">0</span>]; ip &lt; &amp;icache.inode[NINODE]; ip++)&#123;<br>    <span class="hljs-keyword">if</span>(ip-&gt;ref &gt; <span class="hljs-number">0</span> &amp;&amp; ip-&gt;dev == dev &amp;&amp; ip-&gt;inum == inum)&#123;<br>      ip-&gt;ref++;<br>      release(&amp;icache.lock);<br>      <span class="hljs-keyword">return</span> ip;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(empty == <span class="hljs-number">0</span> &amp;&amp; ip-&gt;ref == <span class="hljs-number">0</span>)    <span class="hljs-comment">// Remember empty slot.</span><br>      empty = ip;<br>  &#125;<br><br>  <span class="hljs-comment">// Recycle an inode cache entry.</span><br>  <span class="hljs-keyword">if</span>(empty == <span class="hljs-number">0</span>)<br>    panic(<span class="hljs-string">&quot;iget: no inodes&quot;</span>);<br><br>  ip = empty;<br>  ip-&gt;dev = dev;<br>  ip-&gt;inum = inum;<br>  ip-&gt;ref = <span class="hljs-number">1</span>;<br>  ip-&gt;valid = <span class="hljs-number">0</span>;<br>  release(&amp;icache.lock);<br><br>  <span class="hljs-keyword">return</span> ip;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>bmap()</code>è´Ÿè´£è·å–inodeä¸­çš„ç¬¬nå—data blockçš„åœ°å€ã€‚å½“<code>bn&lt;NDIRECT</code>æ—¶ç›´æ¥è¿”å›<code>ip-&gt;addrs[bn]</code>ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªåœ°å€å°±è°ƒç”¨<code>balloc</code>åˆ†é…ä¸€ä¸ªdata blockã€‚å½“<code>NDIRECT&lt;bn&lt;NINDIRECT</code>æ—¶å…ˆ<code>bread(ip-&gt;dev, ip-&gt;addrs[NDIRECT])</code>ï¼Œç„¶åè·å–<code>bp-&gt;data[bn-NDIRECT]</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> uint<br><span class="hljs-title function_">bmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *ip, uint bn)</span><br>&#123;<br>  uint addr, *a;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bp</span>;</span><br><br>  <span class="hljs-keyword">if</span>(bn &lt; NDIRECT)&#123;<br>    <span class="hljs-keyword">if</span>((addr = ip-&gt;addrs[bn]) == <span class="hljs-number">0</span>)<br>      ip-&gt;addrs[bn] = addr = balloc(ip-&gt;dev);<br>    <span class="hljs-keyword">return</span> addr;<br>  &#125;<br>  bn -= NDIRECT;<br><br>  <span class="hljs-keyword">if</span>(bn &lt; NINDIRECT)&#123;<br>    <span class="hljs-comment">// Load indirect block, allocating if necessary.</span><br>    <span class="hljs-keyword">if</span>((addr = ip-&gt;addrs[NDIRECT]) == <span class="hljs-number">0</span>)<br>      ip-&gt;addrs[NDIRECT] = addr = balloc(ip-&gt;dev);<br>    bp = bread(ip-&gt;dev, addr);<br>    a = (uint*)bp-&gt;data;<br>    <span class="hljs-keyword">if</span>((addr = a[bn]) == <span class="hljs-number">0</span>)&#123;<br>      a[bn] = addr = balloc(ip-&gt;dev);<br>      log_write(bp);<br>    &#125;<br>    brelse(bp);<br>    <span class="hljs-keyword">return</span> addr;<br>  &#125;<br><br>  panic(<span class="hljs-string">&quot;bmap: out of range&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="6-Directoryå±‚"><a href="#6-Directoryå±‚" class="headerlink" title="6.Directoryå±‚"></a>6.Directoryå±‚</h2><p>å’Œæ–‡ä»¶ç±»ä¼¼ï¼Œåªä¸è¿‡è¿™ä¸ªinodeç»“æ„ä½“ç±»å‹ä¸ºT_DIR,æ•°æ®éƒ¨åˆ†æ˜¯<code>directory entry</code>,æ¯ä¸€ä¸ª<code>entry</code>æ•°æ®ç±»å‹ä¸º<code>struct dirent</code>,å› ä¸ºæ¯ä¸€ä¸ª<code>entry</code>ä»æ—§æ˜¯ä¸€ä¸ªæ¡ç›®ï¼Œæ‰€ä»¥è¿˜åº”è¯¥åŒ…å«ä¸€ä¸ª<code>inode number</code>.<br><code>dirlookup</code> æ˜¯åœ¨directoyä¸­æŸ¥æ‰¾åç§°ä¸º<code>name</code>çš„<code>directoy entry</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> inode*<br><span class="hljs-title function_">dirlookup</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *dp, <span class="hljs-type">char</span> *name, uint *poff)</span><br>&#123;<br>  uint off, inum;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> <span class="hljs-title">de</span>;</span><br><br>  <span class="hljs-keyword">if</span>(dp-&gt;type != T_DIR)<br>    panic(<span class="hljs-string">&quot;dirlookup not DIR&quot;</span>);<br><br>  <span class="hljs-keyword">for</span>(off = <span class="hljs-number">0</span>; off &lt; dp-&gt;size; off += <span class="hljs-keyword">sizeof</span>(de))&#123;<br>    <span class="hljs-keyword">if</span>(readi(dp, <span class="hljs-number">0</span>, (uint64)&amp;de, off, <span class="hljs-keyword">sizeof</span>(de)) != <span class="hljs-keyword">sizeof</span>(de))<br>      panic(<span class="hljs-string">&quot;dirlookup read&quot;</span>);<br>    <span class="hljs-keyword">if</span>(de.inum == <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">continue</span>;<br>    <span class="hljs-keyword">if</span>(namecmp(name, de.name) == <span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-comment">// entry matches path element</span><br>      <span class="hljs-keyword">if</span>(poff)<br>        *poff = off;<br>      inum = de.inum;<br>      <span class="hljs-keyword">return</span> iget(dp-&gt;dev, inum);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>readi</code>å‡½æ•°å°±æ˜¯åœ¨<code>struct inode* ip</code>çš„æ–‡ä»¶è¯»å–<code>off</code>åç§»çš„å†…å®¹ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°<code>bmap</code>å‡½æ•°æ¥æ‰“å¼€é€»è¾‘å—å·ï¼Œå†æŠŠå†…å®¹å¤åˆ¶åˆ°å†…æ ¸ç©ºé—´ä¸­æˆ–è€…ç”¨æˆ·ç©ºé—´(æ ¹æ®<code>user_dst</code>ä¸º1æˆ–è€…ä¸º0) ä¸­åœ°å€ä¸º<code>dst</code>çš„åœ°æ–¹å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">readi</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *ip, <span class="hljs-type">int</span> user_dst, uint64 dst, uint off, uint n)</span><br>&#123;<br>  uint tot, m;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bp</span>;</span><br><br>  <span class="hljs-keyword">if</span> (off &gt; ip-&gt;size || off + n &lt; off)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (off + n &gt; ip-&gt;size)<br>    n = ip-&gt;size - off;<br><br>  <span class="hljs-keyword">for</span> (tot = <span class="hljs-number">0</span>; tot &lt; n; tot += m, off += m, dst += m)<br>  &#123;<br>    bp = bread(ip-&gt;dev, bmap(ip, off / BSIZE));<br>    m = min(n - tot, BSIZE - off % BSIZE);<br>    <span class="hljs-keyword">if</span> (either_copyout(user_dst, dst, bp-&gt;data + (off % BSIZE), m) == <span class="hljs-number">-1</span>)<br>    &#123;<br>      brelse(bp);<br>      tot = <span class="hljs-number">-1</span>;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    brelse(bp);<br>  &#125;<br>  <span class="hljs-keyword">return</span> tot;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>dirlink</code>è®²ä¸€ä¸ªæ–°çš„<code>directory entry</code>å†™å…¥æ–‡ä»¶å¤¹<code>dp</code>ä¸­ï¼ŒæŸ¥æ‰¾<code>dp</code>ä¸­å°šæœªåˆ†é…çš„<code>entry</code>,å¦‚æœæ‰¾åˆ°å°±è¦ç”¨<code>writei</code>åœ¨æ–‡ä»¶ä¸­å†™å…¥å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">dirlink</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *dp, <span class="hljs-type">char</span> *name, uint inum)</span><br>&#123;<br>  <span class="hljs-type">int</span> off;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> <span class="hljs-title">de</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">ip</span>;</span><br><br>  <span class="hljs-comment">// Check that name is not present.</span><br>  <span class="hljs-keyword">if</span>((ip = dirlookup(dp, name, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>)&#123;<br>    iput(ip);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// Look for an empty dirent.</span><br>  <span class="hljs-keyword">for</span>(off = <span class="hljs-number">0</span>; off &lt; dp-&gt;size; off += <span class="hljs-keyword">sizeof</span>(de))&#123;<br>    <span class="hljs-keyword">if</span>(readi(dp, <span class="hljs-number">0</span>, (uint64)&amp;de, off, <span class="hljs-keyword">sizeof</span>(de)) != <span class="hljs-keyword">sizeof</span>(de))<br>      panic(<span class="hljs-string">&quot;dirlink read&quot;</span>);<br>    <span class="hljs-keyword">if</span>(de.inum == <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br><br>  <span class="hljs-built_in">strncpy</span>(de.name, name, DIRSIZ);<br>  de.inum = inum;<br>  <span class="hljs-keyword">if</span>(writei(dp, <span class="hljs-number">0</span>, (uint64)&amp;de, off, <span class="hljs-keyword">sizeof</span>(de)) != <span class="hljs-keyword">sizeof</span>(de))<br>    panic(<span class="hljs-string">&quot;dirlink&quot;</span>);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="7-Pathname-å±‚"><a href="#7-Pathname-å±‚" class="headerlink" title="7.Pathname å±‚"></a>7.Pathname å±‚</h2><p><code>namei</code>å‡½æ•°å¯¹pathnameè¿›è¡Œè§£æï¼Œè¿”å›<code>inode</code>ã€‚<code>namei</code>è°ƒç”¨äº†<code>namex</code>å‡½æ•°ï¼Œ<code>namex</code>å‡½æ•°ä¼ å…¥å‚æ•°<code>nameiparent</code>,å½“ä¸º1æ˜¯è¿”å›çš„<code>inode</code>æ˜¯ä¼ å…¥pathçš„çˆ¶æ–‡ä»¶å¤¹ã€‚<br>ä¾‹å¦‚ï¼Œå¦‚æœpathåœ°ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸º&#x2F;,åˆ™è¡¨ç¤ºè¿™æ˜¯ç»å¯¹è·¯å¾„ï¼Œé‚£ä¹ˆé¦–å…ˆéœ€è¦å¾—åˆ°<code>ROOTINO</code>çš„<code>inode</code>ï¼›å¦åˆ™å°±æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œåˆ™è¦æŠŠ<code>myproc-&gt;cwd</code>çš„å¼•ç”¨è®¡æ•°åŠ 1,<code>proc</code>ä¸­çš„<code>cwd</code>ç±»å‹æ˜¯<code>struct inode*</code>ã€‚<br>ç„¶åä¸æ–­ç”¨<code>skipelem</code>å‡½æ•°è§£æpathä¸­çš„&#x2F;,ä¸æ–­æŸ¥æ‰¾ä¸‹ä¸€çº§çš„<code>inode</code>,æœ€å<code>namei</code>è¿”å›ç›®æ ‡<code>inode</code>ã€‚<br>ä¸»è¦å†…å®¹è§ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> inode*<br><span class="hljs-title function_">namex</span><span class="hljs-params">(<span class="hljs-type">char</span> *path, <span class="hljs-type">int</span> nameiparent, <span class="hljs-type">char</span> *name)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">ip</span>, *<span class="hljs-title">next</span>;</span><br><br>  <span class="hljs-keyword">if</span>(*path == <span class="hljs-string">&#x27;/&#x27;</span>)<br>    ip = iget(ROOTDEV, ROOTINO);<br>  <span class="hljs-keyword">else</span><br>    ip = idup(myproc()-&gt;cwd);<br><br>  <span class="hljs-keyword">while</span>((path = skipelem(path, name)) != <span class="hljs-number">0</span>)&#123;<br>    ilock(ip);<br>    <span class="hljs-keyword">if</span>(ip-&gt;type != T_DIR)&#123;<br>      iunlockput(ip);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(nameiparent &amp;&amp; *path == <span class="hljs-string">&#x27;\0&#x27;</span>)&#123;<br>      <span class="hljs-comment">// Stop one level early.</span><br>      iunlock(ip);<br>      <span class="hljs-keyword">return</span> ip;<br>    &#125;<br>    <span class="hljs-keyword">if</span>((next = dirlookup(ip, name, <span class="hljs-number">0</span>)) == <span class="hljs-number">0</span>)&#123;<br>      iunlockput(ip);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    iunlockput(ip);<br>    ip = next;<br>  &#125;<br>  <span class="hljs-keyword">if</span>(nameiparent)&#123;<br>    iput(ip);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ip;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="8-File-descriptorå±‚"><a href="#8-File-descriptorå±‚" class="headerlink" title="8.File descriptorå±‚"></a>8.File descriptorå±‚</h2><p>File descriptorå±‚è®©UNIXä¸­æ‰€æœ‰çš„èµ„æºï¼ŒåŒ…æ‹¬è®¾å¤‡éƒ½å¯ä»¥åŒä¸€è¡¨ç¤ºä¸ºæ–‡ä»¶ã€‚æ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½å¯ä»¥ç”¨<code>struct file</code>æ¥è¡¨ç¤ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span> FD_NONE, FD_PIPE, FD_INODE, FD_DEVICE &#125; type;<br>  <span class="hljs-type">int</span> ref; <span class="hljs-comment">// reference count</span><br>  <span class="hljs-type">char</span> readable;<br>  <span class="hljs-type">char</span> writable;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe</span> *<span class="hljs-title">pipe</span>;</span> <span class="hljs-comment">// FD_PIPE</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">ip</span>;</span>  <span class="hljs-comment">// FD_INODE and FD_DEVICE</span><br>  uint off;          <span class="hljs-comment">// FD_INODE</span><br>  <span class="hljs-type">short</span> major;       <span class="hljs-comment">// FD_DEVICE</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>open</code>å¯ä»¥å¢åŠ æ–‡ä»¶ï¼Œä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶éƒ½ä¿å­˜åœ¨ç»“æ„ä½“<code>proc</code>ä¸­çš„<code>struct file *ofile[NOFILE]</code>æ•°ç»„ä¸­ã€‚<br>æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶éƒ½ä¿å­˜åœ¨global file tableï¼Œå³<code>ftable</code>ä¸­ã€‚<br><code>filealloc</code>è´Ÿè´£åœ¨file tableä¸­åˆ†é…ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨<code>ftable</code>ä¸­æ‰«æ<code>ref==0</code>çš„fileï¼Œå¢åŠ <code>ref</code>åè¿”å›è¿™ä¸ª<code>file *</code>ã€‚<br><code>filedup</code>è´Ÿè´£å¯¹è¿™ä¸ªfile descriptorçš„<code>ref++</code>å¹¶è¿”å›è¿™ä¸ªæ–‡ä»¶çš„<code>file *</code>ã€‚<br><code>fileclose</code>è´Ÿè´£å¯¹file descriptorçš„<code>refâ€“</code>ï¼Œå½“<code>ref==0</code>æ—¶æ ¹æ®è¿™ä¸ªfileçš„ç±»å‹é‡Šæ”¾æ‰<code>pipe</code>æˆ–è€…<code>inode</code>ã€‚</p><hr><h2 id="9-ç›¸å…³ç³»ç»Ÿè°ƒç”¨"><a href="#9-ç›¸å…³ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="9.ç›¸å…³ç³»ç»Ÿè°ƒç”¨"></a>9.ç›¸å…³ç³»ç»Ÿè°ƒç”¨</h2><p><code>sys_link</code>å’Œ<code>sys_unlink</code>è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å®ç°å¯¹<code>inode</code>çš„å¢åŠ æˆ–è€…åˆ é™¤å¼•ç”¨ã€‚<br><code>sys_link</code>ä¼ å…¥ä¸€ä¸ªå‚æ•°<code>old</code>å’Œä¸€ä¸ªå‚æ•°<code>new</code>,<code>new</code>æ˜¯éœ€è¦é“¾æ¥åˆ°<code>old</code>çš„è·¯å¾„ã€‚<code>sys_link</code>é¦–å…ˆå¢åŠ <code>struct inode* ip</code>çš„<code>nlink</code>,ç„¶åè°ƒç”¨<code>nameiparent</code>æŸ¥æ‰¾<code>new</code>çš„çˆ¶æ–‡ä»¶å¤¹ï¼Œè°ƒç”¨<code>dirlink</code>åœ¨çˆ¶æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º<code>new</code>çš„<code>directory entry</code>ã€‚<br>ä¸»è¦å†…å®¹è§ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c">uint64<br><span class="hljs-title function_">sys_link</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-type">char</span> name[DIRSIZ], new[MAXPATH], old[MAXPATH];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">dp</span>, *<span class="hljs-title">ip</span>;</span><br><br>  <span class="hljs-keyword">if</span>(argstr(<span class="hljs-number">0</span>, old, MAXPATH) &lt; <span class="hljs-number">0</span> || argstr(<span class="hljs-number">1</span>, new, MAXPATH) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  begin_op();<br>  <span class="hljs-keyword">if</span>((ip = namei(old)) == <span class="hljs-number">0</span>)&#123;<br>    end_op();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  ilock(ip);<br>  <span class="hljs-keyword">if</span>(ip-&gt;type == T_DIR)&#123;<br>    iunlockput(ip);<br>    end_op();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  ip-&gt;nlink++;<br>  iupdate(ip);<br>  iunlock(ip);<br><br>  <span class="hljs-keyword">if</span>((dp = nameiparent(new, name)) == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">goto</span> bad;<br>  ilock(dp);<br>  <span class="hljs-keyword">if</span>(dp-&gt;dev != ip-&gt;dev || dirlink(dp, name, ip-&gt;inum) &lt; <span class="hljs-number">0</span>)&#123;<br>    iunlockput(dp);<br>    <span class="hljs-keyword">goto</span> bad;<br>  &#125;<br>  iunlockput(dp);<br>  iput(ip);<br><br>  end_op();<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>bad:<br>  ilock(ip);<br>  ip-&gt;nlink--;<br>  iupdate(ip);<br>  iunlockput(ip);<br>  end_op();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç³»ç»Ÿè°ƒç”¨<code>open</code>å¯èƒ½ä¼šè°ƒç”¨<code>create</code>å‡½æ•°ã€‚<br><code>create</code>é¦–å…ˆè°ƒç”¨<code>nameiparent</code>è·å–çˆ¶æ–‡ä»¶å¤¹ï¼Œç„¶åè°ƒç”¨<code>dirlookup</code>æ¥æŸ¥çœ‹è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹æ˜¯å¦å·²ç»å­˜åœ¨åŒåçš„inodeï¼Œå¦‚æœå­˜åœ¨ä¸”è°ƒç”¨è¿™ä¸ª<code>create</code>çš„æ˜¯<code>open</code>æ¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶çš„è¯ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›è¿™ä¸ªinodeã€‚å¦‚æœè¿™ä¸ªåç§°ä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨iallocã€‚å¦‚æœæ˜¯<code>mkdir</code>è°ƒç”¨çš„<code>create</code>ï¼ˆå³<code>type==T_DIR</code>)ï¼Œåˆ™è¦åˆ›å»º<code>..</code>å’Œ<code>.</code>ä½œä¸ºå¯¹çˆ¶çº§inodeå’Œå½“å‰inodeçš„å¼•ç”¨ï¼Œæœ€ç»ˆå°†å½“å‰çš„<code>name</code> <code>dirlink</code>åˆ°å½“å‰inodeã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> inode*<br><span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-type">char</span> *path, <span class="hljs-type">short</span> type, <span class="hljs-type">short</span> major, <span class="hljs-type">short</span> minor)</span><br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">ip</span>, *<span class="hljs-title">dp</span>;</span><br>  <span class="hljs-type">char</span> name[DIRSIZ];<br><br>  <span class="hljs-keyword">if</span>((dp = nameiparent(path, name)) == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>  ilock(dp);<br><br>  <span class="hljs-keyword">if</span>((ip = dirlookup(dp, name, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span>)&#123;<br>    iunlockput(dp);<br>    ilock(ip);<br>    <span class="hljs-keyword">if</span>(type == T_FILE &amp;&amp; (ip-&gt;type == T_FILE || ip-&gt;type == T_DEVICE))<br>      <span class="hljs-keyword">return</span> ip;<br>    iunlockput(ip);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>((ip = ialloc(dp-&gt;dev, type)) == <span class="hljs-number">0</span>)<br>    panic(<span class="hljs-string">&quot;create: ialloc&quot;</span>);<br><br>  ilock(ip);<br>  ip-&gt;major = major;<br>  ip-&gt;minor = minor;<br>  ip-&gt;nlink = <span class="hljs-number">1</span>;<br>  iupdate(ip);<br><br>  <span class="hljs-keyword">if</span>(type == T_DIR)&#123;  <span class="hljs-comment">// Create . and .. entries.</span><br>    dp-&gt;nlink++;  <span class="hljs-comment">// for &quot;..&quot;</span><br>    iupdate(dp);<br>    <span class="hljs-comment">// No ip-&gt;nlink++ for &quot;.&quot;: avoid cyclic ref count.</span><br>    <span class="hljs-keyword">if</span>(dirlink(ip, <span class="hljs-string">&quot;.&quot;</span>, ip-&gt;inum) &lt; <span class="hljs-number">0</span> || dirlink(ip, <span class="hljs-string">&quot;..&quot;</span>, dp-&gt;inum) &lt; <span class="hljs-number">0</span>)<br>      panic(<span class="hljs-string">&quot;create dots&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(dirlink(dp, name, ip-&gt;inum) &lt; <span class="hljs-number">0</span>)<br>    panic(<span class="hljs-string">&quot;create: dirlink&quot;</span>);<br><br>  iunlockput(dp);<br><br>  <span class="hljs-keyword">return</span> ip;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>MIT6.S081</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
      <tag>MIT6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CMU_15445ï¼šProject C++ Primer</title>
    <link href="/2023/08/06/%E6%95%B0%E6%8D%AE%E5%BA%93/CMU_15445/Project0/"/>
    <url>/2023/08/06/%E6%95%B0%E6%8D%AE%E5%BA%93/CMU_15445/Project0/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><p>ä¹¦åˆ°ç”¨æ—¶æ–¹æ¨å°‘ï¼Œè¿™ä¸ªProjectè™½è¯´å‰ç¼€æ ‘æˆ‘åœ¨ä¹‹å‰å°±å­¦è¿‡ï¼Œä½†C++çš„åŸºç¡€çŸ¥è¯†è¿˜æ˜¯å¾ˆä¸ç‰¢å›ºï¼Œæ‰€ä»¥å…ˆæŠŠä¸€äº›éœ€è¦ç”¨çš„çŸ¥è¯†ç‚¹è¦åœ¨è¿™é‡Œå†è®°ä¸€ä¸‹ã€‚</p><h3 id="å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨"><a href="#å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨" class="headerlink" title="å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨"></a>å·¦å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨</h3><ul><li>å·¦å€¼æ˜¯å¯ä»¥æ”¾åœ¨èµ‹å€¼å·å·¦è¾¹çš„ï¼Œå·¦å€¼å¿…é¡»è¦åœ¨å†…å­˜ä¸­æœ‰å®ä½“ã€‚</li><li>å³å€¼å‡ºç°åœ¨èµ‹å€¼å·å³è¾¹ï¼›å³å€¼å¯ä»¥åœ¨å¯„å­˜å™¨ä¹Ÿå¯ä»¥åœ¨å†…å­˜ä¸­ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> num = <span class="hljs-number">10</span>;<br><span class="hljs-type">int</span> &amp;b = num;<br><span class="hljs-type">int</span> &amp;c = <span class="hljs-number">10</span>; <span class="hljs-comment">// é”™è¯¯</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢ã€‚<code>num</code>æœ‰åœ°å€æ˜¯å·¦å€¼ï¼Œ<code>b</code>æ˜¯å¯¹<code>num</code>çš„å¼•ç”¨ï¼Œæ‰€ä»¥è¿™æ˜¯å·¦å€¼å¼•ç”¨ã€‚è€Œ10æ˜¯å³å€¼ï¼Œæ‰€ä»¥<code>c</code>æ˜¯å³å€¼å¼•ç”¨ï¼Œè¿™é‡Œæ˜¯é”™è¯¯çš„ã€‚<br>ä½†è¿™æ ·åˆæ˜¯å¯ä»¥çš„ï¼š<br><code>const int&amp; c =10</code>,å…è®¸ä½¿ç”¨å¸¸é‡å·¦å€¼å¼•ç”¨æ“ä½œå³å€¼ã€‚<br>å®é™…å¼€å‘ä¸­æˆ‘ä»¬å¯èƒ½éœ€è¦å¯¹å³å€¼è¿›è¡Œä¿®æ”¹ï¼ˆå®ç°ç§»åŠ¨è¯­ä¹‰æ—¶å°±éœ€è¦ï¼‰ï¼Œæ˜¾ç„¶å·¦å€¼å¼•ç”¨çš„æ–¹å¼æ˜¯è¡Œä¸é€šçš„ã€‚</p><h4 id="å³å€¼å¼•ç”¨ä»‹ç»"><a href="#å³å€¼å¼•ç”¨ä»‹ç»" class="headerlink" title="å³å€¼å¼•ç”¨ä»‹ç»"></a>å³å€¼å¼•ç”¨ä»‹ç»</h4><p>å³å€¼å¼•ç”¨ä¹Ÿå¿…é¡»ç«‹å³è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œä¸”<strong>ä½¿ç”¨å³å€¼è¿›è¡Œåˆå§‹åŒ–</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span>&amp;&amp; a = <span class="hljs-number">10</span>;<br>a = <span class="hljs-number">100</span>;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ“ä½œéƒ½æ˜¯æ­£ç¡®çš„ã€‚<br>å³å€¼å¼•ç”¨ å¼•ç”¨ å³å€¼ï¼Œä¼šä½¿å³å€¼è¢«å­˜å‚¨åˆ°ç‰¹å®šçš„ä½ç½®ã€‚</p><ul><li>å·¦å€¼å¼•ç”¨çš„çŸ­æ¿<br>ä¼ å€¼ä¼ å‚å’Œä¼ å€¼è¿”å›éƒ½ä¼šäº§ç”Ÿæ‹·è´ï¼Œæœ‰çš„ç”šè‡³æ˜¯æ·±æ‹·è´ï¼Œä»£ä»·å¾ˆå¤§ã€‚è€Œå·¦å€¼å¼•ç”¨çš„å®é™…æ„ä¹‰åœ¨äºåšå‚æ•°å’Œåšè¿”å›å€¼éƒ½å¯ä»¥å‡å°‘æ‹·è´ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚ä½†æ˜¯ï¼Œå·¦å€¼å¼•ç”¨çš„çŸ­æ¿æ˜¯ä¸èƒ½å¤Ÿ<strong>å¼•ç”¨å±€éƒ¨å˜é‡</strong>ã€‚</li></ul><h4 id="ç®€å•ä¾‹å­"><a href="#ç®€å•ä¾‹å­" class="headerlink" title="ç®€å•ä¾‹å­"></a>ç®€å•ä¾‹å­</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-comment">// æ¥æ”¶ä¸€ä¸ª std::vector&lt;int&gt; çš„å³å€¼å¼•ç”¨å‚æ•°</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">processVector</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;&amp;&amp; vec)</span> &#123;<br>    <span class="hljs-comment">// å¯¹å³å€¼å¼•ç”¨è¿›è¡Œæ“ä½œï¼Œè€Œä¸è¿›è¡Œæ‹·è´</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : vec) &#123;<br>        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; num &lt;&lt; <span class="hljs-string">&quot; &quot;</span>;<br>    &#125;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt; nums = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;;<br>    <span class="hljs-comment">// å°† nums ä½œä¸ºå³å€¼ä¼ é€’ç»™å‡½æ•°</span><br>    processVector(<span class="hljs-built_in">std</span>::move(nums));<br><br>    <span class="hljs-comment">// æ­¤æ—¶ nums å·²è¢«ç§»åŠ¨ï¼Œä¸å†å¯ç”¨</span><br>    <span class="hljs-comment">// è¿™é‡Œè®¿é—® nums å°†å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸º</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å³å€¼å¼•ç”¨çš„ç‰¹æ€§æ˜¯å¯ä»¥ç»‘å®šåˆ°ä¸´æ—¶å¯¹è±¡ï¼ˆå³å€¼ï¼‰ä¸Šçš„å¼•ç”¨ï¼Œè€Œä¸´æ—¶å¯¹è±¡åœ¨è¡¨è¾¾å¼æ±‚å€¼åå°±ä¼šè¢«é”€æ¯ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬å°†<code>nums</code>é€šè¿‡<code>std::move()</code>è½¬æ¢ä¸ºå³å€¼å¼•ç”¨åï¼Œå®ƒçš„å€¼ç±»åˆ«å˜ä¸ºå³å€¼ï¼Œè€Œä¸å†æ˜¯å·¦å€¼ã€‚<br>åœ¨å‡½æ•°å‚æ•°ä¸­æ¥æ”¶åˆ°å³å€¼å¼•ç”¨ vec åï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ“ä½œå®ƒï¼Œè€Œä¸éœ€è¦è¿›è¡Œå¯¹è±¡æ‹·è´ã€‚è¿™æ˜¯å› ä¸ºå³å€¼å¼•ç”¨çš„ç‰¹æ€§å…è®¸æˆ‘ä»¬â€œçªƒå–â€ä¸´æ—¶å¯¹è±¡çš„èµ„æºï¼Œè€Œä¸æ˜¯è¿›è¡Œæ‹·è´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>vec</code> çš„èµ„æºï¼ˆä¾‹å¦‚ <code>std::vector</code> ä¸­çš„æ•°æ®ï¼‰ï¼Œè€Œä¸éœ€è¦è¿›è¡Œé¢å¤–çš„æ‹·è´æ“ä½œã€‚</p><h4 id="moveç§»åŠ¨è¯­ä¹‰"><a href="#moveç§»åŠ¨è¯­ä¹‰" class="headerlink" title="moveç§»åŠ¨è¯­ä¹‰"></a>moveç§»åŠ¨è¯­ä¹‰</h4><p>ä½œç”¨æ˜¯å°†ä¸€ä¸ªå·¦å€¼å¼ºåˆ¶è½¬åŒ–ä¸ºå³å€¼ï¼Œä»¥å®ç°ç§»åŠ¨è¯­ä¹‰ã€‚å·¦å€¼è¢« move åå˜ä¸ºå³å€¼ï¼Œäºæ˜¯å³å€¼å¼•ç”¨å¯ä»¥å¼•ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> t = <span class="hljs-number">10</span>;<br><span class="hljs-comment">//int&amp;&amp; rrt = t; // ç¼–è¯‘æŠ¥é”™ï¼Œä¸èƒ½ç›´æ¥å¼•ç”¨å·¦å€¼</span><br><br><span class="hljs-comment">// 2.ä½†æ˜¯å³å€¼å¼•ç”¨å¯ä»¥å¼•ç”¨è¢«moveçš„å·¦å€¼</span><br><span class="hljs-type">int</span>&amp;&amp; rrt = <span class="hljs-built_in">std</span>::move(t);  <span class="hljs-comment">//æ­£ç¡®</span><br></code></pre></td></tr></table></figure><p>å³å€¼å¼•ç”¨æ„ä¹‰å’Œç§»åŠ¨æ„é€ å‡½æ•°:<br>å³å€¼åšå‚æ•°ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ç§»åŠ¨æ„é€ ï¼Œè€Œè°ƒç”¨ç§»åŠ¨æ„é€ å°±ä¼šå‡å°‘æ‹·è´ï¼ˆå¦‚æœæ˜¯åƒ string è¿™æ ·çš„åœ¨å †ç©ºé—´ä¸Šå­˜åœ¨èµ„æºçš„ç±»ï¼Œé‚£ä¹ˆæ¯è°ƒç”¨ä¸€æ¬¡ç§»åŠ¨æ„é€ å°±ä¼šå°‘åšä¸€æ¬¡æ·±æ‹·è´ã€‚</p><h4 id="forwardå®Œç¾è½¬å‘"><a href="#forwardå®Œç¾è½¬å‘" class="headerlink" title="forwardå®Œç¾è½¬å‘"></a>forwardå®Œç¾è½¬å‘</h4><p>æœ‰äº†<code>move</code>å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬åˆé‡åˆ°äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼š</p><p>æŒ‰ç…§ä¸Šé¢çš„å†™æ³•ï¼Œå¤„ç†ä¸´æ—¶å˜é‡ç”¨å³å€¼å¼•ç”¨<code>T&amp;&amp;</code>ï¼Œå¤„ç†æ™®é€šå˜é‡ç”¨<code>const</code>å¼•ç”¨<code>const T&amp;</code>ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«å»ºç«‹ä¸¤ä¸ªå‡½æ•°ï¼Œç„¶åå…¥å‚ä½¿ç”¨ä¸åŒçš„ç±»å‹ï¼Œæ¯ä¸ªå‡½æ•°éƒ½è¦å†™ä¸¤éã€‚<br>é‚£ä¹ˆèƒ½ä¸èƒ½é¿å…é‡å¤ï¼Œå°†<code>T &amp;&amp;</code>ç±»å‹å’Œ<code>const T &amp;</code>ç±»å‹åˆäºŒä¸ºä¸€å‘¢ï¼Ÿ</p><blockquote><p>ç­”æ¡ˆå°±æ˜¯ï¼š<code>forward</code>å‡½æ•°ï¼Œ<code>std::forward</code>ä¹Ÿè¢«ç§°ä¸ºå®Œç¾è½¬å‘ï¼Œå³ï¼šä¿æŒåŸæ¥çš„å€¼å±æ€§ä¸å˜ï¼š</p></blockquote><ul><li>å¦‚æœåŸæ¥çš„å€¼æ˜¯å·¦å€¼ï¼Œç»<code>std::forward</code>å¤„ç†åè¯¥å€¼è¿˜æ˜¯å·¦å€¼ã€‚</li><li>å¦‚æœåŸæ¥çš„å€¼æ˜¯å³å€¼ï¼Œç»<code>std::forward</code>å¤„ç†åå®ƒè¿˜æ˜¯å³å€¼ã€‚<br>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>forward</code>å‡½æ•°å¯¹å…¥å‚è¿›è¡Œå°è£…ï¼Œä»è€Œä¿è¯äº†å…¥å‚çš„ç»Ÿä¸€æ€§ï¼Œä»è€Œå¯ä»¥å®ç°ä¸€ä¸ªæ–¹æ³•å¤„ç†ä¸¤ç§ç±»å‹ï¼<br>æ­£å› ä¸ºå¦‚æ­¤ï¼Œ<code>forward</code>å‡½æ•°è¢«å¤§é‡ç”¨åœ¨äº†å…¥å‚å€¼ç±»å‹æƒ…å†µä¸ç¡®å®šçš„C++æ¨¡æ¿ä¸­ï¼</li></ul><h3 id="æ™ºèƒ½æŒ‡é’ˆ"><a href="#æ™ºèƒ½æŒ‡é’ˆ" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆ"></a>æ™ºèƒ½æŒ‡é’ˆ</h3><p><code>std::unique_ptr</code>æ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆç±»æ¨¡æ¿ï¼Œç”¨äºç®¡ç†åŠ¨æ€åˆ†é…çš„å¯¹è±¡ã€‚å®ƒæä¾›äº†ç‹¬å æ‰€æœ‰æƒçš„è¯­ä¹‰ï¼Œæ„å‘³ç€ä¸€ä¸ª<code>unique_ptr</code>æŒ‡é’ˆå¯ä»¥æ‹¥æœ‰å¯¹ä¸€ä¸ªå¯¹è±¡çš„å”¯ä¸€æ‰€æœ‰æƒï¼Œå¹¶è´Ÿè´£åœ¨å…¶ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾è¯¥å¯¹è±¡ã€‚</p><ul><li><code>move</code>: è½¬ç§»æ‰€æœ‰æƒï¼Œå°†åŸæŒ‡é’ˆç½®ç©ºã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title function_">ptr1</span><span class="hljs-params">(new <span class="hljs-type">int</span>(<span class="hljs-number">10</span>))</span>;<br><span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;<span class="hljs-type">int</span>&gt; ptr2 = <span class="hljs-built_in">std</span>::move(ptr1); <span class="hljs-comment">// ç§»åŠ¨æ‰€æœ‰æƒ</span><br><br><span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;<span class="hljs-type">int</span>&gt;&gt; vec;<br>vec.push_back(<span class="hljs-built_in">std</span>::make_unique&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">20</span>)); <span class="hljs-comment">// ç§»åŠ¨ unique_ptr åˆ°å®¹å™¨ä¸­</span><br></code></pre></td></tr></table></figure><ul><li><code>reset</code>:æ›´æ”¹æ‰€æœ‰æƒã€‚</li></ul><ol><li><code>ptr.reset()</code>:é”€æ¯å¯¹è±¡ï¼ŒæŒ‡é’ˆç½®ç©ºã€‚</li><li><code>ptr.reset(new_ptr)</code>:æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘æ–°çš„å¯¹è±¡ï¼ŒåŸå¯¹è±¡é”€æ¯ã€‚</li></ol><ul><li><code>get</code>ï¼š<code>get()</code>æ˜¯<code> unique_ptr</code>ç±»çš„æˆå‘˜å‡½æ•°ï¼Œå®ƒè¿”å›æŒ‡å‘<code>unique_ptr</code>æ‰€æ‹¥æœ‰çš„å¯¹è±¡çš„æŒ‡é’ˆï¼Œå³åŸå§‹æŒ‡é’ˆã€‚</li></ul><hr><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œå¦‚æœæ„Ÿè§‰è¿˜ä¸æ˜¯å¾ˆæ‡‚ï¼Œå°±ç›´æ¥æ¥çœ‹ä»£ç å§ã€‚<br>æˆ‘è¿™é‡Œåªä»‹ç»ä¸€äº›æ¯”è¾ƒé‡è¦çš„å‡½æ•°ã€‚</p><h3 id="TrieNode"><a href="#TrieNode" class="headerlink" title="TrieNode"></a>TrieNode</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">TrieNode(TrieNode &amp;&amp;other_trie_node) noexcept &#123;<br>    key_char_ = other_trie_node.key_char_;<br>    is_end_ = other_trie_node.is_end_;<br>    children_.swap(other_trie_node.children_);<br>  &#125;<br></code></pre></td></tr></table></figure><p>è¿™å°±æ˜¯ç§»åŠ¨æ„é€ å‡½æ•°ã€‚<br>è°ƒç”¨<code> children_.swap(other_trie_node.children_)</code>ï¼Œä½¿ç”¨<code> std::swap</code>å‡½æ•°å°† <code>other_trie_node</code> çš„ <code>children_</code> æˆå‘˜å˜é‡ä¸å½“å‰å¯¹è±¡çš„ <code>children_</code>æˆå‘˜å˜é‡è¿›è¡Œäº¤æ¢ã€‚è¿™æ ·åšå¯ä»¥å®ç°é«˜æ•ˆçš„ç§»åŠ¨æ“ä½œï¼Œé¿å…ä¸å¿…è¦çš„å¤åˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;TrieNode&gt; *<span class="hljs-title function_">InsertChildNode</span><span class="hljs-params">(<span class="hljs-type">char</span> key_char, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;TrieNode&gt; &amp;&amp;child)</span> &#123;<br>    <span class="hljs-keyword">if</span> (HasChild(key_char) || key_char != child-&gt;key_char_) &#123;<br>      <span class="hljs-keyword">return</span> nullptr;<br>    &#125;<br>    children_[key_char] = <span class="hljs-built_in">std</span>::move(child);<br>    <span class="hljs-keyword">return</span> &amp;children_[key_char];<br>  &#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;TrieNode&gt; *<span class="hljs-title function_">GetChildNode</span><span class="hljs-params">(<span class="hljs-type">char</span> key_char)</span> &#123;<br>    <span class="hljs-keyword">auto</span> node = children_.find(key_char);<br>    <span class="hljs-keyword">if</span> (node != children_.end()) &#123;<br>      <span class="hljs-keyword">return</span> &amp;(node-&gt;second);<br>    &#125;<br>    <span class="hljs-keyword">return</span> nullptr;<br>  &#125;<br></code></pre></td></tr></table></figure><ul><li><p>ä¸ºä»€ä¹ˆè¿”å›çš„éƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆçš„æŒ‡é’ˆï¼Ÿ</p><blockquote><p>å› ä¸ºæ™ºèƒ½æŒ‡é’ˆå¯¹ä¸€ä¸ªå¯¹è±¡æœ‰å”¯ä¸€çš„æ‰€æœ‰æƒ,å¦‚æœæˆ‘ä»¬åœ¨å­—å…¸æ ‘çš„æ“ä½œä¸­éœ€è¦ä¸æ–­è¿­ä»£çš„è¯ï¼Œéœ€è¦ç§»åŠ¨æŒ‡é’ˆï¼Œé‚£å°±éœ€è¦ç”¨åˆ°æ™ºèƒ½æŒ‡é’ˆçš„æŒ‡é’ˆäº†ã€‚</p></blockquote></li><li><p>ä¸ºä»€ä¹ˆè¦<code>children_[key_char] = std::move(child)</code>?</p><blockquote><p>child æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨çš„ std::unique_ptr<TrieNode>ï¼Œåº”è¯¥ç›´æ¥å°†å…¶ç§»åŠ¨ç»™ children_[key_char]ã€‚child çš„æ‰€æœ‰æƒè½¬ç§»ç»™ children_[key_char]ï¼Œè€Œä¸æ˜¯é‡æ–°æ„é€ ä¸€ä¸ªæ–°çš„ std::unique_ptrã€‚è¿™æ ·åšå¯ä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…å’Œææ„ï¼Œå¹¶æ­£ç¡®åœ°è½¬ç§»æ‰€æœ‰æƒã€‚</p></blockquote></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">RemoveChildNode</span><span class="hljs-params">(<span class="hljs-type">char</span> key_char)</span> &#123;<br>    <span class="hljs-keyword">auto</span> node = children_.find(key_char);<br>    <span class="hljs-keyword">if</span> (node != children_.end()) &#123;<br>      node-&gt;second.reset();<br>      children_.erase(key_char);<br>    &#125;<br>  &#125;<br><br></code></pre></td></tr></table></figure><h3 id="TrieNodeWithValue"><a href="#TrieNodeWithValue" class="headerlink" title="TrieNodeWithValue"></a>TrieNodeWithValue</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">TrieNodeWithValue(TrieNode &amp;&amp;trieNode, T value) : TrieNode(<span class="hljs-built_in">std</span>::forward&lt;TrieNode&gt;(trieNode)) &#123;<br>    value_ = value;<br>    SetEndNode(<span class="hljs-literal">true</span>);<br>  &#125;<br></code></pre></td></tr></table></figure><p>ç§»åŠ¨æ„é€ å‡½æ•°ï¼ŒæŠŠ<code>trieNode</code>ä½œä¸ºå³å€¼ä¼ é€’ç»™<code>TrieNodeWithValue</code>ï¼Œå®ç°èµ„æºçš„è½¬ç§»ã€‚</p><h3 id="Trie"><a href="#Trie" class="headerlink" title="Trie"></a>Trie</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c">template &lt;typename T&gt;<br>  <span class="hljs-type">bool</span> <span class="hljs-title function_">Insert</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> &amp;key, T value)</span> &#123;<br>     <span class="hljs-keyword">if</span> (key.empty()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    latch_.WLock();<br>    <span class="hljs-keyword">auto</span> cur = &amp;root_;<br>    <span class="hljs-comment">// latch_.WLock();</span><br>    <span class="hljs-keyword">auto</span> c = key.begin();<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>      <span class="hljs-keyword">auto</span> x = c++;<br>      <span class="hljs-keyword">if</span> (c == key.end()) &#123;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (cur-&gt;get()-&gt;HasChild(*x)) &#123;<br>        cur = cur-&gt;get()-&gt;GetChildNode(*x);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        cur = cur-&gt;get()-&gt;InsertChildNode(*x, <span class="hljs-built_in">std</span>::make_unique&lt;TrieNode&gt;(*x));<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-type">char</span> ch = key.back();<br>    <span class="hljs-keyword">auto</span> end_node = cur-&gt;get()-&gt;GetChildNode(ch);<br><br>    <span class="hljs-keyword">if</span> (end_node != nullptr &amp;&amp; end_node-&gt;get()-&gt;IsEndNode()) &#123;<br>      latch_.WUnlock();<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (end_node != nullptr) &#123;<br>      <span class="hljs-keyword">auto</span> new_node = new TrieNodeWithValue&lt;T&gt;(<span class="hljs-built_in">std</span>::move(*(end_node-&gt;get())), value);<br>      end_node-&gt;reset(new_node);<br><br>      latch_.WUnlock();<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœä¸ºç©º</span><br>    cur = cur-&gt;get()-&gt;InsertChildNode(ch, <span class="hljs-built_in">std</span>::make_unique&lt;TrieNode&gt;(ch));<br>    <span class="hljs-comment">// ç°åœ¨è¿˜æ˜¯ä¸€ä¸ªä¸­é—´èŠ‚ç‚¹ï¼Œè¿˜ä¸æ˜¯TrieNodeWithValue</span><br>    <span class="hljs-keyword">auto</span> new_node = new TrieNodeWithValue&lt;T&gt;(<span class="hljs-built_in">std</span>::move(**cur), value);<br>    cur-&gt;reset(new_node);<br>    latch_.WUnlock();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">Remove</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> &amp;key)</span> &#123;<br>    <span class="hljs-keyword">if</span> (key.empty()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    latch_.WLock();<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;TrieNode&gt; *&gt; storage;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;TrieNode&gt; *node = &amp;root_;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> ch : key) &#123;<br>      storage.emplace_back(node);<br>      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;TrieNode&gt; *next = node-&gt;get()-&gt;GetChildNode(ch);<br><br>      <span class="hljs-keyword">if</span> (next == nullptr) &#123;<br>        latch_.WUnlock();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br><br>      node = next;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (node-&gt;get()-&gt;HasChildren()) &#123;<br>      <span class="hljs-comment">// node = node-&gt;get()-&gt;GetChildNode(key[key.size()-1]);</span><br>      node-&gt;get()-&gt;SetEndNode(<span class="hljs-literal">false</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = storage.size() - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-comment">// æƒ³ä¸€ä¸‹ï¼Œ root èŠ‚ç‚¹æ˜¯ä¸è®°å½•å­—ç¬¦çš„</span><br>        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;TrieNode&gt; *pre = storage[i];<br>        <span class="hljs-keyword">if</span> ((i &lt; static_cast&lt;<span class="hljs-type">int</span>&gt;(key.size() - <span class="hljs-number">1</span>)) &amp;&amp; (node-&gt;get()-&gt;IsEndNode() || node-&gt;get()-&gt;HasChildren())) &#123;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>        pre-&gt;get()-&gt;RemoveChildNode(key[i]);<br>        node = pre;<br>      &#125;<br>    &#125;<br><br>    latch_.WUnlock();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c">template &lt;typename T&gt;<br>  T <span class="hljs-title function_">GetValue</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> &amp;key, <span class="hljs-type">bool</span> *success)</span> &#123;<br>    *success = <span class="hljs-literal">true</span>;<br>    latch_.RLock();<br>    <span class="hljs-keyword">if</span> (key.empty()) &#123;<br>      *success = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">return</span> &#123;&#125;;<br>    &#125;<br><br>    <span class="hljs-keyword">auto</span> cur = &amp;root_;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> ch : key) &#123;<br>      <span class="hljs-keyword">if</span> (cur-&gt;get()-&gt;HasChild(ch)) &#123;<br>        cur = cur-&gt;get()-&gt;GetChildNode(ch);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        *success = <span class="hljs-literal">false</span>;<br>        latch_.RUnlock();<br>        <span class="hljs-keyword">return</span> &#123;&#125;;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!cur-&gt;get()-&gt;IsEndNode()) &#123;<br>      *success = <span class="hljs-literal">false</span>;<br>      latch_.RUnlock();<br>      <span class="hljs-keyword">return</span> &#123;&#125;;<br>    &#125;<br><br>    <span class="hljs-keyword">auto</span> flag_node = dynamic_cast&lt;TrieNodeWithValue&lt;T&gt; *&gt;(cur-&gt;get());<br>    <span class="hljs-keyword">if</span> (flag_node == nullptr) &#123;<br>      *success = <span class="hljs-literal">false</span>;<br>      latch_.RUnlock();<br>      <span class="hljs-keyword">return</span> &#123;&#125;;<br>    &#125;<br><br>    latch_.RUnlock();<br>    <span class="hljs-keyword">return</span> flag_node-&gt;GetValue();<br>  &#125;<br>&#125;;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ•°æ®åº“</category>
      
      <category>CMU_15445</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•°æ®åº“</tag>
      
      <tag>CMU_15445</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çº¿ç¨‹æ± çš„Cè¯­è¨€å®ç°</title>
    <link href="/2023/08/05/%E9%A1%B9%E7%9B%AE/%E7%BA%BF%E7%A8%8B%E6%B1%A0/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/08/05/%E9%A1%B9%E7%9B%AE/%E7%BA%BF%E7%A8%8B%E6%B1%A0/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="1-ä»»åŠ¡é˜Ÿåˆ—"><a href="#1-ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="1.ä»»åŠ¡é˜Ÿåˆ—"></a>1.ä»»åŠ¡é˜Ÿåˆ—</h2><p>çº¿ç¨‹æ± ç»“æ„ä½“å°±æ˜¯å­˜å‚¨ä»»åŠ¡é˜Ÿåˆ—çš„ã€‚å¾ˆæ˜æ˜¾ï¼Œä»»åŠ¡ä¸­éœ€è¦æœ‰æ‰§è¡Œå‡½æ•°çš„å‡½æ•°åœ°å€å’Œä¼ å…¥çš„å‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Task</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">void</span> (*function)(<span class="hljs-type">void</span> *arg);<br>    <span class="hljs-type">void</span> *arg;<br>&#125; Task;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„<code>function</code>å‡½æ•°åªæ¥å—å•ä¸ªå‚æ•°ã€‚</p><ul><li>å¦‚æœéœ€è¦å¤šä¸ªå‚æ•°å‘¢ï¼Ÿæˆ‘åœ¨githubä¸Šç»™å‡ºäº†ä¸€å°æ®µå®ç°ä»£ç ã€‚<br><a href="https://github.com/BlackGhostLzc/ThreadPool.git">è¿™æ˜¯æˆ‘çš„githubä»“åº“</a><br>å…¶å®å°±æ˜¯éœ€è¦ä¸€ä¸ªå‚æ•°ç»“æ„ä½“<code>MyParam</code>ï¼Œ<code>function</code>ä¸­ä¼ å…¥çš„<code>arg</code>ç±»å‹è½¬æ¢ä¸º<code>MyParam</code>å°±è¡Œäº†ã€‚</li></ul><hr><h2 id="2-çº¿ç¨‹æ± å®šä¹‰"><a href="#2-çº¿ç¨‹æ± å®šä¹‰" class="headerlink" title="2.çº¿ç¨‹æ± å®šä¹‰"></a>2.çº¿ç¨‹æ± å®šä¹‰</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ThreadPool</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">// ä»»åŠ¡é˜Ÿåˆ—</span><br>    Task *taskQ;<br>    <span class="hljs-type">int</span> queueCapacity;<br>    <span class="hljs-type">int</span> queueSize; <span class="hljs-comment">// å½“å‰ä»»åŠ¡ä¸ªæ•°</span><br>    <span class="hljs-type">int</span> queueFront;<br>    <span class="hljs-type">int</span> queueRear;<br><br>    <span class="hljs-type">pthread_t</span> managerID;  <span class="hljs-comment">// ç®¡ç†è€…çº¿ç¨‹ID</span><br>    <span class="hljs-type">pthread_t</span> *threadIDs; <span class="hljs-comment">// å·¥ä½œçš„çº¿ç¨‹ID</span><br><br>    <span class="hljs-type">int</span> minNum;  <span class="hljs-comment">// æœ€å°çº¿ç¨‹æ•°</span><br>    <span class="hljs-type">int</span> maxNum;  <span class="hljs-comment">// æœ€å¤§çº¿ç¨‹æ•°</span><br>    <span class="hljs-type">int</span> busyNum; <span class="hljs-comment">// å¿™çš„çº¿ç¨‹æ•°</span><br>    <span class="hljs-type">int</span> liveNum; <span class="hljs-comment">// å­˜æ´»çš„çº¿ç¨‹æ•°</span><br>    <span class="hljs-type">int</span> exitNum; <span class="hljs-comment">// è¦æ€æ­»çš„çº¿ç¨‹ä¸ªæ•°</span><br><br>    <span class="hljs-type">pthread_mutex_t</span> mutexPool; <span class="hljs-comment">// é”æ•´ä¸ªçº¿ç¨‹æ± </span><br>    <span class="hljs-type">pthread_mutex_t</span> mutexBusy; <span class="hljs-comment">// é”busyNumå˜é‡</span><br><br>    <span class="hljs-type">pthread_cond_t</span> notFull; <span class="hljs-comment">// ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æ˜¯æ»¡çš„</span><br>    <span class="hljs-type">pthread_cond_t</span> notEmpty;<br><br>    <span class="hljs-type">int</span> shutdown; <span class="hljs-comment">// æ˜¯å¦é”€æ¯çº¿ç¨‹æ± </span><br>&#125; ThreadPool;<br></code></pre></td></tr></table></figure><hr><h2 id="3-å‡½æ•°ç”³æ˜"><a href="#3-å‡½æ•°ç”³æ˜" class="headerlink" title="3.å‡½æ•°ç”³æ˜"></a>3.å‡½æ•°ç”³æ˜</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// åˆ›å»ºçº¿ç¨‹æ± </span><br>ThreadPool *<span class="hljs-title function_">threadPoolCreate</span><span class="hljs-params">(<span class="hljs-type">int</span> min, <span class="hljs-type">int</span> max, <span class="hljs-type">int</span> queueSize)</span>;<br><span class="hljs-comment">// é”€æ¯çº¿ç¨‹æ± </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">threadPoolDestroy</span><span class="hljs-params">(ThreadPool *pool)</span>;<br><span class="hljs-comment">// å¾€ç­‰å¾…é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡,threadPoolä¸­çš„TaskQ</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">threadPoolAdd</span><span class="hljs-params">(ThreadPool *pool, <span class="hljs-type">void</span> (*func)(<span class="hljs-type">void</span> *), <span class="hljs-type">void</span> *arg)</span>;<br><span class="hljs-comment">// å¿™ç¢Œçº¿ç¨‹çš„ä¸ªæ•°</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">threadPoolBusyNum</span><span class="hljs-params">(ThreadPool *pool)</span>;<br><span class="hljs-comment">// å­˜æ´»çº¿ç¨‹çš„ä¸ªæ•°</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">threadPoolAliveNum</span><span class="hljs-params">(ThreadPool *pool)</span>;<br><span class="hljs-comment">// managerçº¿ç¨‹å¤„ç†å‡½æ•°</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">manager</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span>;<br><span class="hljs-comment">// å­˜æ´»çº¿ç¨‹å¤„ç†å‡½æ•°</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">worker</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span>;<br><span class="hljs-comment">// çº¿ç¨‹é€€å‡º</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">threadExit</span><span class="hljs-params">(ThreadPool *pool)</span>;<br></code></pre></td></tr></table></figure><hr><h2 id="4-å‡½æ•°ä»£ç å®ç°"><a href="#4-å‡½æ•°ä»£ç å®ç°" class="headerlink" title="4.å‡½æ•°ä»£ç å®ç°"></a>4.å‡½æ•°ä»£ç å®ç°</h2><h3 id="threadPoolCreate"><a href="#threadPoolCreate" class="headerlink" title="threadPoolCreate"></a>threadPoolCreate</h3><p>ä½“ä¼šä¸€ä¸‹<code>do... while(0)</code>çš„å¦™ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c">ThreadPool *<span class="hljs-title function_">threadPoolCreate</span><span class="hljs-params">(<span class="hljs-type">int</span> min, <span class="hljs-type">int</span> max, <span class="hljs-type">int</span> queueSize)</span><br>&#123;<br>    ThreadPool *pool = (ThreadPool *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(ThreadPool));<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (pool == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc threadpool fail...\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        pool-&gt;threadIDs = (<span class="hljs-type">pthread_t</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">pthread_t</span>) * max);<br>        <span class="hljs-keyword">if</span> (pool-&gt;threadIDs == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc threadIDs fail...\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-built_in">memset</span>(pool-&gt;threadIDs, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">pthread_t</span>) * max);<br>        pool-&gt;minNum = min;<br>        pool-&gt;maxNum = max;<br>        pool-&gt;busyNum = <span class="hljs-number">0</span>;<br>        pool-&gt;liveNum = min; <span class="hljs-comment">// å’Œæœ€å°ä¸ªæ•°ç›¸ç­‰</span><br>        pool-&gt;exitNum = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">if</span> (pthread_mutex_init(&amp;pool-&gt;mutexPool, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span> ||<br>            pthread_mutex_init(&amp;pool-&gt;mutexBusy, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span> ||<br>            pthread_cond_init(&amp;pool-&gt;notEmpty, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span> ||<br>            pthread_cond_init(&amp;pool-&gt;notFull, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mutex or condition init fail...\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// ä»»åŠ¡é˜Ÿåˆ—</span><br>        pool-&gt;taskQ = (Task *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(Task) * queueSize);<br>        pool-&gt;queueCapacity = queueSize;<br>        pool-&gt;queueSize = <span class="hljs-number">0</span>;<br>        pool-&gt;queueFront = <span class="hljs-number">0</span>;<br>        pool-&gt;queueRear = <span class="hljs-number">0</span>;<br><br>        pool-&gt;shutdown = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">// åˆ›å»ºçº¿ç¨‹</span><br>        pthread_create(&amp;pool-&gt;managerID, <span class="hljs-literal">NULL</span>, manager, pool);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; min; ++i)<br>        &#123;<br>            pthread_create(&amp;pool-&gt;threadIDs[i], <span class="hljs-literal">NULL</span>, worker, pool);<br>        &#125;<br>        <span class="hljs-keyword">return</span> pool;<br>    &#125; <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// é‡Šæ”¾èµ„æº</span><br>    <span class="hljs-keyword">if</span> (pool &amp;&amp; pool-&gt;threadIDs)<br>        <span class="hljs-built_in">free</span>(pool-&gt;threadIDs);<br>    <span class="hljs-keyword">if</span> (pool &amp;&amp; pool-&gt;taskQ)<br>        <span class="hljs-built_in">free</span>(pool-&gt;taskQ);<br>    <span class="hljs-keyword">if</span> (pool)<br>        <span class="hljs-built_in">free</span>(pool);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="threadPoolDestroy"><a href="#threadPoolDestroy" class="headerlink" title="threadPoolDestroy"></a>threadPoolDestroy</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">threadPoolDestroy</span><span class="hljs-params">(ThreadPool *pool)</span><br>&#123;<br><br>    <span class="hljs-keyword">if</span> (pool == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// å…³é—­çº¿ç¨‹æ± </span><br>    pool-&gt;shutdown = <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">// é˜»å¡å›æ”¶ç®¡ç†è€…çº¿ç¨‹</span><br>    pthread_join(pool-&gt;managerID, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">// å”¤é†’é˜»å¡çš„æ¶ˆè´¹è€…çº¿ç¨‹</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; pool-&gt;liveNum; ++i)<br>    &#123;<br>        pthread_cond_signal(&amp;pool-&gt;notEmpty);<br>    &#125;<br>    <span class="hljs-comment">// é‡Šæ”¾å †å†…å­˜</span><br>    <span class="hljs-keyword">if</span> (pool-&gt;taskQ)<br>    &#123;<br>        <span class="hljs-built_in">free</span>(pool-&gt;taskQ);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (pool-&gt;threadIDs)<br>    &#123;<br>        <span class="hljs-built_in">free</span>(pool-&gt;threadIDs);<br>    &#125;<br><br>    pthread_mutex_destroy(&amp;pool-&gt;mutexPool);<br>    pthread_mutex_destroy(&amp;pool-&gt;mutexBusy);<br>    pthread_cond_destroy(&amp;pool-&gt;notEmpty);<br>    pthread_cond_destroy(&amp;pool-&gt;notFull);<br><br>    <span class="hljs-built_in">free</span>(pool);<br>    pool = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="threadPoolAdd"><a href="#threadPoolAdd" class="headerlink" title="threadPoolAdd"></a>threadPoolAdd</h3><ul><li>ä¸ºä»€ä¹ˆéœ€è¦<code>while</code>å¾ªç¯<br>å› ä¸º<code>pthread_cond_signal</code>ä¼šå”¤é†’æ‰€æœ‰è¢«æ¡ä»¶å˜é‡é˜»å¡çš„çº¿ç¨‹ã€‚<br>å‡è®¾æœ‰ä¸¤ä¸ªç”Ÿäº§è€…çº¿ç¨‹å› ä¸ºä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œè€Œè¢«é˜»å¡åœ¨è¯¥ä½ç½®ã€‚éšåæŸä¸ªå·¥ä½œçº¿ç¨‹æ‹¿å–äº†ä¸€ä¸ªä»»åŠ¡è€Œä½¿å¾—ä»»åŠ¡é˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œæ¥ç€<code>pthread_cond_signal</code>å”¤é†’è¿™ä¸¤ä¸ªç”Ÿäº§è€…çº¿ç¨‹ã€‚è¿™ä¸¤ä¸ªç”Ÿäº§è€…çº¿ç¨‹é¦–å…ˆéƒ½å°è¯•è·å–<code>mutexPool</code>è¿™æŠŠé”ï¼Œç„¶ååªæœ‰ä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹æ‹¿åˆ°äº†è¿™æŠŠé”ï¼Œæ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ª<code>while</code>å¾ªç¯æ¡ä»¶ä¸æ»¡è¶³å°±é€€å‡ºäº†ï¼Œç„¶åå°±å¯ä»¥æŠŠä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œæœ€åé‡Šæ”¾æ‰äº†é”ã€‚æ­¤æ—¶ä»»åŠ¡é˜Ÿåˆ—åˆæ»¡äº†ã€‚<br>éšåç¬¬äºŒä¸ªç”Ÿäº§è€…çº¿ç¨‹è·å¾—é”ï¼Œä»åœ¨<code>while</code>å¾ªç¯ä¸­ï¼Œå®ƒå‘ç°æ¡ä»¶ä»ç„¶æ»¡è¶³ï¼Œåˆè°ƒç”¨<code>pthread_cond_wait</code>å‡½æ•°ã€‚<br>é€šè¿‡è¿™æ ·çš„æœºåˆ¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°±ä¸ä¼šåœ¨å·²ç»æ»¡äº†çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ç»§ç»­æ·»åŠ ä»»åŠ¡äº†ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">threadPoolAdd</span><span class="hljs-params">(ThreadPool *pool, <span class="hljs-type">void</span> (*func)(<span class="hljs-type">void</span> *), <span class="hljs-type">void</span> *arg)</span><br>&#123;<br><br>    pthread_mutex_lock(&amp;pool-&gt;mutexPool);<br>    <span class="hljs-keyword">while</span> (pool-&gt;queueSize == pool-&gt;queueCapacity &amp;&amp; !pool-&gt;shutdown)<br>    &#123;<br>        <span class="hljs-comment">// é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹</span><br>        pthread_cond_wait(&amp;pool-&gt;notFull, &amp;pool-&gt;mutexPool);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (pool-&gt;shutdown)<br>    &#123;<br>        pthread_mutex_unlock(&amp;pool-&gt;mutexPool);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// æ·»åŠ ä»»åŠ¡</span><br>    pool-&gt;taskQ[pool-&gt;queueRear].function = func;<br>    pool-&gt;taskQ[pool-&gt;queueRear].arg = arg;<br>    pool-&gt;queueRear = (pool-&gt;queueRear + <span class="hljs-number">1</span>) % pool-&gt;queueCapacity;<br>    pool-&gt;queueSize++;<br><br>    pthread_cond_signal(&amp;pool-&gt;notEmpty);<br>    pthread_mutex_unlock(&amp;pool-&gt;mutexPool);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="threadPoolBusyNumã€threadPoolAliveNum"><a href="#threadPoolBusyNumã€threadPoolAliveNum" class="headerlink" title="threadPoolBusyNumã€threadPoolAliveNum"></a>threadPoolBusyNumã€threadPoolAliveNum</h3><p>è¿™ä¸¤ä¸ªå‡½æ•°æ¯”è¾ƒç®€å•ï¼Œä¸åšè¯´æ˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">threadPoolBusyNum</span><span class="hljs-params">(ThreadPool *pool)</span><br>&#123;<br>    pthread_mutex_lock(&amp;pool-&gt;mutexBusy);<br>    <span class="hljs-type">int</span> busyNum = pool-&gt;busyNum;<br>    pthread_mutex_unlock(&amp;pool-&gt;mutexBusy);<br>    <span class="hljs-keyword">return</span> busyNum;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">threadPoolAliveNum</span><span class="hljs-params">(ThreadPool *pool)</span><br>&#123;<br>    pthread_mutex_lock(&amp;pool-&gt;mutexPool);<br>    <span class="hljs-type">int</span> aliveNum = pool-&gt;liveNum;<br>    pthread_mutex_unlock(&amp;pool-&gt;mutexPool);<br>    <span class="hljs-keyword">return</span> aliveNum;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="worker"><a href="#worker" class="headerlink" title="worker"></a>worker</h3><p>ä¸Šä¸€ç¯‡è¯´è¿‡ï¼Œ<code>woker</code>å‡½æ•°æ˜¯ä¸€ä¸ª<code>while</code>å¾ªç¯ï¼Œè¿™å¾ˆè‡ªç„¶ï¼Œå› ä¸ºçº¿ç¨‹æ± å°±æ˜¯è¦å¤ç”¨çº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹ç»“æŸååº”è¯¥è½¬å»æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä¸åº”è¯¥ç»“æŸã€‚<br><code>while</code>å¾ªç¯ä¸‹è¿˜æœ‰ä¸€ä¸ª<code>while</code>å¾ªç¯ï¼Œè¿™å’Œä¸Šé¢çš„é€»è¾‘å¾ˆåƒã€‚ä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢æŸä¸ªçº¿ç¨‹å°è¯•è·å–ç©ºé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè¿™ä¼šå¼•å‘éš¾ä»¥é¢„æ–™çš„é”™è¯¯ã€‚<br>æœ€åçº¿ç¨‹çš„æ‰§è¡Œå°±æ˜¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨<code>task.function(task.arg)</code><br>è¿™é‡Œè¿˜éœ€è¦æ³¨æ„å¯¹<code>busyNum</code>çš„å¤„ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">worker</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    ThreadPool *pool = (ThreadPool *)arg;<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        pthread_mutex_lock(&amp;pool-&gt;mutexPool);<br>        <span class="hljs-comment">// å½“å‰ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span><br>        <span class="hljs-keyword">while</span> (pool-&gt;queueSize == <span class="hljs-number">0</span> &amp;&amp; !pool-&gt;shutdown)<br>        &#123;<br>            <span class="hljs-comment">// é˜»å¡å·¥ä½œçº¿ç¨‹</span><br>            pthread_cond_wait(&amp;pool-&gt;notEmpty, &amp;pool-&gt;mutexPool);<br><br>            <span class="hljs-comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯è¦é”€æ¯çº¿ç¨‹</span><br>            <span class="hljs-keyword">if</span> (pool-&gt;exitNum &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                pool-&gt;exitNum--;<br>                <span class="hljs-keyword">if</span> (pool-&gt;liveNum &gt; pool-&gt;minNum)<br>                &#123;<br>                    pool-&gt;liveNum--;<br>                    pthread_mutex_unlock(&amp;pool-&gt;mutexPool);<br>                    threadExit(pool);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦è¢«å…³é—­äº†</span><br>        <span class="hljs-keyword">if</span> (pool-&gt;shutdown)<br>        &#123;<br>            pthread_mutex_unlock(&amp;pool-&gt;mutexPool);<br>            threadExit(pool);<br>        &#125;<br><br>        <span class="hljs-comment">// ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡</span><br>        Task task;<br>        task.function = pool-&gt;taskQ[pool-&gt;queueFront].function;<br>        task.arg = pool-&gt;taskQ[pool-&gt;queueFront].arg;<br>        <span class="hljs-comment">// ç§»åŠ¨å¤´ç»“ç‚¹</span><br>        pool-&gt;queueFront = (pool-&gt;queueFront + <span class="hljs-number">1</span>) % pool-&gt;queueCapacity;<br>        pool-&gt;queueSize--;<br>        <span class="hljs-comment">// è§£é”</span><br>        pthread_cond_signal(&amp;pool-&gt;notFull);<br>        pthread_mutex_unlock(&amp;pool-&gt;mutexPool);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread %ld start working...\n&quot;</span>, pthread_self());<br>        pthread_mutex_lock(&amp;pool-&gt;mutexBusy);<br>        pool-&gt;busyNum++;<br>        pthread_mutex_unlock(&amp;pool-&gt;mutexBusy);<br>        task.function(task.arg);<br>        <span class="hljs-built_in">free</span>(task.arg);<br>        task.arg = <span class="hljs-literal">NULL</span>;<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread %ld end working...\n&quot;</span>, pthread_self());<br>        pthread_mutex_lock(&amp;pool-&gt;mutexBusy);<br>        pool-&gt;busyNum--;<br>        pthread_mutex_unlock(&amp;pool-&gt;mutexBusy);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="manager"><a href="#manager" class="headerlink" title="manager"></a>manager</h3><p><code>manager</code>æ˜¯ç®¡ç†è¿™äº›å­˜æ´»çº¿ç¨‹çš„çº¿ç¨‹ã€‚<br><code>exitNum</code>æ˜¯éœ€è¦æ€æ­»çš„çº¿ç¨‹æ•°ç›®ã€‚<br>åœ¨è¿™é‡Œï¼Œå¢åŠ å­˜æ´»çº¿ç¨‹å’Œæ€æ­»å­˜æ´»çº¿ç¨‹çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œè¯¦æƒ…è§ä»£ç ã€‚<br>æ¯ä¸€æ¬¡æœ€å¤šå¢åŠ æˆ–æ€æ­»<code>NUMBER</code>ä¸ªå­˜æ´»çº¿ç¨‹ã€‚å…¶å®æ€æ­»å­˜æ´»çº¿ç¨‹çš„é€»è¾‘ä»ç„¶åœ¨å­˜æ´»çº¿ç¨‹çš„<code>worker</code>å‡½æ•°ä¸­ï¼Œ<del>å­˜æ´»çº¿ç¨‹éƒ½æ˜¯è‡ªæ€çš„</del>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">manager</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    ThreadPool *pool = (ThreadPool *)arg;<br>    <span class="hljs-keyword">while</span> (!pool-&gt;shutdown)<br>    &#123;<br>        <span class="hljs-comment">// æ¯éš”3sæ£€æµ‹ä¸€æ¬¡</span><br>        sleep(<span class="hljs-number">3</span>);<br><br>        <span class="hljs-comment">// å–å‡ºçº¿ç¨‹æ± ä¸­ä»»åŠ¡çš„æ•°é‡å’Œå½“å‰çº¿ç¨‹çš„æ•°é‡</span><br>        pthread_mutex_lock(&amp;pool-&gt;mutexPool);<br>        <span class="hljs-type">int</span> queueSize = pool-&gt;queueSize;<br>        <span class="hljs-type">int</span> liveNum = pool-&gt;liveNum;<br>        pthread_mutex_unlock(&amp;pool-&gt;mutexPool);<br><br>        <span class="hljs-comment">// å–å‡ºå¿™çš„çº¿ç¨‹çš„æ•°é‡</span><br>        pthread_mutex_lock(&amp;pool-&gt;mutexBusy);<br>        <span class="hljs-type">int</span> busyNum = pool-&gt;busyNum;<br>        pthread_mutex_unlock(&amp;pool-&gt;mutexBusy);<br><br>        <span class="hljs-comment">// æ·»åŠ çº¿ç¨‹</span><br>        <span class="hljs-comment">// ä»»åŠ¡çš„ä¸ªæ•°&gt;å­˜æ´»çš„çº¿ç¨‹ä¸ªæ•° &amp;&amp; å­˜æ´»çš„çº¿ç¨‹æ•°&lt;æœ€å¤§çº¿ç¨‹æ•°</span><br>        <span class="hljs-keyword">if</span> (queueSize &gt; liveNum &amp;&amp; liveNum &lt; pool-&gt;maxNum)<br>        &#123;<br>            pthread_mutex_lock(&amp;pool-&gt;mutexPool);<br>            <span class="hljs-type">int</span> counter = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; pool-&gt;maxNum &amp;&amp; counter &lt; NUMBER &amp;&amp; pool-&gt;liveNum &lt; pool-&gt;maxNum; ++i)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (pool-&gt;threadIDs[i] == <span class="hljs-number">0</span>)<br>                &#123;<br>                    pthread_create(&amp;pool-&gt;threadIDs[i], <span class="hljs-literal">NULL</span>, worker, pool);<br>                    counter++;<br>                    pool-&gt;liveNum++;<br>                &#125;<br>            &#125;<br>            pthread_mutex_unlock(&amp;pool-&gt;mutexPool);<br>        &#125;<br>        <span class="hljs-comment">// é”€æ¯çº¿ç¨‹</span><br>        <span class="hljs-comment">// å¿™çš„çº¿ç¨‹*2 &lt; å­˜æ´»çš„çº¿ç¨‹æ•° &amp;&amp; å­˜æ´»çš„çº¿ç¨‹&gt;æœ€å°çº¿ç¨‹æ•°</span><br>        <span class="hljs-keyword">if</span> (busyNum * <span class="hljs-number">2</span> &lt; liveNum &amp;&amp; liveNum &gt; pool-&gt;minNum)<br>        &#123;<br>            pthread_mutex_lock(&amp;pool-&gt;mutexPool);<br>            pool-&gt;exitNum = NUMBER;<br>            pthread_mutex_unlock(&amp;pool-&gt;mutexPool);<br>            <span class="hljs-comment">// è®©å·¥ä½œçš„çº¿ç¨‹è‡ªæ€</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NUMBER; ++i)<br>            &#123;<br>                pthread_cond_signal(&amp;pool-&gt;notEmpty);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="threadExit"><a href="#threadExit" class="headerlink" title="threadExit"></a>threadExit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">threadExit</span><span class="hljs-params">(ThreadPool *pool)</span><br>&#123;<br>    <span class="hljs-type">pthread_t</span> tid = pthread_self();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; pool-&gt;maxNum; ++i)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (pool-&gt;threadIDs[i] == tid)<br>        &#123;<br>            pool-&gt;threadIDs[i] = <span class="hljs-number">0</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;threadExit() called, %ld exiting...\n&quot;</span>, tid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    pthread_exit(<span class="hljs-literal">NULL</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>é¡¹ç›®</category>
      
      <category>çº¿ç¨‹æ± </category>
      
    </categories>
    
    
    <tags>
      
      <tag>é¡¹ç›®</tag>
      
      <tag>çº¿ç¨‹æ± </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çº¿ç¨‹æ± æ¦‚è¿°</title>
    <link href="/2023/08/05/%E9%A1%B9%E7%9B%AE/%E7%BA%BF%E7%A8%8B%E6%B1%A0/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%A6%82%E8%BF%B0/"/>
    <url>/2023/08/05/%E9%A1%B9%E7%9B%AE/%E7%BA%BF%E7%A8%8B%E6%B1%A0/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%A6%82%E8%BF%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="1-çº¿ç¨‹æ± çš„åŸç†"><a href="#1-çº¿ç¨‹æ± çš„åŸç†" class="headerlink" title="1.çº¿ç¨‹æ± çš„åŸç†"></a>1.çº¿ç¨‹æ± çš„åŸç†</h2><p>ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± </p><ul><li>å¹¶å‘çš„çº¿ç¨‹æ•°ç›®è¾ƒå¤šï¼Œå‡å¦‚æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åªæ˜¯æ‰§è¡Œä¸€ä¸ªæ—¶é—´å¾ˆçŸ­çš„ä»»åŠ¡å°±ç»“æŸäº†ï¼Œé‚£ä¹ˆè¿™æ ·é¢‘ç¹çš„åˆ›å»ºçº¿ç¨‹å°±ä¼šå¤§å¤§é™ä½ç³»ç»Ÿçš„æ•ˆç‡ï¼Œå› ä¸ºé¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹éƒ½éœ€è¦æ—¶é—´ã€‚</li></ul><p>çº¿ç¨‹æ± å°±æ˜¯ä½¿å¾—çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åå¹¶ä¸é”€æ¯ã€‚çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹éƒ½æ˜¯åå°çº¿ç¨‹ã€‚å¦‚æœæŸä¸ªçº¿ç¨‹åœ¨æ‰˜ç®¡ä»£ç ä¸­ç©ºé—²ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± å°†æ’å…¥å¦ä¸€ä¸ªè¾…åŠ©çº¿ç¨‹æ¥ä½¿æ‰€æœ‰å¤„ç†å™¨ç¹å¿™ã€‚å¦‚æœçº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½ç¹å¿™ï¼Œä½†é˜Ÿåˆ—ä¸­åŒ…å«æŒ‚èµ·çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± åº”è¯¥åˆ›å»ºä¸€ä¸ªè¾…åŠ©çº¿ç¨‹ä½†çº¿ç¨‹çš„æ€»æ•°ä¸åº”è¶…è¿‡æœ€å¤§å€¼ã€‚è¶…è¿‡æœ€å¤§å€¼çš„çº¿ç¨‹éœ€è¦æ’é˜Ÿã€‚</p><h3 id="çº¿ç¨‹æ± çš„ç»„æˆ"><a href="#çº¿ç¨‹æ± çš„ç»„æˆ" class="headerlink" title="çº¿ç¨‹æ± çš„ç»„æˆ"></a>çº¿ç¨‹æ± çš„ç»„æˆ</h3><h4 id="ä»»åŠ¡é˜Ÿåˆ—"><a href="#ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="ä»»åŠ¡é˜Ÿåˆ—"></a>ä»»åŠ¡é˜Ÿåˆ—</h4><p>å­˜å‚¨éœ€è¦å¤„ç†çš„ä»»åŠ¡ï¼Œç”±å·¥ä½œçš„çº¿ç¨‹æ¥å¤„ç†è¿™äº›ä»»åŠ¡ï¼Œçº¿ç¨‹æ± threadpoolä¸­å°±æ˜¯å­˜å‚¨è¿™äº›å¾…å¤„ç†çš„ä»»åŠ¡ã€‚</p><blockquote><p>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼šç”Ÿäº§è€…çº¿ç¨‹å¾€ä»»åŠ¡é˜Ÿåˆ—é‡Œæ”¾ä»»åŠ¡ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹æŠŠä»»åŠ¡ä»é˜Ÿåˆ—ä¸­å–å‡ºå»ã€‚</p></blockquote><h4 id="å·¥ä½œçš„çº¿ç¨‹"><a href="#å·¥ä½œçš„çº¿ç¨‹" class="headerlink" title="å·¥ä½œçš„çº¿ç¨‹"></a>å·¥ä½œçš„çº¿ç¨‹</h4><p>ä»»åŠ¡é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ã€‚å®ƒä»¬ä¸åœåœ°è¯»å–ä»»åŠ¡é˜Ÿåˆ—ï¼Œä»ä¸­å–å‡ºä»»åŠ¡å¹¶å¤„ç†ã€‚<br>å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œå·¥ä½œçš„çº¿ç¨‹å°†è¢«é˜»å¡ï¼›å¦‚æœé˜»å¡åæœ‰æ–°çš„ä»»åŠ¡ï¼Œç”±ç”Ÿäº§è€…å°†é˜»å¡è§£é™¤ï¼Œå·¥ä½œçº¿ç¨‹å¼€å§‹å·¥ä½œã€‚</p><h4 id="ç®¡ç†è€…çº¿ç¨‹"><a href="#ç®¡ç†è€…çº¿ç¨‹" class="headerlink" title="ç®¡ç†è€…çº¿ç¨‹"></a>ç®¡ç†è€…çº¿ç¨‹</h4><p>å‘¨æœŸæ€§åœ°å¯¹ä»»åŠ¡é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„æ•°é‡ä»¥åŠå¤„äºå¿™ç¢ŒçŠ¶æ€çš„å·¥ä½œçº¿ç¨‹è¿›è¡Œæ£€æµ‹ã€‚</p><ul><li>ä»»åŠ¡è¿‡å¤šçš„æ—¶å€™ï¼Œå¯ä»¥åˆ›å»ºä¸€äº›æ–°çš„å·¥ä½œçº¿ç¨‹</li><li>ä»»åŠ¡è¿‡å°‘æ—¶ï¼Œå¯ä»¥é”€æ¯ä¸€äº›å·¥ä½œçº¿ç¨‹</li></ul><hr><h2 id="2-é¡¹ç›®ä»‹ç»"><a href="#2-é¡¹ç›®ä»‹ç»" class="headerlink" title="2.é¡¹ç›®ä»‹ç»"></a>2.é¡¹ç›®ä»‹ç»</h2><h3 id="ç›¸å…³å‡½æ•°ä»‹ç»"><a href="#ç›¸å…³å‡½æ•°ä»‹ç»" class="headerlink" title="ç›¸å…³å‡½æ•°ä»‹ç»"></a>ç›¸å…³å‡½æ•°ä»‹ç»</h3><p>é¦–å…ˆéœ€è¦ä»‹ç»å‡ ä¸ª<code>pthread.h</code>çš„åº“å‡½æ•°ã€‚<br><code>pthread_create(pthread_t *restrict thread, const pthread_attr_t`` *restrict attr, void *(*start_routine)(void *),void *restrict arg)</code>:åˆ›å»ºçº¿ç¨‹, <code>start_rountine</code>ä½œä¸ºçº¿ç¨‹èµ·å§‹æ‰§è¡Œå‡½æ•°ï¼Œ<code>arg</code>æ˜¯ä¼ è¿›è¯¥å‡½æ•°çš„å‚æ•°ã€‚</p><p><code>pthread_join(pthread_t thread, void **retval)</code>:ç­‰å¾… <code>thread</code>çº¿ç¨‹ç»“æŸï¼Œè°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹å°†è¢«é˜»å¡ã€‚</p><p><code>pthread_cond_wait(pthread_cond_t *restrict cond, pthread_mutex_t *restrict mutex)</code>: åœ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°å‰ï¼Œéƒ½è¦è·å–<code>mutex</code>äº’æ–¥é”ã€‚ç„¶åæŒ‚èµ·è¯¥çº¿ç¨‹ï¼Œé˜»å¡çš„æ—¶å€™é‡Šæ”¾<code>mutex</code>è¿™æŠŠé”ï¼ˆé¿å…æ­»é”ï¼‰ã€‚ç­‰åˆ°å†è¢«å”¤é†’çš„æ—¶å€™ï¼Œä»–åˆä¼šé‡æ–°è·å–<code>mutex</code>è¿™æŠŠé”ã€‚</p><p><code>pthread_signal(pthread_cond_t *cond)</code>:å”¤é†’é˜»å¡åœ¨<code>cond</code>æ¡ä»¶å˜é‡ä¸Šçš„æ‰€æœ‰çº¿ç¨‹ï¼Œé€šå¸¸é…åˆä¸Šé¢çš„å‡½æ•°ä¸€èµ·ä½¿ç”¨ã€‚</p><h3 id="ä»£ç å®ç°æ€è·¯"><a href="#ä»£ç å®ç°æ€è·¯" class="headerlink" title="ä»£ç å®ç°æ€è·¯"></a>ä»£ç å®ç°æ€è·¯</h3><ol><li>å­˜æ´»çº¿ç¨‹ï¼šæ˜¯ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æˆ–è€…å·²ç»åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹</li><li>å¿™ç¢Œçº¿ç¨‹ï¼šå·²ç»åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹</li></ol><ul><li>éœ€è¦åˆ›å»ºä¸€ä¸ªç®¡ç†è€…çº¿ç¨‹ï¼Œä¼ å…¥ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ<code>manage</code>,è¿™ä¸ª<code>manage</code>å‡½æ•°æ˜¯ä¸€ä¸ª<code>while</code>å¾ªç¯ï¼Œå®ƒæ¯éš”ä¸€æ®µæ—¶é—´å°±åšä¸€æ¬¡æ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ·»åŠ æ–°çš„å­˜æ´»çº¿ç¨‹æˆ–è€…é”€æ¯å­˜æ´»çº¿ç¨‹ã€‚</li><li>åˆ›å»ºå¤šä¸ªå­˜æ´»çº¿ç¨‹ï¼Œä¼ å…¥å‡½æ•°æŒ‡é’ˆ<code>worker</code>,åŒæ ·ï¼Œè¿™ä¸ª<code>worker</code>å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ª<code>while</code>å¾ªç¯ï¼Œä¸æ–­å¤„ç†çº¿ç¨‹æ± ä¸­çš„å¾…å¤„ç†ä»»åŠ¡ã€‚åœ¨è·å–äº†çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡åï¼Œå¾…å¤„ç†ä»»åŠ¡çš„æ‰§è¡Œå°±æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå‡½æ•°å®Œæˆåæ¥ç€ä¸‹ä¸€æ¬¡çš„<code>while</code>å¾ªç¯åˆ¤æ–­ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>é¡¹ç›®</category>
      
      <category>çº¿ç¨‹æ± </category>
      
    </categories>
    
    
    <tags>
      
      <tag>é¡¹ç›®</tag>
      
      <tag>çº¿ç¨‹æ± </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¡¬ä»¶è§†è§’çš„æ“ä½œç³»ç»Ÿ</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%A1%AC%E4%BB%B6%E8%A7%86%E8%A7%92%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%A1%AC%E4%BB%B6%E8%A7%86%E8%A7%92%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ¬è®²å†…å®¹ï¼šè®¡ç®—æœºç¡¬ä»¶çš„çŠ¶æ€æœºæ¨¡å‹ï¼›å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š"><a href="#æœ¬è®²å†…å®¹ï¼šè®¡ç®—æœºç¡¬ä»¶çš„çŠ¶æ€æœºæ¨¡å‹ï¼›å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š" class="headerlink" title="æœ¬è®²å†…å®¹ï¼šè®¡ç®—æœºç¡¬ä»¶çš„çŠ¶æ€æœºæ¨¡å‹ï¼›å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š"></a>æœ¬è®²å†…å®¹ï¼šè®¡ç®—æœºç¡¬ä»¶çš„çŠ¶æ€æœºæ¨¡å‹ï¼›å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š</h2><ul><li>ä»€ä¹ˆæ˜¯è®¡ç®—æœºç¡¬ä»¶ï¼Ÿ</li><li>è®¡ç®—æœºç¡¬ä»¶å’Œç¨‹åºå‘˜ä¹‹é—´æ˜¯å¦‚ä½•çº¦å®šçš„ï¼Ÿ</li><li>å¬è¯´æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åºã€‚é‚£åˆ°åº•æ˜¯é¸¡ç”Ÿè›‹è¿˜æ˜¯è›‹ç”Ÿé¸¡ï¼Ÿ</li></ul><h2 id="ç¡¬ä»¶ä¸ç¨‹åºå‘˜çš„çº¦å®š"><a href="#ç¡¬ä»¶ä¸ç¨‹åºå‘˜çš„çº¦å®š" class="headerlink" title="ç¡¬ä»¶ä¸ç¨‹åºå‘˜çš„çº¦å®š"></a>ç¡¬ä»¶ä¸ç¨‹åºå‘˜çš„çº¦å®š</h2><h3 id="Bare-metal-ä¸ç¨‹åºå‘˜çš„çº¦å®š"><a href="#Bare-metal-ä¸ç¨‹åºå‘˜çš„çº¦å®š" class="headerlink" title="Bare-metal ä¸ç¨‹åºå‘˜çš„çº¦å®š"></a>Bare-metal ä¸ç¨‹åºå‘˜çš„çº¦å®š</h3><blockquote><p>Bare-metal æ˜¯æŒ‡åœ¨æ²¡æœ‰æ“ä½œç³»ç»Ÿæˆ–è€…å…¶ä»–è½¯ä»¶æ”¯æŒçš„æƒ…å†µä¸‹ç›´æ¥è¿è¡Œç¡¬ä»¶çš„æƒ…å†µã€‚</p></blockquote><ul><li><p>Bare-metal ä¸å‚å•†çš„çº¦å®š</p><ul><li>CPU Reset åçš„çŠ¶æ€ (å¯„å­˜å™¨å€¼)</li></ul></li></ul><blockquote><p>   Reset åå¤„ç†å™¨éƒ½ä»å›ºå®šåœ°å€ (Reset Vector) å¯åŠ¨<br>     - å‚å•†è‡ªç”±å¤„ç†è¿™ä¸ªåœ°å€ä¸Šçš„å€¼<br>     - Memory-mapped I&#x2F;O</p></blockquote><ul><li><p>å‚å•†ä¸ºæ“ä½œç³»ç»Ÿå¼€å‘è€…æä¾› Firmware</p><ul><li>ç®¡ç†ç¡¬ä»¶å’Œç³»ç»Ÿé…ç½®</li><li>æŠŠå­˜å‚¨è®¾å¤‡ä¸Šçš„ä»£ç åŠ è½½åˆ°å†…å­˜<ul><li>ä¾‹å¦‚å­˜å‚¨ä»‹è´¨ä¸Šçš„ç¬¬äºŒçº§ loader (åŠ è½½å™¨)</li><li>æˆ–è€…ç›´æ¥åŠ è½½æ“ä½œç³»ç»Ÿ (åµŒå…¥å¼ç³»ç»Ÿ)</li></ul></li></ul></li><li><p>Firmware è´Ÿè´£åŠ è½½æ“ä½œç³»ç»Ÿ: BIOS vs UEFI<br>Legacy BIOS æŠŠç¬¬ä¸€ä¸ªå¯å¼•å¯¼è®¾å¤‡çš„ç¬¬ä¸€ä¸ª 512 å­—èŠ‚åŠ è½½åˆ°ç‰©ç†å†…å­˜çš„ 7c00 ä½ç½®<br>æ­¤æ—¶å¤„ç†å™¨å¤„äº 16-bit æ¨¡å¼ã€‚</p></li><li><p>æˆ‘ä»¬æ„é€ ä¸€ä¸ª 512 å­—èŠ‚çš„ â€œMaster Boot Recordâ€ ä½œä¸ºç£ç›˜é•œåƒè£…åœ¨åœ¨æ¨¡æ‹Ÿå™¨ä¸Šï¼Œå¹¶ä¸”ç”¨ gdb è§‚å¯ŸæŒ‡ä»¤åœ¨å¤„ç†å™¨ä¸Šçš„æ‰§è¡Œã€‚</p></li></ul><p>å¦‚ä½•éªŒè¯è¿™ä¸€ç‚¹ï¼Ÿ<br>è®¡ç®—æœºç³»ç»Ÿå…¬ç†ï¼šä½ æƒ³åˆ°çš„å°±ä¸€å®šæœ‰äººåšåˆ°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs asm">#define SECT_SIZE  512<br><br>.code16  // 16-bit assembly<br><br>// Entry of the code<br>.globl _start<br>_start:<br>  lea   (msg), %si   // R[si] = &amp;msg;<br><br>again:<br>  movb  (%si), %al   // R[al] = *R[si]; &lt;--+<br>  incw  %si          // R[si]++;           |<br>  orb   %al, %al     // if (!R[al])        |<br>  jz    done         //   goto done; --+   |<br>  movb  $0x0e, %ah   // R[ah] = 0x0e;  |   |<br>  movb  $0x00, %bh   // R[bh] = 0x00;  |   |<br>  int   $0x10        // bios_call();   |   |<br>  jmp   again        // goto again; ---+---+<br>                     //                |<br>done:                //                |<br>  jmp   .            // goto done; &lt;---+<br><br>// Data: const char msg[] = &quot;...&quot;;<br>msg:<br>  .asciz &quot;This is a baby step towards operating systems!\r\n&quot;<br><br>// Magic number for bootable device<br>.org SECT_SIZE - 2<br>.byte 0x55, 0xAA<br></code></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Makefile"><span class="hljs-section">mbr.img: mbr.S</span><br>gcc -ggdb -c <span class="hljs-variable">$&lt;</span><br>ld mbr.o -Ttext 0x7c00<br>objcopy -S -O binary -j .text a.out <span class="hljs-variable">$@</span><br><br><span class="hljs-section">run: mbr.img</span><br>qemu-system-x86_64 <span class="hljs-variable">$&lt;</span><br><br><span class="hljs-section">debug: mbr.img</span><br>qemu-system-x86_64 -s -S <span class="hljs-variable">$&lt;</span> &amp;  <span class="hljs-comment"># Run QEMU in background</span><br>gdb -x init.gdb  <span class="hljs-comment"># RTFM: gdb (1)</span><br><br><span class="hljs-section">clean:</span><br>rm -f *.img *.o a.out<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs init.gdb"># Kill process (QEMU) on gdb exits<br>define hook-quit<br>  kill<br>end<br><br># Connect to remote<br>target remote localhost:1234<br>file a.out<br>break *0x7c00<br>layout src<br>continue<br></code></pre></td></tr></table></figure><blockquote><p>å‰ä¸‰è¡Œå‘½ä»¤å®šä¹‰äº†ä¸€ä¸ªåä¸º hook-quit çš„ GDB é’©å­ã€‚å½“ç”¨æˆ·åœ¨ GDB ä¸­æ‰§è¡Œ quit å‘½ä»¤æ—¶ï¼ŒGDB å°†è‡ªåŠ¨æ‰§è¡Œ hook-quit é’©å­ä¸­å®šä¹‰çš„å‘½ä»¤ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œhook-quit é’©å­ä¸­åªæœ‰ä¸€æ¡å‘½ä»¤ killï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨ç”¨æˆ·é€€å‡º GDB æ—¶æ€æ­»æ­£åœ¨è¢«è°ƒè¯•çš„è¿›ç¨‹ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨é€€å‡º GDB åï¼Œè¢«è°ƒè¯•çš„è¿›ç¨‹ä¹Ÿä¼šè¢«ç»ˆæ­¢ï¼Œé¿å…å‡ºç°è¿›ç¨‹åƒµæ­»ç­‰é—®é¢˜ã€‚</p></blockquote><ul><li>å¦‚ä½•ç”¨ gdb è°ƒè¯• qemu<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean">qemu-<span class="hljs-keyword">system</span>-x86_64 -s -S mbr.img<br></code></pre></td></tr></table></figure>-Sï¼š æŠŠCPUæš‚åœä¸‹æ¥<br>-sï¼š shorthand for -gdb tcp::1234       ç›‘å¬1234çš„ç«¯å£</li></ul><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¯åŠ¨ä¸€ä¸ª gdb </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">gdb</span><br><span class="hljs-attribute">target</span> remote localhost::<span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥åœ¨gdbä¸­è°ƒè¯•è¿™ä¸ªqemuæ¨¡æ‹Ÿå™¨äº†ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç³»ç»Ÿè°ƒç”¨å’ŒUNIX Shell</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%92%8CUNIX%20Shell/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%92%8CUNIX%20Shell/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ¬è®²å†…å®¹"><a href="#æœ¬è®²å†…å®¹" class="headerlink" title="æœ¬è®²å†…å®¹"></a>æœ¬è®²å†…å®¹</h2><ul><li>Shell</li><li>xv6 shell ä»£ç è®²è§£</li></ul><h3 id="ä»€ä¹ˆæ˜¯-shell"><a href="#ä»€ä¹ˆæ˜¯-shell" class="headerlink" title="ä»€ä¹ˆæ˜¯ shell"></a>ä»€ä¹ˆæ˜¯ shell</h3><ul><li>os &#x3D; API + å¯¹è±¡<blockquote><p>äººä¸å¯èƒ½ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥ä½¿ç”¨æ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥äººå’Œæ“ä½œç³»ç»Ÿä¹‹é—´éš”äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºå°±å« shellã€‚shell æŠŠå†…æ ¸çš„ API å’Œå¯¹è±¡åšä¸€å±‚å°è£…ï¼Œæ¥å¸®åŠ©ç”¨æˆ·ç®¡ç†æ“ä½œç³»ç»Ÿå¯¹è±¡çš„ä¸€ä¸ª<strong>åº”ç”¨ç¨‹åº</strong> ã€‚<br>æœ‰ graphic shell å’Œ command line shellã€‚</p></blockquote></li></ul><h3 id="shell-ç¼–ç¨‹è¯­è¨€"><a href="#shell-ç¼–ç¨‹è¯­è¨€" class="headerlink" title="shell ç¼–ç¨‹è¯­è¨€"></a>shell ç¼–ç¨‹è¯­è¨€</h3><ul><li>åŸºäºæ–‡æœ¬æ›¿æ¢çš„å¿«é€Ÿå·¥ä½œæµæ­å»º<blockquote><p>å†æŠŠ shell å‘½ä»¤æ„å»ºæˆä¸€æ£µæ ‘ï¼Œè§£é‡Šä¸ºä¸€ç»„ç³»ç»Ÿè°ƒç”¨ã€‚</p></blockquote></li></ul><ol><li>é‡å®šå‘: cmd &gt; file &lt; file 2&gt; &#x2F;dev&#x2F;null</li><li>é¡ºåºç»“æ„: cmd1; cmd2, cmd1 &amp;&amp; cmd2, cmd1 || cmd2</li><li>ç®¡é“: cmd1 | cmd2</li><li>é¢„å¤„ç†: $(), &lt;()</li><li>å˜é‡&#x2F;ç¯å¢ƒå˜é‡ã€æ§åˆ¶æµâ€¦â€¦</li></ol><ul><li>Job control<br>ç±»æ¯”çª—å£ç®¡ç†å™¨é‡Œçš„ â€œå‰â€ã€â€œæœ€å°åŒ–â€<br>jobs, fg, bg, wait<br>(ä»Šå¤©çš„ GUI å¹¶æ²¡æœ‰æ¯” CLI å¤šåšå¤ªå¤šäº‹)<blockquote><p>ä¾‹å¦‚ç”¨ jobs æŸ¥çœ‹æ‰€æœ‰çš„è¿›ç¨‹ï¼Œç”¨ fg å‘½ä»¤ä½¿è¯¥è¿›ç¨‹å˜æˆå‰å°è¿›ç¨‹ç­‰ç­‰ã€‚</p></blockquote></li></ul><h3 id="å¤åˆ»ç»å…¸"><a href="#å¤åˆ»ç»å…¸" class="headerlink" title="å¤åˆ»ç»å…¸"></a>å¤åˆ»ç»å…¸</h3><p>ä¸€ä¸ªç®€å•åœ° shell çš„å®ç°<br>æ¨èé˜…è¯»ç½‘ç«™æºä»£ç ã€‚</p><h3 id="ç®¡é“çš„ä¸€äº›ç»†èŠ‚"><a href="#ç®¡é“çš„ä¸€äº›ç»†èŠ‚" class="headerlink" title="ç®¡é“çš„ä¸€äº›ç»†èŠ‚"></a>ç®¡é“çš„ä¸€äº›ç»†èŠ‚</h3><ul><li>åœ¨gdbä¸­å¦‚ä½•è°ƒè¯•ä¼šäº§ç”Ÿå­è¿›ç¨‹(å¤šè¿›ç¨‹)çš„ç¨‹åºï¼Ÿ</li></ul><ol><li>set follow-fork-mode child<blockquote><p>è¿™å¯ä»¥åœ¨ fork åç›´æ¥åˆ‡åˆ°å­è¿›ç¨‹æ‰§è¡Œæµã€‚</p></blockquote></li></ol><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">set</span> follow-fork-mode <span class="hljs-comment">child</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">detach-on-fork off</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">follow-exec-mode same</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">confirm off</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">pagination off</span><br>source <span class="hljs-comment">visualize.py</span><br>break <span class="hljs-comment">_start</span><br>run<br>n <span class="hljs-comment">2</span><br>define <span class="hljs-comment">hook-stop</span><br>    pdump<br>end<br></code></pre></td></tr></table></figure><ol start="2"><li><p>info inferiors å‘½ä»¤æŸ¥çœ‹ gdbä¸­çš„è¿›ç¨‹</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">Num  <span class="hljs-keyword">Description</span>       Executable<br><span class="hljs-number">1</span>    process <span class="hljs-number">1234</span>      <span class="hljs-regexp">/path/</span>to/parent<br><span class="hljs-number">2</span>    process <span class="hljs-number">5678</span>      <span class="hljs-regexp">/path/</span>to/child<br></code></pre></td></tr></table></figure></li><li><p>inferior å‘½ä»¤åˆ‡æ¢è¿›ç¨‹</p><blockquote><p>ä¾‹å¦‚ inferior 1</p></blockquote></li></ol><ul><li><p>åˆ©ç”¨å¥½å·¥å…·ï¼Œå®šåˆ¶åŒ–çš„gdb</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gdb<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcDump</span>(gdb.Command):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(ProcDump, self).__init__(<br>            <span class="hljs-string">&quot;pdump&quot;</span>, gdb.COMMAND_DATA, gdb.COMPLETE_SYMBOL<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params">self, *_</span>):<br>        <span class="hljs-built_in">print</span>()<br>    <br>        <span class="hljs-keyword">for</span> proc <span class="hljs-keyword">in</span> gdb.inferiors():<br>            pid = proc.pid<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">int</span>(pid) == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">continue</span><br>    <br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Process <span class="hljs-subst">&#123;proc.num&#125;</span> (<span class="hljs-subst">&#123;pid&#125;</span>)&#x27;</span>, end=<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">if</span> proc <span class="hljs-keyword">is</span> gdb.selected_inferior():<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;*&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>()<br>    <br>            <span class="hljs-keyword">for</span> fd_desc <span class="hljs-keyword">in</span> subprocess.check_output(<br>                [<span class="hljs-string">&#x27;ls&#x27;</span>, <span class="hljs-string">&#x27;-l&#x27;</span>, <span class="hljs-string">f&#x27;/proc/<span class="hljs-subst">&#123;pid&#125;</span>/fd&#x27;</span>], encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span><br>            ).splitlines()[<span class="hljs-number">1</span>:]:<br>                perm, *_, fd, _, fname = fd_desc.split()<br>    <br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;rw&#x27;</span> <span class="hljs-keyword">in</span> perm: rw = <span class="hljs-string">&#x27;&lt;-&gt;&#x27;</span><br>                <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;r&#x27;</span> <span class="hljs-keyword">in</span> perm: rw = <span class="hljs-string">&#x27;&lt;--&#x27;</span><br>                <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;w&#x27;</span> <span class="hljs-keyword">in</span> perm: rw = <span class="hljs-string">&#x27;--&gt;&#x27;</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;pipe:&#x27;</span> <span class="hljs-keyword">in</span> fname:<br>                    pipe_id = re.search(<span class="hljs-string">f&#x27;[0-9]+&#x27;</span>, fname).group()<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;  <span class="hljs-subst">&#123;fd&#125;</span> <span class="hljs-subst">&#123;rw&#125;</span> [=== <span class="hljs-subst">&#123;pipe_id&#125;</span> ===]&#x27;</span>)<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;  <span class="hljs-subst">&#123;fd&#125;</span> <span class="hljs-subst">&#123;rw&#125;</span> <span class="hljs-subst">&#123;fname&#125;</span>&#x27;</span>)<br><br>ProcDump()<br><br><br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªç±»ç»§æ‰¿è‡ªgdb.Commandç±»ï¼Œè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªGDBå‘½ä»¤çš„åŸºç±»ï¼Œç”¨äºåˆ›å»ºæ–°çš„GDBå‘½ä»¤ã€‚åœ¨è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¼ å…¥äº†ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯â€pdumpâ€ï¼Œgdb.COMMAND_DATAå’Œgdb.COMPLETE_SYMBOLã€‚å…¶ä¸­ï¼Œâ€pdumpâ€æ˜¯å‘½ä»¤åç§°ï¼Œgdb.COMMAND_DATAè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¤„ç†æ•°æ®çš„å‘½ä»¤ï¼Œgdb.COMPLETE_SYMBOLè¡¨ç¤ºè¿™ä¸ªå‘½ä»¤éœ€è¦åœ¨ç¬¦å·è¡¨ä¸­è¿›è¡Œè‡ªåŠ¨è¡¥å…¨ã€‚<br>åœ¨ä½ çš„ä»£ç ä¸­ï¼Œä½ éœ€è¦åœ¨ProcDumpç±»ä¸­å®ç°ä¸€ä¸ªåä¸ºinvokeçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šè¢«è°ƒç”¨æ¥æ‰§è¡Œpdumpå‘½ä»¤çš„å®é™…åŠŸèƒ½ã€‚</p></blockquote></li><li><p>init.gdbè„šæœ¬<br>init.gdbè„šæœ¬æ˜¯ä¸€ä¸ªGDBåˆå§‹åŒ–è„šæœ¬ï¼Œå®ƒä¼šåœ¨GDBå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚ä½ å¯ä»¥åœ¨è¿™ä¸ªè„šæœ¬ä¸­è®¾ç½®GDBçš„ä¸€äº›é»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚è®¾ç½®åˆ«åã€å®šä¹‰å®ã€åŠ è½½ç¬¦å·è¡¨ç­‰ã€‚è¿™ä¸ªè„šæœ¬å¯ä»¥åŒ…å«ä»»æ„æ•°é‡çš„GDBå‘½ä»¤ï¼Œå®ƒä»¬ä¼šæŒ‰ç…§åœ¨è„šæœ¬ä¸­å‡ºç°çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">gdb +x <span class="hljs-keyword">init</span>.gdb a.<span class="hljs-keyword">out</span><br></code></pre></td></tr></table></figure></li><li><p>ä»€ä¹ˆæ˜¯ &#x2F;dev&#x2F;pts ?</p><blockquote><p>&#x2F;dev&#x2F;ptsæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæä¾›äº†ä¸€ä¸ªä¼ªç»ˆç«¯ï¼ˆpseudo-terminalï¼‰æ¥å£ï¼Œå…è®¸ç”¨æˆ·ä¸è®¡ç®—æœºè¿›è¡Œäº¤äº’ã€‚å½“ç”¨æˆ·ç™»å½•åˆ°è®¡ç®—æœºæ—¶ï¼Œç³»ç»Ÿä¼šä¸ºè¯¥ç”¨æˆ·åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ï¼Œè¿™ä¸ªä¼ªç»ˆç«¯å°±ä¼šåœ¨&#x2F;dev&#x2F;ptsç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„è®¾å¤‡æ–‡ä»¶ã€‚</p></blockquote></li></ul><p>echo hello &gt; &#x2F;dev&#x2F;pts&#x2F;8 ä¼šå‘ç”Ÿä»€ä¹ˆ</p><blockquote><p>ä¼šåœ¨ç›¸åº”ç»ˆç«¯äº§ç”Ÿè¾“å‡ºã€‚ä½¿ç”¨ tty å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰ shell ç»ˆç«¯å¯¹åº”çš„ç»ˆç«¯æ–‡ä»¶æ˜¯å“ªä¸€ä¸ªã€‚</p></blockquote><ul><li><p>è¯´æ˜<br>ç”±äºè¿™é‡Œæ–‡ä»¶æè¿°ç¬¦çš„åº”ç”¨æˆ‘åœ¨ MIT 6.S081 ä¸­çš„å®éªŒ1ä¸­å®ç°è¿‡ç±»ä¼¼çš„ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸å†è¯¦ç»†åœ°æè¿°è°ƒä»£ç çš„ç»†èŠ‚ã€‚</p></li><li><p>å…³äº va_list</p><ol><li>va_start sets arg_ptr to the first optional argument in the list of arguments thatâ€™s passed to the function.</li><li>va_arg retrieves a value of type from the location thatâ€™s given by arg_ptr, and increments arg_ptr to point to the next argument in the list by using the size of type to determine where the next argument starts. </li><li>va_end resets the pointer to NULL</li></ol></li></ul><p>æ˜¯ä¸æ˜¯ä¼¼ä¹å¥½åƒä¼šå®ç° printf å‡½æ•°äº†ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è¾“å…¥è¾“å‡ºè®¾å¤‡æ¨¡å‹</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h3 id="IOè®¾å¤‡-CPUè§†è§’-ï¼šä¸€ä¸ªèƒ½ä¸CPUäº¤æ¢æ•°æ®çš„æ¥å£-æ§åˆ¶å™¨"><a href="#IOè®¾å¤‡-CPUè§†è§’-ï¼šä¸€ä¸ªèƒ½ä¸CPUäº¤æ¢æ•°æ®çš„æ¥å£-æ§åˆ¶å™¨" class="headerlink" title="IOè®¾å¤‡(CPUè§†è§’)ï¼šä¸€ä¸ªèƒ½ä¸CPUäº¤æ¢æ•°æ®çš„æ¥å£&#x2F;æ§åˆ¶å™¨"></a>IOè®¾å¤‡(CPUè§†è§’)ï¼šä¸€ä¸ªèƒ½ä¸CPUäº¤æ¢æ•°æ®çš„æ¥å£&#x2F;æ§åˆ¶å™¨</h3><ul><li>å°±æ˜¯â€œå‡ ç»„çº¦å®šå¥½åŠŸèƒ½çš„çº¿â€ï¼Œé€šè¿‡æ¡æ‰‹ä¿¡å·ä»çº¿ä¸Šè¯»å‡º&#x2F;å†™å…¥æ•°æ®</li><li>æ¯ä¸€ç»„çº¿éƒ½æœ‰è‡ªå·±çš„åœ°å€<blockquote><p>CPUå¯ä»¥ç›´æ¥ä½¿ç”¨æŒ‡ä»¤(in&#x2F;out&#x2F;MMIO)å’Œè®¾å¤‡äº¤æ¢æ•°æ®<br>CPUä¸ç®¡è®¾å¤‡å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„</p></blockquote></li></ul><h3 id="æ€»çº¿ã€ä¸­æ–­æ§åˆ¶å™¨å’ŒDMA"><a href="#æ€»çº¿ã€ä¸­æ–­æ§åˆ¶å™¨å’ŒDMA" class="headerlink" title="æ€»çº¿ã€ä¸­æ–­æ§åˆ¶å™¨å’ŒDMA"></a>æ€»çº¿ã€ä¸­æ–­æ§åˆ¶å™¨å’ŒDMA</h3><p>è¶Šæ¥è¶Šå¤šçš„IOè®¾å¤‡ï¼Œå¦‚ä½•ç»™æœªæ¥ç•™å‡ºä¸€ç‚¹ç©ºé—´ï¼Ÿ</p><ul><li>CPUåªç›´æ¥è¿æ¥ä¸€ä¸ªè®¾å¤‡ï¼Œè¿™ä¸ªIOè®¾å¤‡å®é™…ä¸Šæ˜¯ä¸€å—æ¿å¡ï¼Œæ¿å¡ä¸Šæœ‰å¾ˆå¤šä¸ªå°æ’æ§½(å¯„å­˜å™¨)ã€‚è¿™ä¸ªIOè®¾å¤‡è´Ÿè´£ç®¡ç†å…¶ä»–IOè®¾å¤‡ï¼Œè¿™ä¸ªè®¾å¤‡å°±å«åšæ€»çº¿ã€‚</li><li>ç”šè‡³è¿™ä¸ªIOè®¾å¤‡åšå¾—æ›´å½»åº•ä¸€ç‚¹ï¼Œæˆ‘ä»¬çš„å†…å­˜ä¹Ÿè¿æ¥åœ¨è¿™ä¸ªæ€»çº¿ä¸Šï¼ŒåŒä¸€ä¸ªåœ°å€ç©ºé—´ï¼ŒCPUåªéœ€è¦ä¸€ä¸ªåœ°å€ï¼Œå°±å¯ä»¥çŸ¥é“è®¿é—®çš„æ˜¯å†…å­˜è¿˜æ˜¯IOè®¾å¤‡(ç»Ÿä¸€ç¼–å€)ã€‚</li></ul><h3 id="ä¸­æ–­æ²¡èƒ½è§£å†³çš„"><a href="#ä¸­æ–­æ²¡èƒ½è§£å†³çš„" class="headerlink" title="ä¸­æ–­æ²¡èƒ½è§£å†³çš„"></a>ä¸­æ–­æ²¡èƒ½è§£å†³çš„</h3><p>å‡è®¾ç¨‹åºå¸Œæœ›å†™å…¥1GBçš„æ•°æ®åˆ°ç£ç›˜</p><ul><li>å³ä½¿ç£ç›˜å·²ç»å‡†å¤‡å¥½äº†ï¼Œä¾ç„¶éœ€è¦éå¸¸æµªè´¹æ—¶é—´çš„å¾ªç¯ã€‚<blockquote><p>DMAçš„å‡ºç°ï¼šä¸€ä¸ªä¸“é—¨æ‰§è¡Œâ€memcpyâ€ç¨‹åºçš„CPU<br>é€šè¿‡å¢åŠ ä¸€ä¸ªCPUä¸“é—¨è´Ÿè´£ä»å†…å­˜åˆ°æ€»çº¿çš„æ•°æ®æ¬è¿<br>memory-&gt;memory     device-&gt;memory    memory-&gt;device</p></blockquote></li></ul><h3 id="IOè®¾å¤‡å’Œè®¡ç®—æœºä¹‹é—´çš„è¾¹ç•Œé€æ¸æ¨¡ç³Š"><a href="#IOè®¾å¤‡å’Œè®¡ç®—æœºä¹‹é—´çš„è¾¹ç•Œé€æ¸æ¨¡ç³Š" class="headerlink" title="IOè®¾å¤‡å’Œè®¡ç®—æœºä¹‹é—´çš„è¾¹ç•Œé€æ¸æ¨¡ç³Š"></a>IOè®¾å¤‡å’Œè®¡ç®—æœºä¹‹é—´çš„è¾¹ç•Œé€æ¸æ¨¡ç³Š</h3><p>DMAä¸å°±æ˜¯ä¸€ä¸ªâ€œåªåšä¸€ä»¶ç‰¹åˆ«äº‹æƒ…çš„â€CPUå—</p><ul><li>é‚£ä¹ˆæˆ‘ä»¬è¿˜å¯ä»¥æœ‰åšå„ç§äº‹æƒ…çš„â€CPUâ€å•Š, ä¾‹å¦‚æ˜¾å¡</li></ul>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®¾å¤‡é©±åŠ¨ç¨‹åº</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ¬æ¬¡è¯¾çš„ä¸»è¦å†…å®¹"><a href="#æœ¬æ¬¡è¯¾çš„ä¸»è¦å†…å®¹" class="headerlink" title="æœ¬æ¬¡è¯¾çš„ä¸»è¦å†…å®¹"></a>æœ¬æ¬¡è¯¾çš„ä¸»è¦å†…å®¹</h2><ul><li>ä»€ä¹ˆæ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åº</li><li>Linuxè®¾å¤‡æŠ½è±¡</li></ul><h3 id="è®¾å¤‡é©±åŠ¨ç¨‹åºåŸç†"><a href="#è®¾å¤‡é©±åŠ¨ç¨‹åºåŸç†" class="headerlink" title="è®¾å¤‡é©±åŠ¨ç¨‹åºåŸç†"></a>è®¾å¤‡é©±åŠ¨ç¨‹åºåŸç†</h3><ul><li>è®¾å¤‡å…¶å®æ˜¯ä¸€ç»„å¯„å­˜å™¨å’Œä¸€ç»„åè®®ï¼Œä¸€ä¸ªè®¾å¤‡ï¼Œä¸€ä¸ªåè®®</li></ul><p>è®¾å¤‡å¯ä»¥åˆ†ä¸ºä¸¤ç§</p><ol><li>å­—ç¬¦è®¾å¤‡ï¼šå­—èŠ‚æµï¼Œä¾‹å¦‚é”®ç›˜</li><li>å—è®¾å¤‡ï¼šå­—èŠ‚æ•°ç»„ï¼Œä¾‹å¦‚ç£ç›˜</li></ol><h3 id="æ“ä½œç³»ç»Ÿï¼šè®¾å¤‡-æ”¯æŒå„ç±»æ“ä½œçš„å¯¹è±¡ï¼ˆæ–‡ä»¶ï¼‰"><a href="#æ“ä½œç³»ç»Ÿï¼šè®¾å¤‡-æ”¯æŒå„ç±»æ“ä½œçš„å¯¹è±¡ï¼ˆæ–‡ä»¶ï¼‰" class="headerlink" title="æ“ä½œç³»ç»Ÿï¼šè®¾å¤‡&#x3D;æ”¯æŒå„ç±»æ“ä½œçš„å¯¹è±¡ï¼ˆæ–‡ä»¶ï¼‰"></a>æ“ä½œç³»ç»Ÿï¼šè®¾å¤‡&#x3D;æ”¯æŒå„ç±»æ“ä½œçš„å¯¹è±¡ï¼ˆæ–‡ä»¶ï¼‰</h3><ul><li>read: ä»è®¾å¤‡æŸä¸ªæŒ‡å®šçš„ä½ç½®è¯»å‡ºæ•°æ®</li><li>writeï¼šå‘è®¾å¤‡æŸä¸ªä½ç½®å†™å…¥æ•°æ®</li><li>ioctl: è¯»å–&#x2F;è®¾ç½®è®¾å¤‡çš„çŠ¶æ€, ioctlæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨<br>ä¸Šé¢ä¸ºè®¾å¤‡å»ºç«‹ä¸€ä¸ªæ¨¡å‹       <blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŠŠä¸Šé¢è¿™ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯é€šç”¨çš„APIï¼Œç»è¿‡è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œç¿»è¯‘æˆè®¾å¤‡èƒ½å¤Ÿå¬å¾—æ‡‚çš„è¯­è¨€, è¿™æ®µä»£ç å°±æ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚</p></blockquote></li></ul><h3 id="è®¾å¤‡é©±åŠ¨ç¨‹åº"><a href="#è®¾å¤‡é©±åŠ¨ç¨‹åº" class="headerlink" title="è®¾å¤‡é©±åŠ¨ç¨‹åº"></a>è®¾å¤‡é©±åŠ¨ç¨‹åº</h3><p>æŠŠç³»ç»Ÿè°ƒç”¨â€œç¿»è¯‘â€æˆä¸è®¾å¤‡å¯„å­˜å™¨çš„äº¤äº’</p><ul><li>å°±æ˜¯ä¸€æ®µæ™®é€šçš„å†…æ ¸ä»£ç </li><li>æœ‰å¯èƒ½è¿™ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åºåé¢å°±æ˜¯ä¸€ä¸ªçœŸå®çš„è®¾å¤‡ï¼Œæœ‰å¯èƒ½æ²¡æœ‰è®¾å¤‡ï¼Œå°±æ˜¯ç”¨è®¾å¤‡é©±åŠ¨ç¨‹åºæ¥æ¨¡æ‹Ÿè¿™ä¸ªè®¾å¤‡</li></ul><p>ä¾‹å¦‚ï¼š&#x2F;dev&#x2F;ä¸­çš„å¯¹è±¡</p><ol><li>&#x2F;dev&#x2F;null   nullè®¾å¤‡</li><li>&#x2F;dev&#x2F;random   éšæœºæ•°ç”Ÿæˆå™¨</li></ol><h3 id="Linuxè®¾å¤‡é©±åŠ¨"><a href="#Linuxè®¾å¤‡é©±åŠ¨" class="headerlink" title="Linuxè®¾å¤‡é©±åŠ¨"></a>Linuxè®¾å¤‡é©±åŠ¨</h3><p>æˆ‘ä»¬å¸Œæœ›å®ç°ä¸€ä¸ªæœ€ç®€å•çš„â€œè½¯ä»¶å®šä¹‰æ ¸å¼¹â€</p>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å†…æ ¸çº¿ç¨‹ä¸è¿›ç¨‹ã€è¿›ç¨‹API</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%86%85%E6%A0%B8%E7%BA%BF%E7%A8%8B%E4%B8%8E%E8%BF%9B%E7%A8%8B%EF%BC%9B%E8%BF%9B%E7%A8%8BAPI/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%86%85%E6%A0%B8%E7%BA%BF%E7%A8%8B%E4%B8%8E%E8%BF%9B%E7%A8%8B%EF%BC%9B%E8%BF%9B%E7%A8%8BAPI/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ"><a href="#ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ"></a>ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ</h2><h3 id="è™šæ‹ŸåŒ–ï¼šæ“ä½œç³»ç»ŸåŒæ—¶ä¿å­˜å¤šä¸ªçŠ¶æ€æœº"><a href="#è™šæ‹ŸåŒ–ï¼šæ“ä½œç³»ç»ŸåŒæ—¶ä¿å­˜å¤šä¸ªçŠ¶æ€æœº" class="headerlink" title="è™šæ‹ŸåŒ–ï¼šæ“ä½œç³»ç»ŸåŒæ—¶ä¿å­˜å¤šä¸ªçŠ¶æ€æœº"></a>è™šæ‹ŸåŒ–ï¼šæ“ä½œç³»ç»ŸåŒæ—¶ä¿å­˜å¤šä¸ªçŠ¶æ€æœº</h3><p>Cç¨‹åº &#x3D; çŠ¶æ€æœº</p><ul><li>åˆå§‹çŠ¶æ€ï¼š main(argc, argv)</li><li>çŠ¶æ€è¿ç§»ï¼š æŒ‡ä»¤çš„æ‰§è¡Œï¼ŒåŒ…æ‹¬syscall</li></ul><p>å®é™…ä¸Šï¼Œåœ¨ UNIX&#x2F;Linux ç³»ç»Ÿå†…æ ¸å®Œæˆåˆå§‹åŒ–åï¼Œåªæœ‰ä¸€ä¸ª init è¿›ç¨‹è¢«å¯åŠ¨ï¼Œä»æ­¤ä»¥åï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸å°±åŒ–èº«ä¸ºäº†ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„ç¨‹åºã€çŠ¶æ€æœºçš„ç®¡ç†è€…ï¼Œä»…åœ¨ä¸­æ–­å’Œç³»ç»Ÿè°ƒç”¨å‘ç”Ÿæ—¶å¼€å§‹æ‰§è¡Œã€‚</p><p>ä¸‹é¢çœ‹ä¸€æ®µå°ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)&#123;<br>fork();<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello \n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>å†™å‡ºä»£ç çš„è¿è¡Œç»“æœã€‚</p></blockquote><ul><li>.&#x2F;a.out</li><li>.&#x2F;a.out | cat</li></ul><ol><li>å½“æ‰§è¡Œ.&#x2F;a.outæ—¶ï¼Œä¼šæ‰“å° 6 ä¸ª Hello</li><li>å½“æ‰§è¡Œ.&#x2F;a.out | wc -l æ—¶ï¼Œä¼šæ‰“å° 8 ä¸ª Hello ? è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</li></ol><p>ä¸å¦¨ç”¨ strace æ¥çœ‹ä¸€ä¸‹ã€‚<br>æˆ‘ä»¬å‘ç°ï¼Œ</p><blockquote><p>æˆ‘ä»¬çš„ printf ä¸æ€»æ˜¯æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºçš„ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒæ ¹æ®æ ‡å‡†è¾“å‡ºè¿æ¥çš„æ˜¯ç»ˆç«¯è¿˜æ˜¯ç®¡é“ï¼Œå®ƒä¼šåšä¸åŒçš„è¡Œä¸ºï¼Œè¿™é‡Œè¿æ¥åˆ°äº†ç®¡é“ï¼Œä¹Ÿå°±æŠŠè¾“å‡ºæ”¾åˆ°ä¸€ä¸ªç¼“å†²åŒºé‡Œé¢ ã€‚å½“ç¬¬ä¸€ä¸ªå¾ªç¯ä¹‹åï¼Œç¼“å†²åŒºé‡Œé¢æœ‰ä¸€ä¸ª helloï¼Œæœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼›ç¬¬äºŒæ¬¡å¾ªç¯å®Œæ¯•åï¼Œç¼“å†²åŒºé‡Œé¢æœ‰ 2 ä¸ª hello, æ€»å…± 4 ä¸ªè¿›ç¨‹ã€‚æ‰€ä»¥æ‰“å° 8 ä¸ªã€‚ </p></blockquote><h2 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h2><p>åº”ç”¨ç¨‹åºæ‰§è¡Œçš„ç¯å¢ƒã€‚</p><ul><li>export: å‘Šè¯‰shellåœ¨åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™è®¾ç½®ç¯å¢ƒå˜é‡ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¯æ‰§è¡Œç¨‹åº</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="å¯æ‰§è¡Œæ–‡ä»¶ï¼šçŠ¶æ€æœºçš„æè¿°"><a href="#å¯æ‰§è¡Œæ–‡ä»¶ï¼šçŠ¶æ€æœºçš„æè¿°" class="headerlink" title="å¯æ‰§è¡Œæ–‡ä»¶ï¼šçŠ¶æ€æœºçš„æè¿°"></a>å¯æ‰§è¡Œæ–‡ä»¶ï¼šçŠ¶æ€æœºçš„æè¿°</h2><h3 id="ä¸€ä¸ªæè¿°äº†çŠ¶æ€æœºåˆå§‹çŠ¶æ€-è¿ç§»çš„æ•°æ®ç»“æ„"><a href="#ä¸€ä¸ªæè¿°äº†çŠ¶æ€æœºåˆå§‹çŠ¶æ€-è¿ç§»çš„æ•°æ®ç»“æ„" class="headerlink" title="ä¸€ä¸ªæè¿°äº†çŠ¶æ€æœºåˆå§‹çŠ¶æ€ + è¿ç§»çš„æ•°æ®ç»“æ„"></a>ä¸€ä¸ªæè¿°äº†çŠ¶æ€æœºåˆå§‹çŠ¶æ€ + è¿ç§»çš„<font color=#FF000 >æ•°æ®ç»“æ„</font></h3><ol><li>å¯„å­˜å™¨ï¼šå¤§éƒ¨åˆ†ç”±ABIè§„å®šï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£è®¾ç½®ã€‚ä¾‹å¦‚åˆå§‹åŒ–pcã€‚</li><li>åœ°å€ç©ºé—´ï¼šäºŒè¿›åˆ¶æ–‡ä»¶+ABIå…±åŒå†³å®šã€‚ä¾‹å¦‚argvå’Œenvpçš„å­˜å‚¨ã€‚</li><li>å…¶ä»–æœ‰ç”¨çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚è°ƒè¯•å’Œcore dumpçš„ä¿¡æ¯ï¼‰</li></ol><hr><h2 id="å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢åº”è¯¥æœ‰ä»€ä¹ˆï¼Ÿ"><a href="#å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢åº”è¯¥æœ‰ä»€ä¹ˆï¼Ÿ" class="headerlink" title="å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢åº”è¯¥æœ‰ä»€ä¹ˆï¼Ÿ"></a>å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢åº”è¯¥æœ‰ä»€ä¹ˆï¼Ÿ</h2><p>å¯æ‰§è¡Œç¨‹åºæè¿°äº†çŠ¶æ€æœºé‡ç½®åçš„çŠ¶æ€ï¼Œé‚£çŠ¶æ€æœ‰ä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>æ— éå°±æ˜¯å¯„å­˜å™¨å’Œå†…å­˜ï¼ˆåœ°å€ç©ºé—´ï¼‰</p></blockquote><hr><h2 id="æ“ä½œç³»ç»Ÿä¸Šçš„å¯æ‰§è¡Œç¨‹åº"><a href="#æ“ä½œç³»ç»Ÿä¸Šçš„å¯æ‰§è¡Œç¨‹åº" class="headerlink" title="æ“ä½œç³»ç»Ÿä¸Šçš„å¯æ‰§è¡Œç¨‹åº"></a>æ“ä½œç³»ç»Ÿä¸Šçš„å¯æ‰§è¡Œç¨‹åº</h2><p>éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ol><li><p>å…·æœ‰æ‰§è¡Œ(x)æƒé™<br>æ‰§è¡Œ.&#x2F;a.cå‘½ä»¤ (å‡ºç°permission deniedé”™è¯¯)<br>ä½†å¦‚æœå…ˆæ‰§è¡Œ chmod +x a.cå‘½ä»¤ï¼Œä¼šå‡ºç°åŠ è½½å™¨ä¸èƒ½æ­£ç¡®è¯†åˆ«é¢˜ã€‚    </p></li><li><p>åŠ è½½å™¨èƒ½å¤Ÿè¯†åˆ«çš„å¯æ‰§è¡Œæ–‡ä»¶</p></li></ol><hr><h2 id="å¸¸è§çš„å¯æ‰§è¡Œæ–‡ä»¶"><a href="#å¸¸è§çš„å¯æ‰§è¡Œæ–‡ä»¶" class="headerlink" title="å¸¸è§çš„å¯æ‰§è¡Œæ–‡ä»¶"></a>å¸¸è§çš„å¯æ‰§è¡Œæ–‡ä»¶</h2><blockquote><p>å°±æ˜¯æ“ä½œç³»ç»Ÿé‡Œé¢çš„ä¸€ä¸ªæ™®é€šå¯¹è±¡ã€‚</p></blockquote><h3 id="UNIX-Linux"><a href="#UNIX-Linux" class="headerlink" title="UNIX&#x2F;Linux"></a>UNIX&#x2F;Linux</h3><ul><li>a.out</li><li>ELF</li><li>She-bang<blockquote><p>She-bangæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å°±æ˜¯ä¸€ä¸ªâ€œå·æ¢å‚æ•°â€åœ°execveã€‚</p></blockquote></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C">#!/usr/bin/python3               #è¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶<br>print(<span class="hljs-string">&#x27;Hello&#x27;</span>)<br></code></pre></td></tr></table></figure><p>å†æ‰§è¡Œå‘½ä»¤ chmod +x a.cã€‚ä¸Šé¢è¿™ä¸ªæ–‡ä»¶å°±å¯ä»¥æ‰§è¡Œäº†ã€‚<br>å¦‚æœåŠ è½½å™¨è¿™æ ·ä¸€ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œå¦‚æœå®ƒå‘ç°ä¸€ä¸ª#!å¼€å¤´çš„ï¼Œå°±ä¼šåœ¨execveå·æ¢ä¸€ä¸‹ï¼ŒæŠŠ#!åé¢çš„å¡«å…¥execveçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¯¥æ–‡ä»¶åå¡«å…¥ç¬¬äºŒä¸ªå‚æ•°ã€‚</p><hr><h2 id="ä»Cä»£ç åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#ä»Cä»£ç åˆ°äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="ä»Cä»£ç åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"></a>ä»Cä»£ç åˆ°äºŒè¿›åˆ¶æ–‡ä»¶</h2><p>ä¸€æ®µç®€å•çš„Cä»£ç (main.c)ï¼š   </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">f</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> a + b;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    hello();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>gcc -O2 -c main.cå¾—åˆ°main.oæ–‡ä»¶, ç„¶åobjdump -d main.oå¾—åˆ°åæ±‡ç¼– </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-number">0000000000000000</span> &lt;main&gt;:<br>   <span class="hljs-number">0</span>:   f3 <span class="hljs-number">0f</span> <span class="hljs-number">1</span>e fa             endbr64 <br>   <span class="hljs-number">4</span>:   <span class="hljs-number">48</span> <span class="hljs-number">83</span> ec <span class="hljs-number">08</span>             sub    $<span class="hljs-number">0x8</span>,%rsp<br>   <span class="hljs-number">8</span>:   <span class="hljs-number">31</span> c0                   xor    %eax,%eax<br>   a:   e8 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          call   f &lt;main+<span class="hljs-number">0xf</span>&gt;<br>   f:   <span class="hljs-number">31</span> c0                   xor    %eax,%eax<br>  <span class="hljs-number">11</span>:   <span class="hljs-number">48</span> <span class="hljs-number">83</span> c4 <span class="hljs-number">08</span>             add    $<span class="hljs-number">0x8</span>,%rsp<br>  <span class="hljs-number">15</span>:   c3                      ret    <br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° 0xa åœ°å€å¤„ï¼Œç”±äºä¸çŸ¥é“helloå‡½æ•°çš„åœ°å€ï¼Œè¿™é‡Œæš‚æ—¶å¡«ä¸º 0</p><p>hello.cçš„ä»£ç å—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> *p = (<span class="hljs-type">char</span>*)main + <span class="hljs-number">0xa</span> + <span class="hljs-number">1</span>;   <span class="hljs-comment">//æœ‰ä¸Šé¢æ±‡ç¼–ä»£ç å¯ä»¥çœ‹å‡ºï¼Œä»£å¡« </span><br>               <span class="hljs-comment">//helloåœ°å€ä¸º main çš„åœ°å€åŠ ä¸Šåç§»å†åŠ ä¸Š1(æ“ä½œç 1ä¸ªå­—èŠ‚)</span><br>    <span class="hljs-type">int32_t</span> offset = *(<span class="hljs-type">int32_t</span>*)p;<br>    assert( (<span class="hljs-type">char</span>*)main + <span class="hljs-number">0xf</span> +offset == (<span class="hljs-type">char</span>*)hello);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello \n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è§£é‡Šä¸€ä¸‹ï¼šåœ¨æˆ‘ä»¬çš„mainå‡½æ•°è¦è°ƒç”¨helloå‡½æ•°æ—¶ï¼Œæ­¤æ—¶pcä¼šæŒ‡å‘è¿™æ¡callæŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯pcæŒ‡é’ˆä¼šæ˜¯(char*)main + 0xf,ç”±äºæ˜¯ç›¸å¯¹å¯»å€(callæŒ‡ä»¤çš„è¯­ä¹‰)ï¼Œæ‰€ä»¥ä¼šè·³è½¬åˆ°pc + offsetçš„ä½ç½®ï¼Œoffsetä¹Ÿå°±æ˜¯å¾…å¡«åœ°å€å¤„çš„å€¼ã€‚è€Œè·³è½¬åçš„åœ°å€è¦æ˜¯helloçš„åœ°å€ã€‚</p></blockquote><p>æˆ‘ä»¬ readelf -a main.o æ¥çœ‹ä¸€ä¸‹æœ‰ä»€ä¹ˆè¾“å‡ºä¿¡æ¯,å…¶ä¸­æœ‰ä¸€éƒ¨åˆ†æ˜¯è¿™æ ·çš„ï¼ˆè¿™é‡Œå¤åˆ¶è¿‡æ¥æ ¼å¼æœ‰ç‚¹ä¸æ­£ç¡®ï¼‰ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Relocation</span> section &#x27;.rela.text.startup&#x27; at offset <span class="hljs-number">0</span>x1b8 contains <span class="hljs-number">1</span> entry:<br>  <span class="hljs-attribute">Offset</span>          Info       Type        Sym. Value    Sym. Name+Addend<br><span class="hljs-attribute">00000000000b</span>  <span class="hljs-number">000600000004</span> R_X86_64_PLT32 <span class="hljs-number">0000000000000000</span> hello - <span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><h2 id="é‡æ–°ç†è§£ç¼–è¯‘ã€é“¾æ¥æµç¨‹"><a href="#é‡æ–°ç†è§£ç¼–è¯‘ã€é“¾æ¥æµç¨‹" class="headerlink" title="é‡æ–°ç†è§£ç¼–è¯‘ã€é“¾æ¥æµç¨‹"></a>é‡æ–°ç†è§£ç¼–è¯‘ã€é“¾æ¥æµç¨‹</h2><h3 id="ç¼–è¯‘å™¨"><a href="#ç¼–è¯‘å™¨" class="headerlink" title="ç¼–è¯‘å™¨"></a>ç¼–è¯‘å™¨</h3><blockquote><p>High-level semantics(é«˜çº§CçŠ¶æ€æœº) -&gt; Low-level semantics(æ±‡ç¼–çŠ¶æ€æœº)</p></blockquote><h3 id="æ±‡ç¼–å™¨"><a href="#æ±‡ç¼–å™¨" class="headerlink" title="æ±‡ç¼–å™¨"></a>æ±‡ç¼–å™¨</h3><blockquote><p>Low-level semantics -&gt; Binary semantics(çŠ¶æ€æœºçš„å®¹å™¨)</p></blockquote><ol><li>â€œä¸€ä¸€å¯¹åº”â€åœ°ç¿»è¯‘æˆäºŒè¿›åˆ¶ä»£ç ï¼Œsections, symbols, debug infoâ€¦â€¦</li><li>ä¸èƒ½å†³å®šçš„è¦ç•™ä¸‹â€œä¹‹åè¦æ€ä¹ˆåŠâ€çš„ä¿¡æ¯(relocationsé‡å®šä½)</li></ol><h3 id="é“¾æ¥å™¨"><a href="#é“¾æ¥å™¨" class="headerlink" title="é“¾æ¥å™¨"></a>é“¾æ¥å™¨</h3><blockquote><p>åˆå¹¶æ‰€æœ‰çš„å®¹å™¨ï¼Œå¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„çŠ¶æ€æœº</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤šå¤„ç†å™¨ç¼–ç¨‹ä»å…¥é—¨åˆ°æ”¾å¼ƒ</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ¬è®²å†…å®¹ï¼šå¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒï¼š"><a href="#æœ¬è®²å†…å®¹ï¼šå¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒï¼š" class="headerlink" title="æœ¬è®²å†…å®¹ï¼šå¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒï¼š"></a>æœ¬è®²å†…å®¹ï¼šå¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒï¼š</h2><ul><li>å…¥é—¨ï¼šå¤šçº¿ç¨‹ç¼–ç¨‹åº“</li><li>æ”¾å¼ƒï¼šåŸå­æ€§ã€å¯è§æ€§ã€é¡ºåº</li></ul><h2 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h2><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å †æ ˆï¼Œå¦‚ä½•ç¡®å®šå„è‡ªçš„å †æ ˆå¤§å°ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><br><span class="hljs-type">void</span> * <span class="hljs-keyword">volatile</span> low[<span class="hljs-number">64</span>];<br><span class="hljs-type">void</span> * <span class="hljs-keyword">volatile</span> high[<span class="hljs-number">64</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">update_range</span><span class="hljs-params">(<span class="hljs-type">int</span> T, <span class="hljs-type">void</span> *ptr)</span> &#123;<br>    <span class="hljs-keyword">if</span> (ptr &lt; low[T]) low[T] = ptr;<br>    <span class="hljs-keyword">if</span> (ptr &gt; high[T]) high[T] = ptr;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">probe</span><span class="hljs-params">(<span class="hljs-type">int</span> T, <span class="hljs-type">int</span> n)</span> &#123;<br>  update_range(T, &amp;n);<br>  <span class="hljs-type">long</span> sz = (<span class="hljs-type">uintptr_t</span>)high[T] - (<span class="hljs-type">uintptr_t</span>)low[T];<br>  <span class="hljs-keyword">if</span> (sz % <span class="hljs-number">1024</span> &lt; <span class="hljs-number">32</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Stack(T%d) &gt;= %ld KB\n&quot;</span>, T, sz / <span class="hljs-number">1024</span>);<br>  &#125;<br>  probe(T, n + <span class="hljs-number">1</span>);  <span class="hljs-comment">// Infinite recursion</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tprobe</span><span class="hljs-params">(<span class="hljs-type">int</span> T)</span> &#123;<br>  low[T] = (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>;<br>  high[T] = (<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>;<br>  update_range(T, &amp;T);<br>  probe(T, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>    create(Tprobe);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¦ setbuf(stdout, NULL) å…³é—­ç¼“å†²åŒºï¼Ÿ</p><blockquote><p>æœ‰æ—¶å€™ä¸€ä¸ªprintfæ˜æ˜åœ¨crashå‰çš„ä»£ç è¿è¡Œäº†ï¼Œä½†æ²¡æœ‰å¾—åˆ°è¾“å‡ºï¼ŒåŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>æ˜¯å› ä¸ºprintfå…ˆæŠŠè¾“å‡ºæ”¾åœ¨ç¼“å†²åŒºé‡Œã€‚</p></blockquote><p>è¿™æ®µä»£ç çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯æ— ç©·é€’å½’ï¼Œåˆ©ç”¨å‡½æ•°å‚æ•°å­˜å‚¨åœ¨æ ˆç©ºé—´é‡Œä¼°ç®—æ ˆçš„å¤§å°ã€‚</p><h2 id="æ”¾å¼ƒï¼šåŸå­æ€§"><a href="#æ”¾å¼ƒï¼šåŸå­æ€§" class="headerlink" title="æ”¾å¼ƒï¼šåŸå­æ€§"></a>æ”¾å¼ƒï¼šåŸå­æ€§</h2><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N 100000000</span><br><br><span class="hljs-type">long</span> sum = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Tsum</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>    sum++;<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  create(Tsum);<br>  create(Tsum);<br>  join();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;sum = %ld\n&quot;</span>, sum);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ä¼˜åŒ– -O2å¾—åˆ°ç­”æ¡ˆ 200000000</p><blockquote><p>ç¼–è¯‘å™¨ç›´æ¥è®¡ç®—å‡ºç­”æ¡ˆï¼Œä¸€æ¡æŒ‡ä»¤èµ‹å€¼ç»™sum</p></blockquote><p>ç¼–è¯‘ä¼˜åŒ– -O1å¾—åˆ°ç­”æ¡ˆ 100000000</p>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŠ¨æ€é“¾æ¥å’ŒåŠ è½½(2)</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%92%8C%E5%8A%A0%E8%BD%BD(2)/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%92%8C%E5%8A%A0%E8%BD%BD(2)/</url>
    
    <content type="html"><![CDATA[<h2 id="åŠ¨æ€é“¾æ¥ä¸åŠ è½½åŸç†"><a href="#åŠ¨æ€é“¾æ¥ä¸åŠ è½½åŸç†" class="headerlink" title="åŠ¨æ€é“¾æ¥ä¸åŠ è½½åŸç†"></a>åŠ¨æ€é“¾æ¥ä¸åŠ è½½åŸç†</h2><h3 id="è‹¥å¹²è¦ç´ "><a href="#è‹¥å¹²è¦ç´ " class="headerlink" title="è‹¥å¹²è¦ç´ "></a>è‹¥å¹²è¦ç´ </h3><ol><li>ç¼–è¯‘æˆä½ç½®æ— å…³ä»£ç </li><li>å¯¹å¤–éƒ¨å‡½æ•°çš„è°ƒç”¨æ˜¯æŸ¥è¡¨çš„</li><li>åœ¨è¿è¡Œï¼ˆåŠ è½½ï¼‰çš„æ—¶å€™å¡«è¡¨</li></ol><p>æˆ‘ä»¬å°±å‘æ˜äº†GOT(Global Offset Table)</p><blockquote><p>ä¹Ÿå°±æ˜¯table </p></blockquote><h3 id="æœ‰ä¸ªæœ‰è¶£çš„é—®é¢˜"><a href="#æœ‰ä¸ªæœ‰è¶£çš„é—®é¢˜" class="headerlink" title="æœ‰ä¸ªæœ‰è¶£çš„é—®é¢˜"></a>æœ‰ä¸ªæœ‰è¶£çš„é—®é¢˜</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">()</span>; <br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨é‡åˆ°å‡½æ•°è°ƒç”¨ï¼Œåº”è¯¥ç¿»è¯‘æˆå“ªç§æŒ‡ä»¤ï¼Ÿ</p><ul><li>å¦‚æœæ˜¯åŒä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“    call foo   (å› ä¸ºå¦‚æœæ˜¯ä¸€ä¸ªåº“çš„ï¼Œé“¾æ¥çš„æ—¶å€™ç›¸å¯¹åœ°å€å·²ç»ç¡®å®šä¸‹æ¥äº†)</li><li>å¦‚æœæ˜¯å¦å¤–ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“  call TABLE(foo)</li></ul><p>è¿™å°±éœ€è¦PLT (Procedure Linkage Table)       </p><ul><li>å‡½æ•°å¤ªå¤šï¼Œæ¯ä¸ªéƒ½æ ‡è®°åŒºåˆ†å¤ªéš¾çœ‹</li><li>ç¼–è¯‘å™¨æ€»æ˜¯ç”Ÿæˆä¸€ä¸ªç›´æ¥çš„call<blockquote><p>æ¥è‡ªå¦ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“     call foo@plt            </p></blockquote></li></ul><h3 id="æ›´å¤šçš„ç»†èŠ‚"><a href="#æ›´å¤šçš„ç»†èŠ‚" class="headerlink" title="æ›´å¤šçš„ç»†èŠ‚"></a>æ›´å¤šçš„ç»†èŠ‚</h3><p>å¯¹äºä¸€ä¸ªåŠ¨æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œexecveåçš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨å“ªé‡Œï¼Ÿ</p><ul><li>what are the first a few steps executed after execve() of a ELF dynamic link binary?  (Chatgpt)</li></ul><blockquote><p>ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨&#x2F;lib64&#x2F;ld-linux-x86-64.so.2   _startå‡½æ•°<br>ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆšåˆšæ‰§è¡Œç©execveåï¼Œæˆ‘ä»¬çš„pcæŒ‡é’ˆæŒ‡å‘äº†ld.soä¸­çš„ä»£ç ã€‚</p></blockquote><ol><li>é¦–å…ˆä¼šåŠ è½½è¿™ä¸ªELFæ–‡ä»¶ï¼ŒæŠŠç›¸å…³çš„æ®µåŠ è½½è¿›åœ°å€ç©ºé—´ä¸­ã€‚</li><li>å†…æ ¸ä¼šæ ¹æ®æŸ¥çœ‹ç¨‹åºå¤´è¡¨(program header)ä¸­çš„PT_INTERPçš„åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ¨æ€é“¾æ¥ã€‚å¦‚æœéœ€è¦ï¼Œå†…æ ¸å°±ä¼šæŠŠåŠ¨æ€é“¾æ¥å™¨(é€šå¸¸æ¥è¯´æ˜¯ld-linux.so)åŠ è½½è¿›è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ã€‚</li><li>è®¾ç½®æ ˆçš„åˆå§‹çŠ¶æ€ã€‚</li><li>æŠŠæ§åˆ¶äº¤ç»™åŠ¨æ€é“¾æ¥å™¨ï¼šå†…æ ¸æŠŠpcæŒ‡é’ˆè®¾ç½®ä¸ºåŠ¨æ€é“¾æ¥å™¨çš„å…¥å£åœ°å€ã€‚</li><li>åŠ¨æ€é“¾æ¥å™¨çš„åˆå§‹åŒ–ï¼Œè§£æç¬¦å·ï¼Œé‡å®šä½ç­‰ã€‚</li><li>æŠŠæ§åˆ¶æƒäº¤ç»™ç¨‹åº(é€šå¸¸æ¥è¯´æ˜¯_startå‡½æ•°)</li></ol><ul><li>How can I compile an ELF binary that use an alternative dynamic loader than the default ld.so?ï¼ˆèƒ½å¦æ›¿æ¢è¿™ä¸ªåŠ è½½å™¨ï¼‰ <blockquote><p>gcc -o hello hello.c -Wl, â€“dynamic-linker&#x3D;&#x2F;path&#x2F;to&#x2F;my_ld.so<br>readelf -l hello | grep â€œprogram interpreterâ€ æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„åŠ¨æ€é“¾æ¥å™¨</p></blockquote></li></ul><p>ç¤ºä¾‹ä»£ç <br>ld.S  â€”â€”  å°†æ¥é“¾æ¥æˆåŠ¨æ€é“¾æ¥åº“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><br>.globl _start<br>_start:<br>  movq $SYS_write, %rax   <span class="hljs-comment">// write(</span><br>  movq $<span class="hljs-number">1</span>,         %rdi   <span class="hljs-comment">//   fd=1,</span><br>  lea  <span class="hljs-title function_">st</span><span class="hljs-params">(%rip)</span>,   %rsi   <span class="hljs-comment">//   buf=st,</span><br>  movq $<span class="hljs-params">(ed - st)</span>, %rdx   <span class="hljs-comment">//   count=ed-st</span><br>  syscall                 <span class="hljs-comment">// );</span><br><br>  movq $SYS_exit,  %rax   <span class="hljs-comment">// exit(</span><br>  movq $1,         %rdi   <span class="hljs-comment">//   status=1</span><br>  syscall                 <span class="hljs-comment">// );</span><br><br>st:<br>  .ascii &quot;\033[01;<span class="hljs-number">31</span>mThis is a loader.\<span class="hljs-number">033</span>[<span class="hljs-number">0</span>m\n<span class="hljs-string">&quot;</span><br><span class="hljs-string">ed:</span><br></code></pre></td></tr></table></figure><p>hello.c </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>Makefile</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ld<span class="hljs-selector-class">.so</span>: ld<span class="hljs-selector-class">.S</span> hello<span class="hljs-selector-class">.c</span><br>gcc -fPIC -shared -c ld<span class="hljs-selector-class">.S</span><br>ld -shared ld<span class="hljs-selector-class">.o</span> -o ld<span class="hljs-selector-class">.so</span><br>gcc hello<span class="hljs-selector-class">.c</span> -Wl,<span class="hljs-attr">--dynamic-linker</span>=$(PWD)/ld.so<br></code></pre></td></tr></table></figure><ul><li>å½“æˆ‘ä»¬è¾“å…¥makeæŒ‡ä»¤å¹¶æ‰§è¡Œ .&#x2F;a.out æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è¾“å‡ºHello,è€Œæ˜¯è¾“å‡ºäº†This is a loader. è¿™ä¹Ÿå°±è¯´æ˜äº†æˆ‘ä»¬çš„åŠ¨æ€é“¾æ¥å™¨ç¡®å®æ¢æ‰äº†ï¼Œç”±äºhello.cæ˜¯åŠ¨æ€é“¾æ¥çš„ï¼Œæ‰€ä»¥å†…æ ¸ä¼šåŠ è½½æˆ‘ä»¬è‡ªå·±çš„åŠ¨æ€é“¾æ¥å™¨å¹¶æ‰§è¡Œã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŠ¨æ€é“¾æ¥å’ŒåŠ è½½(1)</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%92%8C%E5%8A%A0%E8%BD%BD(1)/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%92%8C%E5%8A%A0%E8%BD%BD(1)/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ¬æ¬¡è¯¾è¦å›ç­”çš„é—®é¢˜"><a href="#æœ¬æ¬¡è¯¾è¦å›ç­”çš„é—®é¢˜" class="headerlink" title="æœ¬æ¬¡è¯¾è¦å›ç­”çš„é—®é¢˜"></a>æœ¬æ¬¡è¯¾è¦å›ç­”çš„é—®é¢˜</h2><ol><li>å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦‚ä½•è¢«æ“ä½œç³»ç»ŸåŠ è½½çš„</li><li>ä»€ä¹ˆæ˜¯åŠ¨æ€é“¾æ¥&#x2F;åŠ¨æ€åŠ è½½</li></ol><h2 id="é™æ€ELFåŠ è½½å™¨ï¼šå®ç°"><a href="#é™æ€ELFåŠ è½½å™¨ï¼šå®ç°" class="headerlink" title="é™æ€ELFåŠ è½½å™¨ï¼šå®ç°"></a>é™æ€ELFåŠ è½½å™¨ï¼šå®ç°</h2><h3 id="åŠ è½½å™¨"><a href="#åŠ è½½å™¨" class="headerlink" title="åŠ è½½å™¨"></a>åŠ è½½å™¨</h3><ol><li>è§£ææ•°æ®ç»“æ„ + å¤åˆ¶åˆ°å†…å­˜ + è·³è½¬</li><li>åˆ›å»ºè¿›ç¨‹è¿è¡Œæ—¶çš„åˆå§‹çŠ¶æ€(argv,envp,â€¦)</li></ol><h3 id="loader-static-c"><a href="#loader-static-c" class="headerlink" title="loader-static.c"></a>loader-static.c</h3><ol><li>å¯ä»¥åŠ è½½ä»»ä½•é™æ€é“¾æ¥çš„ä»£ç , minimal.S, dfs-fork.c</li><li>å¹¶å¯ä»¥æ­£ç¡®å¤„ç†å‚æ•°&#x2F;ç¯å¢ƒå˜é‡ env.c<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;elf.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STK_SZ           (1 &lt;&lt; 20)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ROUND(x, align)  (void *)(((uintptr_t)x) &amp; ~(align - 1))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOD(x, align)    (((uintptr_t)x) &amp; (align - 1))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> push(sp, T, ...) (&#123; *((T*)sp) = (T)__VA_ARGS__; sp = (void *)((uintptr_t)(sp) + sizeof(T)); &#125;)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">execve_</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">char</span> *argv[], <span class="hljs-type">char</span> *envp[])</span> &#123;<br>  <span class="hljs-comment">// WARNING: This execve_ does not free process resources.</span><br>  <span class="hljs-type">int</span> fd = open(file, O_RDONLY);<br>  assert(fd &gt; <span class="hljs-number">0</span>);<br>  Elf64_Ehdr *h = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">4096</span>, PROT_READ, MAP_PRIVATE, fd, <span class="hljs-number">0</span>);<br>  assert(h != (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>);<br>  assert(h-&gt;e_type == ET_EXEC &amp;&amp; h-&gt;e_machine == EM_X86_64);<br><br>  Elf64_Phdr *pht = (Elf64_Phdr *)((<span class="hljs-type">char</span> *)h + h-&gt;e_phoff);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; h-&gt;e_phnum; i++) &#123;<br>    Elf64_Phdr *p = &amp;pht[i];<br>    <span class="hljs-keyword">if</span> (p-&gt;p_type == PT_LOAD) &#123;<br>      <span class="hljs-type">int</span> prot = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> (p-&gt;p_flags &amp; PF_R) prot |= PROT_READ;<br>      <span class="hljs-keyword">if</span> (p-&gt;p_flags &amp; PF_W) prot |= PROT_WRITE;<br>      <span class="hljs-keyword">if</span> (p-&gt;p_flags &amp; PF_X) prot |= PROT_EXEC;<br>      <span class="hljs-type">void</span> *ret = mmap(<br>        ROUND(p-&gt;p_vaddr, p-&gt;p_align),              <span class="hljs-comment">// addr, rounded to ALIGN</span><br>        p-&gt;p_memsz + MOD(p-&gt;p_vaddr, p-&gt;p_align),   <span class="hljs-comment">// length</span><br>        prot,                                       <span class="hljs-comment">// protection</span><br>        MAP_PRIVATE | MAP_FIXED,                    <span class="hljs-comment">// flags, private &amp; strict</span><br>        fd,                                         <span class="hljs-comment">// file descriptor</span><br>        (<span class="hljs-type">uintptr_t</span>)ROUND(p-&gt;p_offset, p-&gt;p_align)); <span class="hljs-comment">// offset</span><br>      assert(ret != (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>);<br>      <span class="hljs-built_in">memset</span>((<span class="hljs-type">void</span> *)(p-&gt;p_vaddr + p-&gt;p_filesz), <span class="hljs-number">0</span>, p-&gt;p_memsz - p-&gt;p_filesz);<br>    &#125;<br>  &#125;<br>  close(fd);<br><br>  <span class="hljs-type">static</span> <span class="hljs-type">char</span> <span class="hljs-built_in">stack</span>[STK_SZ], rnd[<span class="hljs-number">16</span>];<br>  <span class="hljs-type">void</span> *sp = ROUND(<span class="hljs-built_in">stack</span> + <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">stack</span>) - <span class="hljs-number">4096</span>, <span class="hljs-number">16</span>);<br>  <span class="hljs-type">void</span> *sp_exec = sp;<br>  <span class="hljs-type">int</span> argc = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// argc</span><br>  <span class="hljs-keyword">while</span> (argv[argc]) argc++;<br>  push(sp, <span class="hljs-type">intptr_t</span>, argc);<br>  <span class="hljs-comment">// argv[], NULL-terminate</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt;= argc; i++)<br>    push(sp, <span class="hljs-type">intptr_t</span>, argv[i]);<br>  <span class="hljs-comment">// envp[], NULL-terminate</span><br>  <span class="hljs-keyword">for</span> (; *envp; envp++) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strchr</span>(*envp, <span class="hljs-string">&#x27;_&#x27;</span>)) <span class="hljs-comment">// remove some verbose ones</span><br>      push(sp, <span class="hljs-type">intptr_t</span>, *envp);<br>  &#125;<br>  <span class="hljs-comment">// auxv[], AT_NULL-terminate</span><br>  push(sp, <span class="hljs-type">intptr_t</span>, <span class="hljs-number">0</span>);<br>  push(sp, Elf64_auxv_t, &#123; .a_type = AT_RANDOM, .a_un.a_val = (<span class="hljs-type">uintptr_t</span>)rnd &#125; );<br>  push(sp, Elf64_auxv_t, &#123; .a_type = AT_NULL &#125; );<br><br>  <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-string">&quot;mov $0, %%rdx;&quot;</span> <span class="hljs-comment">// required by ABI</span></span><br><span class="hljs-params">    <span class="hljs-string">&quot;mov %0, %%rsp;&quot;</span></span><br><span class="hljs-params">    <span class="hljs-string">&quot;jmp *%1&quot;</span> : : <span class="hljs-string">&quot;a&quot;</span>(sp_exec), <span class="hljs-string">&quot;b&quot;</span>(h-&gt;e_entry))</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[], <span class="hljs-type">char</span> *envp[])</span> &#123;<br>  <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Usage: %s file [args...]\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  execve_(argv[<span class="hljs-number">1</span>], argv + <span class="hljs-number">1</span>, envp);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è§£é‡Šä¸€ä¸‹æˆ‘ä»¬è¿™é‡Œçš„loader(å®ƒæ˜¯åŠ¨æ€é“¾æ¥çš„): ç»™æˆ‘ä»¬çš„loaderä¼ å…¥ä¸€ä¸ªå‚æ•°,å®ƒæ‰§è¡Œåˆ°æŸä¸€ä¸ªçŠ¶æ€çš„æ—¶å€™ï¼ŒæŠŠæˆ‘ä»¬çš„ELFæ–‡ä»¶(argv[1])æ¬åˆ°æˆ‘ä»¬çš„loaderç¨‹åºçš„çŠ¶æ€ä¸Š,ç›¸å½“äºæˆ‘ä»¬çš„ç¨‹åºè¢«æ›¿æ¢äº†,ä½†è¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰æ‰§è¡Œexecve,åªæ˜¯ç®€å•åœ°ç”¨mmapç³»ç»Ÿè°ƒç”¨(å½“ç„¶æ“ä½œç³»ç»ŸåŠ è½½loaderè¿™ä¸ªç¨‹åºçš„æ—¶å€™ä¼šç”¨execve)ã€‚</p></blockquote></li></ol><h3 id="åˆå§‹åŒ–å †æ ˆ"><a href="#åˆå§‹åŒ–å †æ ˆ" class="headerlink" title="åˆå§‹åŒ–å †æ ˆ"></a>åˆå§‹åŒ–å †æ ˆ</h3><p>çŠ¶æ€æœºæ˜¯well-definedçš„ã€‚</p><table><thead><tr><th>è¡¨å¤´</th><th>è¡¨å¤´</th><th>é•¿åº¦(å­—èŠ‚)</th></tr></thead><tbody><tr><td>å…¶ä»–ä¿¡æ¯</td><td></td><td>æœªçŸ¥</td></tr><tr><td>Null auxiliary vector entry</td><td></td><td>1 eightbyte each</td></tr><tr><td>Auxiliary vector entries</td><td></td><td>2 eightbytes each</td></tr><tr><td>0</td><td></td><td>8</td></tr><tr><td>Environment pointers</td><td></td><td>8 bytes each</td></tr><tr><td>0</td><td>8 + 8*argc + %rsp</td><td>8</td></tr><tr><td>Argument pointers</td><td>8 + %rsp</td><td>argc 8</td></tr><tr><td>Argument count</td><td>%rsp</td><td>8</td></tr><tr><td>Undefined</td><td>Low Address</td><td></td></tr></tbody></table><h3 id="æœ‰è¶£ä¹‹å¤„"><a href="#æœ‰è¶£ä¹‹å¤„" class="headerlink" title="æœ‰è¶£ä¹‹å¤„"></a>æœ‰è¶£ä¹‹å¤„</h3><blockquote><p>è¿™æ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸Šå®ç°çš„ã€‚ç”¨ open , mmap, closeå®ç°äº†ä¸€ä¸ª execveã€‚     </p></blockquote><hr><h2 id="åŠ¨æ€é“¾æ¥å’ŒåŠ è½½"><a href="#åŠ¨æ€é“¾æ¥å’ŒåŠ è½½" class="headerlink" title="åŠ¨æ€é“¾æ¥å’ŒåŠ è½½"></a>åŠ¨æ€é“¾æ¥å’ŒåŠ è½½</h2><h3 id="ä¸ºä»€ä¹ˆè¦åŠ¨æ€åŠ è½½"><a href="#ä¸ºä»€ä¹ˆè¦åŠ¨æ€åŠ è½½" class="headerlink" title="ä¸ºä»€ä¹ˆè¦åŠ¨æ€åŠ è½½"></a>ä¸ºä»€ä¹ˆè¦åŠ¨æ€åŠ è½½</h3><ol><li>å‡å°‘åº“å‡½æ•°çš„ç£ç›˜å’Œå†…å­˜æ‹·è´</li></ol><ul><li>æ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢éƒ½æœ‰æ‰€æœ‰çš„åº“å‡½æ•°æ‹·è´é‚£ä¹Ÿå¤ªæµªè´¹äº†</li><li>åªè¦éµå®ˆçº¦å®šï¼Œä¸æŒ‘æˆ˜åº“å‡½æ•°çš„ç‰ˆæœ¬(å¦åˆ™å‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬å°±è¦é‡æ–°ç¼–è¯‘å…¨éƒ¨ç¨‹åº)</li></ul><h3 id="è¿™å°±æœ‰äº†â€æ‹†è§£åº”ç”¨ç¨‹åºâ€çš„éœ€æ±‚"><a href="#è¿™å°±æœ‰äº†â€æ‹†è§£åº”ç”¨ç¨‹åºâ€çš„éœ€æ±‚" class="headerlink" title="è¿™å°±æœ‰äº†â€æ‹†è§£åº”ç”¨ç¨‹åºâ€çš„éœ€æ±‚"></a>è¿™å°±æœ‰äº†â€æ‹†è§£åº”ç”¨ç¨‹åºâ€çš„éœ€æ±‚</h3><blockquote><p>éšç€åº“å‡½æ•°è¶Šæ¥è¶Šå¤§ï¼Œå¸Œæœ›é¡¹ç›®èƒ½å¤Ÿè¿è¡Œæ—¶é“¾æ¥ã€‚</p></blockquote><h3 id="åŠ¨æ€é“¾æ¥ï¼Œä½†ä¸è®²ELF-æ¢ä¸€ç§æ–¹æ³•ã€‚"><a href="#åŠ¨æ€é“¾æ¥ï¼Œä½†ä¸è®²ELF-æ¢ä¸€ç§æ–¹æ³•ã€‚" class="headerlink" title="åŠ¨æ€é“¾æ¥ï¼Œä½†ä¸è®²ELF,æ¢ä¸€ç§æ–¹æ³•ã€‚"></a>åŠ¨æ€é“¾æ¥ï¼Œä½†ä¸è®²ELF,æ¢ä¸€ç§æ–¹æ³•ã€‚</h3><ul><li>å¦‚æœç¼–è¯‘å™¨ã€é“¾æ¥å™¨ã€åŠ è½½å™¨éƒ½å—ä½ æ§åˆ¶</li><li>é‚£ä½ æ€ä¹ˆè®¾è®¡å®ç°ä¸€ä¸ªâ€œæœ€ç›´è§‚â€çš„åŠ¨æ€é“¾æ¥æ ¼å¼ï¼Ÿ</li><li>å¦‚ä½•æ”¹è¿›ï¼Œå°±å¾—åˆ°äº†ELFï¼</li><li>å‡è®¾ç¼–è¯‘å™¨å¯ä»¥ä¸ºä½ ç”Ÿæˆä½ç½®æ— å…³ä»£ç (PIC)</li></ul><h3 id="æ¥çœ‹ä¸€ä¸‹è’‹ç¥çš„è®¾è®¡-main-part"><a href="#æ¥çœ‹ä¸€ä¸‹è’‹ç¥çš„è®¾è®¡-main-part" class="headerlink" title="æ¥çœ‹ä¸€ä¸‹è’‹ç¥çš„è®¾è®¡(main part)"></a>æ¥çœ‹ä¸€ä¸‹è’‹ç¥çš„è®¾è®¡(main part)</h3><h4 id="å¤´æ–‡ä»¶"><a href="#å¤´æ–‡ä»¶" class="headerlink" title="å¤´æ–‡ä»¶"></a>å¤´æ–‡ä»¶</h4><ul><li>dl.h(æ•°æ®ç»“æ„å®šä¹‰)</li></ul><h4 id="å…¨å®¶æ¡¶å·¥å…·é›†"><a href="#å…¨å®¶æ¡¶å·¥å…·é›†" class="headerlink" title="å…¨å®¶æ¡¶å·¥å…·é›†"></a>å…¨å®¶æ¡¶å·¥å…·é›†</h4><ul><li>dlbox.c(gcc, readdl, objdump, interp)</li></ul><h4 id="ç¤ºä¾‹ä»£ç "><a href="#ç¤ºä¾‹ä»£ç " class="headerlink" title="ç¤ºä¾‹ä»£ç "></a>ç¤ºä¾‹ä»£ç </h4><ul><li>libc.S - æä¾› putchar å’Œ exit</li><li>libhello.S - è°ƒç”¨ putchar, æä¾› hello</li><li>main.S - è°ƒç”¨ hello, æä¾› main</li></ul><h4 id="ä½¿ç”¨è¯´æ˜"><a href="#ä½¿ç”¨è¯´æ˜" class="headerlink" title="ä½¿ç”¨è¯´æ˜"></a>ä½¿ç”¨è¯´æ˜</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">gcc -o dlbox dlbox<span class="hljs-selector-class">.c</span><br>./dlbox gcc libc<span class="hljs-selector-class">.S</span><br>./dlbox gcc libhello<span class="hljs-selector-class">.S</span><br>./dlbox gcc <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.S</span><br>./dlbox readdl libc<span class="hljs-selector-class">.dl</span>         <span class="hljs-comment">//readelf</span><br></code></pre></td></tr></table></figure><blockquote></blockquote><p>ä¼šç”Ÿæˆ.dlæ ¼å¼çš„è‡ªå®šä¹‰å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ˜¯ä¸å¯ä»¥åœ¨æ“ä½œç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œéœ€è¦è‡ªå·±çš„åŠ è½½å™¨ã€‚<br>å¹¶ä¸”æˆ‘ä»¬çš„åŠ è½½å™¨æ˜¯åœ¨å½“å‰ç›®å½•ä¸­åŠ¨æ€åŠ è½½.dlæ–‡ä»¶(æ ¹æ®)çš„ï¼Œå¦‚æœå…ˆå‰æ²¡æœ‰ç”Ÿæˆæ‰€éœ€è¦çš„.dlæ–‡ä»¶çš„è¯ï¼Œæˆ‘ä»¬çš„åŠ è½½å™¨ä¼šå‡ºç°é”™è¯¯ã€‚</p><blockquote></blockquote><h4 id="æ¼”ç¤ºä¸€ä¸‹ä¸‹"><a href="#æ¼”ç¤ºä¸€ä¸‹ä¸‹" class="headerlink" title="æ¼”ç¤ºä¸€ä¸‹ä¸‹"></a><strong>æ¼”ç¤ºä¸€ä¸‹ä¸‹</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;dl.h&quot;</span></span><br><br>DL_HEAD<br><br><span class="hljs-title function_">LOAD</span><span class="hljs-params">(<span class="hljs-string">&quot;libc.dl&quot;</span>)</span><br><span class="hljs-title function_">IMPORT</span><span class="hljs-params">(<span class="hljs-built_in">putchar</span>)</span><br><span class="hljs-title function_">EXPORT</span><span class="hljs-params">(hello)</span><br><br>DL_CODE<br><br>hello:<br>  lea <span class="hljs-title function_">str</span><span class="hljs-params">(%rip)</span>, %rdi<br>  mov <span class="hljs-title function_">count</span><span class="hljs-params">(%rip)</span>, %eax<br>  push %rbx<br>  mov %rdi, %rbx<br>  inc %eax<br>  mov %eax, <span class="hljs-title function_">count</span><span class="hljs-params">(%rip)</span><br>  add $0x30, %eax<br>  movb %al, 0<span class="hljs-title function_">x6</span><span class="hljs-params">(%rdi)</span><br>loop:<br>  <span class="hljs-title function_">movsbl</span> <span class="hljs-params">(%rbx)</span>,%edi<br>  test %dil,%dil<br>  je out<br>  call <span class="hljs-title function_">DSYM</span><span class="hljs-params">(<span class="hljs-built_in">putchar</span>)</span><br>  inc  %rbx<br>  jmp loop<br>out:<br>  pop %rbx<br>  ret<br><br>str:<br>  .asciz &quot;Hello X\n&quot;<br><br>count:<br>  .<span class="hljs-type">int</span> 0<br><br>DL_END<br><br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªæ–‡ä»¶éœ€è¦ä½¿ç”¨å¤–éƒ¨çš„putcharå‡½æ•°,æ‰€ä»¥éœ€è¦call DSYM(putchar), DSYMè¡¨ç¤ºåŠ¨æ€é“¾æ¥çš„ï¼Œä¹Ÿéœ€è¦æ‰‹åŠ¨æŒ‡æ˜putcharå‡½æ•°æ‰€åœ¨çš„åº“libc.dlã€‚å®ƒå®šä¹‰æœ‰ä¸€ä¸ªhelloå‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦å¯¼å‡ºã€‚ä¹Ÿå°±æ˜¯EXPORT(hello).</p></blockquote><h3 id="ä»£ç è§£æ"><a href="#ä»£ç è§£æ" class="headerlink" title="ä»£ç è§£æ"></a><strong>ä»£ç è§£æ</strong></h3><ol><li><p><strong>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹dl.hæ–‡ä»¶</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> REC_SZ 32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DL_MAGIC <span class="hljs-string">&quot;\x01\x14\x05\x14&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __ASSEMBLER__</span><br>  <span class="hljs-meta">#<span class="hljs-keyword">define</span> DL_HEAD     __hdr: \</span><br><span class="hljs-meta">                      <span class="hljs-comment">/* magic */</span>    .ascii DL_MAGIC; \</span><br><span class="hljs-meta">                      <span class="hljs-comment">/* file_sz */</span>  .4byte (__end - __hdr); \</span><br><span class="hljs-meta">                      <span class="hljs-comment">/* code_off */</span> .4byte (__code - __hdr)</span><br>  <span class="hljs-meta">#<span class="hljs-keyword">define</span> DL_CODE     .fill REC_SZ - 1, 1, 0; \</span><br><span class="hljs-meta">                      .align REC_SZ, 0; \</span><br><span class="hljs-meta">                      __code:</span><br>  <span class="hljs-meta">#<span class="hljs-keyword">define</span> DL_END      __end:</span><br><br>  <span class="hljs-meta">#<span class="hljs-keyword">define</span> RECORD(sym, off, name) \</span><br><span class="hljs-meta">    .align REC_SZ, 0; \</span><br><span class="hljs-meta">    sym .8byte (off); .ascii name</span><br><br>  <span class="hljs-meta">#<span class="hljs-keyword">define</span> IMPORT(sym) RECORD(sym:,           0, <span class="hljs-string">&quot;?&quot;</span> #sym <span class="hljs-string">&quot;\0&quot;</span>)</span><br>  <span class="hljs-meta">#<span class="hljs-keyword">define</span> EXPORT(sym) RECORD(    , sym - __hdr, <span class="hljs-string">&quot;#&quot;</span> #sym <span class="hljs-string">&quot;\0&quot;</span>)</span><br>  <span class="hljs-meta">#<span class="hljs-keyword">define</span> LOAD(lib)   RECORD(    ,           0, <span class="hljs-string">&quot;+&quot;</span> lib  <span class="hljs-string">&quot;\0&quot;</span>)</span><br>  <span class="hljs-meta">#<span class="hljs-keyword">define</span> DSYM(sym)   *sym(%rip)</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dl_hdr</span> &#123;</span><br>    <span class="hljs-type">char</span> magic[<span class="hljs-number">4</span>];<br>    <span class="hljs-type">uint32_t</span> file_sz, code_off;<br>  &#125;;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">symbol</span> &#123;</span><br>    <span class="hljs-type">int64_t</span> offset;<br>    <span class="hljs-type">char</span> type, name[REC_SZ - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int64_t</span>) - <span class="hljs-number">1</span>];<br>  &#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br></code></pre></td></tr></table></figure><blockquote><ol><li>__ASSEMBLER__æ˜¯ä¸€ä¸ªå†…ç½®çš„å®ï¼Œå®ƒç”±ç¼–è¯‘å™¨é¢„å®šä¹‰ï¼Œç”¨äºåˆ¤æ–­å½“å‰ä»£ç æ˜¯å¦ä¸ºæ±‡ç¼–ä»£ç ã€‚åœ¨ç¼–å†™æ±‡ç¼–ä»£ç æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å®šä¹‰è¿™ä¸ªå®ã€‚</li><li>æ€ä¹ˆç”¨æ±‡ç¼–è¯­è¨€å®šä¹‰ç»“æ„ä½“å‘¢ï¼Ÿ ä¸ºä»€ä¹ˆå˜é‡åå‰é¢è¦åŠ .å‘¢ï¼Ÿè¿™è¡¨ç¤ºè¿™æ˜¯åœ¨å½“å‰åç§»é‡ä¸‹å®šä¹‰çš„ã€‚</li><li>RECORDå®å®šä¹‰ï¼š.align REC_SZ, 0 è¡¨ç¤ºå°†å½“å‰ä½ç½®å¯¹é½åˆ° REC_SZ å­—èŠ‚è¾¹ç•Œã€‚<br>è¿™è¡Œä»£ç å®šä¹‰äº†ä¸€ä¸ªæ ‡ç­¾ symï¼Œå¹¶å°† off è¡¨ç¤ºçš„åç§»é‡å­˜å‚¨åˆ°è¯¥æ ‡ç­¾å¤„ã€‚.8byte æŒ‡ä»¤å‘Šè¯‰æ±‡ç¼–å™¨ä¸ºè¯¥æ ‡ç­¾åˆ†é…ä¸€ä¸ª 8 å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼Œå³ä½¿ç”¨ä¸€ä¸ª 64 ä½æ— ç¬¦å·æ•´æ•°æ¥å­˜å‚¨åç§»é‡ã€‚<br>.ascii name è¡¨ç¤ºå°† name å‚æ•°è¡¨ç¤ºçš„è®°å½•åç§°ä½œä¸º ASCII å­—ç¬¦ä¸²åµŒå…¥åˆ°æ±‡ç¼–ä»£ç ä¸­ã€‚.ascii æŒ‡ä»¤ç”¨äºå°†ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡åµŒå…¥åˆ°æ±‡ç¼–ä»£ç ä¸­ã€‚</li><li>#define DSYM(sym)  è¿™æ˜¯é—´æ¥è·³è½¬ï¼Œå…ˆå°† %rip å¯„å­˜å™¨ä¸­å­˜å‚¨çš„å½“å‰æŒ‡ä»¤åœ°å€åŠ ä¸Š hello ç¬¦å·ç›¸å¯¹äºå½“å‰æŒ‡ä»¤çš„åç§»é‡ï¼Œå¾—åˆ°å‡½æ•°åœ°å€ï¼Œç„¶åå†æ ¹æ®è¿™ä¸ªåœ°å€çš„å€¼è¿›è¡Œè·³è½¬ï¼Œè€Œç¬¦å·è¡¨ç»“æ„ä½“å‰å…«ä¸ªå­—èŠ‚å°±æ˜¯å‡½æ•°çš„åœ°å€ã€‚</li></ol></blockquote></li><li><p><strong>dlbox.cæ–‡ä»¶</strong></p></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;dl.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE 4096</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LENGTH(arr) (sizeof(arr) / sizeof(arr[0]))</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dlib</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dl_hdr</span> <span class="hljs-title">hdr</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">symbol</span> *<span class="hljs-title">symtab</span>;</span> <span class="hljs-comment">// borrowed spaces from header</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *path;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> dlib *<span class="hljs-title function_">dlopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span>;<br><br><span class="hljs-keyword">struct</span> dlib *<span class="hljs-title function_">dlopen_chk</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dlib</span> *<span class="hljs-title">lib</span> =</span> dlopen(path);<br>  <span class="hljs-keyword">if</span> (!lib) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Not a valid dlib file: %s.\n&quot;</span>, path);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> lib;<br>&#125;<br><br><span class="hljs-comment">// Implementation of binutils</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">dl_gcc</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">256</span>], *dot = <span class="hljs-built_in">strrchr</span>(path, <span class="hljs-string">&#x27;.&#x27;</span>);<br>  <span class="hljs-keyword">if</span> (dot) &#123;<br>    *dot = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;gcc -m64 -fPIC -c %s.S &amp;&amp; &quot;</span><br>      <span class="hljs-string">&quot;objcopy -S -j .text -O binary %s.o %s.dl&quot;</span>, path, path, path);<br>    system(buf);<br>  &#125;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">dl_readdl</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dlib</span> *<span class="hljs-title">h</span> =</span> dlopen_chk(path);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DLIB file %s:\n\n&quot;</span>, h-&gt;path);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">struct</span> symbol *sym = h-&gt;symtab; sym-&gt;type; sym++) &#123;<br>    <span class="hljs-keyword">switch</span> (sym-&gt;type) &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;+&#x27;</span>: <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    LOAD  %s\n&quot;</span>, sym-&gt;name); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;?&#x27;</span>: <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  EXTERN  %s\n&quot;</span>, sym-&gt;name); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;#&#x27;</span>: <span class="hljs-built_in">printf</span>(   <span class="hljs-string">&quot;%08lx  %s\n&quot;</span>, sym-&gt;offset, sym-&gt;name); <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">dl_objdump</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dlib</span> *<span class="hljs-title">h</span> =</span> dlopen_chk(path);<br>  <span class="hljs-type">char</span> *hc = (<span class="hljs-type">char</span> *)h, cmd[<span class="hljs-number">64</span>];<br>  FILE *fp = <span class="hljs-literal">NULL</span>;<br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Disassembly of binary %s:\n&quot;</span>, h-&gt;path);<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> *code = hc + h-&gt;hdr.code_off; code &lt; hc + h-&gt;hdr.file_sz; code++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">struct</span> symbol *sym = h-&gt;symtab; sym-&gt;type; sym++) &#123;<br>      <span class="hljs-keyword">if</span> (hc + sym-&gt;offset == code) &#123;<br>        <span class="hljs-type">int</span> off = code - hc - h-&gt;hdr.code_off;<br>        <span class="hljs-keyword">if</span> (fp) pclose(fp);<br>        <span class="hljs-built_in">sprintf</span>(cmd, <span class="hljs-string">&quot;ndisasm - -b 64 -o 0x%08x\n&quot;</span>, off);<br>        fp = popen(cmd, <span class="hljs-string">&quot;w&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n%016x &lt;%s&gt;:\n&quot;</span>, off, sym-&gt;name);<br>        fflush(<span class="hljs-built_in">stdout</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (fp) fputc(*code, fp);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (fp) pclose(fp);<br>&#125;<br><br><span class="hljs-comment">// binutils: interpreter</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">dl_interp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dlib</span> *<span class="hljs-title">h</span> =</span> dlopen_chk(path);<br>  <span class="hljs-type">int</span> (*entry)() = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">struct</span> symbol *sym = h-&gt;symtab; sym-&gt;type; sym++)<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(sym-&gt;name, <span class="hljs-string">&quot;main&quot;</span>) == <span class="hljs-number">0</span>)<br>      entry = (<span class="hljs-type">void</span> *)((<span class="hljs-type">char</span> *)h + sym-&gt;offset);<br>  <span class="hljs-keyword">if</span> (entry) &#123;<br>    <span class="hljs-built_in">exit</span>(entry());<br>  &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmd</span> &#123;</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *cmd;<br>  <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path);<br>&#125; commands[] = &#123;<br>  &#123; <span class="hljs-string">&quot;gcc&quot;</span>,     dl_gcc &#125;,<br>  &#123; <span class="hljs-string">&quot;readdl&quot;</span>,  dl_readdl &#125;,<br>  &#123; <span class="hljs-string">&quot;objdump&quot;</span>, dl_objdump &#125;,<br>  &#123; <span class="hljs-string">&quot;interp&quot;</span>,  dl_interp &#125;,<br>  &#123; <span class="hljs-string">&quot;&quot;</span>,        <span class="hljs-literal">NULL</span> &#125;,<br>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">3</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Usage: %s &#123;gcc|readdl|objdump|interp&#125; FILE...\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">struct</span> cmd *cmd = &amp;commands[<span class="hljs-number">0</span>]; cmd-&gt;handler; cmd++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> **path = &amp;argv[<span class="hljs-number">2</span>]; *path &amp;&amp; <span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], cmd-&gt;cmd) == <span class="hljs-number">0</span>; path++) &#123;<br>      <span class="hljs-keyword">if</span> (path != argv + <span class="hljs-number">2</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>      cmd-&gt;handler(*path);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// Implementation of dlopen()</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">symbol</span> *<span class="hljs-title">libs</span>[16], <span class="hljs-title">syms</span>[128];</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">dlsym</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dlexport</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *addr)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dlload</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> symbol *sym)</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> dlib *<span class="hljs-title function_">dlopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dl_hdr</span> <span class="hljs-title">hdr</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dlib</span> *<span class="hljs-title">h</span>;</span><br><br>  <span class="hljs-type">int</span> fd = open(path, O_RDONLY);<br>  <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">goto</span> bad;<br>  <span class="hljs-keyword">if</span> (read(fd, &amp;hdr, <span class="hljs-keyword">sizeof</span>(hdr)) &lt; <span class="hljs-keyword">sizeof</span>(hdr)) <span class="hljs-keyword">goto</span> bad;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(hdr.magic, DL_MAGIC, <span class="hljs-built_in">strlen</span>(DL_MAGIC)) != <span class="hljs-number">0</span>) <span class="hljs-keyword">goto</span> bad;<br><br>  h = mmap(<span class="hljs-literal">NULL</span>, hdr.file_sz, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE, fd, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (h == (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>) <span class="hljs-keyword">goto</span> bad;<br><br>  h-&gt;symtab = (<span class="hljs-keyword">struct</span> symbol *)((<span class="hljs-type">char</span> *)h + REC_SZ);<br>  h-&gt;path = path;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">struct</span> symbol *sym = h-&gt;symtab; sym-&gt;type; sym++) &#123;<br>    <span class="hljs-keyword">switch</span> (sym-&gt;type) &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;+&#x27;</span>: dlload(sym); <span class="hljs-keyword">break</span>; <span class="hljs-comment">// (recursively) load</span><br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;?&#x27;</span>: sym-&gt;offset = (<span class="hljs-type">uintptr_t</span>)dlsym(sym-&gt;name); <span class="hljs-keyword">break</span>; <span class="hljs-comment">// resolve</span><br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;#&#x27;</span>: dlexport(sym-&gt;name, (<span class="hljs-type">char</span> *)h + sym-&gt;offset); <span class="hljs-keyword">break</span>; <span class="hljs-comment">// export</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> h;<br><br>bad:<br>  <span class="hljs-keyword">if</span> (fd &gt; <span class="hljs-number">0</span>) close(fd);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">dlsym</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; LENGTH(syms); i++)<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(syms[i].name, name) == <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)syms[i].offset;<br>  assert(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dlexport</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *addr)</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; LENGTH(syms); i++)<br>    <span class="hljs-keyword">if</span> (!syms[i].name[<span class="hljs-number">0</span>]) &#123;<br>      syms[i].offset = (<span class="hljs-type">uintptr_t</span>)addr; <span class="hljs-comment">// load-time offset</span><br>      <span class="hljs-built_in">strcpy</span>(syms[i].name, name);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  assert(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dlload</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> symbol *sym)</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; LENGTH(libs); i++) &#123;<br>    <span class="hljs-keyword">if</span> (libs[i] &amp;&amp; <span class="hljs-built_in">strcmp</span>(libs[i]-&gt;name, sym-&gt;name) == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// already loaded</span><br>    <span class="hljs-keyword">if</span> (!libs[i]) &#123;<br>      libs[i] = sym;<br>      dlopen(sym-&gt;name); <span class="hljs-comment">// load recursively</span><br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125;<br>  assert(<span class="hljs-number">0</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="æ¥è§£é‡Šä¸€ä¸‹-æŒ‰é¡ºåº-ï¼š"><a href="#æ¥è§£é‡Šä¸€ä¸‹-æŒ‰é¡ºåº-ï¼š" class="headerlink" title="æ¥è§£é‡Šä¸€ä¸‹(æŒ‰é¡ºåº)ï¼š"></a>æ¥è§£é‡Šä¸€ä¸‹(æŒ‰é¡ºåº)ï¼š</h3><ol><li><p>é¦–å…ˆéœ€è¦dl_gccå„.Sæ–‡ä»¶å¾—åˆ°.dlã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">dl_gcc</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">256</span>], *dot = <span class="hljs-built_in">strrchr</span>(path, <span class="hljs-string">&#x27;.&#x27;</span>);<br>  <span class="hljs-keyword">if</span> (dot) &#123;<br>    *dot = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;gcc -m64 -fPIC -c %s.S &amp;&amp; &quot;</span><br>      <span class="hljs-string">&quot;objcopy -S -j .text -O binary %s.o %s.dl&quot;</span>, path, path, path);<br>    system(buf);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>åŸæ¥å‘½ä»¤è¡Œè¿˜å¯ä»¥è¿™ä¹ˆå†™ï¼ å‰ä¸€å¥ç”Ÿæˆ64ä½çš„ä½ç½®æ— å…³ä»£ç ï¼Œç„¶åå†æŠŠä»£ç æ®µæ‹·è´æˆ.dlæ–‡ä»¶ã€‚è¿™é‡Œä¸»è¦æ˜¯ä¸€äº›å®æ›¿æ¢ï¼Œå¹¶ä¸”ç”±äºæˆ‘ä»¬çš„æ±‡ç¼–ä»£ç æ ¼å¼æ˜¯å¾ˆä¸¥æ ¼åœ°æŒ‰ç…§dl_hdrçš„å½¢å¼å†™çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°çš„å…¶å®æ˜¯ä¸€ä¸ªdl_libçš„ç»“æ„ä½“ã€‚æ›´ç›´è§‚åœ°æ¥æ„Ÿå—ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨å‘½ä»¤gcc -E main.S,å¾—åˆ°å®æ›¿æ¢å±•å¼€çš„æ–‡ä»¶(å¦‚ä¸‹):</p></blockquote><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment"># 0 &quot;main.S&quot;</span><br><span class="hljs-comment"># 0 &quot;&lt;built-in&gt;&quot;</span><br><span class="hljs-comment"># 0 &quot;&lt;command-line&gt;&quot;</span><br><span class="hljs-comment"># 1 &quot;/usr/include/stdc-predef.h&quot; 1 3 4</span><br><span class="hljs-comment"># 0 &quot;&lt;command-line&gt;&quot; 2</span><br><span class="hljs-comment"># 1 &quot;main.S&quot;</span><br><span class="hljs-comment"># 1 &quot;dl.h&quot; 1</span><br><span class="hljs-comment"># 2 &quot;main.S&quot; 2</span><br><br>__hdr: <span class="hljs-string">.ascii</span> <span class="hljs-string">&quot;\x01\x14\x05\x14&quot;</span>; <span class="hljs-string">.4byte</span> <span class="hljs-params">(__end - __hdr)</span>; <span class="hljs-string">.4byte</span> <span class="hljs-params">(__code - __hdr)</span><br><br><span class="hljs-string">.align</span> 32, 0; <span class="hljs-string">.8byte</span> <span class="hljs-params">(0)</span>; <span class="hljs-string">.ascii</span> <span class="hljs-string">&quot;+&quot;</span> <span class="hljs-string">&quot;libc.dl&quot;</span> <span class="hljs-string">&quot;\0&quot;</span><br><span class="hljs-string">.align</span> 32, 0; <span class="hljs-string">.8byte</span> <span class="hljs-params">(0)</span>; <span class="hljs-string">.ascii</span> <span class="hljs-string">&quot;+&quot;</span> <span class="hljs-string">&quot;libhello.dl&quot;</span> <span class="hljs-string">&quot;\0&quot;</span><br><span class="hljs-string">.align</span> 32, 0; hello: <span class="hljs-string">.8byte</span> <span class="hljs-params">(0)</span>; <span class="hljs-string">.ascii</span> <span class="hljs-string">&quot;?&quot;</span> <span class="hljs-string">&quot;hello&quot;</span> <span class="hljs-string">&quot;\0&quot;</span><br><span class="hljs-string">.align</span> 32, 0; <span class="hljs-string">.8byte</span> <span class="hljs-params">(main - __hdr)</span>; <span class="hljs-string">.ascii</span> <span class="hljs-string">&quot;#&quot;</span> <span class="hljs-string">&quot;main&quot;</span> <span class="hljs-string">&quot;\0&quot;</span><br><br><span class="hljs-string">.fill</span> 32 - 1, 1, 0; <span class="hljs-string">.align</span> 32, 0; __code:<br><br>main:<br>  call *hello<span class="hljs-params">(%rip)</span><br>  call *hello<span class="hljs-params">(%rip)</span><br>  call *hello<span class="hljs-params">(%rip)</span><br>  call *hello<span class="hljs-params">(%rip)</span><br>  movq $0, %rax<br>  ret<br><br>__end:<br></code></pre></td></tr></table></figure><blockquote><p>xxd main.dlå‘½ä»¤å¾—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dotnetcli">00000000: 0114 0514 e000 0000 c000 0000 0000 0000  ................<br>00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>00000020: 0000 0000 0000 0000 2b6c 6962 632e 646c  ........+libc.dl<br>00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>00000040: 0000 0000 0000 0000 2b6c 6962 6865 6c6c  ........+libhell<br>00000050: 6f2e 646c 0000 0000 0000 0000 0000 0000  o.dl............<br>00000060: 0000 0000 0000 0000 3f68 656c 6c6f 0000  ........?hello..<br>00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>00000080: c000 0000 0000 0000 236d 6169 6e00 0000  ........#main...<br>00000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................<br>000000c0: ff15 9aff ffff ff15 94ff ffff ff15 8eff  ................<br>000000d0: ffff ff15 88ff ffff 48c7 c000 0000 00c3  ........H.......<br></code></pre></td></tr></table></figure><blockquote><p>libc.dlã€libhello.dlã€helloè¿™ä¸‰ä¸ªç¬¦å·éƒ½æ˜¯å¡«é›¶çš„ã€‚åªæœ‰mainå‡½æ•°å·²ç»å¡«ä¸Šäº†æ­£ç¡®çš„åç§»ã€‚<br>å¯ä»¥åæ¨ï¼Œæˆ‘ä»¬å¾—åˆ°çš„.dlæ–‡ä»¶çš„æ ¼å¼æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆæ˜¯__hdrå¤´ï¼Œè¿™é‡Œæœ‰æ¨¡æ•°ï¼Œæ–‡ä»¶çš„å¤§å°ï¼Œä»¥åŠä»£ç æ®µçš„åç§»ã€‚ ç„¶åæ˜¯ç¬¦å·è¡¨ï¼›ç¬¦å·è¡¨ç»“æŸåï¼Œå†32ä¸ªå­—èŠ‚å¡«0ä½œä¸ºåˆ†ç•Œçº¿ï¼Œç„¶åæ˜¯ä»£ç æ®µã€‚ å¦™å“‡å¦™å“‡ï¼åŸæ¥å®å®šä¹‰è¿˜å¯ä»¥è¿™ä¹ˆç”¨ï¼</p></blockquote></li><li><p><strong>ç„¶åæ˜¯dl_interpå‡½æ•°æ¥è§£é‡Šæ‰§è¡Œ</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">dl_interp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dlib</span> *<span class="hljs-title">h</span> =</span> dlopen_chk(path);<br>  <span class="hljs-type">int</span> (*entry)() = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">struct</span> symbol *sym = h-&gt;symtab; sym-&gt;type; sym++)<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(sym-&gt;name, <span class="hljs-string">&quot;main&quot;</span>) == <span class="hljs-number">0</span>)<br>      entry = (<span class="hljs-type">void</span> *)((<span class="hljs-type">char</span> *)h + sym-&gt;offset);<br>  <span class="hljs-keyword">if</span> (entry) &#123;<br>    <span class="hljs-built_in">exit</span>(entry());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ‰¾åˆ°mainå‡½æ•°ï¼Œexit(entry()) çš„ä½œç”¨å°±æ˜¯åœ¨ç¨‹åºç»“æŸæ—¶æ‰§è¡Œ main å‡½æ•°ï¼Œå¹¶å°†å…¶è¿”å›å€¼ä½œä¸ºç¨‹åºçš„é€€å‡ºç ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> dlib *<span class="hljs-title function_">dlopen_chk</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dlib</span> *<span class="hljs-title">lib</span> =</span> dlopen(path);<br>  <span class="hljs-keyword">if</span> (!lib) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Not a valid dlib file: %s.\n&quot;</span>, path);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> lib;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> dlib *<span class="hljs-title function_">dlopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dl_hdr</span> <span class="hljs-title">hdr</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dlib</span> *<span class="hljs-title">h</span>;</span><br><br>  <span class="hljs-type">int</span> fd = open(path, O_RDONLY);<br>  <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">goto</span> bad;<br>  <span class="hljs-keyword">if</span> (read(fd, &amp;hdr, <span class="hljs-keyword">sizeof</span>(hdr)) &lt; <span class="hljs-keyword">sizeof</span>(hdr)) <span class="hljs-keyword">goto</span> bad;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(hdr.magic, DL_MAGIC, <span class="hljs-built_in">strlen</span>(DL_MAGIC)) != <span class="hljs-number">0</span>) <span class="hljs-keyword">goto</span> bad;<br><br>  h = mmap(<span class="hljs-literal">NULL</span>, hdr.file_sz, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE, fd, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (h == (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>) <span class="hljs-keyword">goto</span> bad;<br><br>  h-&gt;symtab = (<span class="hljs-keyword">struct</span> symbol *)((<span class="hljs-type">char</span> *)h + REC_SZ);<br>  h-&gt;path = path;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">struct</span> symbol *sym = h-&gt;symtab; sym-&gt;type; sym++) &#123;<br>    <span class="hljs-keyword">switch</span> (sym-&gt;type) &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;+&#x27;</span>: dlload(sym); <span class="hljs-keyword">break</span>; <span class="hljs-comment">// (recursively) load</span><br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;?&#x27;</span>: sym-&gt;offset = (<span class="hljs-type">uintptr_t</span>)dlsym(sym-&gt;name); <span class="hljs-keyword">break</span>; <span class="hljs-comment">// resolve</span><br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;#&#x27;</span>: dlexport(sym-&gt;name, (<span class="hljs-type">char</span> *)h + sym-&gt;offset); <span class="hljs-keyword">break</span>; <span class="hljs-comment">// export</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> h;<br><br>bad:<br>  <span class="hljs-keyword">if</span> (fd &gt; <span class="hljs-number">0</span>) close(fd);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ol><li>è¿™é‡Œè¦æ‰“å¼€.dlæ–‡ä»¶ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªæ–‡ä»¶ç”¨mmapå‡½æ•°æ˜ å°„åˆ°dlboxè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæ­¤æ—¶å…¶ä»–.dlæ–‡ä»¶çš„ä»£ç æ®µå°±ä¼šæ˜ å°„åˆ°dlboxè¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ï¼Œä¹Ÿå°±å¯ä»¥ç¡®å®šå‡½æ•°çš„åœ°å€äº†ï¼Œè¿™ä¹Ÿå°±å’ŒåŠ¨æ€é“¾æ¥çš„é“¾æ¥æ—¶ç»‘å®šæ€æƒ³ä¸è°‹è€Œåˆã€‚æ‰“å¼€è¿™ä¸ªå¯æ‰§è¡Œç¨‹åºæ—¶ï¼Œh-&gt;symtab &#x3D; (struct symbol *)((char *)h + REC_SZ);è¿™é‡Œæ˜¯åˆå§‹åŒ–ç¬¦å·è¡¨ã€‚</li><li>å¦‚æœé‡åˆ°.dlä½œä¸ºç¬¦å·è¡¨é¡¹(â€˜+â€™)ï¼Œåˆ™ç”¨dlloadé€’å½’åŠ è½½ï¼Œdlloadåˆ™æ˜¯è°ƒç”¨dlopenå®ç°çš„ã€‚</li><li>å¦‚æœé‡åˆ°ç¬¦å·è¡¨é¡¹çš„æŸä¸€é¡¹æ ‡è®°ä½â€™?â€™,è¡¨ç¤ºå¼•ç”¨å¤–éƒ¨ç¬¦å·ï¼Œæˆ‘ä»¬é€šè¿‡æŸ¥è¡¨dlsymå‡½æ•°æ¥å¡«è¡¨ã€‚</li><li>å¯ä»¥æƒ³è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œé€’å½’åœ°å¡«è¡¨ã€‚å¦‚æœå˜é‡æ˜¯è¿™ä¸ªmainç¨‹åºçš„å‡½æ•°(â€˜#â€™),æˆ‘ä»¬ç›´æ¥å¯ä»¥ç¡®å®šè¯¥å‡½æ•°çš„åœ°å€ã€‚ä¹Ÿå°±æ˜¯è¡¨å¤´çš„åœ°å€åŠ ä¸Šåç§»ã€‚</li><li>å¦‚æœè¿™ä¸ªç¬¦å·æ˜¯ä¸ª.dlæ–‡ä»¶ï¼Œåˆ™éœ€è¦è°ƒç”¨dlopenæŠŠè¿™ä¸ªæ–‡ä»¶æ•´ä½“æ˜ å°„è¿›è¿›ç¨‹çš„åœ°å€ç©ºé—´(é€’å½’)ï¼Œæ˜ å°„å®Œåï¼Œæ‰€æœ‰ç¬¦å·çš„åœ°å€éƒ½ä¼šè¢«ç¡®å®šï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥éå†æ¥å¡«symè¡¨äº†ã€‚è¿™ä¸ªsymè¡¨è®°å½•äº†æ‰€æœ‰ç¬¦å·ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œä¸€å¼€å§‹æ‰€æœ‰çš„é¡¹çš„nameå­—æ®µåˆå§‹åŒ–ä¸ºNULLã€‚</li></ol></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;#&#x27;</span>: dlexport(sym-&gt;name, (<span class="hljs-type">char</span> *)h + sym-&gt;offset); <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dlexport</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">void</span> *addr)</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; LENGTH(syms); i++)<br>    <span class="hljs-keyword">if</span> (!syms[i].name[<span class="hljs-number">0</span>]) &#123;<br>      syms[i].offset = (<span class="hljs-type">uintptr_t</span>)addr; <span class="hljs-comment">// load-time offset</span><br>      <span class="hljs-built_in">strcpy</span>(syms[i].name, name);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  assert(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ol start="6"><li>å¦‚æœè¿™ä¸ªç¬¦å·æ˜¯å¤–éƒ¨çš„å‡½æ•°ï¼Œç”±äºæˆ‘ä»¬å…ˆåŒ…å«.dlçš„åº“æ–‡ä»¶ï¼Œæ‰€ä»¥å¤–éƒ¨ç¬¦å·è¿™æ—¶å€™éƒ½ä¼šè§£æå®Œæ¯•ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å¡«å…¥æ­£ç¡®çš„åœ°å€ã€‚</li><li>ä¸Šé¢çš„æ€æƒ³ä¸»è¦æ˜¯ï¼šæˆ‘ä»¬åœ¨è£…è½½åŠ¨æ€åº“çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸åƒé™æ€é“¾æ¥é‚£æ ·å¯ä»¥çŸ¥é“è¿™ä¸ªæ¨¡å—æ˜¯è£…è½½åœ¨å“ªä¸ªä½ç½®çš„ã€‚æˆ‘ä»¬çš„è§£å†³æ–¹æ³•æ˜¯é€šè¿‡é—´æ¥è·³è½¬åœ¨æœ¬æ¨¡å—çš„æŸä¸ªä½ç½®(è¿™æ˜¯å¯ä»¥ç¡®å®šçš„)ï¼Œè¿™ä¸ªä½ç½®å°±æœ‰è¿™ä¸ªå‡½æ•°çš„åœ°å€çš„ä¿¡æ¯ã€‚ç”±äºæˆ‘ä»¬éƒ½æ˜¯æŒ‰æ¨¡å—è£…è½½çš„ï¼Œæ‰€ä»¥è¿™ä¸€ç‚¹å¹¶ä¸éš¾å®ç°ï¼Œé€šè¿‡æ·»åŠ ä¸€ä¸ªsymçš„å…¨å±€å˜é‡ç»“æ„æ•°ç»„ï¼Œåœ¨æ¯è£…è½½ä¸€ä¸ªæ¨¡å—(.dl)æ—¶ï¼Œå°±æŠŠè¯¥æ¨¡å—çš„æ‰€æœ‰è¿™ä¸ªæ¨¡å—çš„exportç±»å‹çš„å˜é‡å…¨éƒ¨å¡«å…¥è¿™ä¸ªsymæ•°ç»„ä¸­ã€‚<br>ç„¶åï¼Œæœ‰äº†è¿™ä¸ªsymæ•°ç»„ï¼Œå°±å¯ä»¥å¼€å§‹å›å¡«åˆ°æ¯ä¸ªæ¨¡å—çš„ç¬¦å·è¡¨ä¸­å¸¦æœ‰(â€˜?â€™)çš„ç¬¦å·offsetå­—æ®µäº†ã€‚</li></ol></blockquote></li></ol><hr><h3 id="åæ€ä¸æ”¹è¿›-æœ€ç²¾å½©çš„éƒ¨åˆ†"><a href="#åæ€ä¸æ”¹è¿›-æœ€ç²¾å½©çš„éƒ¨åˆ†" class="headerlink" title="åæ€ä¸æ”¹è¿›(æœ€ç²¾å½©çš„éƒ¨åˆ†)"></a><strong>åæ€ä¸æ”¹è¿›(æœ€ç²¾å½©çš„éƒ¨åˆ†)</strong></h3><h5 id="ä¸€äº›å°ç¼ºé™·"><a href="#ä¸€äº›å°ç¼ºé™·" class="headerlink" title="ä¸€äº›å°ç¼ºé™·"></a>ä¸€äº›å°ç¼ºé™·</h5><ul><li>å­˜å‚¨ä¿æŠ¤å’ŒåŠ è½½ä½ç½®ã€‚å…è®¸å°†.dlä¸­çš„ä¸€éƒ¨åˆ†ä»¥æŸä¸ªæŒ‡å®šçš„æƒé™æ˜ å°„åˆ°å†…å­˜çš„æŸä¸ªä½ç½®â€”&gt;ç¨‹åºå¤´è¡¨</li><li>å…è®¸è‡ªç”±æŒ‡å®šåŠ è½½å™¨â€”&gt;åŠ å…¥INTERP</li><li>ç©ºé—´æµªè´¹ â€”&gt;å­—ç¬¦ä¸²å­˜å‚¨åœ¨å¸¸é‡æ± ï¼Œç»Ÿä¸€é€šè¿‡â€œæŒ‡é’ˆâ€è®¿é—®(è¿™ä¹Ÿæ˜¯ELFéš¾è¯»çš„åŸå› )</li></ul><h5 id="å¦ä¸€ä¸ªå¤§ç¼ºé™·"><a href="#å¦ä¸€ä¸ªå¤§ç¼ºé™·" class="headerlink" title="å¦ä¸€ä¸ªå¤§ç¼ºé™·"></a>å¦ä¸€ä¸ªå¤§ç¼ºé™·</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// a.c</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><blockquote><p>ä¸€ç§å†™æ³•ï¼Œä¸¤ç§æƒ…å†µ</p></blockquote><ul><li>æ¥è‡ªäºå…¶ä»–ç¼–è¯‘å•å…ƒ(é™æ€é“¾æ¥)</li><li>åŠ¨æ€é“¾æ¥åº“</li></ul><p>ä¾‹å¦‚ï¼Œæœ‰a.oå’Œb.oé™æ€é“¾æ¥å†å’Œlib.soåŠ¨æ€é“¾æ¥,å¦‚æœa.oä¸­å¼•ç”¨äº†ä¸€ä¸ªå¤–éƒ¨ç¬¦å·foo,é‚£ä¹ˆè¯¥å¦‚ä½•åˆ¤æ–­è¿™ä¸ªç¬¦å·ç©¶ç«Ÿæ˜¯å±äºå“ªä¸ªå•å…ƒå‘¢ï¼Ÿå¦‚æœåªæ˜¯ç®€å•åœ°å®æ›¿æ¢, call *foo(%rip),ä½†å…¶å®è¿™æ ·æ˜¯æ•ˆç‡å¾ˆä½çš„ã€‚</p><h5 id="â€œå‘æ˜â€PLT-GOT"><a href="#â€œå‘æ˜â€PLT-GOT" class="headerlink" title="â€œå‘æ˜â€PLT &amp; GOT"></a>â€œå‘æ˜â€PLT &amp; GOT</h5><blockquote><p>å…ˆç¼–è¯‘ä¸ºç›¸å¯¹äº%ripçš„ç®€å•çš„callè°ƒç”¨ï¼Œåœ¨é“¾æ¥çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°è¿™æ˜¯ä¸€ä¸ªæœ¬å•å…ƒçš„ç¬¦å·ï¼Œç›´æ¥ç›¸å¯¹äºripå¯»å€ï¼›å¦‚æœå‘ç°è¿™æ˜¯ä¸€ä¸ªå¤–éƒ¨(åŠ¨æ€é“¾æ¥)åº“çš„è¯ï¼Œå°±éœ€è¦pltè¿™æ¡entry,å†æŠŠåœ°å€å¡«ä¸Šå»ã€‚</p></blockquote><blockquote><p>æˆ‘ä»¬çš„â€œç¬¦å·è¡¨â€å°±æ˜¯Global Offset Table(GOT).</p></blockquote><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">00000000000011e0</span> &lt;printf@plt&gt;:<br>    <span class="hljs-attribute">11e0</span>:       f3 <span class="hljs-number">0</span>f <span class="hljs-number">1</span>e fa             endbr64<br>    <span class="hljs-attribute">11e4</span>:       f2 ff <span class="hljs-number">25</span> <span class="hljs-number">7</span>d <span class="hljs-number">2</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span>    bnd jmp *<span class="hljs-number">0</span>x2d7d(%rip)        # <span class="hljs-number">3</span>f68 &lt;printf@GLIBC_2.<span class="hljs-number">2</span>.<span class="hljs-number">5</span>&gt;<br>    <span class="hljs-attribute">11eb</span>:       <span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">44</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>          nopl   <span class="hljs-number">0</span>x0(%rax,%rax,<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><blockquote><p>å’¦ï¼Œè¿™æ¡jmpæŒ‡ä»¤ä¸æ˜¯æœ‰ç‚¹ç†Ÿæ‚‰å—ï¼Ÿå’Œæˆ‘ä»¬çš„DSYMå¾ˆç›¸ä¼¼ã€‚è¿™ä¸å°è¯äº†æˆ‘ä»¬çš„çŒœæƒ³å—ï¼Ÿ</p></blockquote><h5 id="æœ€åä¸€ä¸ªé—®é¢˜ï¼šæ•°æ®"><a href="#æœ€åä¸€ä¸ªé—®é¢˜ï¼šæ•°æ®" class="headerlink" title="æœ€åä¸€ä¸ªé—®é¢˜ï¼šæ•°æ®"></a>æœ€åä¸€ä¸ªé—®é¢˜ï¼šæ•°æ®</h5><blockquote><p>ä¸ç®¡å¤šå°‘ä¸ªé™æ€åº“åŠ¨æ€åº“ï¼Œä½†æˆ‘ä»¬çš„ç¨‹åºåªæœ‰ä¸€ä¸ªerrno,environ,stdoutã€‚</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxä¸–ç•Œä¸­çš„åº”ç”¨ç¨‹åº(æ„å»ºæœ€å°çš„Linux)</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux%E4%B8%96%E7%95%8C%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F(%E6%9E%84%E5%BB%BA%E6%9C%80%E5%B0%8F%E7%9A%84Linux)/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux%E4%B8%96%E7%95%8C%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F(%E6%9E%84%E5%BB%BA%E6%9C%80%E5%B0%8F%E7%9A%84Linux)/</url>
    
    <content type="html"><![CDATA[<h2 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h2><ul><li><p>åŠ è½½ç¬¬ä¸€ä¸ªè¿›ç¨‹ ï¼ˆinit åº”ç”¨ç¨‹åºï¼‰</p><blockquote><p>ç›¸å½“äºåœ¨æ“ä½œç³»ç»Ÿä¸­æ”¾ç½®ä¸€ä¸ªä½äºåˆå§‹çŠ¶æ€çš„çŠ¶æ€æœº</p></blockquote></li><li><p>åŒ…å«ä¸€äº›è¿›ç¨‹å¯ä»¥æ“çºµçš„æ“ä½œç³»ç»Ÿå¯¹è±¡</p></li><li><p>ç„¶å Linux å˜æˆä¸€ä¸ªä¸­æ–­(ç³»ç»Ÿè°ƒç”¨)å¤„ç†ç¨‹åº</p></li></ul><p>systemdä¸ºä»€ä¹ˆæ˜¯è¿›ç¨‹æ ‘çš„æ ¹ (init è¿›ç¨‹å¹¶ä¸æ˜¯ systemd)</p><h2 id="Linux-Kernel-ç³»ç»Ÿè°ƒç”¨ä¸Šçš„å‘è¡Œç‰ˆå’Œåº”ç”¨ç”Ÿæ€"><a href="#Linux-Kernel-ç³»ç»Ÿè°ƒç”¨ä¸Šçš„å‘è¡Œç‰ˆå’Œåº”ç”¨ç”Ÿæ€" class="headerlink" title="Linux Kernel ç³»ç»Ÿè°ƒç”¨ä¸Šçš„å‘è¡Œç‰ˆå’Œåº”ç”¨ç”Ÿæ€"></a>Linux Kernel ç³»ç»Ÿè°ƒç”¨ä¸Šçš„å‘è¡Œç‰ˆå’Œåº”ç”¨ç”Ÿæ€</h2><ul><li>ç³»ç»Ÿå·¥å…· coreutils, binutils, systemd, â€¦.</li><li>æ¡Œé¢ç³»ç»Ÿ </li><li>åº”ç”¨ç¨‹åº</li></ul><h2 id="æ„å»ºæœ€å°çš„Linux"><a href="#æ„å»ºæœ€å°çš„Linux" class="headerlink" title="æ„å»ºæœ€å°çš„Linux"></a>æ„å»ºæœ€å°çš„Linux</h2><p>ç›®æ ‡ï¼šæŠŠLinuxå†…æ ¸å¯åŠ¨èµ·æ¥ï¼ŒæŠŠminimal.Sçš„äºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½ï¼Œæ‰“å°HelloWorldï¼Œç„¶åå°±é€€å‡ºã€‚</p><p>æˆ‘ä»¬çœŸæ­£çš„å£å’</p><ol><li>æ€ä¹ˆæ ·æå‡ºé—®é¢˜</li><li>æ€æ ·å›ç­”é—®å‡ºçš„é—®é¢˜</li></ol><p>é—®é¢˜ï¼š  æˆ‘å¸Œæœ›ç”¨ QEMU åœ¨ç»™å®šçš„ Linux å†…æ ¸å®Œæˆåˆå§‹åŒ–åï¼Œç›´æ¥æ‰§è¡Œæˆ‘è‡ªå·±ç¼–å†™çš„ã€é™æ€é“¾æ¥çš„ init äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æˆ‘åº”è¯¥æ€ä¹ˆåšï¼Ÿ</p><ol><li>éœ€è¦ç¼–è¯‘ä¸€ä¸ªé™æ€é“¾æ¥çš„ init äºŒè¿›åˆ¶æ–‡ä»¶ã€‚<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">$ gcc -<span class="hljs-keyword">static</span> -o <span class="hljs-keyword">init</span> <span class="hljs-keyword">init</span>.c<br></code></pre></td></tr></table></figure></li><li>åˆ›å»ºä¸€ä¸ª initramfs æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶ä¸­åŒ…å«æ‚¨çš„ init äºŒè¿›åˆ¶æ–‡ä»¶å’Œä»»ä½•å…¶ä»–å¿…éœ€çš„æ–‡ä»¶å’Œç›®å½•ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">initramfs:<br><span class="hljs-comment"># Copy kernel and busybox from the host system</span><br>@<span class="hljs-built_in">mkdir</span> -p build/initramfs/bin<br>sudo bash -c <span class="hljs-string">&quot;cp /boot/vmlinuz build/ &amp;&amp; chmod 666 build/vmlinuz&quot;</span><br><span class="hljs-built_in">cp</span> init build/initramfs/<br><span class="hljs-built_in">cp</span> $(shell <span class="hljs-built_in">which</span> busybox) build/initramfs/bin/<br></code></pre></td></tr></table></figure></li></ol><ul><li><p>ä»€ä¹ˆæ˜¯ cpio </p><blockquote><p>cpio æ˜¯ä¸€ä¸ªç±»ä¼¼äº tar çš„å·¥å…·ï¼Œç”¨äºåˆ›å»ºå’Œæå–å½’æ¡£æ–‡ä»¶ã€‚æœ€ç»ˆï¼Œå½’æ¡£æ–‡ä»¶å°†è¾“å‡ºåˆ°åä¸º initramfs.cpio çš„æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå‘½ä»¤é€šå¸¸ç”¨äºåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ initramfs æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥ä¾¿åœ¨å¯åŠ¨æ—¶åŠ è½½è‡ªå®šä¹‰çš„è½¯ä»¶å’Œé…ç½®æ–‡ä»¶ã€‚</p></blockquote><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-keyword">cd</span> build/initramfs &amp;&amp; \<br>find . -print0 \<br>| cpio <span class="hljs-params">--null</span> -ov <span class="hljs-params">--format=newc</span> \<br>| gzip -9 &gt; <span class="hljs-string">../initramfs.cpio.gz</span><br></code></pre></td></tr></table></figure></li><li><p>ä»€ä¹ˆæ˜¯ initramfs</p><blockquote><p>initramfs æ˜¯ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä»¥ä¾¿åœ¨ Linux å†…æ ¸åˆå§‹åŒ–åæä¾›ä¸€ä¸ªåˆå§‹æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚è¿™ä¸ªä¸´æ—¶çš„æ ¹æ–‡ä»¶ç³»ç»Ÿåœ¨æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¹‹å‰æ‰§è¡Œå¿…è¦çš„åˆå§‹åŒ–ä»»åŠ¡ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">-initrd build/initramfs.cpio.gz<br></code></pre></td></tr></table></figure></li></ul><ol start="3"><li>ç„¶åï¼Œæ‚¨éœ€è¦åœ¨ QEMU ä¸­å°† initramfs æ–‡ä»¶ç³»ç»ŸåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶å°† init äºŒè¿›åˆ¶æ–‡ä»¶è®¾ç½®ä¸º init è¿›ç¨‹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ QEMUï¼š<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs livescript">run:<br><span class="hljs-comment"># Run QEMU with the installed kernel and generated initramfs</span><br>qemu-system-x86_64 <span class="hljs-string">\</span><br>  -serial mon:stdio <span class="hljs-string">\</span><br>  -kernel build/vmlinuz <span class="hljs-string">\</span><br>  -initrd build/initramfs.cpio.gz <span class="hljs-string">\</span><br>  -machine accel=kvm:tcg <span class="hljs-string">\</span><br>  -append <span class="hljs-string">&quot;console=ttyS0 quiet rdinit=$(INIT)&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>rdinit&#x3D;init æ˜¯ä¸€ä¸ªå†…æ ¸å‘½ä»¤è¡Œå‚æ•°ï¼Œç”¨äºæŒ‡å®šå†…æ ¸å¯åŠ¨ååº”è¯¥è¿è¡Œå“ªä¸ªç¨‹åºä½œä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿçš„åˆå§‹åŒ–è¿›ç¨‹ã€‚åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œinit è¿›ç¨‹æ˜¯æ‰€æœ‰è¿›ç¨‹çš„ç¥–å…ˆè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡å’Œè¿›ç¨‹ã€‚rdinit&#x3D;init å‚æ•°å‘Šè¯‰å†…æ ¸åœ¨å¯åŠ¨æ—¶è¿è¡Œåä¸º init çš„ç¨‹åºä½œä¸º init è¿›ç¨‹ï¼Œè¿™é€šå¸¸æ˜¯æŒ‡åœ¨ initramfs æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç¨‹åºã€‚<br>å¦‚æœè¿™ä¸ªinitè¿›ç¨‹ä¸­é€”ç»“æŸé€€å‡ºäº†çš„è¯ï¼Œä¾‹å¦‚æŠŠè¿™ä¸ªinitè¿›ç¨‹æ¢æˆæˆ‘ä»¬çš„ä¸€ä¸ªminimal.S(ç®€å•çš„æ‰“å°åé€€å‡º)ï¼Œé‚£ä¹ˆç”±äºinitè¿›ç¨‹ç»“æŸï¼Œç³»ç»Ÿä¼španicã€‚initè¿›ç¨‹æœ‰ç€ç‰¹æ®Šçš„ä½œç”¨ã€‚</p></blockquote></li></ol><ul><li>ä»€ä¹ˆæ˜¯busybox<blockquote><p>Busyboxæ˜¯ä¸€ä¸ªå¼€æºå·¥å…·é›†ï¼Œé›†æˆäº†è®¸å¤šå¸¸ç”¨çš„Unixå·¥å…·ï¼Œå¦‚lsã€catã€grepã€findç­‰ï¼Œå¯ä»¥åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­æä¾›å‘½ä»¤è¡Œç•Œé¢çš„æ”¯æŒã€‚Busyboxçš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªå°å·§ã€é«˜æ•ˆçš„Unixå·¥å…·é›†ã€‚</p></blockquote></li></ul><ol><li>busybox sh å°±å˜æˆä¸€ä¸ª shell</li><li>busybox ls å°±æ‰§è¡Œ ls å‘½ä»¤</li></ol><ul><li>busybox å¯ä»¥çœ‹æˆLinuxæ‰€æœ‰ç¨‹åºçš„ä¸€ä¸ªæ‰“åŒ…</li></ul><ul><li><p>init ç¨‹åº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/busybox sh</span><br><br><span class="hljs-comment"># initrd, only busybox and /init</span><br>BB=/bin/busybox<br><br><span class="hljs-comment"># (1) Print something and exit</span><br><span class="hljs-variable">$BB</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\033[31mHello, OS World\033[0m&quot;</span><br><br><span class="hljs-comment"># (2) Run a shell on the init console</span><br><span class="hljs-variable">$BB</span> sh<br></code></pre></td></tr></table></figure><p>æŠŠ init ç¨‹åºæ¢æˆè¿™ä¸ªè„šæœ¬åï¼Œç³»ç»Ÿå¯åŠ¨æ²¡æœ‰ kernel panicäº†ã€‚<br>make runå¯åŠ¨åï¼Œå¾—åˆ°äº†ä¸€ä¸ªLinuxçš„ç»ˆç«¯ï¼Œä½†è¾“å…¥ ls å‘½ä»¤æ˜¯æ²¡æœ‰ååº”çš„ã€‚</p><blockquote><p>å›æƒ³ä¸€ä¸‹ï¼šç³»ç»Ÿåœ¨å¯åŠ¨ä»¥åï¼Œåªæœ‰ init å’Œ busyboxï¼Œç³»ç»Ÿå¹¶ä¸è®¤è¯† ls å‘½ä»¤ã€‚å¯ä»¥ &#x2F;bin&#x2F;busybox lsã€‚</p></blockquote></li><li><p>é‚£åº”è¯¥æ€ä¹ˆåŠï¼Ÿ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/busybox sh</span><br><br><span class="hljs-comment"># initrd, only busybox and /init</span><br>BB=/bin/busybox<br><br><span class="hljs-comment"># (1) Print something and exit</span><br><span class="hljs-variable">$BB</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\033[31mHello, OS World\033[0m&quot;</span><br><br><span class="hljs-comment"># (3) Rock&#x27;n Roll!</span><br><span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> $(<span class="hljs-variable">$BB</span> --list); <span class="hljs-keyword">do</span><br>  <span class="hljs-variable">$BB</span> <span class="hljs-built_in">ln</span> -s <span class="hljs-variable">$BB</span> /bin/<span class="hljs-variable">$cmd</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-variable">$BB</span> sh<br><br><span class="hljs-built_in">mkdir</span> -p /tmp<br><span class="hljs-built_in">mkdir</span> -p /proc &amp;&amp; mount -t proc  none /proc<br><span class="hljs-built_in">mkdir</span> -p /sys  &amp;&amp; mount -t sysfs none /sys<br><span class="hljs-built_in">mknod</span> /dev/tty c 4 1<br>setsid /bin/sh &lt;/dev/tty &gt;/dev/tty 2&gt;&amp;1<br></code></pre></td></tr></table></figure></li><li><p>åœ¨ &#x2F;bin ç›®å½•ä¸‹åˆ›å»ºå¤šä¸ªå‘½ä»¤çš„å¿«æ·æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> $(<span class="hljs-variable">$BB</span> --list); <span class="hljs-keyword">do</span><br>  <span class="hljs-variable">$BB</span> <span class="hljs-built_in">ln</span> -s <span class="hljs-variable">$BB</span> /bin/<span class="hljs-variable">$cmd</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure></li><li><p>æœ€åå›ç­”ä»€ä¹ˆæ˜¯ systemd, å®ƒä¸ºä»€ä¹ˆæ˜¯è¿›ç¨‹æ ‘çš„æ ¹ã€‚</p><blockquote><p>åœ¨ä¹‹åï¼Œä¼šæ‰§è¡Œ &#x2F;usr&#x2F;sbin&#x2F;init<br>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸ªå¿«æ·æ–¹å¼ï¼ŒæŒ‡å‘ &#x2F;lib&#x2F;systemd&#x2F;systemd</p></blockquote></li></ul>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»£ç é£æ ¼å’Œå®šåˆ¶åŒ–gdbè°ƒè¯•</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E5%92%8C%E5%AE%9A%E5%88%B6%E5%8C%96gdb%E8%B0%83%E8%AF%95/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E5%92%8C%E5%AE%9A%E5%88%B6%E5%8C%96gdb%E8%B0%83%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ¬è®²å†…å®¹"><a href="#æœ¬è®²å†…å®¹" class="headerlink" title="æœ¬è®²å†…å®¹"></a>æœ¬è®²å†…å®¹</h2><ol><li>ç¼–ç¨‹ä¸­çš„ä¸€äº›ç»†èŠ‚</li><li>è°ƒè¯•å·¥å…·çš„æ­£ç¡®ä½¿ç”¨æ–¹æ³•</li></ol><h3 id="è½¯ä»¶çš„çƒ­æ›´æ–°DSU"><a href="#è½¯ä»¶çš„çƒ­æ›´æ–°DSU" class="headerlink" title="è½¯ä»¶çš„çƒ­æ›´æ–°DSU"></a>è½¯ä»¶çš„çƒ­æ›´æ–°DSU</h3><h4 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STRINGIFY(s) #s</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TOSTRING(s)  STRINGIFY(s)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">padding</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-string">&quot;.fill &quot;</span> TOSTRING(PADDING) <span class="hljs-string">&quot;, 1, 0x90&quot;</span></span><br><span class="hljs-params">  )</span>;<br>&#125;<br><br>__attribute__((noinline)) <span class="hljs-type">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;In old function %s\n&quot;</span>, __func__);<br>&#125;<br><br>__attribute__((noinline)) <span class="hljs-type">void</span> <span class="hljs-title function_">foo_new</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;In new function %s\n&quot;</span>, __func__);<br>&#125;<br><br><span class="hljs-comment">// 48 b8 (64-bit imm)   movabs $imm,%rax</span><br><span class="hljs-comment">// ff e0                jmpq   *%rax</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> PATCH[] = <span class="hljs-string">&quot;\x48\xb8--------\xff\xe0&quot;</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">DSU</span><span class="hljs-params">(<span class="hljs-type">void</span> *func, <span class="hljs-type">void</span> *func_new)</span> &#123;<br>  <span class="hljs-type">int</span> flag = PROT_WRITE | PROT_READ | PROT_EXEC, rc, np;<br><br>  <span class="hljs-comment">// Grant write permission to the memory</span><br>  <span class="hljs-comment">// We must handle boundary cases</span><br>  <span class="hljs-type">uintptr_t</span> fn = (<span class="hljs-type">uintptr_t</span>)func;<br>  <span class="hljs-type">uintptr_t</span> base = fn &amp; ~<span class="hljs-number">0xfff</span>;<br>  <span class="hljs-keyword">if</span> (fn + <span class="hljs-keyword">sizeof</span>(PATCH) &gt; base + <span class="hljs-number">4096</span>) &#123;<br>    np = <span class="hljs-number">2</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    np = <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;np = %d\n&quot;</span>, np);<br><br>  rc = mprotect((<span class="hljs-type">void</span> *)base, np * <span class="hljs-number">4096</span>, flag);<br>  assert(rc == <span class="hljs-number">0</span>);  <span class="hljs-comment">// Not expecting a failure</span><br>  <br>  <span class="hljs-comment">// Patch the first instruction (this is UB in C spec)</span><br>  <span class="hljs-built_in">memcpy</span>(func, PATCH, <span class="hljs-keyword">sizeof</span>(PATCH));<br>  <span class="hljs-built_in">memcpy</span>((<span class="hljs-type">char</span> *)func + <span class="hljs-number">2</span>, &amp;func_new, <span class="hljs-keyword">sizeof</span>(func_new));<br><br>  <span class="hljs-comment">// Revoke the write permission</span><br>  rc = mprotect((<span class="hljs-type">void</span> *)base, np * <span class="hljs-number">4096</span>, PROT_READ | PROT_EXEC);<br>  assert(rc == <span class="hljs-number">0</span>);  <span class="hljs-comment">// Not expecting a failure</span><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  foo();<br>  DSU(foo, foo_new);  <span class="hljs-comment">// Dynamic software update</span><br>  foo();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ä¸€äº›ç¼–ç¨‹å°æŠ€å·§"><a href="#ä¸€äº›ç¼–ç¨‹å°æŠ€å·§" class="headerlink" title="ä¸€äº›ç¼–ç¨‹å°æŠ€å·§"></a>ä¸€äº›ç¼–ç¨‹å°æŠ€å·§</h4><ul><li><p>ä»€ä¹ˆæ˜¯ __func__ï¼Ÿ</p><blockquote><p><strong>func</strong> æ˜¯Cè¯­è¨€ä¸­çš„ä¸€ä¸ªå†…ç½®å®ï¼Œå®ƒè¿”å›å½“å‰å‡½æ•°çš„åç§°ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ã€‚å®ƒå¯ä»¥ç”¨äºè°ƒè¯•å’Œé”™è¯¯æŠ¥å‘Šï¼Œä»¥ä¾¿åœ¨ç¨‹åºå‡ºé”™æ—¶èƒ½å¤Ÿæ›´å®¹æ˜“åœ°ç¡®å®šé”™è¯¯å‘ç”Ÿåœ¨å“ªä¸ªå‡½æ•°ä¸­ã€‚<br>ç›¸å½“äºï¼š</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">my_function</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __func__ <span class="hljs-string">&quot;my_func&quot;</span></span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Current function: %s\n&quot;</span>, __func__);<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> __func__ </span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ä½¿ç”¨ <strong>func</strong> å®ä¸éœ€è¦åŒ…å«ä»»ä½•å¤´æ–‡ä»¶ï¼Œå› ä¸ºå®ƒæ˜¯Cè¯­è¨€çš„å†…ç½®å®ï¼Œå¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­ä½¿ç”¨ã€‚</p></blockquote></li><li><p>ä½¿ç”¨ assert æ–­è¨€</p><blockquote><p>æœ‰åˆ©äº bug çš„å®šä½</p></blockquote></li></ul><h4 id="ä»£ç è®²è§£"><a href="#ä»£ç è®²è§£" class="headerlink" title="ä»£ç è®²è§£"></a>ä»£ç è®²è§£</h4><ul><li><p>ä¸ºä»€ä¹ˆè¦æŠŠå‡½æ•°è®¾ç½®æˆ inline?<br>å†…è”å‡½æ•°ï¼ˆinline functionï¼‰æ˜¯ä¸€ç§ç¼–è¯‘å™¨æä¾›çš„ä¼˜åŒ–æ‰‹æ®µï¼Œå®ƒçš„æœ¬è´¨æ˜¯å°†å‡½æ•°åœ¨è°ƒç”¨å¤„å±•å¼€ï¼Œä»è€Œé¿å…äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå†…è”å‡½æ•°ä¸æ˜¯çœŸæ­£çš„å‡½æ•°è°ƒç”¨ï¼Œè€Œæ˜¯å°†å‡½æ•°çš„ä»£ç åµŒå…¥åˆ°è°ƒç”¨å¤„ï¼Œç±»ä¼¼äºå®æ›¿æ¢ã€‚</p></li><li><p>æ‰“ä¸€ä¸ªå°è¡¥ä¸</p><blockquote><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è°ƒç”¨ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œé¦–å…ˆ call foo, æŠŠè¿”å›åœ°å€å‹æ ˆï¼Œå¹¶è·³è½¬åˆ°fooå‡½æ•°å¤„ï¼Œç„¶åå†åœ¨fooå‡½æ•°é‚£é‡Œç»™ä¸Šä¸€ä¸ªè¡¥ä¸ã€‚</p></blockquote><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cos">movabs <span class="hljs-built_in">$imm</span> , <span class="hljs-built_in">%rax</span><br>jump *(rax)<br></code></pre></td></tr></table></figure><p>%raxæ˜¯ foo_newå‡½æ•°çš„åœ°å€ï¼Œå› ä¸ºfoo_newå‡½æ•°æœ€åä¹Ÿä¼šè°ƒç”¨ ret æŒ‡ä»¤ï¼Œæ‰€ä»¥ç»“æŸåè¿”å›åˆ°åŸæ¥çš„åœ°æ–¹ã€‚</p></li></ul><h3 id="ç”¨å¥½å·¥å…·"><a href="#ç”¨å¥½å·¥å…·" class="headerlink" title="ç”¨å¥½å·¥å…·"></a>ç”¨å¥½å·¥å…·</h3><ul><li>å¦‚ä½•è®©gdbä»¥æ›´å‹å¥½çš„æ–¹å¼å¸®æˆ‘ä»¬æ‰“å°ç›¸å…³çš„ä¿¡æ¯ï¼Ÿ<br>è®¡ç®—æœºå…¬ç†3ï¼šè®©ä½ æ„Ÿåˆ°ä¸é€‚çš„ tedious å·¥ä½œï¼Œä¸€å®šæœ‰åŠæ³•æé«˜æ•ˆç‡ã€‚</li></ul><blockquote><p>ç”¨pythonå†™ä¸€ä¸ªè„šæœ¬ï¼Œå¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„gdbå‘½ä»¤</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> gdb<br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<br><br>REGS = [<br>    <span class="hljs-string">&#x27;rax&#x27;</span>, <span class="hljs-string">&#x27;rbx&#x27;</span>, <span class="hljs-string">&#x27;rcx&#x27;</span>, <span class="hljs-string">&#x27;rdx&#x27;</span>,<br>    <span class="hljs-string">&#x27;rbp&#x27;</span>, <span class="hljs-string">&#x27;rsp&#x27;</span>, <span class="hljs-string">&#x27;rsi&#x27;</span>, <span class="hljs-string">&#x27;rdi&#x27;</span>,<br>    <span class="hljs-string">&#x27;r8&#x27;</span>, <span class="hljs-string">&#x27;r9&#x27;</span>, <span class="hljs-string">&#x27;r10&#x27;</span>, <span class="hljs-string">&#x27;r11&#x27;</span>,<br>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RegDump</span>(gdb.Command):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(RegDump, self).__init__(<br>            <span class="hljs-string">&quot;rdump&quot;</span>, gdb.COMMAND_DATA, gdb.COMPLETE_SYMBOL<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params">self, arg, _</span>):<br>        <span class="hljs-comment"># å¾—åˆ°å˜é‡ ctx çš„å€¼</span><br>        <span class="hljs-comment"># æ¯æ¬¡è¾“å…¥ rdump å‘½ä»¤ä¼šæ‰§è¡Œ invoke å‡½æ•°</span><br>        ctx = gdb.parse_and_eval(<span class="hljs-string">f&#x27;ctx&#x27;</span>)<br>        <span class="hljs-keyword">for</span> i, r <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(REGS):<br>            <span class="hljs-built_in">print</span>(<br>                <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;r.upper():<span class="hljs-number">3</span>&#125;</span> = <span class="hljs-subst">&#123;<span class="hljs-built_in">int</span>(ctx[r]):016x&#125;</span>&#x27;</span>,<br>                end=[<span class="hljs-string">&#x27;  &#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>][i % <span class="hljs-number">2</span>]<br>            )<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">40</span>)<br><br>RegDump()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_source_line</span>(<span class="hljs-params">address</span>):<br>    <span class="hljs-comment"># by GPT-4</span><br><br>    <span class="hljs-comment"># Find the source code line corresponding to the given address</span><br>    symtab_and_line = gdb.find_pc_line(address)<br><br>    <span class="hljs-comment"># Check if the source code line was found</span><br>    <span class="hljs-keyword">if</span> symtab_and_line.symtab <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># Get the source file name and line number</span><br>        filename = symtab_and_line.symtab.filename<br>        line_number = symtab_and_line.line<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;Path(filename).name&#125;</span>:<span class="hljs-subst">&#123;line_number&#125;</span>&#x27;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Source code line not found&quot;</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcDump</span>(gdb.Command):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(ProcDump, self).__init__(<br>            <span class="hljs-string">&quot;pdump&quot;</span>, gdb.COMMAND_DATA, gdb.COMPLETE_SYMBOL<br>        )<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params">self, *_</span>):<br>        n = gdb.parse_and_eval(<span class="hljs-string">f&#x27;NTASK&#x27;</span>)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            tsk = gdb.parse_and_eval(<span class="hljs-string">f&#x27;tasks[<span class="hljs-subst">&#123;i&#125;</span>]&#x27;</span>)<br>            pc = <span class="hljs-built_in">int</span>(tsk[<span class="hljs-string">&#x27;context&#x27;</span>][<span class="hljs-string">&#x27;rip&#x27;</span>])<br>            is_current = <span class="hljs-built_in">int</span>(<br>                gdb.parse_and_eval(<span class="hljs-string">f&#x27;&amp;tasks[<span class="hljs-subst">&#123;i&#125;</span>] == current&#x27;</span>)<br>            )<br>            <span class="hljs-built_in">print</span>(<br>                <span class="hljs-string">f&#x27;Proc-<span class="hljs-subst">&#123;i&#125;</span><span class="hljs-subst">&#123;<span class="hljs-string">&quot; *&quot;</span>[is_current]&#125;</span> &#x27;</span>,<br>                get_source_line(pc)<br>            )<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span> * <span class="hljs-number">40</span>)<br><br>ProcDump()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linuxè¿›ç¨‹åœ°å€ç©ºé—´</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/Linux%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/</url>
    
    <content type="html"><![CDATA[<h2 id="Linuxè¿›ç¨‹çš„åœ°å€ç©ºé—´"><a href="#Linuxè¿›ç¨‹çš„åœ°å€ç©ºé—´" class="headerlink" title="Linuxè¿›ç¨‹çš„åœ°å€ç©ºé—´"></a>Linuxè¿›ç¨‹çš„åœ°å€ç©ºé—´</h2><p>æœ‰ä»€ä¹ˆå·¥å…·å¯ä»¥æ¥æŸ¥çœ‹è¿›ç¨‹çš„åœ°å€ç©ºé—´</p><ol><li>pmap</li><li>cat &#x2F;proc&#x2F; [pid] &#x2F; maps</li><li>gdb</li><li>readelf</li><li>objdump</li></ol><p>æœ‰çš„ç¨‹åºåˆšå¼€å§‹æ‰§è¡Œå°±ç»“æŸäº†(æ¯”å¦‚æ‰“å°ä¸€ä¸ªä¸œè¥¿å°±é€€å‡º)ï¼Œå¦‚æœè¦æŸ¥çœ‹è¿™ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚é‚£æ€ä¹ˆåŠï¼Ÿ</p><blockquote><p>ä½¿ç”¨gdbã€‚<br>ä½¿ç”¨gdbå‘½ä»¤ info inferiorså¾—åˆ°è¿›ç¨‹çš„pid</p></blockquote><ul><li>è¯¥å‘½ä»¤æ‰“å°gdbå½“å‰ç®¡ç†çš„inferiorsåˆ—è¡¨ï¼Œæ¯ä¸ªinferioréƒ½æœ‰è‡ªå·±çš„ä¸åŒåœ°å€ç©ºé—´ï¼Œinferiorä¸è¿›ç¨‹å¯¹åº”ã€‚</li></ul><ol><li><p>å¾—åˆ°è¿›ç¨‹çš„pidå,ä½¿ç”¨å‘½ä»¤ !pmap [pid], åœ¨gdbä¸­ä½¿ç”¨shellå‘½ä»¤éœ€è¦åœ¨å‰é¢åŠ ä¸Š ï¼ã€‚</p></li><li><p>åŒæ ·ï¼Œåœ¨gdbä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ !cat &#x2F;proc&#x2F; [pid] &#x2F;mapsæ¥æŸ¥çœ‹è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</p></li></ol><ul><li>å…¶å®pmapå°±æ˜¯ä½¿ç”¨ç³»ç»Ÿä¸­çš„ &#x2F;proc&#x2F;[pid]&#x2F;è¿™ä¸ªæ–‡ä»¶å®ç°çš„ã€‚<br>æ€ä¹ˆè¯æ˜å‘¢ï¼Ÿ<blockquote><p>ä½¿ç”¨ strace   strace pmap [pid]</p></blockquote></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello World\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h4><p>gdbè°ƒè¯•startiä¹‹åï¼ŒæŸ¥çœ‹è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0000555555554000</span>      <span class="hljs-number">4</span>K r---- a.out<br><span class="hljs-attribute">0000555555555000</span>      <span class="hljs-number">4</span>K r-x-- a.out<br><span class="hljs-attribute">0000555555556000</span>      <span class="hljs-number">4</span>K r---- a.out<br><span class="hljs-attribute">0000555555557000</span>      <span class="hljs-number">8</span>K rw--- a.out<br><span class="hljs-attribute">00007ffff7fbd000</span>     <span class="hljs-number">16</span>K r----  <span class="hljs-meta"> [ anon ]</span><br><span class="hljs-attribute">00007ffff7fc1000</span>      <span class="hljs-number">8</span>K r-x--  <span class="hljs-meta"> [ anon ]</span><br><span class="hljs-attribute">00007ffff7fc3000</span>      <span class="hljs-number">8</span>K r---- ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br><span class="hljs-attribute">00007ffff7fc5000</span>    <span class="hljs-number">168</span>K r-x-- ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br><span class="hljs-attribute">00007ffff7fef000</span>     <span class="hljs-number">44</span>K r---- ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br><span class="hljs-attribute">00007ffff7ffb000</span>     <span class="hljs-number">16</span>K rw--- ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br><span class="hljs-attribute">00007ffffffdd000</span>    <span class="hljs-number">136</span>K rw---  <span class="hljs-meta"> [ stack ]</span><br> <span class="hljs-attribute">total</span>              <span class="hljs-number">416</span>K<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å‘ç°ï¼Œåœ¨æŒ‰ä¸‹startiåï¼Œæœ‰ä¸€æ¡ä¿¡æ¯ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-number">0</span>x00007ffff7fe32b0 in _start () <span class="hljs-keyword">from</span> <span class="hljs-regexp">/lib64/</span>ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜åŠ¨æ€é“¾æ¥çš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨&#x2F;lib64&#x2F;ld-linux-x86-64.so.2ä¸­ï¼Œç”šè‡³åœ¨åœ°å€ç©ºé—´ä¸­æ­¤æ—¶ä¹Ÿæ²¡æœ‰libcè¿™ä¸ªåº“ã€‚<br>åœ¨çŠ¶æ€æœºåœ¨åˆšåˆšè¢«åˆå§‹åŒ–çš„ä¸€ç¬é—´ï¼Œåœ¨è¿›ç¨‹é‡Œé¢è¿˜æ²¡æœ‰printfã€‚</p><blockquote><p>åŠ¨æ€é“¾æ¥çš„ELFæ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªINTERP, å°±æ˜¯è¿™é‡Œçš„ld-linux-x86-64.so.2, éœ€è¦å¦å¤–ä¸€ä¸ªç¨‹åºï¼Œæ‰èƒ½æ‰§è¡Œç°åœ¨è¿™ä¸ªç¨‹åºï¼Œå¯¹äºåŠ¨æ€é“¾æ¥æ¥è¯´ï¼Œè¿™å°±æ˜¯åŠ è½½å™¨ã€‚</p></blockquote><p>å†åœ¨mainå‡½æ•°ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼Œcontinueåå†æ‰“å°ä¸€æ¬¡è¿›ç¨‹çš„åœ°å€ç©ºé—´</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0000555555554000</span>      <span class="hljs-number">4</span>K r---- a.out<br><span class="hljs-attribute">0000555555555000</span>      <span class="hljs-number">4</span>K r-x-- a.out<br><span class="hljs-attribute">0000555555556000</span>      <span class="hljs-number">4</span>K r---- a.out<br><span class="hljs-attribute">0000555555557000</span>      <span class="hljs-number">4</span>K r---- a.out<br><span class="hljs-attribute">0000555555558000</span>      <span class="hljs-number">4</span>K rw--- a.out<br><span class="hljs-attribute">00007ffff7d7f000</span>     <span class="hljs-number">12</span>K rw---  <span class="hljs-meta"> [ anon ]</span><br><span class="hljs-attribute">00007ffff7d82000</span>    <span class="hljs-number">160</span>K r---- libc.so.<span class="hljs-number">6</span><br><span class="hljs-attribute">00007ffff7daa000</span>   <span class="hljs-number">1620</span>K r-x-- libc.so.<span class="hljs-number">6</span><br><span class="hljs-attribute">00007ffff7f3f000</span>    <span class="hljs-number">352</span>K r---- libc.so.<span class="hljs-number">6</span><br><span class="hljs-attribute">00007ffff7f97000</span>     <span class="hljs-number">16</span>K r---- libc.so.<span class="hljs-number">6</span><br><span class="hljs-attribute">00007ffff7f9b000</span>      <span class="hljs-number">8</span>K rw--- libc.so.<span class="hljs-number">6</span><br><span class="hljs-attribute">00007ffff7f9d000</span>     <span class="hljs-number">52</span>K rw---  <span class="hljs-meta"> [ anon ]</span><br><span class="hljs-attribute">00007ffff7fbb000</span>      <span class="hljs-number">8</span>K rw---  <span class="hljs-meta"> [ anon ]</span><br><span class="hljs-attribute">00007ffff7fbd000</span>     <span class="hljs-number">16</span>K r----  <span class="hljs-meta"> [ anon ]</span><br><span class="hljs-attribute">00007ffff7fc1000</span>      <span class="hljs-number">8</span>K r-x--  <span class="hljs-meta"> [ anon ]</span><br><span class="hljs-attribute">00007ffff7fc3000</span>      <span class="hljs-number">8</span>K r---- ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br><span class="hljs-attribute">00007ffff7fc5000</span>    <span class="hljs-number">168</span>K r-x-- ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br><span class="hljs-attribute">00007ffff7fef000</span>     <span class="hljs-number">44</span>K r---- ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br><span class="hljs-attribute">00007ffff7ffb000</span>      <span class="hljs-number">8</span>K r---- ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br><span class="hljs-attribute">00007ffff7ffd000</span>      <span class="hljs-number">8</span>K rw--- ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span><br><span class="hljs-attribute">00007ffffffdd000</span>    <span class="hljs-number">136</span>K rw---  <span class="hljs-meta"> [ stack ]</span><br> <span class="hljs-attribute">total</span>             <span class="hljs-number">2644</span>K<br></code></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œæˆ‘ä»¬å‘ç°libcå·²ç»æœ‰äº†ã€‚åŠ è½½å™¨ä¹Ÿè¿˜åœ¨ï¼Œæœªæ¥å¯èƒ½è¿˜éœ€è¦è¿™ä¸ªåŠ è½½å™¨åŠ è½½å…¶ä»–åŠ¨æ€é“¾æ¥åº“ã€‚</p><h4 id="å…¶ä»–å°ç»†èŠ‚"><a href="#å…¶ä»–å°ç»†èŠ‚" class="headerlink" title="å…¶ä»–å°ç»†èŠ‚"></a>å…¶ä»–å°ç»†èŠ‚</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> main&#123;<br><span class="hljs-built_in">time</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨åº“éƒ½åŠ è½½å®Œæˆåï¼Œç”¨ !cat &#x2F;proc&#x2F;14776&#x2F;&#x2F;maps æŸ¥çœ‹è¯¥è¿›ç¨‹çš„åœ°å€ç©ºé—´</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">7ffff7fbd000</span>-<span class="hljs-number">7</span>ffff7fc1000 r--p <span class="hljs-number">00000000</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span>                         <span class="hljs-meta"> [vvar]</span><br><br><span class="hljs-attribute">7ffff7fc1000</span>-<span class="hljs-number">7</span>ffff7fc3000 r-xp <span class="hljs-number">00000000</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span>                         <span class="hljs-meta"> [vdso]</span><br><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°è¿™ä¸¤è¡Œï¼Œ vvar å’Œ vdso æ˜¯ä»€ä¹ˆï¼Ÿ</p><blockquote><p>ä¸è¿›å…¥å†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨ã€‚<br>vvar is a memory region that contains kernel variables that are frequently accessed by user-space programs. These variables are read-only and can be accessed directly by the user-space programs without making a system call.<br>ä¾‹å¦‚<br>å½“å‰çš„æ—¶é—´ï¼Œ ç³»ç»Ÿé¡µé¢å¤§å°<br>vdso is a memory region that contains a small shared library provided by the kernel. This library contains a set of functions that are commonly used by user-space programs and can be excuted directly in user mode, without the need for a system call.</p></blockquote><h3 id="è¿›ç¨‹åœ°å€ç©ºé—´çš„ç®¡ç†"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´çš„ç®¡ç†" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´çš„ç®¡ç†"></a>è¿›ç¨‹åœ°å€ç©ºé—´çš„ç®¡ç†</h3><p>æ“ä½œç³»ç»Ÿåº”è¯¥æä¾›ä¸€ä¸ªä¿®æ”¹è¿›ç¨‹åœ°å€ç©ºé—´çš„ç³»ç»Ÿè°ƒç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// æ˜ å°„</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">           <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">munmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length)</span>;<br><br><span class="hljs-comment">// ä¿®æ”¹æ˜ å°„æƒé™</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">mprotect</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot)</span>;<br></code></pre></td></tr></table></figure><p>æœ¬è´¨ï¼šåœ¨çŠ¶æ€æœºçŠ¶æ€ä¸Šå¢åŠ &#x2F;åˆ é™¤&#x2F;ä¿®æ”¹ä¸€æ®µå¯è®¿é—®çš„å†…å­˜</p><ul><li>mmap: å¯ä»¥ç”¨æ¥ç”³è¯·å†…å­˜ (MAP_ANONYMOUS)ï¼Œä¹Ÿå¯ä»¥æŠŠæ–‡ä»¶ â€œæ¬åˆ°â€ è¿›ç¨‹åœ°å€ç©ºé—´ä¸­</li></ul><p>ä¸€å°æ®µç¤ºä¾‹ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GiB * (1024LL * 1024 * 1024)</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">volatile</span> <span class="hljs-type">uint8_t</span> *p = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">8</span> GiB, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mmap: %lx\n&quot;</span>, (<span class="hljs-type">uintptr_t</span>)p);<br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">intptr_t</span>)p == <span class="hljs-number">-1</span>) &#123;<br>    perror(<span class="hljs-string">&quot;cannot map&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  *(p + <span class="hljs-number">2</span> GiB) = <span class="hljs-number">1</span>;<br>  *(p + <span class="hljs-number">4</span> GiB) = <span class="hljs-number">2</span>;<br>  *(p + <span class="hljs-number">7</span> GiB) = <span class="hljs-number">3</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Read get: %d\n&quot;</span>, *(p + <span class="hljs-number">4</span> GiB));<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Read get: %d\n&quot;</span>, *(p + <span class="hljs-number">6</span> GiB));<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Read get: %d\n&quot;</span>, *(p + <span class="hljs-number">7</span> GiB));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç–‘é—®ï¼šè¿™ä¸ªç¨‹åºè¿è¡Œä¼šä¸ä¼šéœ€è¦å¾ˆé•¿çš„æ—¶é—´ï¼Œå› ä¸ºå®ƒåˆ†é…äº†é‚£ä¹ˆå¤šçš„å†…å­˜ï¼Ÿ</p><blockquote><p>å…¶å®ä¸€ç¬é—´å°±å®Œæˆäº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä½¿ç”¨mmapçš„æ—¶å€™ï¼Œåªæ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­æ ‡è®°äº†è¿™ä¸ªè¿›ç¨‹è¿™ä¹ˆå¤šçš„å†…å­˜ï¼Œè¿™ä¸ªè¿›ç¨‹ä¸­è¿™äº›å†…å­˜è¿˜å¹¶æ²¡æœ‰å¼€å§‹åˆ†é…ï¼Œåªæ˜¯åœ¨åé¢ç”¨åˆ°äº†æ‰ä¼šäº§ç”Ÿç¼ºé¡µä¸­æ–­ã€‚</p></blockquote><h3 id="å…¥ä¾µåœ°å€ç©ºé—´"><a href="#å…¥ä¾µåœ°å€ç©ºé—´" class="headerlink" title="å…¥ä¾µåœ°å€ç©ºé—´"></a>å…¥ä¾µåœ°å€ç©ºé—´</h3><p>è¿›ç¨‹ (M,  R çŠ¶æ€æœº) åœ¨ â€œæ— æƒ…æ‰§è¡ŒæŒ‡ä»¤æœºå™¨â€ ä¸Šæ‰§è¡Œ</p><ul><li>çŠ¶æ€æœºæ˜¯ä¸€ä¸ªå°é—­ä¸–ç•Œ</li><li>ä½†å¦‚æœå…è®¸ä¸€ä¸ªè¿›ç¨‹å¯¹å…¶ä»–è¿›ç¨‹çš„åœ°å€ç©ºé—´æœ‰è®¿é—®æƒï¼Ÿ</li></ul><p>ä¸€äº›å…¥ä¾µåœ°å€ç©ºé—´çš„ä¾‹å­</p><ol><li>è°ƒè¯•å™¨(gdb)</li></ol><ul><li>gdb å¯ä»¥ä»»æ„è§‚æµ‹å’Œä¿®æ”¹ç¨‹åºçš„çŠ¶æ€</li></ul><ol start="2"><li>Profiler (perf)</li></ol><h4 id="å…¥ä¾µè¿›ç¨‹åœ°å€ç©ºé—´-1-é‡‘å±±æ¸¸ä¾ "><a href="#å…¥ä¾µè¿›ç¨‹åœ°å€ç©ºé—´-1-é‡‘å±±æ¸¸ä¾ " class="headerlink" title="å…¥ä¾µè¿›ç¨‹åœ°å€ç©ºé—´ (1): é‡‘å±±æ¸¸ä¾ "></a>å…¥ä¾µè¿›ç¨‹åœ°å€ç©ºé—´ (1): é‡‘å±±æ¸¸ä¾ </h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_WATCH 65536</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game</span> &#123;</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;  <span class="hljs-comment">// Name of the binary</span><br>  <span class="hljs-type">int</span> pid;           <span class="hljs-comment">// Process ID</span><br><br>  <span class="hljs-type">int</span> memfd;         <span class="hljs-comment">// Address space of the process</span><br>  <span class="hljs-type">int</span> bits;          <span class="hljs-comment">// Search bit-width (16, 32, or 64)</span><br>  <span class="hljs-type">bool</span> has_watch;    <span class="hljs-comment">// Watched values</span><br>  <span class="hljs-type">uintptr_t</span> watch[MAX_WATCH];<br>&#125;;<br><br>FILE* <span class="hljs-title function_">popens</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* fmt, ...)</span>;<br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">mem_load</span><span class="hljs-params">(<span class="hljs-type">char</span> *mem, <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> bits)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">scan</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> game *g, <span class="hljs-type">uint32_t</span> val)</span> &#123;<br>  <span class="hljs-type">uintptr_t</span> start, kb;<br>  <span class="hljs-type">char</span> perm[<span class="hljs-number">16</span>];<br>  FILE *fp = popens(<span class="hljs-string">&quot;pmap -x $(pidof %s) | tail -n +3&quot;</span>, g-&gt;name);<br>  <span class="hljs-type">int</span> nmatch = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fscanf</span>(fp, <span class="hljs-string">&quot;%lx&quot;</span>, &amp;start) == <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">fscanf</span>(fp, <span class="hljs-string">&quot;%ld%*ld%*ld%s%*[^\n]s&quot;</span>, &amp;kb, perm);<br>    <span class="hljs-keyword">if</span> (perm[<span class="hljs-number">1</span>] != <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">continue</span>;  <span class="hljs-comment">// Non-writable areas</span><br><br>    <span class="hljs-type">uintptr_t</span> size = kb * <span class="hljs-number">1024</span>;<br>    <span class="hljs-type">char</span> *mem = <span class="hljs-built_in">calloc</span>(size + <span class="hljs-number">16</span>, <span class="hljs-number">1</span>);  <span class="hljs-comment">// Ignores error handling for brevity</span><br>    lseek(g-&gt;memfd, start, SEEK_SET);  <span class="hljs-comment">// Don&#x27;t do this in production!</span><br>    size = read(g-&gt;memfd, mem, size);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Scanning %lx--%lx\n&quot;</span>, start, start + size);<br><br>    <span class="hljs-keyword">if</span> (!g-&gt;has_watch) &#123;<br>      <span class="hljs-comment">// First-time search; scan all memory</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> off = <span class="hljs-number">0</span>; off &lt; size; off += <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-type">uint64_t</span> v = mem_load(mem, off, g-&gt;bits);<br>        <span class="hljs-keyword">if</span> (v == val &amp;&amp; nmatch &lt; MAX_WATCH) &#123;<br>          g-&gt;watch[nmatch++] = start + off;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// Search in the watched values</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_WATCH; i++) &#123;<br>        <span class="hljs-type">intptr_t</span> off = g-&gt;watch[i] - start;<br>        <span class="hljs-keyword">if</span> (g-&gt;watch[i] &amp;&amp; <span class="hljs-number">0</span> &lt;= off &amp;&amp; off &lt; size) &#123;<br>          <span class="hljs-type">uint64_t</span> v = mem_load(mem, off, g-&gt;bits);<br>          <span class="hljs-keyword">if</span> (v == val) nmatch++;<br>          <span class="hljs-keyword">else</span> g-&gt;watch[i] = <span class="hljs-number">0</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-built_in">free</span>(mem);<br>  &#125;<br>  pclose(fp);<br><br>  <span class="hljs-keyword">if</span> (nmatch &gt; <span class="hljs-number">0</span>) &#123;<br>    g-&gt;has_watch = <span class="hljs-literal">true</span>;<br>  &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;There are %d match(es).\n&quot;</span>, nmatch);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">overwrite</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> game *g, <span class="hljs-type">uint64_t</span> val)</span> &#123;<br>  <span class="hljs-type">int</span> nwrite = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_WATCH; i++)<br>    <span class="hljs-keyword">if</span> (g-&gt;watch[i]) &#123;<br>      lseek(g-&gt;memfd, g-&gt;watch[i], SEEK_SET);<br>      write(g-&gt;memfd, &amp;val, g-&gt;bits / <span class="hljs-number">8</span>);<br>      nwrite++;<br>    &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d value(s) written.\n&quot;</span>, nwrite);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">reset</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> game *g)</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_WATCH; i++) &#123;<br>    g-&gt;watch[i] = <span class="hljs-number">0</span>;<br>  &#125;<br>  g-&gt;has_watch = <span class="hljs-literal">false</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Search for %d-bit values in %s.\n&quot;</span>, g-&gt;bits, g-&gt;name);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">load_game</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> game *g, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span> &#123;<br>  FILE *pid_fp;<br>  <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>  g-&gt;name = name;<br>  g-&gt;bits = <span class="hljs-number">32</span>;<br>  reset(g);<br><br>  pid_fp = popens(<span class="hljs-string">&quot;pidof %s&quot;</span>, g-&gt;name);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fscanf</span>(pid_fp, <span class="hljs-string">&quot;%d&quot;</span>, &amp;g-&gt;pid) != <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Panic: fail to get pid of \&quot;%s\&quot;.\n&quot;</span>, g-&gt;name);<br>    ret = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">goto</span> release;<br>  &#125;<br><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">64</span>];<br>  <span class="hljs-built_in">snprintf</span>(buf, <span class="hljs-keyword">sizeof</span>(buf), <span class="hljs-string">&quot;/proc/%d/mem&quot;</span>, g-&gt;pid);<br>  g-&gt;memfd = open(buf, O_RDWR);<br>  <span class="hljs-keyword">if</span> (g-&gt;memfd &lt; <span class="hljs-number">0</span>) &#123;<br>    perror(<span class="hljs-string">&quot;/proc/[pid]/mem&quot;</span>);<br>    ret = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">goto</span> release;<br>  &#125;<br><br>release:<br>  <span class="hljs-keyword">if</span> (pid_fp) pclose(pid_fp);<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">close_game</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> game *g)</span> &#123;<br>  <span class="hljs-keyword">if</span> (g-&gt;memfd &gt;= <span class="hljs-number">0</span>) &#123;<br>    close(g-&gt;memfd);<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-type">long</span> val;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">64</span>];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">game</span> <span class="hljs-title">game</span>;</span><br><br>  <span class="hljs-keyword">if</span> (load_game(&amp;game, argv[<span class="hljs-number">1</span>]) &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">goto</span> release;<br>  &#125;<br><br>  <span class="hljs-keyword">while</span> (!feof(<span class="hljs-built_in">stdin</span>)) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(%s %d) &quot;</span>, game.name, game.pid);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>, buf) &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">goto</span> release;<br><br>    <span class="hljs-keyword">switch</span> (buf[<span class="hljs-number">0</span>]) &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;q&#x27;</span>: <span class="hljs-keyword">goto</span> release; <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;val); game.bits = val; reset(&amp;game); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;val); scan(&amp;game, val); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;w&#x27;</span>: <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;val); overwrite(&amp;game, val); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;r&#x27;</span>: reset(&amp;game); <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>release:<br>  close_game(&amp;game);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>FILE* <span class="hljs-title function_">popens</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* fmt, ...)</span> &#123;<br>  <span class="hljs-type">char</span> cmd[<span class="hljs-number">128</span>];<br>  va_list args;<br>  va_start(args, fmt);<br>  vsnprintf(cmd, <span class="hljs-keyword">sizeof</span>(cmd), fmt, args);<br>  va_end(args);<br>  FILE *ret = popen(cmd, <span class="hljs-string">&quot;r&quot;</span>);<br>  assert(ret);<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">mem_load</span><span class="hljs-params">(<span class="hljs-type">char</span> *mem, <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> bits)</span> &#123;<br>  <span class="hljs-type">uint64_t</span> val = *(<span class="hljs-type">uint64_t</span> *)(&amp;mem[off]);<br>  <span class="hljs-keyword">switch</span> (bits) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">16</span>: val &amp;= <span class="hljs-number">0xffff</span>; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">32</span>: val &amp;= <span class="hljs-number">0xffffffff</span>; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">64</span>: <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>: assert(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> val;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç å¯¼è¯»</p><ul><li>va_listï¼Œva_start()ã€va_arg() å’Œ va_end() æ˜¯ä»€ä¹ˆ<blockquote><p>è¿™å¯ä»¥ä½¿Cè¯­è¨€å®ç°å˜é•¿å‚æ•°ã€‚</p><blockquote><p>va_list æ˜¯ä¸€ä¸ªç±»å‹ï¼Œç”¨äºè¡¨ç¤ºå¯å˜å‚æ•°åˆ—è¡¨ã€‚<br>va_start() å®ç”¨äºåˆå§‹åŒ–å¯å˜å‚æ•°åˆ—è¡¨<br>va_arg() å®ç”¨äºè®¿é—®å¯å˜å‚æ•°åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªå‚æ•°<br>va_end() å®ç”¨äºç»“æŸå¯å˜å‚æ•°åˆ—è¡¨çš„è®¿é—®</p></blockquote></blockquote></li><li>ä¸€æ®µå°ä¾‹å­<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span><br><br><span class="hljs-type">double</span> <span class="hljs-title function_">average</span><span class="hljs-params">(<span class="hljs-type">int</span> count, ...)</span> &#123;<br>    va_list ap;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">double</span> total = <span class="hljs-number">0.0</span>;<br><br>    va_start(ap, count); <span class="hljs-comment">// åˆå§‹åŒ–å¯å˜å‚æ•°åˆ—è¡¨</span><br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>        total += va_arg(ap, <span class="hljs-type">double</span>); <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªå‚æ•°</span><br>    &#125;<br><br>    va_end(ap); <span class="hljs-comment">// ç»“æŸå¯å˜å‚æ•°åˆ—è¡¨</span><br><br>    <span class="hljs-keyword">return</span> total / count;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">double</span> avg = average(<span class="hljs-number">5</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">3.0</span>, <span class="hljs-number">4.0</span>, <span class="hljs-number">5.0</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;å¹³å‡å€¼ä¸ºï¼š%f\n&quot;</span>, avg);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>popenå‡½æ•°</p><blockquote><p>popen()ä¼šè°ƒç”¨fork()äº§ç”Ÿå­è¿›ç¨‹ï¼Œç„¶åä»å­è¿›ç¨‹ä¸­è°ƒç”¨&#x2F;bin&#x2F;sh -cæ¥æ‰§è¡Œå‚æ•°commandçš„æŒ‡ä»¤ã€‚å‚æ•°typeå¯ä½¿ç”¨â€œrâ€ä»£è¡¨è¯»å–ï¼Œâ€œwâ€ä»£è¡¨å†™å…¥ã€‚ä¾ç…§æ­¤typeå€¼ï¼Œpopen()ä¼šå»ºç«‹ç®¡é“è¿åˆ°å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºè®¾å¤‡æˆ–æ ‡å‡†è¾“å…¥è®¾å¤‡ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆã€‚éšåè¿›ç¨‹ä¾¿å¯åˆ©ç”¨æ­¤æ–‡ä»¶æŒ‡é’ˆæ¥è¯»å–å­è¿›ç¨‹çš„è¾“å‡ºè®¾å¤‡æˆ–æ˜¯å†™å…¥åˆ°å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥è®¾å¤‡ä¸­ã€‚</p></blockquote></blockquote></li><li>ä¹Ÿå°±æ˜¯è¯´ï¼Œé¦–å…ˆè·å–æ¸¸æˆè¿›ç¨‹çš„åå­—åï¼Œå…ˆåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œ pidof [name]çš„å‘½ä»¤ï¼Œå¯ä»¥è·å–æ¸¸æˆè¿›ç¨‹pidã€‚ç„¶åfscanf(pid_fp, â€œ%dâ€, &amp;g-&gt;pid) !&#x3D; 1è¯»å–è¯¥è¿›ç¨‹pidã€‚<br>æ¥ç€æ‰“å¼€&#x2F;proc&#x2F;[pid]&#x2F;memè¿™ä¸ªæ–‡ä»¶ã€‚g-&gt;memfdæŒ‡å‘è¿™ä¸ªæ–‡ä»¶ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">snprintf</span>(buf, <span class="hljs-keyword">sizeof</span>(buf), <span class="hljs-string">&quot;/proc/%d/mem&quot;</span>, g-&gt;pid);<br>  g-&gt;memfd = open(buf, O_RDWR);<br>  <span class="hljs-keyword">if</span> (g-&gt;memfd &lt; <span class="hljs-number">0</span>) &#123;<br>    perror(<span class="hljs-string">&quot;/proc/[pid]/mem&quot;</span>);<br>    ret = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">goto</span> release;<br>  &#125;<br><br></code></pre></td></tr></table></figure></li><li>scanå‡½æ•°<br>åœ¨ç”¨pmapå¾—åˆ°è™šæ‹Ÿåœ°å€åŒºåŸŸåï¼Œå°±å¯ä»¥æŠŠè¿™ä¸ªåŒºåŸŸæ˜ å°„åˆ°å…¥ä¾µç¨‹åºçš„åœ°å€ç©ºé—´ä¸­ï¼Œå¹¶å¾—åˆ°èµ·å§‹åœ°å€ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> *mem = <span class="hljs-built_in">calloc</span>(size + <span class="hljs-number">16</span>, <span class="hljs-number">1</span>);  <span class="hljs-comment">// Ignores error handling for </span><br></code></pre></td></tr></table></figure></li><li>ä¹‹åæŠŠ &#x2F;proc&#x2F;pid&#x2F;memçš„æ–‡ä»¶åç§»è®¾ä¸ºè™šæ‹Ÿåœ°å€åŒºåŸŸèµ·å§‹å¤„ã€‚</li></ul><ul><li>å¦‚æœæƒ³è¦åœ¨&#x2F;proc&#x2F;pid&#x2F;mem æ–‡ä»¶è®¿é—®è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ 0x12345678ï¼Œæ‚¨éœ€è¦å°†æ–‡ä»¶åç§»é‡è®¾ç½®ä¸º 0x12345678ã€‚<br>å¹¶æŠŠè¿™ä¸ªåŒºåŸŸçš„å†…å­˜å…¨éƒ¨å†™å…¥å…¥ä¾µè¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ã€‚<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">lseek(g-&gt;memfd, start, SEEK_SET);  <span class="hljs-comment">// Don&#x27;t do this in production!</span><br>size = read(g-&gt;memfd, mem, size);<br></code></pre></td></tr></table></figure></li></ul><ul><li>ç„¶åå°±å¯ä»¥æ ¹æ®åç§»ï¼Œå¯ä»¥æŠŠç›¸åº”çš„åœ°å€å¯¹åº”èµ·æ¥äº†ã€‚å¤§è‡´æ„æ€å°±æ˜¯åœ¨å…¥ä¾µåœ°å€é‡Œæš´åŠ›å¯»æ‰¾ç¬¦åˆæ¡ä»¶çš„åœ°å€ï¼Œç„¶åæ ¹æ®æ‰¾çš„çš„ç¬¦åˆæ¡ä»¶çš„åœ°å€ï¼Œç”±äºåç§»æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±å¯ä»¥æŠŠè¿™ä¸ªåœ°å€å¯¹åº”åˆ°è¢«å…¥ä¾µè¿›ç¨‹çš„ç›¸åº”è™šæ‹Ÿåœ°å€åŒºåŸŸä¸­äº†ã€‚</li></ul><h4 id="å…¥ä¾µè¿›ç¨‹åœ°å€ç©ºé—´-2-å˜é€Ÿé½¿è½®"><a href="#å…¥ä¾µè¿›ç¨‹åœ°å€ç©ºé—´-2-å˜é€Ÿé½¿è½®" class="headerlink" title="å…¥ä¾µè¿›ç¨‹åœ°å€ç©ºé—´ (2): å˜é€Ÿé½¿è½®"></a>å…¥ä¾µè¿›ç¨‹åœ°å€ç©ºé—´ (2): å˜é€Ÿé½¿è½®</h4><p>ç”¨ä¿®æ”¹ç¨‹åºç³»ç»Ÿè°ƒç”¨çš„æ‰‹æ®µæ¥æ¬ºéª—ç¨‹åºå¯¹æ—¶é—´çš„è®¤è¯†ï¼Œå°±å¯ä»¥å®ç°æ¸¸æˆçš„åŠ é€Ÿå’Œå‡é€Ÿã€‚</p><ul><li><p>ç®€å•çš„ä¸€æ®µCç¨‹åº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> hp = <span class="hljs-number">10000</span>;<br><br>__attribute__((noinline)) <span class="hljs-type">int</span> <span class="hljs-title function_">hit</span><span class="hljs-params">(<span class="hljs-type">int</span> damage)</span> &#123;<br>  <span class="hljs-keyword">return</span> hp - damage;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    hp = hit(rand() % <span class="hljs-number">10</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hp = %d\n&quot;</span>, hp);<br>    usleep(<span class="hljs-number">10000</span>);<br>    <span class="hljs-keyword">if</span> (hp &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Game Over\n&quot;</span>);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>python è„šæœ¬</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv<br><span class="hljs-keyword">import</span> subprocess<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(argv) &lt; <span class="hljs-number">2</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Usage <span class="hljs-subst">&#123;argv[<span class="hljs-number">0</span>]&#125;</span> [--hp] [--fast] [--slow]&#x27;</span>)<br>    exit(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">addr, patch</span>):<br>    pid = <span class="hljs-built_in">int</span>(subprocess.check_output([<span class="hljs-string">&#x27;pidof&#x27;</span>, <span class="hljs-string">&#x27;game&#x27;</span>]))<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">f&#x27;/proc/<span class="hljs-subst">&#123;pid&#125;</span>/mem&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> fp:<br>        fp.seek(addr)<br>        fp.write(patch)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">symbol</span>):<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> subprocess.check_output([<span class="hljs-string">&#x27;nm&#x27;</span>, <span class="hljs-string">&#x27;game&#x27;</span>]).splitlines():<br>        tokens = line.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>).split()<br>        <span class="hljs-keyword">if</span> tokens[-<span class="hljs-number">2</span>:] == [<span class="hljs-string">&#x27;T&#x27;</span>, symbol]:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(tokens[<span class="hljs-number">0</span>], base=<span class="hljs-number">16</span>)<br><br><span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;--hp&#x27;</span> <span class="hljs-keyword">in</span> argv:<br>    <span class="hljs-comment"># hit -&gt; mov $9999999, %eax; ret</span><br>    patch(name(<span class="hljs-string">&#x27;hit&#x27;</span>), <span class="hljs-string">b&#x27;\xb8\x7f\x96\x98\x00\xc3&#x27;</span>)<br><br><span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;--slow&#x27;</span> <span class="hljs-keyword">in</span> argv:<br>    <span class="hljs-comment"># usleep (endbr64) -&gt; shl $0x4, %rdi</span><br>    patch(name(<span class="hljs-string">&#x27;usleep&#x27;</span>), <span class="hljs-string">b&#x27;\x48\xc1\xe7\x04&#x27;</span>)<br><br><span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;--fast&#x27;</span> <span class="hljs-keyword">in</span> argv:<br>    <span class="hljs-comment"># usleep (endbr64) -&gt; shr $0x4, %rdi</span><br>    patch(name(<span class="hljs-string">&#x27;usleep&#x27;</span>), <span class="hljs-string">b&#x27;\x48\xc1\xef\x04&#x27;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>forkçš„åº”ç”¨</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/fork%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/fork%E7%9A%84%E5%BA%94%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="å¤ä¹ "><a href="#å¤ä¹ " class="headerlink" title="å¤ä¹ "></a>å¤ä¹ </h2><ul><li>forkçŠ¶æ€æœºå¤åˆ¶ï¼ŒåŒ…æ‹¬æŒæœ‰çš„æ‰€æœ‰æ“ä½œç³»ç»Ÿå¯¹è±¡(å¦‚æ–‡ä»¶æè¿°ç¬¦)</li><li>execveé‡ç½®çŠ¶æ€æœºï¼Œä½†ç»§æ‰¿æŒæœ‰çš„æ‰€æœ‰æ“ä½œç³»ç»Ÿçš„å¯¹è±¡</li><li>ä¾‹å¦‚åœ¨forkä¹‹å‰æ‰“å¼€ä¸€ä¸ªç®¡é“, ç„¶åå°±å¯ä»¥æŠŠä¸€éƒ¨åˆ†è®¡ç®—çš„è¾“å‡ºç®¡é“ç»™å¦å¤–ä¸€ä¸ªè¿›ç¨‹çš„è¾“å…¥</li></ul><h2 id="æ–‡ä»¶æè¿°ç¬¦"><a href="#æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦"></a>æ–‡ä»¶æè¿°ç¬¦</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">int</span> flags)</span>;<br></code></pre></td></tr></table></figure><ul><li>RTFM: O_CLOEXEC : execveæ—¶æ–‡ä»¶æè¿°ç¬¦ä¸åº”è¯¥è¢«ç»§æ‰¿ï¼› O_APPENDï¼šä»¥è¿½åŠ çš„æ–¹å¼å†™è¯¥æ–‡ä»¶</li><li>å¯¹äºæ•°æ®æ–‡ä»¶ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¼šè®°ä½ä¸Šæ¬¡è®¿é—®çš„ä½ç½®</li><li>dupï¼šå¤åˆ¶ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿›ç¨‹æœ‰ä¸¤ä¸ªfdæŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”å…·æœ‰åŒä¸€ä¸ªoffset</li></ul><h2 id="å›åˆ°fork-å¤åˆ¶ï¼Œä½†åˆæ²¡æœ‰å®Œå…¨å¤åˆ¶"><a href="#å›åˆ°fork-å¤åˆ¶ï¼Œä½†åˆæ²¡æœ‰å®Œå…¨å¤åˆ¶" class="headerlink" title="å›åˆ°fork, å¤åˆ¶ï¼Œä½†åˆæ²¡æœ‰å®Œå…¨å¤åˆ¶"></a>å›åˆ°fork, å¤åˆ¶ï¼Œä½†åˆæ²¡æœ‰å®Œå…¨å¤åˆ¶</h2><p>æ¦‚å¿µä¸ŠçŠ¶æ€æœºè¢«å¤åˆ¶ï¼Œä½†å®é™…ä¸Šå¤åˆ¶åå†…å­˜éƒ½å…±äº«</p><ul><li>â€œCopy on Writeâ€åªæœ‰è¢«å†™å…¥çš„é¡µé¢æ‰ä¼šå¤åˆ¶ä¸€ä»½<ol><li>è¢«å¤åˆ¶åï¼Œæ•´ä¸ªåœ°å€ç©ºé—´éƒ½è¢«æ ‡è®°ä½â€åªè¯»â€</li><li>æ“ä½œç³»ç»Ÿæ•è·Page Faultåé…Œæƒ…å¤åˆ¶é¡µé¢</li><li>æ“ä½œç³»ç»Ÿä¼šç»´æŠ¤æ¯ä¸ªé¡µé¢çš„å¼•ç”¨è®¡æ•°</li></ol></li></ul>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Cæ ‡å‡†åº“å’Œå®ç°</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/C%E6%A0%87%E5%87%86%E5%BA%93%E5%92%8C%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/C%E6%A0%87%E5%87%86%E5%BA%93%E5%92%8C%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="æˆ‘ä»¬è¯¥å¦‚ä½•å­¦ä¹ -C-æ ‡å‡†åº“"><a href="#æˆ‘ä»¬è¯¥å¦‚ä½•å­¦ä¹ -C-æ ‡å‡†åº“" class="headerlink" title="æˆ‘ä»¬è¯¥å¦‚ä½•å­¦ä¹  C æ ‡å‡†åº“?"></a>æˆ‘ä»¬è¯¥å¦‚ä½•å­¦ä¹  C æ ‡å‡†åº“?</h2><ul><li><del>ç›´æ¥è°ƒè¯• glibc (åƒæˆ‘ä»¬ä¸Šè¯¾é‚£æ ·)</del></li><li>å¯»æ‰¾æ›´å¥½çš„æ›¿ä»£å“ï¼Œä¸€å®šæœ‰ä¸ºåµŒå…¥å¼è®¾å¤‡å®ç°çš„ç®€åŒ– libcã€‚<blockquote><p>é€‰æ‹© musl<br>muslæ˜¯ä¸€ä¸ªè½»é‡çº§çš„Cæ ‡å‡†åº“ï¼Œå®ƒä¸“æ³¨äºæä¾›é«˜æ•ˆã€å¯é å’Œå®‰å…¨çš„Cè¯­è¨€è¿è¡Œæ—¶ç¯å¢ƒã€‚muslåº“çš„è®¾è®¡ç›®æ ‡æ˜¯éµå¾ªPOSIXæ ‡å‡†ï¼ŒåŒæ—¶ä¿æŒä»£ç çš„ç®€æ´å’Œæ˜“äºç»´æŠ¤ã€‚å®ƒä¸»è¦ç”¨äºåµŒå…¥å¼ç³»ç»Ÿã€è½»é‡çº§å®¹å™¨å’Œå…¶ä»–ç±»ä¼¼çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå› ä¸ºå®ƒæ¯”å…¶ä»–æ ‡å‡†åº“æ›´å°ã€æ›´å¿«ã€æ›´å®‰å…¨ï¼Œå¹¶ä¸”ä¸åŒ…å«ä»»ä½•ä¸“æœ‰ä»£ç æˆ–è®¸å¯è¯é™åˆ¶ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒä¹Ÿå¯ä»¥ç”¨ä½œæ›¿ä»£glibcçš„æ ‡å‡†åº“ã€‚</p></blockquote></li></ul><ul><li>é‚£æ€ä¹ˆç¼–è¯‘ä¸€ä¸ª C ç¨‹åºç”¨ musl ä½œä¸º libc è€Œä¸æ˜¯ç”¨ glibcå‘¢ ï¼Ÿ<ol><li>sudo apt-get install musl-tools</li><li>ç¼–å†™Cç¨‹åºï¼ŒåŒ…å« stdio.h å¤´æ–‡ä»¶</li><li>musl-gcc -o hello hello.c</li></ol></li></ul><h2 id="libc-çš„åŸºæœ¬åŠŸèƒ½"><a href="#libc-çš„åŸºæœ¬åŠŸèƒ½" class="headerlink" title="libc çš„åŸºæœ¬åŠŸèƒ½"></a>libc çš„åŸºæœ¬åŠŸèƒ½</h2><ul><li>åŸºç¡€æ•°æ®çš„ä½“ç³»ç»“æ„æ— å…³æŠ½è±¡</li></ul><ul><li>inttypes.h</li></ul><ul><li>å­—ç¬¦ä¸²å’Œæ•°ç»„æ“ä½œ</li></ul><h2 id="æ“ä½œç³»ç»Ÿå¯¹è±¡ä¸ç¯å¢ƒ"><a href="#æ“ä½œç³»ç»Ÿå¯¹è±¡ä¸ç¯å¢ƒ" class="headerlink" title="æ“ä½œç³»ç»Ÿå¯¹è±¡ä¸ç¯å¢ƒ"></a>æ“ä½œç³»ç»Ÿå¯¹è±¡ä¸ç¯å¢ƒ</h2><ul><li><p>ç¯å¢ƒå˜é‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> **environ;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> **env = environ; *env; env++) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, *env);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>environæ˜¯ä¸€ä¸ªå­—ç¬¦æŒ‡é’ˆçš„æŒ‡é’ˆã€‚</p></li><li><p>environæ˜¯è°èµ‹å€¼çš„ï¼Ÿ</p></li></ul><p>gdbè°ƒè¯•<br>ç¬¬ä¸€æ¡æŒ‡ä»¤çš„æ—¶å€™ environ è¿˜æ²¡æœ‰è¢«èµ‹å€¼ã€‚</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-number">0</span>x00007ffff7fc7bfe in _dlstart () <span class="hljs-keyword">from</span> <span class="hljs-regexp">/lib/</span>ld-musl-x86_64.so.<span class="hljs-number">1</span><br>(gdb) p(<span class="hljs-keyword">char</span>*) environ<br>$<span class="hljs-number">1</span> = <span class="hljs-number">0</span>x0<br></code></pre></td></tr></table></figure><p>è€Œåœ¨mainå‡½æ•°çš„æ—¶å€™ï¼Œenvironæ˜¯æœ‰æ­£ç¡®çš„å€¼çš„ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>__libc_start_mainå‡½æ•°<br>char **envp = argv + argc + <span class="hljs-number">1</span>;<br>.....<br>.....<br><span class="hljs-regexp">//</span>__init_libcå‡½æ•°<br>environ = envp<br></code></pre></td></tr></table></figure><h2 id="åŠ¨æ€å†…å­˜ç®¡ç†"><a href="#åŠ¨æ€å†…å­˜ç®¡ç†" class="headerlink" title="åŠ¨æ€å†…å­˜ç®¡ç†"></a>åŠ¨æ€å†…å­˜ç®¡ç†</h2>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åº”ç”¨è§†è§’çš„æ“ä½œç³»ç»Ÿ</title>
    <link href="/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%BA%94%E7%94%A8%E8%A7%86%E8%A7%92%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    <url>/2023/08/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/jyy%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%BA%94%E7%94%A8%E8%A7%86%E8%A7%92%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<h2 id="æœ¬è®²å†…å®¹ï¼šæŒ‡ä»¤åºåˆ—å’Œé«˜çº§è¯­è¨€çš„çŠ¶æ€æœºæ¨¡å‹ï¼›å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š"><a href="#æœ¬è®²å†…å®¹ï¼šæŒ‡ä»¤åºåˆ—å’Œé«˜çº§è¯­è¨€çš„çŠ¶æ€æœºæ¨¡å‹ï¼›å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š" class="headerlink" title="æœ¬è®²å†…å®¹ï¼šæŒ‡ä»¤åºåˆ—å’Œé«˜çº§è¯­è¨€çš„çŠ¶æ€æœºæ¨¡å‹ï¼›å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š"></a>æœ¬è®²å†…å®¹ï¼šæŒ‡ä»¤åºåˆ—å’Œé«˜çº§è¯­è¨€çš„çŠ¶æ€æœºæ¨¡å‹ï¼›å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š</h2><ul><li>ä»€ä¹ˆæ˜¯è½¯ä»¶ (ç¨‹åº)ï¼Ÿ</li><li>å¦‚ä½•åœ¨æ“ä½œç³»ç»Ÿä¸Šæ„é€ æœ€å°&#x2F;ä¸€èˆ¬&#x2F;å›¾å½¢ç•Œé¢åº”ç”¨ç¨‹åºï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ç¼–è¯‘å™¨ï¼Ÿç¼–è¯‘å™¨æŠŠä¸€æ®µç¨‹åºç¿»è¯‘æˆä»€ä¹ˆæ ·çš„æŒ‡ä»¤åºåˆ—æ‰ç®— â€œæ­£ç¡®â€ï¼Ÿ</li></ul><h2 id="æ„å»ºä¸€ä¸ªæœ€å°çš„ç¨‹åº"><a href="#æ„å»ºä¸€ä¸ªæœ€å°çš„ç¨‹åº" class="headerlink" title="æ„å»ºä¸€ä¸ªæœ€å°çš„ç¨‹åº"></a>æ„å»ºä¸€ä¸ªæœ€å°çš„ç¨‹åº</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello World\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="gcc-ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ä¸€ç‚¹ä¹Ÿä¸å°"><a href="#gcc-ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ä¸€ç‚¹ä¹Ÿä¸å°" class="headerlink" title="gcc ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ä¸€ç‚¹ä¹Ÿä¸å°"></a>gcc ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ä¸€ç‚¹ä¹Ÿä¸å°</h3><ol><li>objdump å·¥å…·å¯ä»¥æŸ¥çœ‹å¯¹åº”çš„æ±‡ç¼–ä»£ç </li><li>â€“verbose å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç¼–è¯‘é€‰é¡¹ (çœŸä¸å°‘)</li><li>printf å˜æˆäº† puts@plt</li><li>-Wl,â€“verbose å¯ä»¥æŸ¥çœ‹æ‰€æœ‰é“¾æ¥é€‰é¡¹ (çœŸä¸å°‘)<br>åŸæ¥é“¾æ¥äº†é‚£ä¹ˆå¤šä¸œè¥¿<br>è¿˜è§£é‡Šäº† end ç¬¦å·çš„ç”±æ¥</li><li>-static ä¼šé“¾æ¥ libc (å¤§é‡çš„ä»£ç )<blockquote><p>gcc a.c å’Œ gcc a.c -static æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p></blockquote></li></ol><h3 id="å¼ºè¡Œæ„é€ æœ€å°çš„-Hello-Worldï¼Ÿ"><a href="#å¼ºè¡Œæ„é€ æœ€å°çš„-Hello-Worldï¼Ÿ" class="headerlink" title="å¼ºè¡Œæ„é€ æœ€å°çš„ Hello, Worldï¼Ÿ"></a>å¼ºè¡Œæ„é€ æœ€å°çš„ Hello, Worldï¼Ÿ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">gcc -c hello<span class="hljs-selector-class">.c</span>    -&gt; hello<span class="hljs-selector-class">.o</span> <br>ld hello<span class="hljs-selector-class">.o</span> -e <span class="hljs-selector-tag">main</span>   -&gt; <span class="hljs-selector-tag">a</span>.out<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œa.out,ä¼šå‘ç”ŸSegmentation Fault.</p><p>å¦‚æœæ”¹ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å†ç»§ç»­æ‰§è¡Œä¸Šé¢çš„ç¼–è¯‘å‘½ä»¤ï¼Œå‘ç°ç¨‹åºå¯ä»¥æ­£å¸¸æ‰§è¡Œäº†ï¼ˆæ­»å¾ªç¯ï¼‰ã€‚</p><blockquote><p>æŸ¥çœ‹æ±‡ç¼–è¯­è¨€ï¼ŒçŒœæµ‹ç¨‹åºè¿”å›æ—¶çš„ ret å‡ºç°äº†é”™è¯¯ã€‚</p></blockquote><h3 id="è§£å†³å¼‚å¸¸é€€å‡º"><a href="#è§£å†³å¼‚å¸¸é€€å‡º" class="headerlink" title="è§£å†³å¼‚å¸¸é€€å‡º"></a>è§£å†³å¼‚å¸¸é€€å‡º</h3><blockquote><p>è§£å†³åŠæ³•ï¼šç”¨ä¸€æ¡ç‰¹æ®Šçš„æŒ‡ä»¤è¯·æ“ä½œç³»ç»Ÿå¸®å¿™</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">movq $SYS_exit,  %rax   <span class="hljs-comment"># exit(</span><br>movq $1,         %rdi   <span class="hljs-comment">#   status=1</span><br><span class="hljs-keyword">syscall</span>                 <span class="hljs-comment"># );</span><br></code></pre></td></tr></table></figure><ul><li>æŠŠ â€œç³»ç»Ÿè°ƒç”¨â€ çš„å‚æ•°æ”¾åˆ°å¯„å­˜å™¨ä¸­</li><li>æ‰§è¡Œ syscallï¼Œæ“ä½œç³»ç»Ÿæ¥ç®¡ç¨‹åº<ul><li>ç¨‹åºæŠŠæ§åˆ¶æƒå®Œå…¨äº¤ç»™æ“ä½œç³»ç»Ÿ</li><li>æ“ä½œç³»ç»Ÿå¯ä»¥æ”¹å˜ç¨‹åºçŠ¶æ€ç”šè‡³ç»ˆæ­¢ç¨‹åº</li></ul></li></ul><h2 id="ç†è§£é«˜çº§ç¼–ç¨‹è¯­è¨€ç¨‹åº"><a href="#ç†è§£é«˜çº§ç¼–ç¨‹è¯­è¨€ç¨‹åº" class="headerlink" title="ç†è§£é«˜çº§ç¼–ç¨‹è¯­è¨€ç¨‹åº"></a>ç†è§£é«˜çº§ç¼–ç¨‹è¯­è¨€ç¨‹åº</h2><blockquote><p>ç¼–ç¨‹è¯­è¨€ä¹Ÿæ˜¯ä¸€ä¸ªçŠ¶æ€æœº</p></blockquote><ul><li>éé€’å½’çš„æ±‰è¯ºå¡”<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">int</span> pc, n;<br>  <span class="hljs-type">char</span> from, to, via;<br>&#125; Frame;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> call(...) (&#123; *(++top) = (Frame) &#123; .pc = 0, __VA_ARGS__ &#125;; &#125;)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ret()     (&#123; top--; &#125;)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> goto(loc) (&#123; f-&gt;pc = (loc) - 1; &#125;)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hanoi</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">char</span> from, <span class="hljs-type">char</span> to, <span class="hljs-type">char</span> via)</span> &#123;<br>  Frame stk[<span class="hljs-number">64</span>], *top = stk - <span class="hljs-number">1</span>;<br>  call(n, from, to, via);<br>  <span class="hljs-keyword">for</span> (Frame *f; (f = top) &gt;= stk; f-&gt;pc++) &#123;<br>    n = f-&gt;n; from = f-&gt;from; to = f-&gt;to; via = f-&gt;via;<br>    <span class="hljs-keyword">switch</span> (f-&gt;pc) &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) &#123; <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c -&gt; %c\n&quot;</span>, from, to); <span class="hljs-keyword">goto</span>(<span class="hljs-number">4</span>); &#125; <br>      <span class="hljs-comment">// ä¸ºä»€ä¹ˆgoto(4)åªæ˜¯è®¾ç½®pcä¸º3ï¼Œæ˜¯å› ä¸ºå¾ªç¯ä¼š++</span><br><span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: call(n - <span class="hljs-number">1</span>, from, via, to);   <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: call(    <span class="hljs-number">1</span>, from, to,  via);  <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: call(n - <span class="hljs-number">1</span>, via,  to,  from); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: ret();                        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>: assert(<span class="hljs-number">0</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>ä»€ä¹ˆå«å‡½æ•°è°ƒç”¨<blockquote><p>å‡½æ•°æ˜¯ç”±å¾ˆå¤šä¸ªæ ˆå¸§ç»„æˆçš„ï¼Œæ¯ä¸€ä¸ªæ ˆå¸§éƒ½æœ‰ä¸€ä¸ªPC</p></blockquote></li></ul><p>ä»€ä¹ˆæ˜¯å‡½æ•°è°ƒç”¨ï¼Ÿ</p><blockquote><p> å‡½æ•°è°ƒç”¨å°±æ˜¯åœ¨æ ˆå¸§çš„é¡¶éƒ¨å†åŠ ä¸Šä¸€ä¸ªæ ˆå¸§ï¼Œè¿™ä¸ªæ ˆå¸§çš„PCæ˜¯0ï¼Œç„¶åæŠŠå‚æ•°æ”¾åˆ°æ ˆä¸Š</p></blockquote><p>ä»€ä¹ˆæ˜¯å‡½æ•°è¿”å›</p><blockquote><p>  æŠŠé¡¶éƒ¨çš„æ ˆç»™æŠ¹æ‰</p></blockquote><p>ä»€ä¹ˆæ˜¯æ‰§è¡Œä¸€æ¡è¯­å¥</p><blockquote><p>  å–æœ€é¡¶ä¸Šæ ˆå¸§PCä¸Šçš„è¯­å¥æ‰§è¡Œ</p></blockquote><ul><li>ä»£ç è®²è§£<br>è¿™æ˜¯é€’å½’ç‰ˆçš„æ±‰è¯ºå¡”<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">hanoi</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">char</span> from, <span class="hljs-type">char</span> to, <span class="hljs-type">char</span> via)</span> &#123;<br>  <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c -&gt; %c\n&quot;</span>, from, to);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    hanoi(n - <span class="hljs-number">1</span>, from, via, to);<br>    hanoi(<span class="hljs-number">1</span>,     from, to,  via);<br>    hanoi(n - <span class="hljs-number">1</span>, via,  to,  from);<br>  &#125;<br>  <span class="hljs-comment">// return çœç•¥äº†</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ ¹æ®ä¸Šé¢çš„æ€æƒ³ï¼ŒæŠŠæ•´ä¸ªhanoiå‡½æ•°ç†è§£æˆä¸€ä¸ªæ ˆå¸§ï¼Œæ¯ä¸€ä¸ªæ ˆå¸§æœ‰ä¸€ä¸ªPCï¼Œè¿˜éœ€è¦å‚æ•°ä¿¡æ¯</p></blockquote></li></ul><p><strong>å¯ä»¥ç†è§£æˆå‡½æ•°ä½“æ¯ä¸€æ¡è¯­å¥éƒ½æ˜¯ä¸€æ¡PCæŒ‡é’ˆ</strong><br>æ¯ä¸€æ¬¡å¾ªç¯ï¼Œéƒ½ä¼šå–æœ€é¡¶ä¸Šçš„æ ˆå¸§æ¥æ“ä½œ<br>è¿™ä¹Ÿå°±æ˜¯ä¸‹éƒ¨åˆ†çš„é€»è¾‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">switch</span> (f-&gt;pc) &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) &#123; <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c -&gt; %c\n&quot;</span>, from, to); <span class="hljs-keyword">goto</span>(<span class="hljs-number">4</span>); &#125; <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: call(n - <span class="hljs-number">1</span>, from, via, to);   <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: call(    <span class="hljs-number">1</span>, from, to,  via);  <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: call(n - <span class="hljs-number">1</span>, via,  to,  from); <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: ret();                        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>: assert(<span class="hljs-number">0</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="æ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶-åº”ç”¨ç¨‹åº"><a href="#æ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶-åº”ç”¨ç¨‹åº" class="headerlink" title="æ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶ (åº”ç”¨ç¨‹åº)"></a>æ“ä½œç³»ç»Ÿä¸Šçš„è½¯ä»¶ (åº”ç”¨ç¨‹åº)</h2><blockquote><p>ä»»ä½•ç¨‹åº &#x3D; minimal.S &#x3D; è°ƒç”¨ syscall çš„çŠ¶æ€æœº</p></blockquote><p>å¯æ‰§è¡Œæ–‡ä»¶æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„å¯¹è±¡</p><ul><li><p>ä¸å¤§å®¶æ—¥å¸¸ä½¿ç”¨çš„æ–‡ä»¶ (a.c, README.txt) æ²¡æœ‰æœ¬è´¨åŒºåˆ«</p></li><li><p>æ“ä½œç³»ç»Ÿæä¾› API æ‰“å¼€ã€è¯»å–ã€æ”¹å†™ (éƒ½éœ€è¦ç›¸åº”çš„æƒé™)</p></li></ul><p>æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶</p><ul><li>vim, cat, xxd éƒ½å¯ä»¥ç›´æ¥ â€œæŸ¥çœ‹â€ å¯æ‰§è¡Œæ–‡ä»¶</li><li>vim ä¸­äºŒè¿›åˆ¶çš„éƒ¨åˆ†æ— æ³• â€œé˜…è¯»â€ï¼Œä½†å¯ä»¥çœ‹åˆ°å­—ç¬¦ä¸²å¸¸é‡</li><li>ä½¿ç”¨ xxd å¯ä»¥çœ‹åˆ°æ–‡ä»¶ä»¥ â€œ\x7fâ€ â€œELFâ€ å¼€å¤´</li><li>Vscode æœ‰ binary editor æ’ä»¶</li></ul><p>åœ¨ Vim ä¸­è¾“å…¥ %!xxd å‘½ä»¤ä¼šå°†å½“å‰ç¼–è¾‘çš„æ–‡ä»¶è½¬æ¢æˆåå…­è¿›åˆ¶è¡¨ç¤ºï¼Œå¹¶åœ¨ Vim ä¸­æ˜¾ç¤ºã€‚è¿™ä¸ªå‘½ä»¤çš„ä½œç”¨æ˜¯å°†å½“å‰ç¼–è¾‘çš„æ–‡ä»¶ä½œä¸ºè¾“å…¥ä¼ é€’ç»™ xxd å‘½ä»¤(%è¡¨ç¤ºå¯¹æ•´ä¸ªæ–‡ä»¶æ‰§è¡Œæ“ä½œ)ï¼Œxxd å‘½ä»¤ä¼šå°†å…¶è½¬æ¢æˆåå…­è¿›åˆ¶æ ¼å¼ï¼Œå¹¶å°†ç»“æœè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºæµï¼Œæ­¤æ—¶ Vim ä¼šå°†å…¶è¯»å–å¹¶æ˜¾ç¤ºåœ¨ç¼–è¾‘å™¨ä¸­ã€‚</p><h2 id="åŠ¨æ‰‹å®éªŒï¼šè§‚å¯Ÿç¨‹åºçš„æ‰§è¡Œ"><a href="#åŠ¨æ‰‹å®éªŒï¼šè§‚å¯Ÿç¨‹åºçš„æ‰§è¡Œ" class="headerlink" title="åŠ¨æ‰‹å®éªŒï¼šè§‚å¯Ÿç¨‹åºçš„æ‰§è¡Œ"></a>åŠ¨æ‰‹å®éªŒï¼šè§‚å¯Ÿç¨‹åºçš„æ‰§è¡Œ</h2><p>å·¥å…·ç¨‹åºä»£è¡¨ï¼šç¼–è¯‘å™¨ (gcc)</p><ul><li>ä¸»è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼šexecve, read, write</li><li>strace -f gcc a.c (gcc ä¼šå¯åŠ¨å…¶ä»–è¿›ç¨‹ï¼Œ -fé€‰é¡¹ä¼šè¿½è¸ªæ‰€æœ‰å­è¿›ç¨‹)<ul><li>å¯ä»¥ç®¡é“ç»™ç¼–è¾‘å™¨ vim -</li><li>ç¼–è¾‘å™¨é‡Œè¿˜å¯ä»¥ %!grep (ç»†èŠ‚&#x2F;æŠ€å·§)</li></ul></li></ul><p>grep å‘½ä»¤çš„ -e é€‰é¡¹ç”¨äºæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªåŒ¹é…æ¨¡å¼ï¼Œè¿™äº›æ¨¡å¼å¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼æˆ–æ™®é€šå­—ç¬¦ä¸²ã€‚</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">strace <span class="hljs-keyword">ls</span> |&amp; <span class="hljs-keyword">grep</span> -<span class="hljs-keyword">e</span> <span class="hljs-keyword">read</span> -<span class="hljs-keyword">e</span> <span class="hljs-keyword">write</span><br></code></pre></td></tr></table></figure><p>å›¾å½¢ç•Œé¢ç¨‹åºä»£è¡¨ï¼šç¼–è¾‘å™¨ (xedit)</p><ul><li>ä¸»è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼špoll, recvmsg, writev</li><li>strace xedit<ul><li>å›¾å½¢ç•Œé¢ç¨‹åºå’Œ X-Window æœåŠ¡å™¨æŒ‰ç…§ X11 åè®®é€šä¿¡</li><li>è™šæ‹Ÿæœºä¸­çš„ xedit å°† X11 å‘½ä»¤é€šè¿‡ ssh (X11 forwarding) è½¬å‘åˆ° Host</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>æ“ä½œç³»ç»Ÿ</category>
      
      <category>jyyæ“ä½œç³»ç»Ÿ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jyyæ“ä½œç³»ç»Ÿ</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
